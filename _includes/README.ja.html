<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>

<p><em>注）
本文書は英語から翻訳したものであり、その内容が最新でない場合もあります。最新の情報はオリジナルの英語版を参照してください。</em></p>

<p>Sinatraは最小の労力でRubyによるWebアプリケーションを手早く作るための<a href="https://ja.wikipedia.org/wiki/%E3%83%A1%E3%82%A4%E3%83%B3%E3%83%9A%E3%83%BC%E3%82%B8%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E5%9B%BA%E6%9C%89%E8%A8%80%E8%AA%9E">DSL</a>です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># myapp.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Hello world!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>gemをインストールし、</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra
</code></pre>
</div>

<p>次のように実行します。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby myapp.rb
</code></pre>
</div>

<p><a href="http://localhost:4567">http://localhost:4567</a> を開きます。</p>

<p>ThinがあればSinatraはこれを利用するので、<code class="highlighter-rouge">gem install thin</code>することをお薦めします。</p>

<h2>目次</h2>



<h2>ルーティング(Routes)</h2>

<p>Sinatraでは、ルーティングはHTTPメソッドとURLマッチングパターンがペアになっています。
ルーティングはブロックに結び付けられています。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何か見せる</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何か生成する</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">put</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何か更新する</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">patch</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何か修正する</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">delete</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何か削除する</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">options</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何か満たす</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">link</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何かリンクを張る</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">unlink</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="err">何かアンリンクする</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ルーティングは定義された順番にマッチします。
リクエストに最初にマッチしたルーティングが呼び出されます。</p>

<p>トレイリングスラッシュを付けたルートは、そうでないルートと異なったものになります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code>    <span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
      <span class="c1"># Does not match "GET /foo/"</span>
    <span class="k">end</span>
</code></pre>
</div>

<p>ルーティングのパターンは名前付きパラメータを含むことができ、
<code class="highlighter-rouge">params</code>ハッシュで取得できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/hello/:name'</span> <span class="k">do</span>
  <span class="c1"># "GET /hello/foo" と "GET /hello/bar" にマッチ</span>
  <span class="c1"># params['name'] は 'foo' か 'bar'</span>
  <span class="s2">"Hello </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>また、ブロックパラメータで名前付きパラメータにアクセスすることもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/hello/:name'</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="c1"># "GET /hello/foo" と "GET /hello/bar" にマッチ</span>
  <span class="c1"># params['name'] は 'foo' か 'bar'</span>
  <span class="c1"># n が params['name'] を保持</span>
  <span class="s2">"Hello </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ルーティングパターンはアスタリスク(すなわちワイルドカード)を含むこともでき、
<code class="highlighter-rouge">params['splat']</code> で取得できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/say/*/to/*'</span> <span class="k">do</span>
  <span class="c1"># /say/hello/to/world にマッチ</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["hello", "world"]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/download/*.*'</span> <span class="k">do</span>
  <span class="c1"># /download/path/to/file.xml にマッチ</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["path/to/file", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ここで、ブロックパラメータを使うこともできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/download/*.*'</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="p">,</span> <span class="n">ext</span><span class="o">|</span>
  <span class="p">[</span><span class="n">path</span><span class="p">,</span> <span class="n">ext</span><span class="p">]</span> <span class="c1"># =&gt; ["path/to/file", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ルーティングを正規表現にマッチさせることもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">/\/hello\/([\w]+)/</span> <span class="k">do</span>
  <span class="s2">"Hello, </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'captures'</span><span class="p">].</span><span class="nf">first</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ここでも、ブロックパラメータが使えます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{/hello/([</span><span class="se">\w</span><span class="sr">]+)}</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="s2">"Hello, </span><span class="si">#{</span><span class="n">c</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ルーティングパターンは、オプショナルパラメータを取ることもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/posts/:format?'</span> <span class="k">do</span>
  <span class="c1"># "GET /posts/" と "GET /posts/json", "GET /posts/xml" の拡張子などにマッチ</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ところで、ディレクトリトラバーサル攻撃防御設定を無効にしないと（下記参照）、
ルーティングにマッチする前にリクエストパスが修正される可能性があります。</p>

<h2>条件(Conditions)</h2>

<p>ルーティングにはユーザエージェントのようなさまざまな条件を含めることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span><span class="p">,</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird (\d\.\d)[\d\/]*?/</span> <span class="k">do</span>
  <span class="s2">"Songbirdのバージョン </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'agent'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">を使ってます。"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="c1"># Songbird以外のブラウザにマッチ</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ほかに<code class="highlighter-rouge">host_name</code>と<code class="highlighter-rouge">provides</code>条件が利用可能です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="sr">/^admin\./</span> <span class="k">do</span>
  <span class="s2">"Adminエリアです。アクセスを拒否します!"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="s1">'html'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'rss'</span><span class="p">,</span> <span class="s1">'atom'</span><span class="p">,</span> <span class="s1">'xml'</span><span class="p">]</span> <span class="k">do</span>
  <span class="n">builder</span> <span class="ss">:feed</span>
<span class="k">end</span>
</code></pre>
</div>

<p>独自の条件を定義することも簡単にできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:probability</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span> <span class="n">condition</span> <span class="p">{</span> <span class="nb">rand</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>

<span class="n">get</span> <span class="s1">'/win_a_car'</span><span class="p">,</span> <span class="ss">:probability</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="k">do</span>
  <span class="s2">"あなたの勝ちです!"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/win_a_car'</span> <span class="k">do</span>
  <span class="s2">"残念、あなたの負けです。"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>複数の値を取る条件には、アスタリスクを使います。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:auth</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">roles</span><span class="o">|</span>   <span class="c1"># &lt;- ここでアスタリスクを使う</span>
  <span class="n">condition</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">logged_in?</span> <span class="o">&amp;&amp;</span> <span class="n">roles</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">role</span><span class="o">|</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">in_role?</span> <span class="n">role</span> <span class="p">}</span>
      <span class="n">redirect</span> <span class="s2">"/login/"</span><span class="p">,</span> <span class="mi">303</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/my/account/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">]</span> <span class="k">do</span>
  <span class="s2">"アカウントの詳細"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/only/admin/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="ss">:admin</span> <span class="k">do</span>
  <span class="s2">"ここは管理者だけ!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>戻り値(Return Values)</h2>

<p>ルーティングブロックの戻り値は、HTTPクライアントまたはRackスタックでの次のミドルウェアに渡されるレスポンスボディを決定します。</p>

<p>これは大抵の場合、上の例のように文字列ですが、それ以外の値も使用することができます。</p>

<p>Rackレスポンス、Rackボディオブジェクト、HTTPステータスコードのいずれかとして妥当なオブジェクトであればどのようなオブジェクトでも返すことができます。</p>

<ul>
  <li>3つの要素を含む配列:
<code class="highlighter-rouge">[ステータス(Integer), ヘッダ(Hash), レスポンスボディ(#eachに応答する)]</code>
</li>
  <li>2つの要素を含む配列:
<code class="highlighter-rouge">[ステータス(Integer), レスポンスボディ(#eachに応答する)]</code>
</li>
  <li>
<code class="highlighter-rouge">#each</code>に応答するオブジェクト。通常はそのまま何も返さないが、
与えられたブロックに文字列を渡す。</li>
  <li>ステータスコードを表現する整数(Integer)</li>
</ul>

<p>これにより、例えばストリーミングを簡単に実装することができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Stream</span>
  <span class="k">def</span> <span class="nf">each</span>
    <span class="mi">100</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="k">yield</span> <span class="s2">"</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="no">Stream</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
</code></pre>
</div>

<p>後述する<code class="highlighter-rouge">stream</code>ヘルパーメソッドを使って、定型パターンを減らしつつストリーミングロジックをルーティングに埋め込むこともできます。</p>

<h2>カスタムルーティングマッチャー(Custom Route Matchers)</h2>

<p>先述のようにSinatraはルーティングマッチャーとして、文字列パターンと正規表現を使うことをビルトインでサポートしています。しかしこれに留まらず、独自のマッチャーを簡単に定義することもできるのです。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">AllButPattern</span>
  <span class="nc">Match</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:captures</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">except</span><span class="p">)</span>
    <span class="vi">@except</span>   <span class="o">=</span> <span class="n">except</span>
    <span class="vi">@captures</span> <span class="o">=</span> <span class="no">Match</span><span class="p">.</span><span class="nf">new</span><span class="p">([])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="vi">@captures</span> <span class="k">unless</span> <span class="vi">@except</span> <span class="o">===</span> <span class="n">str</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">all_but</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
  <span class="no">AllButPattern</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="n">all_but</span><span class="p">(</span><span class="s2">"/index"</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ノート: この例はオーバースペックであり、以下のようにも書くことができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">//</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">==</span> <span class="s2">"/index"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>または、否定先読みを使って:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{(?!/index)}</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>静的ファイル(Static Files)</h2>

<p>静的ファイルは<code class="highlighter-rouge">./public</code>ディレクトリから配信されます。
<code class="highlighter-rouge">:public_folder</code>オプションを指定することで別の場所を指定することができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:public_folder</span><span class="p">,</span> <span class="n">__dir__</span> <span class="o">+</span> <span class="s1">'/static'</span>
</code></pre>
</div>

<p>ノート: この静的ファイル用のディレクトリ名はURL中に含まれません。
例えば、<code class="highlighter-rouge">./public/css/style.css</code>は<code class="highlighter-rouge">http://example.com/css/style.css</code>でアクセスできます。</p>

<p><code class="highlighter-rouge">Cache-Control</code>の設定をヘッダーへ追加するには<code class="highlighter-rouge">:static_cache_control</code>の設定(下記参照)を加えてください。</p>

<h2>ビュー / テンプレート(Views / Templates)</h2>

<p>各テンプレート言語はそれ自身のレンダリングメソッドを通して展開されます。それらのメソッドは単に文字列を返します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これは、<code class="highlighter-rouge">views/index.erb</code>をレンダリングします。</p>

<p>テンプレート名を渡す代わりに、直接そのテンプレートの中身を渡すこともできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">code</span> <span class="o">=</span> <span class="s2">"&lt;%= Time.now %&gt;"</span>
  <span class="n">erb</span> <span class="n">code</span>
<span class="k">end</span>
</code></pre>
</div>

<p>テンプレートのレイアウトは第２引数のハッシュ形式のオプションをもとに表示されます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:post</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これは、<code class="highlighter-rouge">views/post.erb</code>内に埋め込まれた<code class="highlighter-rouge">views/index.erb</code>をレンダリングします（デフォルトは<code class="highlighter-rouge">views/layout.erb</code>があればそれになります）。</p>

<p>Sinatraが理解できないオプションは、テンプレートエンジンに渡されることになります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:html5</span>
<span class="k">end</span>
</code></pre>
</div>

<p>テンプレート言語ごとにオプションをセットすることもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:haml</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:html5</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>レンダリングメソッドに渡されたオプションは<code class="highlighter-rouge">set</code>で設定されたオプションを上書きします。</p>

<p>利用可能なオプション:</p>

<dl>
  <dt>locals</dt>
  <dd>
    ドキュメントに渡されるローカルのリスト。パーシャルに便利。
    例: <tt>erb "&lt;%= foo %&gt;", :locals =&gt; {:foo =&gt; "bar"}</tt>
  </dd>

  <dt>default_encoding</dt>
  <dd>
    文字エンコーディングが確実でない場合に指定。デフォルトは、<tt>settings.default_encoding</tt>。
  </dd>

  <dt>views</dt>
  <dd>
    テンプレートを読み出すビューのディレクトリ。デフォルトは、<tt>settings.views</tt>。
  </dd>

  <dt>layout</dt>
  <dd>
    レイアウトを使うかの指定(<tt>true</tt> または <tt>false</tt>)。値がシンボルの場合は、使用するテンプレートが指定される。例: <tt>erb :index, :layout =&gt; !request.xhr?</tt>
  </dd>

  <dt>content_type</dt>
  <dd>
    テンプレートが生成するContent-Type。デフォルトはテンプレート言語ごとに異なる。
  </dd>

  <dt>scope</dt>
  <dd>
    テンプレートをレンダリングするときのスコープ。デフォルトは、アプリケーションのインスタンス。これを変更した場合、インスタンス変数およびヘルパーメソッドが利用できなくなる。
  </dd>

  <dt>layout_engine</dt>
  <dd>
    レイアウトをレンダリングするために使用するテンプレートエンジン。レイアウトをサポートしない言語で有用。デフォルトはテンプレートに使われるエンジン。例: <tt>set :rdoc, :layout_engine =&gt; :erb</tt>
  </dd>

  <dt>layout_options</dt>
  <dd>
    レイアウトをレンダリングするときだけに使う特別なオプション。例:
    <tt>set :rdoc, :layout_options =&gt; { :views =&gt; 'views/layouts' }</tt>
  </dd>
</dl>

<p>テンプレートは<code class="highlighter-rouge">./views</code>ディレクトリ下に配置されています。
他のディレクトリを使用する場合の例:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="nf">root</span> <span class="o">+</span> <span class="s1">'/templates'</span>
</code></pre>
</div>

<p>テンプレートの参照は、テンプレートがサブディレクトリ内にある場合でも常にシンボルで指定することを覚えておいてください。
（これは<code class="highlighter-rouge">:'subdir/template'</code>または<code class="highlighter-rouge">'subdir/template'.to_sym</code>のように指定することを意味します。）
レンダリングメソッドにシンボルではなく文字列を渡してしまうと、そのまま文字列として出力してしまいます。</p>

<h3>リテラルテンプレート(Literal Templates)</h3>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Hello World'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これはテンプレート文字列をレンダリングしています。
テンプレート文字列に関連するファイルパスや行数を<code class="highlighter-rouge">:path</code>や<code class="highlighter-rouge">:line</code>オプションで指定することで、バックトレースを明確にすることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Hello World'</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">'examples/file.haml'</span><span class="p">,</span> <span class="ss">:line</span> <span class="o">=&gt;</span> <span class="mi">3</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>利用可能なテンプレート言語</h3>

<p>いくつかの言語には複数の実装があります。使用する（そしてスレッドセーフにする）実装を指定するには、それを最初にrequireしてください。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rdiscount'</span> <span class="c1"># または require 'bluecloth'</span>
<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="n">markdown</span> <span class="ss">:index</span> <span class="p">}</span>
</code></pre>
</div>

<h4>Haml テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://haml.info/" title="haml">haml</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.haml</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>haml :index, :format =&gt; :html5</tt></td>
  </tr>
</table>

<h4>Erb テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="https://github.com/jeremyevans/erubi" title="erubi">erubi</a>
      または <a href="http://www.kuwata-lab.com/erubis/" title="erubis">erubis</a>
      または erb (Rubyに同梱)
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td>
<tt>.erb</tt>, <tt>.rhtml</tt> または <tt>.erubi</tt> (Erubiだけ) または<tt>.erubis</tt> (Erubisだけ)</td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>erb :index</tt></td>
  </tr>
</table>

<h4>Builder テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="https://github.com/jimweirich/builder" title="builder">builder</a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.builder</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>builder { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>

<p>インラインテンプレート用にブロックを取ることもできます（例を参照）。</p>

<h4>Nokogiri テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://www.nokogiri.org/" title="nokogiri">nokogiri</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.nokogiri</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>nokogiri { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>

<p>インラインテンプレート用にブロックを取ることもできます（例を参照）。</p>

<h4>Sass テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.sass</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>sass :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>

<h4>Scss テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.scss</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>scss :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>

<h4>Less テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://lesscss.org/" title="less">less</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.less</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>less :stylesheet</tt></td>
  </tr>
</table>

<h4>Liquid テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://shopify.github.io/liquid/" title="liquid">liquid</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.liquid</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>liquid :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>LiquidテンプレートからRubyのメソッド(<code class="highlighter-rouge">yield</code>を除く)を呼び出すことができないため、ほぼ全ての場合にlocalsを指定する必要があるでしょう。</p>

<h4>Markdown テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      次の何れか:
        <a href="https://github.com/davidfstr/rdiscount" title="RDiscount">RDiscount</a>,
        <a href="https://github.com/vmg/redcarpet" title="RedCarpet">RedCarpet</a>,
        <a href="https://github.com/ged/bluecloth" title="bluecloth">BlueCloth</a>,
        <a href="https://kramdown.gettalong.org/" title="kramdown">kramdown</a>,
        <a href="https://github.com/bhollis/maruku" title="maruku">maruku</a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td>
<tt>.markdown</tt>, <tt>.mkd</tt> and <tt>.md</tt>
</td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>markdown :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Markdownからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>ノート: 他のテンプレート内で<code class="highlighter-rouge">markdown</code>メソッドを呼び出せます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Hello</span> <span class="no">From</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:greetings</span><span class="p">)</span>
</code></pre>
</div>

<p>MarkdownからはRubyを呼ぶことができないので、Markdownで書かれたレイアウトを使うことはできません。しかしながら、<code class="highlighter-rouge">:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>Textile テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://redcloth.org/" title="RedCloth">RedCloth</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.textile</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>textile :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Textileからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>ノート: 他のテンプレート内で<code class="highlighter-rouge">textile</code>メソッドを呼び出せます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Hello</span> <span class="no">From</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:greetings</span><span class="p">)</span>
</code></pre>
</div>

<p>TexttileからはRubyを呼ぶことができないので、Textileで書かれたレイアウトを使うことはできません。しかしながら、<code class="highlighter-rouge">:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>RDoc テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://rdoc.sourceforge.net/" title="RDoc">RDoc</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.rdoc</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>rdoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>RDocからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>ノート: 他のテンプレート内で<code class="highlighter-rouge">rdoc</code>メソッドを呼び出せます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Hello</span> <span class="no">From</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:greetings</span><span class="p">)</span>
</code></pre>
</div>

<p>RDocからはRubyを呼ぶことができないので、RDocで書かれたレイアウトを使うことはできません。しかしながら、<code class="highlighter-rouge">:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>AsciiDoc テンプレート</h4>

<table>
 <tr>
   <td>依存</td>
   <td><a href="https://asciidoctor.org/" title="Asciidoctor">Asciidoctor</a></td>
 </tr>
 <tr>
   <td>ファイル拡張子</td>
   <td>
<tt>.asciidoc</tt>, <tt>.adoc</tt> and <tt>.ad</tt>
</td>
 </tr>
 <tr>
   <td>例</td>
   <td><tt>asciidoc :README, :layout_engine =&gt; :erb</tt></td>
 </tr>
</table>

<p>AsciiDocテンプレートからRubyのメソッドを直接呼び出すことができないため、ほぼ全ての場合にlocalsを指定する必要があるでしょう。</p>

<h4>Radius テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/jlong/radius" title="Radius">Radius</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.radius</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>radius :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>RadiusテンプレートからRubyのメソッドを直接呼び出すことができないため、ほぼ全ての場合にlocalsを指定する必要があるでしょう。</p>

<h4>Markaby テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://markaby.github.io/" title="Markaby">Markaby</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.mab</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>markaby { h1 "Welcome!" }</tt></td>
  </tr>
</table>

<p>インラインテンプレート用にブロックを取ることもできます（例を参照）。</p>

<h4>RABL テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/nesquena/rabl" title="Rabl">Rabl</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.rabl</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>rabl :index</tt></td>
  </tr>
</table>

<h4>Slim テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="http://slim-lang.com/" title="Slim Lang">Slim Lang</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.slim</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>slim :index</tt></td>
  </tr>
</table>

<h4>Creole テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/minad/creole" title="Creole">Creole</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.creole</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>creole :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Creoleからメソッドを呼び出すことも、localsに変数を渡すこともできません。
それゆえ、他のレンダリングエンジンとの組み合わせで使うのが普通です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">creole</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>ノート: 他のテンプレート内で<code class="highlighter-rouge">creole</code>メソッドを呼び出せます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Hello</span> <span class="no">From</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">creole</span><span class="p">(</span><span class="ss">:greetings</span><span class="p">)</span>
</code></pre>
</div>

<p>CreoleからはRubyを呼ぶことができないので、Creoleで書かれたレイアウトを使うことはできません。しかしながら、<code class="highlighter-rouge">:layout_engine</code>オプションを渡すことでテンプレートのものとは異なるレンダリングエンジンをレイアウトのために使うことができます。</p>

<h4>MediaWiki テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/nricciar/wikicloth" title="WikiCloth">WikiCloth</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td>
<tt>.mediawiki</tt> および <tt>.mw</tt>
</td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>mediawiki :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>MediaWikiのテンプレートは直接メソッドから呼び出したり、ローカル変数を通すことはできません。それゆえに、通常は別のレンダリングエンジンと組み合わせて利用します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">mediawiki</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>ノート: 他のテンプレートから部分的に<code class="highlighter-rouge">mediawiki</code>メソッドを呼び出すことも可能です。</p>

<h4>CoffeeScript テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="https://github.com/josh/ruby-coffee-script" title="Ruby CoffeeScript">
        CoffeeScript
      </a> および
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        JavaScriptの起動方法
      </a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.coffee</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>coffee :index</tt></td>
  </tr>
</table>

<h4>Stylus テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td>
      <a href="https://github.com/forgecrafted/ruby-stylus" title="Ruby Stylus">
        Stylus
      </a> および
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        JavaScriptの起動方法
      </a>
    </td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.styl</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>stylus :index</tt></td>
  </tr>
</table>

<p>Stylusテンプレートを使えるようにする前に、まず<code class="highlighter-rouge">stylus</code>と<code class="highlighter-rouge">stylus/tilt</code>を読み込む必要があります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'stylus'</span>
<span class="nb">require</span> <span class="s1">'stylus/tilt'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stylus</span> <span class="ss">:example</span>
<span class="k">end</span>
</code></pre>
</div>

<h4>Yajl テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/brianmario/yajl-ruby" title="yajl-ruby">yajl-ruby</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.yajl</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td>
      <tt>
        yajl :index,
             :locals =&gt; { :key =&gt; 'qux' },
             :callback =&gt; 'present',
             :variable =&gt; 'resource'
      </tt>
    </td>
  </tr>
</table>

<p>テンプレートのソースはRubyの文字列として評価され、その結果のJSON変数は<code class="highlighter-rouge">#to_json</code>を使って変換されます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">json</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span> <span class="p">}</span>
<span class="n">json</span><span class="p">[</span><span class="ss">:baz</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">:callback</code>および<code class="highlighter-rouge">:variable</code>オプションは、レンダリングされたオブジェクトを装飾するために使うことができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">var</span> <span class="n">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"foo"</span><span class="ss">:"bar"</span><span class="p">,</span><span class="s2">"baz"</span><span class="ss">:"qux"</span><span class="p">};</span> <span class="n">present</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span>
</code></pre>
</div>

<h4>WLang テンプレート</h4>

<table>
  <tr>
    <td>依存</td>
    <td><a href="https://github.com/blambeau/wlang/" title="wlang">wlang</a></td>
  </tr>
  <tr>
    <td>ファイル拡張子</td>
    <td><tt>.wlang</tt></td>
  </tr>
  <tr>
    <td>例</td>
    <td><tt>wlang :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>WLang内でのRubyメソッドの呼び出しは一般的ではないので、ほとんどの場合にlocalsを指定する必要があるでしょう。しかしながら、WLangで書かれたレイアウトは<code class="highlighter-rouge">yield</code>をサポートしています。</p>

<h3>テンプレート内での変数へのアクセス</h3>

<p>テンプレートはルーティングハンドラと同じコンテキストの中で評価されます。ルーティングハンドラでセットされたインスタンス変数はテンプレート内で直接使うことができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="vi">@foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= @foo.name'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>また、ローカル変数のハッシュで明示的に指定することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= bar.name'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:bar</span> <span class="o">=&gt;</span> <span class="n">foo</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これは他のテンプレート内で部分テンプレートとして表示する典型的な手法です。</p>

<h3>
<code class="highlighter-rouge">yield</code>を伴うテンプレートとネストしたレイアウト</h3>

<p>レイアウトは通常、<code class="highlighter-rouge">yield</code>を呼ぶ単なるテンプレートに過ぎません。
そのようなテンプレートは、既に説明した<code class="highlighter-rouge">:template</code>オプションを通して使われるか、または次のようなブロックを伴ってレンダリングされます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>このコードは、<code class="highlighter-rouge">erb :index, :layout =&gt; :post</code>とほぼ等価です。</p>

<p>レンダリングメソッドにブロックを渡すスタイルは、ネストしたレイアウトを作るために最も役立ちます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:main_layout</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:admin_layout</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これはまた次のより短いコードでも達成できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:admin_layout</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:main_layout</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:user</span>
<span class="k">end</span>
</code></pre>
</div>

<p>現在、次のレンダリングメソッドがブロックを取れます: <code class="highlighter-rouge">erb</code>, <code class="highlighter-rouge">haml</code>,
<code class="highlighter-rouge">liquid</code>, <code class="highlighter-rouge">slim </code>, <code class="highlighter-rouge">wlang</code>。
また汎用の<code class="highlighter-rouge">render</code>メソッドもブロックを取れます。</p>

<h3>インラインテンプレート(Inline Templates)</h3>

<p>テンプレートはソースファイルの最後で定義することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="cp">__END__

@@ layout
%html
  = yield

@@ index
%div.title Hello world!!!!!
</span></code></pre>
</div>

<p>ノート: Sinatraをrequireするソースファイル内で定義されたインラインテンプレートは自動的に読み込まれます。他のソースファイル内にインラインテンプレートがある場合には<code class="highlighter-rouge">enable :inline_templates</code>を明示的に呼んでください。</p>

<h3>名前付きテンプレート(Named Templates)</h3>

<p>テンプレートはトップレベルの<code class="highlighter-rouge">template</code>メソッドで定義することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">template</span> <span class="ss">:layout</span> <span class="k">do</span>
  <span class="s2">"%html</span><span class="se">\n</span><span class="s2">  =yield</span><span class="se">\n</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">template</span> <span class="ss">:index</span> <span class="k">do</span>
  <span class="s1">'%div.title Hello World!'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>「layout」という名前のテンプレートが存在する場合は、そのテンプレートファイルは他のテンプレートがレンダリングされる度に使用されます。<code class="highlighter-rouge">:layout =&gt; false</code>で個別に、または<code class="highlighter-rouge">set :haml, :layout =&gt; false</code>でデフォルトとして、レイアウトを無効にすることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>ファイル拡張子の関連付け</h3>

<p>任意のテンプレートエンジンにファイル拡張子を関連付ける場合は、<code class="highlighter-rouge">Tilt.register</code>を使います。例えば、Textileテンプレートに<code class="highlighter-rouge">tt</code>というファイル拡張子を使いたい場合は、以下のようにします。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:tt</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:textile</span><span class="p">]</span>
</code></pre>
</div>

<h3>オリジナルテンプレートエンジンの追加</h3>

<p>まず、Tiltでそのエンジンを登録し、次にレンダリングメソッドを作ります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:myat</span><span class="p">,</span> <span class="no">MyAwesomeTemplateEngine</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">myat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="n">render</span><span class="p">(</span><span class="ss">:myat</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">myat</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これは、<code class="highlighter-rouge">./views/index.myat</code>をレンダリングします。Tiltについての詳細は、https://github.com/rtomayko/tilt を参照してください。</p>

<h3>カスタムロジックを使用したテンプレートの探索</h3>

<p>オリジナルテンプレートの検索メカニズムを実装するためには、<code class="highlighter-rouge">#find_template</code>メソッドを実装します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:views</span> <span class="p">[</span> <span class="s1">'./views/a'</span><span class="p">,</span> <span class="s1">'./views/b'</span> <span class="p">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="no">Array</span><span class="p">(</span><span class="n">views</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
    <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>フィルタ(Filters)</h2>

<p>beforeフィルタは、リクエストのルーティングと同じコンテキストで各リクエストの前に評価され、それによってリクエストとレスポンスを変更可能にします。フィルタ内でセットされたインスタンス変数はルーティングとテンプレートからアクセスすることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@note</span> <span class="o">=</span> <span class="s1">'Hi!'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s1">'/foo/bar/baz'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/foo/*'</span> <span class="k">do</span>
  <span class="vi">@note</span> <span class="c1">#=&gt; 'Hi!'</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1">#=&gt; 'bar/baz'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>afterフィルタは、リクエストのルーティングと同じコンテキストで各リクエストの後に評価され、それによってこれもリクエストとレスポンスを変更可能にします。beforeフィルタとルーティング内でセットされたインスタンス変数はafterフィルタからアクセスすることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">status</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ノート: <code class="highlighter-rouge">body</code>メソッドを使わずにルーティングから文字列を返すだけの場合、その内容はafterフィルタでまだ利用できず、その後に生成されることになります。</p>

<p>フィルタにはオプションとしてパターンを渡すことができ、この場合はリクエストのパスがパターンにマッチした場合にのみフィルタが評価されるようになります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="s1">'/protected/*'</span> <span class="k">do</span>
  <span class="n">authenticate!</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/create/:slug'</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="o">|</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:last_slug</span><span class="p">]</span> <span class="o">=</span> <span class="n">slug</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ルーティング同様、フィルタもまた条件を取ることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird/</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/blog/*'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="s1">'example.com'</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>ヘルパー(Helpers)</h2>

<p>トップレベルの<code class="highlighter-rouge">helpers</code>メソッドを使用してルーティングハンドラやテンプレートで使うヘルパーメソッドを定義できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">bar"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:name'</span> <span class="k">do</span>
  <span class="n">bar</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>
</div>

<p>あるいは、ヘルパーメソッドをモジュール内で個別に定義することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">module</span> <span class="nn">FooUtils</span>
  <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">foo"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">BarUtils</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">bar"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">helpers</span> <span class="no">FooUtils</span><span class="p">,</span> <span class="no">BarUtils</span>
</code></pre>
</div>

<p>その効果は、アプリケーションクラスにモジュールをインクルードするのと同じです。</p>

<h3>セッションの使用</h3>

<p>セッションはリクエスト間での状態維持のために使用されます。セッションを有効化すると、ユーザセッションごとに一つのセッションハッシュが与えられます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s2">"value = "</span> <span class="o">&lt;&lt;</span> <span class="n">session</span><span class="p">[</span><span class="ss">:value</span><span class="p">].</span><span class="nf">inspect</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:value'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:value</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ノート: <code class="highlighter-rouge">enable :sessions</code>は実際にはすべてのデータをクッキーに保持します。これは必ずしも期待通りのものにならないかもしれません（例えば、大量のデータを保持することでトラフィックが増大するなど）。Rackセッションミドルウェアの利用が可能であり、その場合は<code class="highlighter-rouge">enable :sessions</code>を呼ばずに、選択したミドルウェアを他のミドルウェアのときと同じようにして取り込んでください。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s2">"value = "</span> <span class="o">&lt;&lt;</span> <span class="n">session</span><span class="p">[</span><span class="ss">:value</span><span class="p">].</span><span class="nf">inspect</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:value'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:value</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>セキュリティ向上のため、クッキー内のセッションデータはセッション秘密鍵(session secret)で署名されます。Sinatraによりランダムな秘密鍵が個別に生成されます。しかし、この秘密鍵はアプリケーションの立ち上げごとに変わってしまうので、すべてのアプリケーションのインスタンスで共有できる秘密鍵をセットしたくなるかもしれません。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:session_secret</span><span class="p">,</span> <span class="s1">'super secret'</span>
</code></pre>
</div>

<p>更に、設定変更をしたい場合は、<code class="highlighter-rouge">sessions</code>の設定においてオプションハッシュを保持することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'foo.com'</span>
</code></pre>
</div>

<p>foo.comのサブドメイン上のアプリ間でセッションを共有化したいときは、代わりにドメインの前に <em>.</em> を付けます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'.foo.com'</span>
</code></pre>
</div>

<h4>セッションミドルウェアの選択</h4>

<p><code class="highlighter-rouge">enable :sessions</code>とすることで、クッキー内の全てのデータを実際に保存してしまうことに注意してください。
これは、あなたが望む挙動ではない（例えば、大量のデータを保存することでトラフィックが増大してしまう）かもしれません。
あなたは、次のいずれかの方法によって、任意のRackセッションミドルウェアを使用することができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>
<span class="n">set</span> <span class="ss">:session_store</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
</code></pre>
</div>

<p>オプションのハッシュを設定するためには、次のようにします。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>
<span class="n">set</span> <span class="ss">:session_store</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
</code></pre>
</div>

<p>他の方法は<code class="highlighter-rouge">enable :sessions</code>を<strong>しない</strong>で、他のミドルウェアの選択と同様にあなた自身でミドルウェアを選択することです。</p>

<p>この方法を選択する場合は、セッションベースの保護は<strong>デフォルトで有効にならない</strong>ということに注意することが重要です。</p>

<p>これを満たすためのRackミドルウェアを追加することが必要になります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Protection</span><span class="o">::</span><span class="no">RemoteToken</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Protection</span><span class="o">::</span><span class="no">SessionHijacking</span>
</code></pre>
</div>

<p>より詳しい情報は、「攻撃防御に対する設定」の項を参照してください。</p>

<h3>停止(Halting)</h3>

<p>フィルタまたはルーティング内で直ちにリクエストを止める場合</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span>
</code></pre>
</div>

<p>この際、ステータスを指定することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">410</span>
</code></pre>
</div>

<p>body部を指定することも、</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="s1">'ここにbodyを書く'</span>
</code></pre>
</div>

<p>ステータスとbody部を指定することも、</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">'立ち去れ!'</span>
</code></pre>
</div>

<p>ヘッダを付けることもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">402</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/plain'</span><span class="p">},</span> <span class="s1">'リベンジ'</span>
</code></pre>
</div>

<p>もちろん、テンプレートを<code class="highlighter-rouge">halt</code>に結びつけることも可能です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="n">erb</span><span class="p">(</span><span class="ss">:error</span><span class="p">)</span>
</code></pre>
</div>

<h3>パッシング(Passing)</h3>

<p>ルーティングは<code class="highlighter-rouge">pass</code>を使って次のルーティングに飛ばすことができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/guess/:who'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">unless</span> <span class="n">params</span><span class="p">[</span><span class="s1">'who'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Frank'</span>
  <span class="s2">"見つかっちゃった!"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/guess/*'</span> <span class="k">do</span>
  <span class="s2">"はずれです!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ルーティングブロックからすぐに抜け出し、次にマッチするルーティングを実行します。マッチするルーティングが見当たらない場合は404が返されます。</p>

<h3>別ルーティングの誘発</h3>

<p><code class="highlighter-rouge">pass</code>を使ってルーティングを飛ばすのではなく、他のルーティングを呼んだ結果を得たいという場合があります。
これは<code class="highlighter-rouge">call</code>を使用することで実現できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">call</span> <span class="n">env</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="s2">"PATH_INFO"</span> <span class="o">=&gt;</span> <span class="s1">'/bar'</span><span class="p">)</span>
  <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:upcase</span><span class="p">)]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="s2">"bar"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ノート: 先の例において、テストを楽にしパフォーマンスを改善するには、<code class="highlighter-rouge">"bar"</code>を単にヘルパーに移し、<code class="highlighter-rouge">/foo</code>および<code class="highlighter-rouge">/bar</code>から使えるようにしたほうが良いです。</p>

<p>リクエストが、その複製物でない同じアプリケーションのインスタンスに送られるようにしたいときは、<code class="highlighter-rouge">call</code>に代えて<code class="highlighter-rouge">call!</code>を使ってください。</p>

<p><code class="highlighter-rouge">call</code>についての詳細はRackの仕様を参照してください。</p>

<h3>ボディ、ステータスコードおよびヘッダの設定</h3>

<p>ステータスコードおよびレスポンスボディを、ルーティングブロックの戻り値にセットすることが可能であり、これは推奨されています。しかし、あるケースでは実行フローの任意のタイミングでボディをセットしたくなるかもしれません。<code class="highlighter-rouge">body</code>ヘルパーメソッドを使えばそれができます。そうすると、それ以降、ボディにアクセスするためにそのメソッドを使うことができるようになります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">body</span> <span class="s2">"bar"</span>
<span class="k">end</span>

<span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">body</span>
<span class="k">end</span>
</code></pre>
</div>

<p>また、<code class="highlighter-rouge">body</code>にはブロックを渡すことができ、これはRackハンドラにより実行されることになります(これはストリーミングを実装するのに使われます。”戻り値”の項を参照してください。)</p>

<p>ボディと同様に、ステータスコードおよびヘッダもセットできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span> <span class="mi">418</span>
  <span class="n">headers</span> <span class="p">\</span>
    <span class="s2">"Allow"</span>   <span class="o">=&gt;</span> <span class="s2">"BREW, POST, GET, PROPFIND, WHEN"</span><span class="p">,</span>
    <span class="s2">"Refresh"</span> <span class="o">=&gt;</span> <span class="s2">"Refresh: 20; https://www.ietf.org/rfc/rfc2324.txt"</span>
  <span class="n">body</span> <span class="s2">"I'm a tea pot!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>引数を伴わない<code class="highlighter-rouge">body</code>、<code class="highlighter-rouge">headers</code>、<code class="highlighter-rouge">status</code>などは、それらの現在の値にアクセスするために使えます。</p>

<h3>ストリーミングレスポンス(Streaming Responses)</h3>

<p>レスポンスボディの部分を未だ生成している段階で、データを送り出したいということがあります。極端な例では、クライアントがコネクションを閉じるまでデータを送り続けたいことがあります。<code class="highlighter-rouge">stream</code>ヘルパーを使えば、独自ラッパーを作る必要はありません。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stream</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"それは伝 -</span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">" (少し待つ) </span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"- 説になる！</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これはストリーミングAPI、<a href="https://w3c.github.io/eventsource/">Server Sent Events</a>の実装を可能にし、<a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>の土台に使うことができます。また、一部のコンテンツが遅いリソースに依存しているときに、スループットを上げるために使うこともできます。</p>

<p>ノート: ストリーミングの挙動、特に並行リクエスト(cuncurrent requests)の数は、アプリケーションを提供するのに使われるWebサーバに強く依存します。いくつかのサーバは、ストリーミングを全くサポートしません。サーバがストリーミングをサポートしない場合、ボディは<code class="highlighter-rouge">stream</code>に渡されたブロックの実行が終了した後、一度に全部送られることになります。ストリーミングは、Shotgunを使った場合は全く動作しません。</p>

<p>オプション引数が<code class="highlighter-rouge">keep_open</code>にセットされている場合、ストリームオブジェクト上で<code class="highlighter-rouge">close</code>は呼ばれず、実行フローの任意の遅れたタイミングでユーザがこれを閉じることを可能にします。これはThinやRainbowsのようなイベント型サーバ上でしか機能しません。他のサーバでは依然ストリームは閉じられます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># ロングポーリング</span>

<span class="n">set</span> <span class="ss">:server</span><span class="p">,</span> <span class="ss">:thin</span>
<span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">get</span> <span class="s1">'/subscribe'</span> <span class="k">do</span>
  <span class="c1"># サーバイベントにおけるクライアントの関心を登録</span>
  <span class="n">stream</span><span class="p">(</span><span class="ss">:keep_open</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">connections</span> <span class="o">&lt;&lt;</span> <span class="n">out</span>
    <span class="c1"># 死んでいるコネクションを排除</span>
    <span class="n">connections</span><span class="p">.</span><span class="nf">reject!</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:closed?</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/message'</span> <span class="k">do</span>
  <span class="n">connections</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="c1"># クライアントへ新規メッセージ到着の通知</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>

    <span class="c1"># クライアントへの再接続の指示</span>
    <span class="n">out</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>

  <span class="c1"># 肯定応答</span>
  <span class="s2">"message received"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>クライアントはソケットに書き込もうとしている接続を閉じることも可能です。そのため、記述しようとする前に<code class="highlighter-rouge">out.closed?</code>をチェックすることを勧めます。</p>

<h3>ロギング(Logging)</h3>

<p>リクエストスコープにおいて、<code class="highlighter-rouge">logger</code>ヘルパーは<code class="highlighter-rouge">Logger</code>インスタンスを作り出します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"loading data"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>このロガーは、自動でRackハンドラのロギング設定を参照します。ロギングが無効(disabled)にされている場合、このメソッドはダミーオブジェクトを返すので、ルーティングやフィルタにおいて特に心配することはありません。</p>

<p>ノート: ロギングは、<code class="highlighter-rouge">Sinatra::Application</code>に対してのみデフォルトで有効にされているので、<code class="highlighter-rouge">Sinatra::Base</code>を継承している場合は、ユーザがこれを有効化する必要があります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
    <span class="n">enable</span> <span class="ss">:logging</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ロギングミドルウェアが設定されてしまうのを避けるには、<code class="highlighter-rouge">logging</code>設定を<code class="highlighter-rouge">nil</code>にセットします。しかしこの場合、<code class="highlighter-rouge">logger</code>が<code class="highlighter-rouge">nil</code>を返すことを忘れないように。よくあるユースケースは、オリジナルのロガーをセットしたいときです。Sinatraは、とにかく<code class="highlighter-rouge">env['rack.logger']</code>で見つかるものを使います。</p>

<h3>MIMEタイプ(Mime Types)</h3>

<p><code class="highlighter-rouge">send_file</code>か静的ファイルを使う時、SinatraがMIMEタイプを理解できない場合があります。その時は <code class="highlighter-rouge">mime_type</code> を使ってファイル拡張子毎に登録してください。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">mime_type</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'text/foo'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これは<code class="highlighter-rouge">content_type</code>ヘルパーで利用することができます:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:foo</span>
  <span class="s2">"foo foo foo"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>URLの生成</h3>

<p>URLを生成するためには<code class="highlighter-rouge">url</code>ヘルパーメソッドが使えます。Hamlではこのようにします。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">a</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s1">'/foo'</span><span class="p">)}</span> <span class="n">foo</span>
</code></pre>
</div>

<p>これはリバースプロキシおよびRackルーティングを、それらがあれば考慮に入れます。</p>

<p>このメソッドには<code class="highlighter-rouge">to</code>というエイリアスがあります(以下の例を参照)。</p>

<h3>ブラウザリダイレクト(Browser Redirect)</h3>

<p><code class="highlighter-rouge">redirect</code> ヘルパーメソッドを使うことで、ブラウザをリダイレクトさせることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>他に追加されるパラメータは、<code class="highlighter-rouge">halt</code>に渡される引数と同様に取り扱われます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">),</span> <span class="mi">303</span>
<span class="n">redirect</span> <span class="s1">'https://www.google.com/'</span><span class="p">,</span> <span class="s1">'wrong place, buddy'</span>
</code></pre>
</div>

<p>また、<code class="highlighter-rouge">redirect back</code>を使えば、簡単にユーザが来たページへ戻るリダイレクトを作れます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="s2">"&lt;a href='/bar'&gt;do something&lt;/a&gt;"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">do_something</span>
  <span class="n">redirect</span> <span class="n">back</span>
<span class="k">end</span>
</code></pre>
</div>

<p>redirectに引数を渡すには、それをクエリーに追加するか、</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar?sum=42'</span><span class="p">)</span>
</code></pre>
</div>

<p>または、セッションを使います。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'foo'</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>キャッシュ制御(Cache Control)</h3>

<p>ヘッダを正しく設定することが、適切なHTTPキャッシングのための基礎となります。</p>

<p>キャッシュ制御ヘッダ(Cache-Control header)は、次のように簡単に設定できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span>
  <span class="s2">"キャッシュしました!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ヒント: キャッシングをbeforeフィルタ内で設定します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">60</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">expires</code>ヘルパーを対応するヘッダに使っている場合は、キャッシュ制御は自動で設定されます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">expires</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span>
<span class="k">end</span>
</code></pre>
</div>

<p>キャッシュを適切に使うために、<code class="highlighter-rouge">etag</code>または<code class="highlighter-rouge">last_modified</code>を使うことを検討してください。これらのヘルパーを、重い仕事をさせる <em>前</em> に呼ぶことを推奨します。そうすれば、クライアントが既にキャッシュに最新版を持っている場合はレスポンスを直ちに破棄するようになります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/article/:id'</span> <span class="k">do</span>
  <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">find</span> <span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
  <span class="n">last_modified</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">updated_at</span>
  <span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span>
  <span class="n">erb</span> <span class="ss">:article</span>
<span class="k">end</span>
</code></pre>
</div>

<p>また、<a href="https://ja.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation">weak ETag</a>を使うこともできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span><span class="p">,</span> <span class="ss">:weak</span>
</code></pre>
</div>

<p>これらのヘルパーは、キャッシングをしてくれませんが、必要な情報をキャッシュに与えてくれます。もし手早いリバースプロキシキャッシングの解決策をお探しなら、 <a href="https://github.com/rtomayko/rack-cache">rack-cache</a>を試してください。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s2">"rack/cache"</span>
<span class="nb">require</span> <span class="s2">"sinatra"</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cache</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">36000</span>
  <span class="nb">sleep</span> <span class="mi">5</span>
  <span class="s2">"hello"</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">:static_cache_control</code>設定(以下を参照)を、キャッシュ制御ヘッダ情報を静的ファイルに追加するために使ってください。</p>

<p>RFC 2616によれば、アプリケーションは、If-MatchまたはIf-None-Matchヘッダが<code class="highlighter-rouge">*</code>に設定されている場合には、要求されたリソースが既に存在するか否かに応じて、異なる振る舞いをすべきとなっています。Sinatraは、getのような安全なリクエストおよびputのような冪等なリクエストは既に存在しているものとして仮定し、一方で、他のリソース(例えば、postリクエスト)は新たなリソースとして取り扱われるよう仮定します。この振る舞いは、<code class="highlighter-rouge">:new_resource</code>オプションを渡すことで変更できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/create'</span> <span class="k">do</span>
  <span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="no">Article</span><span class="p">.</span><span class="nf">create</span>
  <span class="n">erb</span> <span class="ss">:new_article</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ここでもWeak ETagを使いたい場合は、<code class="highlighter-rouge">:kind</code>オプションを渡してください。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="ss">:weak</span>
</code></pre>
</div>

<h3>ファイルの送信</h3>

<p>ファイルを送信するには、<code class="highlighter-rouge">send_file</code>ヘルパーメソッドを使います。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">send_file</span> <span class="s1">'foo.png'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これはオプションを取ることもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">send_file</span> <span class="s1">'foo.png'</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:jpg</span>
</code></pre>
</div>

<p>オプション一覧</p>

<dl>
  <dt>filename</dt>
    <dd>ファイル名。デフォルトは実際のファイル名。</dd>

  <dt>last_modified</dt>
    <dd>Last-Modifiedヘッダの値。デフォルトはファイルのmtime。</dd>

  <dt>type</dt>
    <dd>コンテンツの種類。設定がない場合、ファイル拡張子から類推される。</dd>

  <dt>disposition</dt>
    <dd>
      Content-Dispositionに使われる。許容値: <tt>nil</tt> (デフォルト)、
      <tt>:attachment</tt> および <tt>:inline</tt>
    </dd>

  <dt>length</dt>
    <dd>Content-Lengthヘッダ。デフォルトはファイルサイズ。</dd>

  <dt>status</dt>
    <dd>
      送られるステータスコード。静的ファイルをエラーページとして送るときに便利。

      Rackハンドラでサポートされている場合は、Rubyプロセスからのストリーミング以外の手段が使われる。このヘルパーメソッドを使うと、Sinatraは自動で範囲リクエスト(range requests)を扱う。
    </dd>
</dl>

<h3>リクエストオブジェクトへのアクセス</h3>

<p>受信するリクエストオブジェクトは、<code class="highlighter-rouge">request</code>メソッドを通じてリクエストレベル(フィルタ、ルーティング、エラーハンドラ)からアクセスすることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># アプリケーションが http://example.com/example で動作している場合</span>
<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">t</span> <span class="o">=</span> <span class="sx">%w[text/css text/html application/javascript]</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept</span>              <span class="c1"># ['text/html', '*/*']</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept?</span> <span class="s1">'text/xml'</span>  <span class="c1"># true</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">preferred_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>   <span class="c1"># 'text/html'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span>                <span class="c1"># クライアントによって送信されたリクエストボディ(下記参照)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">scheme</span>              <span class="c1"># "http"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">script_name</span>         <span class="c1"># "/example"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span>           <span class="c1"># "/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">port</span>                <span class="c1"># 80</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">request_method</span>      <span class="c1"># "GET"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">query_string</span>        <span class="c1"># ""</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">content_length</span>      <span class="c1"># request.bodyの長さ</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>          <span class="c1"># request.bodyのメディアタイプ</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">host</span>                <span class="c1"># "example.com"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">get?</span>                <span class="c1"># true (他の動詞にも同種メソッドあり)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">form_data?</span>          <span class="c1"># false</span>
  <span class="n">request</span><span class="p">[</span><span class="s2">"some_param"</span><span class="p">]</span>       <span class="c1"># some_param変数の値。[]はパラメータハッシュのショートカット</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">referrer</span>            <span class="c1"># クライアントのリファラまたは'/'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">user_agent</span>          <span class="c1"># ユーザエージェント (:agent 条件によって使用される)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">cookies</span>             <span class="c1"># ブラウザクッキーのハッシュ</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>                <span class="c1"># Ajaxリクエストかどうか</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">url</span>                 <span class="c1"># "http://example.com/example/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path</span>                <span class="c1"># "/example/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">ip</span>                  <span class="c1"># クライアントのIPアドレス</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">secure?</span>             <span class="c1"># false (sslではtrueになる)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">forwarded?</span>          <span class="c1"># true (リバースプロキシの裏で動いている場合)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">env</span>                 <span class="c1"># Rackによって渡された生のenvハッシュ</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">script_name</code>や<code class="highlighter-rouge">path_info</code>などのオプションは次のように利用することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s2">"/"</span> <span class="p">}</span>

<span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
  <span class="s2">"全てのリクエストはここに来る"</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">request.body</code>はIOまたはStringIOのオブジェクトです。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">post</span> <span class="s2">"/api"</span> <span class="k">do</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">rewind</span>  <span class="c1"># 既に読まれているときのため</span>
  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span>
  <span class="s2">"Hello </span><span class="si">#{</span><span class="n">data</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>アタッチメント(Attachments)</h3>

<p><code class="highlighter-rouge">attachment</code>ヘルパーを使って、レスポンスがブラウザに表示されるのではなく、ディスクに保存されることをブラウザに対し通知することができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span>
  <span class="s2">"保存しました!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ファイル名を渡すこともできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span> <span class="s2">"info.txt"</span>
  <span class="s2">"保存しました!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>日付と時刻の取り扱い</h3>

<p>Sinatraは<code class="highlighter-rouge">time_for</code>ヘルパーメソッドを提供しており、それは与えられた値からTimeオブジェクトを生成します。これはまた<code class="highlighter-rouge">DateTime</code>、<code class="highlighter-rouge">Date</code>および類似のクラスを変換できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">&gt;</span> <span class="n">time_for</span><span class="p">(</span><span class="s1">'Dec 23, 2012'</span><span class="p">)</span>
  <span class="s2">"まだ時間がある"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>このメソッドは、<code class="highlighter-rouge">expires</code>、<code class="highlighter-rouge">last_modified</code>といった種類のものの内部で使われています。そのため、アプリケーションにおいて、<code class="highlighter-rouge">time_for</code>をオーバーライドすることでそれらのメソッドの挙動を簡単に拡張できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">time_for</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">value</span>
    <span class="k">when</span> <span class="ss">:yesterday</span> <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">when</span> <span class="ss">:tomorrow</span>  <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">else</span> <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">last_modified</span> <span class="ss">:yesterday</span>
  <span class="n">expires</span> <span class="ss">:tomorrow</span>
  <span class="s2">"hello"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>テンプレートファイルの探索</h3>

<p><code class="highlighter-rouge">find_template</code>ヘルパーは、レンダリングのためのテンプレートファイルを見つけるために使われます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">find_template</span> <span class="n">settings</span><span class="p">.</span><span class="nf">views</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:haml</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"could be </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>この例はあまり有益ではありません。しかし、このメソッドを、独自の探索機構で働くようオーバーライドするなら有益になります。例えば、複数のビューディレクトリを使えるようにしたいときがあります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="p">[</span><span class="s1">'views'</span><span class="p">,</span> <span class="s1">'templates'</span><span class="p">]</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">Array</span><span class="p">(</span><span class="n">views</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>他の例としては、異なるエンジン用の異なるディレクトリを使う場合です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="ss">:sass</span> <span class="o">=&gt;</span> <span class="s1">'views/sass'</span><span class="p">,</span> <span class="ss">:haml</span> <span class="o">=&gt;</span> <span class="s1">'templates'</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">'views'</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">views</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">engine</span> <span class="o">==</span> <span class="no">Tilt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">folder</span> <span class="o">||=</span> <span class="n">views</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span>
    <span class="k">super</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これをエクステンションとして書いて、他の人と簡単に共有することもできます！</p>

<p>ノート: <code class="highlighter-rouge">find_template</code>はファイルが実際に存在するかのチェックをしませんが、与えられたブロックをすべての可能なパスに対し呼び出します。これがパフォーマンス上の問題にはならないのは、<code class="highlighter-rouge">render</code>はファイルを見つけると直ちに<code class="highlighter-rouge">break</code>を使うからです。また、テンプレートの場所（および内容）は、developmentモードでの起動でない限りはキャッシュされます。このことは、複雑なメソッド(a really crazy method)を書いた場合は記憶しておく必要があります。</p>

<h2>コンフィギュレーション(Configuration)</h2>

<p>どの環境でも起動時に１回だけ実行されます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="c1"># １つのオプションをセット</span>
  <span class="n">set</span> <span class="ss">:option</span><span class="p">,</span> <span class="s1">'value'</span>

  <span class="c1"># 複数のオプションをセット</span>
  <span class="n">set</span> <span class="ss">:a</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="mi">2</span>

  <span class="c1"># `set :option, true`と同じ</span>
  <span class="n">enable</span> <span class="ss">:option</span>

  <span class="c1"># `set :option, false`と同じ</span>
  <span class="n">disable</span> <span class="ss">:option</span>

  <span class="c1"># ブロックを使って動的な設定をすることもできます。</span>
  <span class="n">set</span><span class="p">(</span><span class="ss">:css_dir</span><span class="p">)</span> <span class="p">{</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s1">'css'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>環境設定(<code class="highlighter-rouge">APP_ENV</code>環境変数)が<code class="highlighter-rouge">:production</code>に設定されている時だけ実行する方法:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<p>環境設定が<code class="highlighter-rouge">:production</code>か<code class="highlighter-rouge">:test</code>に設定されている時だけ実行する方法:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<p>設定したオプションには<code class="highlighter-rouge">settings</code>からアクセスできます:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo?</span> <span class="c1"># =&gt; true</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo</span>  <span class="c1"># =&gt; 'bar'</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<h3>攻撃防御に対する設定</h3>

<p>Sinatraは<a href="https://github.com/sinatra/sinatra/tree/master/rack-protection#readme">Rack::Protection</a>を使用することで、アプリケーションを一般的な日和見的攻撃から守っています。これは簡単に無効化できます（が、アプリケーションに大量の一般的な脆弱性を埋め込むことになってしまいます）。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">disable</span> <span class="ss">:protection</span>
</code></pre>
</div>

<p>ある1つの防御を無効にするには、<code class="highlighter-rouge">protection</code>にハッシュでオプションを指定します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="ss">:path_traversal</span>
</code></pre>
</div>

<p>配列を渡すことで、複数の防御を無効にすることもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:path_traversal</span><span class="p">,</span> <span class="ss">:session_hijacking</span><span class="p">]</span>
</code></pre>
</div>

<p>デフォルトでSinatraは、<code class="highlighter-rouge">:sessions</code>が有効になっている場合、セッションベースの防御だけを設定します。しかし、自身でセッションを設定したい場合があります。その場合は、<code class="highlighter-rouge">:session</code>オプションを渡すことにより、セッションベースの防御を設定することができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
<span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>

<h3>利用可能な設定</h3>

<dl>
  <dt>absolute_redirects</dt>
  <dd>
    無効のとき、Sinatraは相対リダイレクトを許容するが、RFC 2616 (HTTP 1.1)は絶対リダイレクトのみを許容するので、これには準拠しなくなる。
  </dd>
  <dd>
    アプリケーションが、適切に設定されていないリバースプロキシの裏で走っている場合は有効。ノート: <tt>url</tt>ヘルパーは、第２引数に<tt>false</tt>を渡さない限り、依然として絶対URLを生成する。
  </dd>
  <dd>デフォルトは無効。</dd>

  <dt>add_charset</dt>
  <dd>
    Mimeタイプ <tt>content_type</tt>ヘルパーが自動的にキャラクタセット情報をここに追加する。このオプションは書き換えるのではなく、値を追加するようにすること。
    <tt>settings.add_charset &lt;&lt; "application/foobar"</tt>
  </dd>

  <dt>app_file</dt>
  <dd>
    メインのアプリケーションファイルのパスであり、プロジェクトのルート、viewsおよびpublicフォルダを見つけるために使われる。
  </dd>

  <dt>bind</dt>
  <dd>バインドするIPアドレス(デフォルト: `environment`がdevelopmentにセットされているときは、<tt>0.0.0.0</tt> <em>または</em> <tt>localhost</tt>)。ビルトインサーバでのみ使われる。</dd>

  <dt>default_encoding</dt>
  <dd>不明なときに仮定されるエンコーディング(デフォルトは<tt>"utf-8"</tt>)。</dd>

  <dt>dump_errors</dt>
  <dd>ログにおけるエラーの表示。</dd>

  <dt>environment</dt>
  <dd>
    現在の環境。デフォルトは<tt>ENV['APP_ENV']</tt>、それが無い場合は<tt>"development"</tt>。
  </dd>

  <dt>logging</dt>
  <dd>ロガーの使用。</dd>

  <dt>lock</dt>
  <dd>
    各リクエスト周りのロックの配置で、Rubyプロセスごとにリクエスト処理を並行して走らせるようにする。
  </dd>
  <dd>アプリケーションがスレッドセーフでなければ有効。デフォルトは無効。</dd>

  <dt>method_override</dt>
  <dd>
    put/deleteフォームを、それらをサポートしないブラウザで使えるように<tt>_method</tt>のおまじないを使えるようにする。
  </dd>

  <dt>port</dt>
  <dd>待ち受けポート。ビルトインサーバのみで有効。</dd>

  <dt>prefixed_redirects</dt>
  <dd>
    絶対パスが与えられていないときに、リダイレクトに<tt>request.script_name</tt>を挿入するか否かの設定。これにより<tt>redirect '/foo'</tt>は、<tt>redirect to('/foo')</tt>のように振る舞う。デフォルトは無効。
  </dd>

  <dt>protection</dt>
  <dd>Web攻撃防御を有効にするか否かの設定。上述の攻撃防御の項を参照。</dd>

  <dt>public_dir</dt>
  <dd>
<tt>public_folder</tt>のエイリアス。以下を参照。</dd>

  <dt>public_folder</dt>
  <dd>
    publicファイルが提供されるディレクトリのパス。静的ファイルの提供が有効になっている場合にのみ使われる (以下の<tt>static</tt>設定を参照)。設定されていない場合、<tt>app_file</tt>設定から推定。
  </dd>

  <dt>reload_templates</dt>
  <dd>
    リクエスト間でテンプレートを再ロードするか否かの設定。developmentモードでは有効。
  </dd>

  <dt>root</dt>
  <dd>
    プロジェクトのルートディレクトリのパス。設定されていない場合、<tt>app_file</tt>設定から推定。
  </dd>

  <dt>raise_errors</dt>
  <dd>
    例外発生の設定(アプリケーションは止まる)。<tt>environment</tt>が<tt>"test"</tt>に設定されているときはデフォルトは有効。それ以外は無効。
  </dd>

  <dt>run</dt>
  <dd>
    有効のとき、SinatraがWebサーバの起動を取り扱う。rackupまたは他の手段を使うときは有効にしないこと。
  </dd>

  <dt>running</dt>
  <dd>ビルトインサーバが稼働中か？この設定を変更しないこと！</dd>

  <dt>server</dt>
  <dd>
    ビルトインサーバとして使用するサーバまたはサーバ群の指定。指定順位は優先度を表し、デフォルトはRuby実装に依存。
  </dd>

  <dt>sessions</dt>
  <dd>
    <tt>Rack::Session::Cookie</tt>を使ったクッキーベースのセッションサポートの有効化。詳しくは、'セッションの使用'の項を参照のこと。
  </dd>

  <dt>show_exceptions</dt>
  <dd>
    例外発生時にブラウザにスタックトレースを表示する。<tt>environment</tt>が<tt>"development"</tt>に設定されているときは、デフォルトで有効。それ以外は無効。
  </dd>
  <dd>
    また、<tt>:after_handler</tt>をセットすることができ、これにより、ブラウザにスタックトレースを表示する前に、アプリケーション固有のエラーハンドリングを起動させられる。
  </dd>

  <dt>static</dt>
  <dd>Sinatraが静的ファイルの提供を取り扱うかの設定。</dd>
  <dd>その取り扱いができるサーバを使う場合は無効。</dd>
  <dd>無効化でパフォーマンスは改善する</dd>
  <dd>
    クラッシックスタイルではデフォルトで有効。モジュラースタイルでは無効。
  </dd>

  <dt>static_cache_control</dt>
  <dd>
    Sinatraが静的ファイルを提供するときこれをセットして、レスポンスに<tt>Cache-Control</tt>ヘッダを追加するようにする。<tt>cache_control</tt>ヘルパーを使うこと。デフォルトは無効。
  </dd>
  <dd>
    複数の値をセットするときは明示的に配列を使う:
    <tt>set :static_cache_control, [:public, :max_age =&gt; 300]</tt>
  </dd>

  <dt>threaded</dt>
  <dd>
    <tt>true</tt>に設定されているときは、Thinにリクエストを処理するために<tt>EventMachine.defer</tt>を使うことを通知する。
  </dd>

  <dt>views</dt>
  <dd>
    ビューディレクトリのパス。設定されていない場合、<tt>app_file</tt>設定から推定する。
  </dd>

  <dt>x_cascade</dt>
  <dd>
    マッチするルーティングが無い場合に、X-Cascadeヘッダをセットするか否かの設定。デフォルトは<tt>true</tt>。
  </dd>
</dl>

<h2>環境設定(Environments)</h2>

<p>3種類の既定環境、<code class="highlighter-rouge">"development"</code>、<code class="highlighter-rouge">"production"</code>および<code class="highlighter-rouge">"test"</code>があります。環境は、<code class="highlighter-rouge">APP_ENV</code>環境変数を通して設定できます。デフォルト値は、<code class="highlighter-rouge">"development"</code>です。<code class="highlighter-rouge">"development"</code>環境において、すべてのテンプレートは、各リクエスト間で再ロードされ、そして、特別の<code class="highlighter-rouge">not_found</code>および<code class="highlighter-rouge">error</code>ハンドラがブラウザにスタックトレースを表示します。<code class="highlighter-rouge">"production"</code>および<code class="highlighter-rouge">"test"</code>環境においては、テンプレートはデフォルトでキャッシュされます。</p>

<p>異なる環境を走らせるには、<code class="highlighter-rouge">APP_ENV</code>環境変数を設定します。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code><span class="nv">APP_ENV</span><span class="o">=</span>production ruby my_app.rb
</code></pre>
</div>

<p>既定メソッド、<code class="highlighter-rouge">development?</code>、<code class="highlighter-rouge">test?</code>および<code class="highlighter-rouge">production?</code>を、現在の環境設定を確認するために使えます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">settings</span><span class="p">.</span><span class="nf">development?</span>
    <span class="s2">"development!"</span>
  <span class="k">else</span>
    <span class="s2">"not development!"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>エラーハンドリング(Error Handling)</h2>

<p>エラーハンドラはルーティングおよびbeforeフィルタと同じコンテキストで実行されます。すなわちこれは、<code class="highlighter-rouge">haml</code>、<code class="highlighter-rouge">erb</code>、<code class="highlighter-rouge">halt</code>といった便利なものが全て使えることを意味します。</p>

<h3>未検出(Not Found)</h3>

<p><code class="highlighter-rouge">Sinatra::NotFound</code>例外が発生したとき、またはレスポンスのステータスコードが404のときに、<code class="highlighter-rouge">not_found</code>ハンドラが発動します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">not_found</span> <span class="k">do</span>
  <span class="s1">'ファイルが存在しません'</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>エラー(Error)</h3>

<p><code class="highlighter-rouge">error</code>ハンドラはルーティングブロックまたはフィルタ内で例外が発生したときはいつでも発動します。
しかし、環境設定がdevelopmentの場合は<code class="highlighter-rouge">:after_handler</code>を設定している場合のみ発動するようになります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:show_exceptions</span><span class="p">,</span> <span class="ss">:after_handler</span>
</code></pre>
</div>

<p>例外オブジェクトはRack変数<code class="highlighter-rouge">sinatra.error</code>から取得できます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="k">do</span>
  <span class="s1">'エラーが発生しました。 - '</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>エラーをカスタマイズする場合は、</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="no">MyCustomError</span> <span class="k">do</span>
  <span class="s1">'エラーメッセージ...'</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>と書いておいて、下記のように呼び出します。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">raise</span> <span class="no">MyCustomError</span><span class="p">,</span> <span class="s1">'何かがまずかったようです'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>そうするとこうなります。</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>エラーメッセージ... 何かがまずかったようです
</code></pre>
</div>

<p>あるいは、ステータスコードに対応するエラーハンドラを設定することもできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="mi">403</span> <span class="k">do</span>
  <span class="s1">'Access forbidden'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/secret'</span> <span class="k">do</span>
  <span class="mi">403</span>
<span class="k">end</span>
</code></pre>
</div>

<p>範囲指定もできます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="mi">400</span><span class="p">.</span><span class="nf">.</span><span class="mi">510</span> <span class="k">do</span>
  <span class="s1">'Boom'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Sinatraを開発環境の下で実行している場合は、特別な<code class="highlighter-rouge">not_found</code>および<code class="highlighter-rouge">error</code>ハンドラが導入され、これは親切なスタックトレースと追加のデバッギング情報をブラウザに表示します。</p>

<h2>Rackミドルウェア(Rack Middleware)</h2>

<p>SinatraはRuby製Webフレームワークのミニマルな標準的インタフェースである<a href="https://rack.github.io/">Rack</a>上に構築されています。アプリケーションデベロッパーにとってRackにおける最も興味深い機能は、「ミドルウェア(middleware)」をサポートしていることであり、これは、サーバとアプリケーションとの間に置かれ、HTTPリクエスト/レスポンスを監視および/または操作することで、各種の汎用的機能を提供するコンポーネントです。</p>

<p>Sinatraはトップレベルの<code class="highlighter-rouge">use</code>メソッドを通して、Rackミドルウェアパイプラインの構築を楽にします。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'my_custom_middleware'</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Lint</span>
<span class="n">use</span> <span class="no">MyCustomMiddleware</span>

<span class="n">get</span> <span class="s1">'/hello'</span> <span class="k">do</span>
  <span class="s1">'Hello World'</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">use</code>の文法は、<a href="http://www.rubydoc.info/github/rack/rack/master/Rack/Builder">Rack::Builder</a>DSLで定義されているそれ（rackupファイルで最もよく使われる）と同じです。例えば <code class="highlighter-rouge">use</code>メソッドは複数の引数、そしてブロックも取ることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Auth</span><span class="o">::</span><span class="no">Basic</span> <span class="k">do</span> <span class="o">|</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">|</span>
  <span class="n">username</span> <span class="o">==</span> <span class="s1">'admin'</span> <span class="o">&amp;&amp;</span> <span class="n">password</span> <span class="o">==</span> <span class="s1">'secret'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Rackは、ロギング、デバッギング、URLルーティング、認証、セッション管理など、多様な標準的ミドルウェアを共に配布されています。Sinatraはその多くのコンポーネントを自動で使うよう基本設定されているため、通常、それらを<code class="highlighter-rouge">use</code>で明示的に指定する必要はありません。</p>

<p>便利なミドルウェアを以下で見つけられます。</p>

<p><a href="https://github.com/rack/rack/tree/master/lib/rack">rack</a>、
<a href="https://github.com/rack/rack-contrib#readm">rack-contrib</a>、
または<a href="https://github.com/rack/rack/wiki/List-of-Middleware">Rack wiki</a>。</p>

<h2>テスト(Testing)</h2>

<p>SinatraでのテストはRackベースのテストライブラリまたはフレームワークを使って書くことができます。<a href="http://www.rubydoc.info/github/brynary/rack-test/master/frames">Rack::Test</a>をお薦めします。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'my_sinatra_app'</span>
<span class="nb">require</span> <span class="s1">'minitest/autorun'</span>
<span class="nb">require</span> <span class="s1">'rack/test'</span>

<span class="k">class</span> <span class="nc">MyAppTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_my_default</span>
    <span class="n">get</span> <span class="s1">'/'</span>
    <span class="n">assert_equal</span> <span class="s1">'Hello World!'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_with_params</span>
    <span class="n">get</span> <span class="s1">'/meet'</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Frank'</span>
    <span class="n">assert_equal</span> <span class="s1">'Hello Frank!'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_with_user_agent</span>
    <span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">'HTTP_USER_AGENT'</span> <span class="o">=&gt;</span> <span class="s1">'Songbird'</span>
    <span class="n">assert_equal</span> <span class="s2">"Songbirdを使ってます!"</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ノート: モジュラースタイルでSinatraを使う場合は、上記<code class="highlighter-rouge">Sinatra::Application</code>をアプリケーションのクラス名に置き換えてください。</p>

<h2>Sinatra::Base - ミドルウェア、ライブラリおよびモジュラーアプリ</h2>

<p>軽量なアプリケーションであれば、トップレベルでアプリケーションを定義していくことはうまくいきますが、再利用性可能なコンポーネント、例えばRackミドルウェア、RailsのMetal、サーバコンポーネントを含むシンプルなライブラリ、あるいはSinatraの拡張プログラムを構築するような場合、これは無視できない欠点を持つものとなります。トップレベルは、軽量なアプリケーションのスタイルにおける設定（例えば、単一のアプリケーションファイル、<code class="highlighter-rouge">./public</code>および<code class="highlighter-rouge">./views</code>ディレクトリ、ロギング、例外詳細ページなど）を仮定しています。そこで<code class="highlighter-rouge">Sinatra::Base</code>の出番です。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="kp">true</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>

  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Hello world!'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">Sinatra::Base</code>のサブクラスで利用できるメソッドは、トップレベルDSLで利用できるものと全く同じです。ほとんどのトップレベルで記述されたアプリは、以下の2点を修正することで<code class="highlighter-rouge">Sinatra::Base</code>コンポーネントに変えることができます。</p>

<ul>
  <li>
<code class="highlighter-rouge">sinatra</code>の代わりに<code class="highlighter-rouge">sinatra/base</code>を読み込む
(そうしない場合、SinatraのDSLメソッドの全てがmainの名前空間にインポートされます)</li>
  <li>ルーティング、エラーハンドラ、フィルタ、オプションを<code class="highlighter-rouge">Sinatra::Base</code>のサブクラスに書く</li>
</ul>

<p><code class="highlighter-rouge">Sinatra::Base</code>はまっさらです。ビルトインサーバを含む、ほとんどのオプションがデフォルトで無効になっています。利用可能なオプションとその挙動の詳細については<a href="http://www.sinatrarb.com/configuration.html">Configuring Settings</a>(英語)をご覧ください。</p>

<p>もしもクラシックスタイルと同じような挙動のアプリケーションをトップレベルで定義させる必要があれば、<code class="highlighter-rouge">Sinatra::Application</code>をサブクラス化させてください。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s2">"sinatra/base"</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
    <span class="s1">'Hello world!'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>モジュラースタイル vs クラッシックスタイル</h3>

<p>一般的認識と違って、クラッシックスタイルを使うことに問題はなにもありません。それがそのアプリケーションに合っているのであれば、モジュラーアプリケーションに移行する必要はありません。</p>

<p>モジュラースタイルを使わずにクラッシックスタイルを使った場合の一番の不利な点は、Rubyプロセスごとにただ一つのSinatraアプリケーションしか持てない点です。複数が必要な場合はモジュラースタイルに移行してください。モジュラースタイルとクラッシックスタイルを混合できないということはありません。</p>

<p>一方のスタイルから他方へ移行する場合、デフォルト設定がわずかに異なる点に注意が必要です。</p>

<table>
  <tr>
    <th>設定</th>
    <th>クラッシック</th>
    <th>モジュラー</th>
    <th>モジュラー</th>
  </tr>

  <tr>
    <td>app_file</td>
    <td>sinatraを読み込むファイル</td>
    <td>Sinatra::Baseをサブクラス化したファイル</td>
    <td>Sinatra::Applicationをサブクラス化したファイル</td>
  </tr>

  <tr>
    <td>run</td>
    <td>$0 == app_file</td>
    <td>false</td>
    <td>false</td>
  </tr>

  <tr>
    <td>logging</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>method_override</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>inline_templates</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>static</td>
    <td>true</td>
    <td>File.exist?(public_folder)</td>
    <td>true</td>
  </tr>
</table>

<h3>モジュラーアプリケーションの提供</h3>

<p>モジュラーアプリケーションを開始、つまり<code class="highlighter-rouge">run!</code>を使って開始させる二種類のやり方があります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># my_app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ... アプリケーションのコードを書く ...</span>

  <span class="c1"># Rubyファイルが直接実行されたらサーバを立ち上げる</span>
  <span class="n">run!</span> <span class="k">if</span> <span class="n">app_file</span> <span class="o">==</span> <span class="vg">$0</span>
<span class="k">end</span>
</code></pre>
</div>

<p>として、次のように起動するか、</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby my_app.rb
</code></pre>
</div>

<p>または、Rackハンドラを使えるようにする<code class="highlighter-rouge">config.ru</code>ファイルを書いて、</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru (rackupで起動)</span>
<span class="nb">require</span> <span class="s1">'./my_app'</span>
<span class="n">run</span> <span class="no">MyApp</span>
</code></pre>
</div>

<p>起動します。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>rackup -p 4567
</code></pre>
</div>

<h3>config.ruを用いたクラッシックスタイルアプリケーションの使用</h3>

<p>アプリケーションファイルと、</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Hello world!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>対応する<code class="highlighter-rouge">config.ru</code>を書きます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'./app'</span>
<span class="n">run</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h3>config.ruはいつ使うのか？</h3>

<p><code class="highlighter-rouge">config.ru</code>ファイルは、以下の場合に適しています。</p>

<ul>
  <li>異なるRackハンドラ(Passenger, Unicorn, Herokuなど)でデプロイしたいとき</li>
  <li>
<code class="highlighter-rouge">Sinatra::Base</code>の複数のサブクラスを使いたいとき</li>
  <li>Sinatraをミドルウェアとして利用し、エンドポイントとしては利用しないとき</li>
</ul>

<p><strong>モジュラースタイルに移行したという理由だけで、<code class="highlighter-rouge">config.ru</code>に移行する必要はなく、<code class="highlighter-rouge">config.ru</code>で起動するためにモジュラースタイルを使う必要はありません。</strong></p>

<h3>Sinatraのミドルウェアとしての利用</h3>

<p>Sinatraは他のRackミドルウェアを利用することができるだけでなく、
全てのSinatraアプリケーションは、それ自体ミドルウェアとして別のRackエンドポイントの前に追加することが可能です。</p>

<p>このエンドポイントには、別のSinatraアプリケーションまたは他のRackベースのアプリケーション(Rails/Ramaze/Camping/…)が用いられるでしょう。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">LoginScreen</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">enable</span> <span class="ss">:sessions</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span> <span class="p">{</span> <span class="n">haml</span> <span class="ss">:login</span> <span class="p">}</span>

  <span class="n">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'admin'</span> <span class="n">and</span> <span class="n">params</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'admin'</span>
      <span class="n">session</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">redirect</span> <span class="s1">'/login'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ミドルウェアはbeforeフィルタの前に実行される</span>
  <span class="n">use</span> <span class="no">LoginScreen</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">session</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span>
      <span class="n">halt</span> <span class="s2">"アクセスは拒否されました。&lt;a href='/login'&gt;ログイン&lt;/a&gt;してください。"</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Hello </span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span><span class="si">}</span><span class="s2">."</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>動的なアプリケーションの生成</h3>

<p>新しいアプリケーションを実行時に、定数に割り当てることなく生成したくなる場合があるでしょう。<code class="highlighter-rouge">Sinatra.new</code>を使えばそれができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="n">my_app</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"hi"</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">my_app</span><span class="p">.</span><span class="nf">run!</span>
</code></pre>
</div>

<p>これは省略できる引数として、それが継承するアプリケーションを取ります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru (rackupで起動)</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">controller</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="ss">:logging</span>
  <span class="n">helpers</span> <span class="no">MyHelpers</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/a'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'a'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/b'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'b'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>これは特にSinatraのextensionをテストするときや、Sinatraを自身のライブラリで利用する場合に役立ちます。</p>

<p>これはまた、Sinatraをミドルウェアとして利用することを極めて簡単にします。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">use</span> <span class="no">Sinatra</span> <span class="k">do</span>
  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">RailsProject</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h2>スコープとバインディング(Scopes and Binding)</h2>

<p>現在のスコープはどのメソッドや変数が利用可能かを決定します。</p>

<h3>アプリケーション/クラスのスコープ</h3>

<p>全てのSinatraアプリケーションはSinatra::Baseのサブクラスに相当します。
もしトップレベルDSLを利用しているならば(<code class="highlighter-rouge">require 'sinatra'</code>)このクラスはSinatra::Applicationであり、
そうでなければ、あなたが明示的に作成したサブクラスです。
クラスレベルでは<code class="highlighter-rouge">get</code>や<code class="highlighter-rouge">before</code>のようなメソッドを持っています。
しかし<code class="highlighter-rouge">request</code>や<code class="highlighter-rouge">session</code>オブジェクトには、全てのリクエストに対する単一のアプリケーションクラスがあるだけなので、アクセスできません。</p>

<p><code class="highlighter-rouge">set</code>によって作られたオプションはクラスレベルのメソッドです。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># アプリケーションスコープの中だよ!</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="mi">42</span>
  <span class="n">foo</span> <span class="c1"># =&gt; 42</span>

  <span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
    <span class="c1"># もうアプリケーションスコープの中にいないよ!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>次の場所ではアプリケーションスコープバインディングを持ちます。</p>

<ul>
  <li>アプリケーションクラス本体</li>
  <li>拡張によって定義されたメソッド</li>
  <li>
<code class="highlighter-rouge">helpers</code>に渡されたブロック</li>
  <li>
<code class="highlighter-rouge">set</code>の値として使われるProcまたはブロック</li>
  <li>
<code class="highlighter-rouge">Sinatra.new</code>に渡されたブロック</li>
</ul>

<p>このスコープオブジェクト(クラス)は次のように利用できます。</p>

<ul>
  <li>configureブロックに渡されたオブジェクト経由(<code class="highlighter-rouge">configure { |c| ... }</code>)</li>
  <li>リクエストスコープの中での<code class="highlighter-rouge">settings</code>
</li>
</ul>

<h3>リクエスト/インスタンスのスコープ</h3>

<p>やってくるリクエストごとに、あなたのアプリケーションクラスの新しいインスタンスが作成され、全てのハンドラブロックがそのスコープで実行されます。
このスコープの内側からは<code class="highlighter-rouge">request</code>や<code class="highlighter-rouge">session</code>オブジェクトにアクセスすることができ、<code class="highlighter-rouge">erb</code>や<code class="highlighter-rouge">haml</code>のようなレンダリングメソッドを呼び出すことができます。
リクエストスコープの内側からは、<code class="highlighter-rouge">settings</code>ヘルパーによってアプリケーションスコープにアクセスすることができます。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># アプリケーションスコープの中だよ!</span>
  <span class="n">get</span> <span class="s1">'/define_route/:name'</span> <span class="k">do</span>
    <span class="c1"># '/define_route/:name'のためのリクエストスコープ</span>
    <span class="vi">@value</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">settings</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"/</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1"># "/#{params['name']}"のためのリクエストスコープ</span>
      <span class="vi">@value</span> <span class="c1"># =&gt; nil (not the same request)</span>
    <span class="k">end</span>

    <span class="s2">"ルーティングが定義された!"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>次の場所ではリクエストスコープバインディングを持ちます。</p>

<ul>
  <li>get/head/post/put/delete/options/patch/link/unlink ブロック</li>
  <li>before/after フィルタ</li>
  <li>helper メソッド</li>
  <li>テンプレート/ビュー</li>
</ul>

<h3>デリゲートスコープ</h3>

<p>デリゲートスコープは、単にクラススコープにメソッドを転送します。
しかしながら、クラスのバインディングを持っていないため、クラススコープと全く同じふるまいをするわけではありません。
委譲すると明示的に示されたメソッドのみが利用可能であり、またクラススコープと変数/状態を共有することはできません(注:
異なった<code class="highlighter-rouge">self</code>を持っています)。
<code class="highlighter-rouge">Sinatra::Delegator.delegate :method_name</code>を呼び出すことによってデリゲートするメソッドを明示的に追加することができます。</p>

<p>次の場所ではデリゲートスコープを持ちます。</p>

<ul>
  <li>もし<code class="highlighter-rouge">require "sinatra"</code>しているならば、トップレベルバインディング</li>
  <li>
<code class="highlighter-rouge">Sinatra::Delegator</code> mixinでextendされたオブジェクト</li>
</ul>

<p>コードをご覧ください: ここでは <a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/base.rb#L1609-1633">Sinatra::Delegator
mixin</a>は<a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/main.rb#L28-30">mainオブジェクトにextendされています</a>。</p>

<h2>コマンドライン</h2>

<p>Sinatraアプリケーションは直接実行できます。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby myapp.rb <span class="o">[</span>-h] <span class="o">[</span>-x] <span class="o">[</span>-e ENVIRONMENT] <span class="o">[</span>-p PORT] <span class="o">[</span>-o HOST] <span class="o">[</span>-s HANDLER]
</code></pre>
</div>

<p>オプション:</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>-h # ヘルプ
-p # ポート指定(デフォルトは4567)
-o # ホスト指定(デフォルトは0.0.0.0)
-e # 環境を指定 (デフォルトはdevelopment)
-s # rackserver/handlerを指定 (デフォルトはthin)
-x # mutex lockを付ける (デフォルトはoff)
</code></pre>
</div>

<h3>マルチスレッド</h3>

<p><em>この<a href="https://stackoverflow.com/a/6282999/5245129">StackOverflow</a>
のKonstantinによる回答を言い換えています。</em></p>

<p>Sinatraでは同時実行モデルを負わせることはできませんが、根本的な部分であるThinやPuma、WebrickのようなRackハンドラ(サーバー)部分に委ねることができます。
Sinatra自身はスレッドセーフであり、もしRackハンドラが同時実行モデルのスレッドを使用していても問題はありません。
つまり、これはサーバーを起動させる時、特定のRackハンドラに対して正しい起動処理を特定することが出来ます。
この例はThinサーバーをマルチスレッドで起動する方法のデモです。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app.rb</span>

<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">App</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s2">"Hello, World"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">App</span><span class="p">.</span><span class="nf">run!</span>
</code></pre>
</div>

<p>サーバーを開始するコマンドです。</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>thin --threaded start
</code></pre>
</div>

<h2>必要環境</h2>

<p>次のRubyバージョンが公式にサポートされています。</p>

<dl>
  <dt>Ruby 1.8.7</dt>
  <dd>
    1.8.7は完全にサポートされていますが、特にそれでなければならないという理由がないのであれば、アップグレードまたはJRubyまたはRubiniusへの移行を薦めます。1.8.7のサポートがSinatra 2.0の前に終わることはないでしょう。Ruby 1.8.6はサポート対象外です。
  </dd>

  <dt>Ruby 1.9.2</dt>
  <dd>
    1.9.2は完全にサポートされています。1.9.2p0は、Sinatraを起動したときにセグメントフォルトを引き起こすことが分かっているので、使わないでください。公式なサポートは、少なくともSinatra 1.5のリリースまでは続きます。
  </dd>

  <dt>Ruby 1.9.3</dt>
  <dd>
    1.9.3は完全にサポート、そして推奨されています。以前のバージョンからの1.9.3への移行は全セッションを無効にする点、覚えておいてください。
  </dd>

  <dt>Ruby 2.0.0</dt>
  <dd>
    2.0.0は完全にサポート、そして推奨されています。現在、その公式サポートを終了する計画はありません。
  </dd>

  <dt>Rubinius</dt>
  <dd>
    Rubiniusは公式にサポートされています(Rubinius &gt;= 2.x)。
    <tt>gem install puma</tt>することが推奨されています。
  </dd>

  <dt>JRuby</dt>
  <dd>
    JRubyの最新安定版が公式にサポートされています。JRubyでC拡張を使うことは推奨されていません。
    <tt>gem install trinidad</tt>することが推奨されています。
  </dd>
</dl>

<p>開発チームは常に最新となるRubyバージョンに注視しています。</p>

<p>次のRuby実装は公式にはサポートされていませんが、Sinatraが起動すると報告されています。</p>

<ul>
  <li>JRubyとRubiniusの古いバージョン</li>
  <li>Ruby Enterprise Edition</li>
  <li>MacRuby, Maglev, IronRuby</li>
  <li>Ruby 1.9.0と1.9.1 (これらの使用はお薦めしません)</li>
</ul>

<p>公式サポートをしないという意味は、問題がそこだけで起こり、サポートされているプラットフォーム上では起きない場合に、開発チームはそれはこちら側の問題ではないとみなすということです。</p>

<p>開発チームはまた、ruby-head(最新となる2.1.0)に対しCIを実行していますが、それが一貫して動くようになるまで何も保証しません。2.1.0が完全にサポートされればその限りではありません。</p>

<p>Sinatraは、利用するRuby実装がサポートしているオペレーティングシステム上なら動作するはずです。</p>

<p>MacRubyを使う場合は、<code class="highlighter-rouge">gem install control_tower</code>してください。</p>

<p>Sinatraは現在、Cardinal、SmallRuby、BlueRubyまたは1.8.7以前のバージョンのRuby上では動作しません。</p>

<h2>最新開発版</h2>

<p>Sinatraの最新開発版のコードを使いたい場合は、マスターブランチに対してアプリケーションを走らせて構いません。ある程度安定しています。また、適宜プレリリース版gemをpushしているので、</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra --pre
</code></pre>
</div>

<p>すれば、最新の機能のいくつかを利用できます。</p>

<h3>Bundlerを使う場合</h3>

<p>最新のSinatraでアプリケーションを動作させたい場合には、<a href="https://bundler.io">Bundler</a>を使うのがお薦めのやり方です。</p>

<p>まず、Bundlerがなければそれをインストールします。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install bundler
</code></pre>
</div>

<p>そして、プロジェクトのディレクトリで、<code class="highlighter-rouge">Gemfile</code>を作ります。</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">gem</span> <span class="s1">'sinatra'</span><span class="p">,</span> <span class="ss">:github</span> <span class="o">=&gt;</span> <span class="s2">"sinatra/sinatra"</span>

<span class="c1"># 他の依存ライブラリ</span>
<span class="n">gem</span> <span class="s1">'haml'</span>                    <span class="c1"># Hamlを使う場合</span>
<span class="n">gem</span> <span class="s1">'activerecord'</span><span class="p">,</span> <span class="s1">'~&gt; 3.0'</span>  <span class="c1"># ActiveRecord 3.xが必要かもしれません</span>
</code></pre>
</div>

<p>ノート: <code class="highlighter-rouge">Gemfile</code>にアプリケーションの依存ライブラリのすべてを並べる必要があります。しかし、Sinatraが直接依存するもの(RackおよびTile)はBundlerによって自動的に取り込まれ、追加されます。</p>

<p>これで、以下のようにしてアプリケーションを起動することができます。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>bundle <span class="nb">exec </span>ruby myapp.rb
</code></pre>
</div>

<h3>直接組み込む場合</h3>

<p>ローカルにクローンを作って、<code class="highlighter-rouge">sinatra/lib</code>ディレクトリを<code class="highlighter-rouge">$LOAD_PATH</code>に追加してアプリケーションを起動します。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code><span class="nb">cd </span>myapp
git clone git://github.com/sinatra/sinatra.git
ruby -I sinatra/lib myapp.rb
</code></pre>
</div>

<p>追ってSinatraのソースを更新する方法。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code><span class="nb">cd </span>myapp/sinatra
git pull
</code></pre>
</div>

<h3>グローバル環境にインストールする場合</h3>

<p>Sinatraのgemを自身でビルドすることもできます。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>git clone git://github.com/sinatra/sinatra.git
<span class="nb">cd </span>sinatra
rake sinatra.gemspec
rake install
</code></pre>
</div>

<p>gemをルートとしてインストールする場合は、最後のステップはこうなります。</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>sudo rake install
</code></pre>
</div>

<h2>バージョニング(Versioning)</h2>

<p>Sinatraは、<a href="https://semver.org/">Semantic Versioning</a>におけるSemVerおよびSemVerTagの両方に準拠しています。</p>

<h2>参考文献</h2>

<ul>
  <li>
<a href="http://www.sinatrarb.com/">プロジェクトサイト</a> - ドキュメント、ニュース、他のリソースへのリンクがあります。</li>
  <li>
<a href="http://www.sinatrarb.com/contributing.html">プロジェクトに参加(貢献)する</a> - バグレポート パッチの送信、サポートなど</li>
  <li><a href="https://github.com/sinatra/sinatra/issues">Issue tracker</a></li>
  <li><a href="https://twitter.com/sinatra">Twitter</a></li>
  <li><a href="https://groups.google.com/group/sinatrarb/topics">メーリングリスト</a></li>
  <li>http://freenode.net上のIRC: <a href="irc://chat.freenode.net/#sinatra">#sinatra</a>
</li>
  <li>
<a href="https://github.com/sinatra/sinatra-book/">Sinatra Book</a> クックブック、チュートリアル</li>
  <li>
<a href="http://recipes.sinatrarb.com/">Sinatra Recipes</a> コミュニティによるレシピ集</li>
  <li>http://www.rubydoc.info/上のAPIドキュメント: <a href="http://www.rubydoc.info/gems/sinatra">最新版(latest release)用</a>または<a href="http://www.rubydoc.info/github/sinatra/sinatra">現在のHEAD用</a>
</li>
  <li><a href="https://travis-ci.org/sinatra/sinatra">CIサーバ</a></li>
  <li><a href="http://route477.net/w/RackReferenceJa.html">Greenbear Laboratory Rack日本語マニュアル</a></li>
</ul>
</body></html>
