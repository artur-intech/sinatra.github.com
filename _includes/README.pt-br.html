<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>

<p><em>Atenção: Este documento é apenas uma tradução da versão em inglês e
pode estar desatualizado.</em></p>

<p>Alguns dos trechos de código a seguir utilizam caracteres UTF-8. Então, caso
esteja utilizando uma versão de ruby inferior à <code class="highlighter-rouge">2.0.0</code>, adicione o encoding
no início de seus arquivos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># encoding: utf-8</span>
</code></pre>
</div>

<p>Sinatra é uma
<a href="https://pt.wikipedia.org/wiki/Linguagem_de_dom%C3%ADnio_espec%C3%ADfico">DSL</a> para
criar aplicações web em Ruby com o mínimo de esforço e rapidez:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># minha_app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Olá Mundo!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Instale a gem:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra
</code></pre>
</div>

<p>Em seguida execute:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby minha_app.rb
</code></pre>
</div>

<p>Acesse em: <a href="http://localhost:4567">http://localhost:4567</a></p>

<p>Códigos alterados só terão efeito após você reiniciar o servidor.
Por favor, reinicie o servidor após qualquer mudança ou use
<a href="http://www.sinatrarb.com/contrib/reloader">sinatra/reloader</a>.</p>

<p>É recomendado também executar <code class="highlighter-rouge">gem install thin</code>. Caso esta gem esteja
disponível, o Sinatra irá utilizá-la.</p>

<h2>Conteúdo</h2>



<h2>Rotas</h2>

<p>No Sinatra, uma rota é um método HTTP emparelhado com um padrão de URL.
Cada rota possui um bloco de execução:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">mostrando</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">criando</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">put</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">atualizando</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">patch</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">modificando</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">delete</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">removendo</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">options</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">estabelecendo</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">link</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">associando</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">unlink</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">separando</span> <span class="n">alguma</span> <span class="n">coisa</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>
</code></pre>
</div>

<p>As rotas são interpretadas na ordem em que são definidas. A primeira
rota encontrada responde a requisição.</p>

<p>Rotas com barras à direita são diferentes das que não contém as barras:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="c1"># Não é o mesmo que "GET /foo/"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Padrões de rota podem conter parâmetros nomeados, acessíveis por meio do
hash <code class="highlighter-rouge">params</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/ola/:nome'</span> <span class="k">do</span>
  <span class="c1"># corresponde a "GET /ola/foo" e "GET /ola/bar"</span>
  <span class="c1"># params['nome'] é 'foo' ou 'bar'</span>
  <span class="s2">"Olá </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'nome'</span><span class="p">]</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você também pode acessar parâmetros nomeados por meio dos parâmetros de
um bloco:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/ola/:nome'</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="c1"># corresponde a "GET /ola/foo" e "GET /ola/bar"</span>
  <span class="c1"># params['nome'] é 'foo' ou 'bar'</span>
  <span class="c1"># n guarda o valor de params['nome']</span>
  <span class="s2">"Olá </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Padrões de rota também podem conter parâmetros splat (curinga),
acessível por meio do array <code class="highlighter-rouge">params['splat']</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/diga/*/para/*'</span> <span class="k">do</span>
  <span class="c1"># corresponde a /diga/ola/para/mundo</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["ola", "mundo"]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/download/*.*'</span> <span class="k">do</span>
  <span class="c1"># corresponde a /download/caminho/do/arquivo.xml</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["caminho/do/arquivo", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou com parâmetros de um bloco:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/download/*.*'</span> <span class="k">do</span> <span class="o">|</span><span class="n">caminho</span><span class="p">,</span> <span class="n">ext</span><span class="o">|</span>
  <span class="p">[</span><span class="n">caminho</span><span class="p">,</span> <span class="n">ext</span><span class="p">]</span> <span class="c1"># =&gt; ["caminho/do/arquivo", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Rotas podem casar com expressões regulares:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">/\/ola\/([\w]+)/</span> <span class="k">do</span>
  <span class="s2">"Olá, </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'captures'</span><span class="p">].</span><span class="nf">first</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou com parâmetros de um bloco:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{/ola/([</span><span class="se">\w</span><span class="sr">]+)}</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># corresponde a "GET /meta/ola/mundo", "GET /ola/mundo/1234" etc.</span>
  <span class="s2">"Olá, </span><span class="si">#{</span><span class="n">c</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Padrões de rota podem contar com parâmetros opcionais:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/posts/:formato?'</span> <span class="k">do</span>
  <span class="c1"># corresponde a "GET /posts/" e qualquer extensão "GET /posts/json", "GET /posts/xml", etc.</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Rotas também podem utilizar query strings:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/posts'</span> <span class="k">do</span>
  <span class="c1"># corresponde a "GET /posts?titulo=foo&amp;autor=bar"</span>
  <span class="n">titulo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'titulo'</span><span class="p">]</span>
  <span class="n">autor</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'autor'</span><span class="p">]</span>
  <span class="c1"># utiliza as variaveis titulo e autor; a query é opicional para a rota /posts</span>
<span class="k">end</span>
</code></pre>
</div>

<p>A propósito, a menos que você desative a proteção contra ataques (veja
<a href="#configurando-prote%C3%A7%C3%A3o-a-ataques">abaixo</a>), o caminho solicitado pode ser
alterado antes de concluir a comparação com as suas rotas.</p>

<p>Você pode customizar as opções usadas do
<a href="https://github.com/sinatra/mustermann#readme">Mustermann</a> para uma
rota passando <code class="highlighter-rouge">:mustermann_opts</code> num hash:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'\A/posts\z'</span><span class="p">,</span> <span class="ss">:musterman_opts</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="n">regexp</span><span class="p">,</span> <span class="ss">:check_anchors</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">}</span> <span class="k">do</span>
  <span class="c1"># corresponde a /posts exatamente, com ancoragem explícita</span>
  <span class="s2">"Se você combinar um padrão ancorado bata palmas!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Parece com uma <a href="#condi%C3%A7%C3%B5es">condição</a> mas não é! Essas opções serão
misturadas no hash global <code class="highlighter-rouge">:mustermann_opts</code> descrito
<a href="#configura%C3%A7%C3%B5es-dispon%C3%ADveis">abaixo</a></p>

<h2>Condições</h2>

<p>Rotas podem incluir uma variedade de condições, tal como o <code class="highlighter-rouge">user agent</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span><span class="p">,</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird (\d\.\d)[\d\/]*?/</span> <span class="k">do</span>
  <span class="s2">"Você está usando o Songbird versão </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'agent'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="c1"># Correspondente a navegadores que não sejam Songbird</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Outras condições disponíveis são <code class="highlighter-rouge">host_name</code> e <code class="highlighter-rouge">provides</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="sr">/^admin\./</span> <span class="k">do</span>
  <span class="s2">"Área administrativa. Acesso negado!"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="s1">'html'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'rss'</span><span class="p">,</span> <span class="s1">'atom'</span><span class="p">,</span> <span class="s1">'xml'</span><span class="p">]</span> <span class="k">do</span>
  <span class="n">builder</span> <span class="ss">:feed</span>
<span class="k">end</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">provides</code> procura o cabeçalho Accept das requisições</p>

<p>Você pode facilmente definir suas próprias condições:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:probabilidade</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">valor</span><span class="o">|</span> <span class="n">condition</span> <span class="p">{</span> <span class="nb">rand</span> <span class="o">&lt;=</span> <span class="n">valor</span> <span class="p">}</span> <span class="p">}</span>

<span class="n">get</span> <span class="s1">'/ganha_um_carro'</span><span class="p">,</span> <span class="ss">:probabilidade</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="k">do</span>
  <span class="s2">"Você ganhou!"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/ganha_um_carro'</span> <span class="k">do</span>
  <span class="s2">"Sinto muito, você perdeu."</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Use splat, para uma condição que leva vários valores:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:auth</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">roles</span><span class="o">|</span>   <span class="c1"># &lt;- observe o splat aqui</span>
  <span class="n">condition</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">logged_in?</span> <span class="o">&amp;&amp;</span> <span class="n">roles</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">role</span><span class="o">|</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">in_role?</span> <span class="n">role</span> <span class="p">}</span>
      <span class="n">redirect</span> <span class="s2">"/login/"</span><span class="p">,</span> <span class="mi">303</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/minha/conta/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:usuario</span><span class="p">,</span> <span class="ss">:administrador</span><span class="p">]</span> <span class="k">do</span>
  <span class="s2">"Detalhes da sua conta"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/apenas/administrador/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="ss">:administrador</span> <span class="k">do</span>
  <span class="s2">"Apenas administradores são permitidos aqui!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Retorno de valores</h2>

<p>O valor de retorno do bloco de uma rota determina pelo menos o corpo da
resposta passado para o cliente HTTP, ou pelo menos o próximo middleware
na pilha Rack. Frequentemente, isto é uma <code class="highlighter-rouge">string</code>, tal como nos
exemplos acima. Entretanto, outros valores também são aceitos.</p>

<p>Você pode retornar uma resposta válida ou um objeto para o Rack, sendo
eles de qualquer tipo de objeto que queira. Além disso, é possível
retornar um código de status HTTP.</p>

<ul>
  <li>
    <p>Um array com três elementros: <code class="highlighter-rouge">[status (Integer), cabecalho (Hash),
  corpo da resposta (responde à #each)]</code></p>
  </li>
  <li>
    <p>Um array com dois elementros: <code class="highlighter-rouge">[status (Integer), corpo da resposta
  (responde à #each)]</code></p>
  </li>
  <li>
    <p>Um objeto que responda à <code class="highlighter-rouge">#each</code> sem passar nada, mas, sim, <code class="highlighter-rouge">strings</code>
  para um dado bloco</p>
  </li>
  <li>
    <p>Um objeto <code class="highlighter-rouge">Integer</code> representando o código de status</p>
  </li>
</ul>

<p>Dessa forma, podemos implementar facilmente um exemplo de streaming:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Stream</span>
  <span class="k">def</span> <span class="nf">each</span>
    <span class="mi">100</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="k">yield</span> <span class="s2">"</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="no">Stream</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
</code></pre>
</div>

<p>Você também pode usar o método auxiliar <code class="highlighter-rouge">stream</code>
(<a href="#respostas-de-streaming">descrito abaixo</a>) para reduzir códigos
boilerplate e para incorporar a lógica de streaming (transmissão) na rota.</p>

<h2>Validadores de Rota Personalizados</h2>

<p>Como apresentado acima, a estrutura do Sinatra conta com suporte
embutido para uso de padrões de String e expressões regulares como
validadores de rota. No entanto, ele não pára por aí. Você pode
facilmente definir os seus próprios validadores:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">AllButPattern</span>
  <span class="nc">Match</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:captures</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">except</span><span class="p">)</span>
    <span class="vi">@except</span>   <span class="o">=</span> <span class="n">except</span>
    <span class="vi">@captures</span> <span class="o">=</span> <span class="no">Match</span><span class="p">.</span><span class="nf">new</span><span class="p">([])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="vi">@captures</span> <span class="k">unless</span> <span class="vi">@except</span> <span class="o">===</span> <span class="n">str</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">all_but</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
  <span class="no">AllButPattern</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="n">all_but</span><span class="p">(</span><span class="s2">"/index"</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Note que o exemplo acima pode ser robusto e complicado em excesso. Pode
também ser implementado como:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">//</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">==</span> <span class="s2">"/index"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou, usando algo mais denso à frente:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{(?!/index)}</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Arquivos estáticos</h2>

<p>Arquivos estáticos são disponibilizados a partir do diretório
<code class="highlighter-rouge">./public</code>. Você pode especificar um local diferente pela opção
<code class="highlighter-rouge">:public_folder</code></p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:public_folder</span><span class="p">,</span> <span class="n">__dir__</span> <span class="o">+</span> <span class="s1">'/estatico'</span>
</code></pre>
</div>

<p>Note que o nome do diretório público não é incluido na URL. Um arquivo
<code class="highlighter-rouge">./public/css/style.css</code> é disponibilizado como
<code class="highlighter-rouge">http://exemplo.com/css/style.css</code>.</p>

<p>Use a configuração <code class="highlighter-rouge">:static_cache_control</code> (veja <a href="#controle-de-cache">abaixo</a>)
para adicionar a informação <code class="highlighter-rouge">Cache-Control</code> no cabeçalho.</p>

<h2>Views / Templates</h2>

<p>Cada linguagem de template é exposta através de seu próprio método de
renderização. Estes métodos simplesmente retornam uma string:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isto renderiza <code class="highlighter-rouge">views/index.rb</code></p>

<p>Ao invés do nome do template, você também pode passar direto o conteúdo do
template:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">code</span> <span class="o">=</span> <span class="s2">"&lt;%= Time.now %&gt;"</span>
  <span class="n">erb</span> <span class="n">code</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Templates também aceitam como um segundo argumento, um hash de opções:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:post</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isto irá renderizar a <code class="highlighter-rouge">views/index.erb</code> inclusa dentro da <code class="highlighter-rouge">views/post.erb</code>
(o padrão é a <code class="highlighter-rouge">views/layout.erb</code>, se existir).</p>

<p>Qualquer opção não reconhecida pelo Sinatra será passada adiante para o engine
de template:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:html5</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você também pode definir opções padrões para um tipo de template:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:haml</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:html5</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Opções passadas para o método de renderização sobrescreve as opções definitas
através do método <code class="highlighter-rouge">set</code>.</p>

<p>Opções disponíveis:</p>

<dl>
  <dt>locals</dt>
  <dd>
    Lista de locais passado para o documento. Conveniente para *partials*
    Exemplo: <tt>erb "&lt;%= foo %&gt;", :locals =&gt; {:foo =&gt; "bar"}</tt>
  </dd>

  <dt>default_encoding</dt>
  <dd>
    String encoding para ser utilizada em caso de incerteza. o padrão é
    <tt>settings.default_encoding</tt>.
  </dd>

  <dt>views</dt>
  <dd>
    Diretório de onde os templates são carregados. O padrão é
    <tt>settings.views</tt>.
  </dd>

  <dt>layout</dt>
  <dd>
    Para definir quando utilizar ou não um
    layout (<tt>true</tt> ou <tt>false</tt>). E se for um
    Symbol, especifica qual template usar. Exemplo:
    <tt>erb :index, :layout =&gt; !request.xhr?</tt>
  </dd>

  <dt>content_type</dt>
  <dd>
    O *Content-Type* que o template produz. O padrão depente
    da linguagem de template utilizada.
  </dd>

  <dt>scope</dt>
  <dd>
    Escopo em que o template será renderizado. Padrão é a
    instância da aplicação. Se você mudar isto as variáveis
    de instância métodos auxiliares não serão
    disponibilizados.
  </dd>

  <dt>layout_engine</dt>
  <dd>
    A engine de template utilizada para renderizar seu layout.
    Útil para linguagens que não suportam templates de outra
    forma. O padrão é a engine do template utilizado. Exemplo:
    <tt>set :rdoc, :layout_engine =&gt; :erb</tt>
  </dd>

  <dt>layout_options</dt>
  <dd>
    Opções especiais utilizadas apenas para renderizar o
    layout. Exemplo:
    <tt>set :rdoc, :layout_options =&gt; { :views =&gt; 'views/layouts' }</tt>
  </dd>
</dl>

<p>É pressuposto que os templates estarão localizados diretamente sob o
diretório <code class="highlighter-rouge">./views</code>. Para usar um diretório diferente:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="nf">root</span> <span class="o">+</span> <span class="s1">'/templates'</span>
</code></pre>
</div>

<p>Uma coisa importante para se lembrar é que você sempre deve
referenciar os templates utilizando <em>symbols</em>, mesmo que
eles estejam em um subdiretório (neste caso use:
<code class="highlighter-rouge">:'subdir/template'</code> or <code class="highlighter-rouge">'subdir/template'.to_sym</code>). Você deve
utilizar um <em>symbol</em> porque senão o método de renderização irá
renderizar qualquer outra string que você passe diretamente
para ele</p>

<h3>Literal Templates</h3>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Olá Mundo'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Renderiza um template string. Você pode opcionalmente especificar <code class="highlighter-rouge">path</code>
e <code class="highlighter-rouge">:line</code> para um backtrace mais claro se existir um caminho do sistema de
arquivos ou linha associada com aquela string.</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Olá Mundo'</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">'exemplos/arquivo.haml'</span><span class="p">,</span> <span class="ss">:line</span> <span class="o">=&gt;</span> <span class="mi">3</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Linguagens de template disponíveis</h3>

<p>Algumas linguagens possuem multiplas implementações. Para especificar qual
implementação deverá ser utilizada (e para ser <em>thread-safe</em>), você deve
requere-la primeiro:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rdiscount'</span> <span class="c1"># ou require 'bluecloth'</span>
<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="n">markdown</span> <span class="ss">:index</span> <span class="p">}</span>
</code></pre>
</div>

<h4>Haml Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://haml.info/" title="haml">haml</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.haml</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>haml :index, :format =&gt; :html5</tt></td>
  </tr>
</table>

<h4>Erb Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="http://www.kuwata-lab.com/erubis/" title="erubis">erubis</a>
      or erb (included in Ruby)
    </td>
  </tr>
  <tr>
    <td>Extensão dos Arquivos</td>
    <td>
<tt>.erb</tt>, <tt>.rhtml</tt> or <tt>.erubis</tt> (Erubis only)</td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>erb :index</tt></td>
  </tr>
</table>

<h4>Builder Templates</h4>

<table>
  <tr>
    <td>Dependêcia</td>
    <td>
      <a href="https://github.com/jimweirich/builder" title="builder">
        builder
      </a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.builder</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>builder { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>

<p>It also takes a block for inline templates (see exemplo).</p>

<h4>Nokogiri Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://www.nokogiri.org/" title="nokogiri">nokogiri</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.nokogiri</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>nokogiri { |xml| xml.em "hi" }</tt></td>
  </tr>
</table>

<p>It also takes a block for inline templates (see exemplo).</p>

<h4>Sass Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.sass</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>sass :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>

<h4>SCSS Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.scss</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>scss :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>

<h4>Less Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://lesscss.org/" title="less">less</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.less</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>less :stylesheet</tt></td>
  </tr>
</table>

<h4>Liquid Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="https://shopify.github.io/liquid/" title="liquid">liquid</a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.liquid</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>liquid :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>Já que você não pode chamar o Ruby (exceto pelo método <code class="highlighter-rouge">yield</code>) pelo template
Liquid, você quase sempre precisará passar o <code class="highlighter-rouge">locals</code> para ele.</p>

<h4>Markdown Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      Anyone of:
        <a href="https://github.com/davidfstr/rdiscount" title="RDiscount">
          RDiscount
        </a>,
        <a href="https://github.com/vmg/redcarpet" title="RedCarpet">
          RedCarpet
        </a>,
        <a href="https://github.com/ged/bluecloth" title="bluecloth">
          BlueCloth
        </a>,
        <a href="http://kramdown.gettalong.org/" title="kramdown">
          kramdown
        </a>,
        <a href="https://github.com/bhollis/maruku" title="maruku">
          maruku
        </a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivos</td>
    <td>
<tt>.markdown</tt>, <tt>.mkd</tt> and <tt>.md</tt>
</td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>markdown :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Não é possível chamar métodos por este template, nem passar <em>locals</em> para o
mesmo. Portanto normalmente é utilizado junto a outra engine de renderização:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:introducao</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Note que vcoê também pode chamar o método <code class="highlighter-rouge">markdown</code> dentro de outros templates:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Ol</span><span class="err">á</span> <span class="k">do</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:saudacoes</span><span class="p">)</span>
</code></pre>
</div>

<p>Já que você não pode chamar o Ruby pelo Markdown, você não
pode utilizar um layout escrito em Markdown. Contudo é
possível utilizar outra engine de renderização como template,
deve-se passar a <code class="highlighter-rouge">:layout_engine</code> como opção.</p>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://redcloth.org/" title="RedCloth">RedCloth</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.textile</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>textile :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Não é possível chamar métodos por este template, nem passar <em>locals</em> para o
mesmo. Portanto normalmente é utilizado junto a outra engine de renderização:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:introducao</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Note que vcoê também pode chamar o método <code class="highlighter-rouge">textile</code> dentro de outros templates:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Ol</span><span class="err">á</span> <span class="k">do</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:saudacoes</span><span class="p">)</span>
</code></pre>
</div>

<p>Já que você não pode chamar o Ruby pelo Textile, você não
pode utilizar um layout escrito em Textile. Contudo é
possível utilizar outra engine de renderização como template,
deve-se passar a <code class="highlighter-rouge">:layout_engine</code> como opção.</p>

<h4>RDoc Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://rdoc.sourceforge.net/" title="RDoc">RDoc</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.rdoc</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>rdoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Não é possível chamar métodos por este template, nem passar <em>locals</em> para o
mesmo. Portanto normalmente é utilizado junto a outra engine de renderização:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:introducao</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Note que vcoê também pode chamar o método <code class="highlighter-rouge">rdoc</code> dentro de outros templates:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Ol</span><span class="err">á</span> <span class="k">do</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:saudacoes</span><span class="p">)</span>
</code></pre>
</div>

<p>Já que você não pode chamar o Ruby pelo RDoc, você não
pode utilizar um layout escrito em RDoc. Contudo é
possível utilizar outra engine de renderização como template,
deve-se passar a <code class="highlighter-rouge">:layout_engine</code> como opção.</p>

<h4>AsciiDoc Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="http://asciidoctor.org/" title="Asciidoctor">Asciidoctor</a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td>
<tt>.asciidoc</tt>, <tt>.adoc</tt> and <tt>.ad</tt>
</td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>asciidoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Já que você não pode chamar o Ruby pelo template AsciiDoc,
você quase sempre precisará passar o <code class="highlighter-rouge">locals</code> para ele.</p>

<h4>Radius Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="https://github.com/jlong/radius" title="Radius">Radius</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.radius</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>radius :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>Já que você não pode chamar o Ruby pelo template Radius,
você quase sempre precisará passar o <code class="highlighter-rouge">locals</code> para ele.</p>

<h4>Markaby Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://markaby.github.io/" title="Markaby">Markaby</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.mab</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>markaby { h1 "Welcome!" }</tt></td>
  </tr>
</table>

<p>Este também recebe um bloco para templates (veja o exemplo).</p>

<h4>RABL Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="https://github.com/nesquena/rabl" title="Rabl">Rabl</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.rabl</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>rabl :index</tt></td>
  </tr>
</table>

<h4>Slim Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="http://slim-lang.com/" title="Slim Lang">Slim Lang</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.slim</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>slim :index</tt></td>
  </tr>
</table>

<h4>Creole Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td><a href="https://github.com/minad/creole" title="Creole">Creole</a></td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.creole</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>creole :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Não é possível chamar métodos por este template, nem passar <em>locals</em> para o
mesmo. Portanto normalmente é utilizado junto a outra engine de renderização:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">creole</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Note que você também pode chamar o método <code class="highlighter-rouge">creole</code> dentro de outros templates:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Ol</span><span class="err">á</span> <span class="k">do</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">creole</span><span class="p">(</span><span class="ss">:saudacoes</span><span class="p">)</span>
</code></pre>
</div>

<p>Já que você não pode chamar o Ruby pelo Creole, você não
pode utilizar um layout escrito em Creole. Contudo é
possível utilizar outra engine de renderização como template,
deve-se passar a <code class="highlighter-rouge">:layout_engine</code> como opção.</p>

<h4>MediaWiki Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="https://github.com/nricciar/wikicloth" title="WikiCloth">
        WikiCloth
      </a>
      </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td>
<tt>.mediawiki</tt> and <tt>.mw</tt>
</td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>mediawiki :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>It is not possible to call methods from MediaWiki markup, nor to pass locals to
it. You therefore will usually use it in combination with another rendering
engine:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">mediawiki</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Note that you may also call the <code class="highlighter-rouge">mediawiki</code> method from within other templates:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Hello</span> <span class="no">From</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">mediawiki</span><span class="p">(</span><span class="ss">:greetings</span><span class="p">)</span>
</code></pre>
</div>

<p>Já que você não pode chamar o Ruby pelo MediaWiki, você não
pode utilizar um layout escrito em MediaWiki. Contudo é
possível utilizar outra engine de renderização como template,
deve-se passar a <code class="highlighter-rouge">:layout_engine</code> como opção.</p>

<h4>CoffeeScript Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="https://github.com/josh/ruby-coffee-script" title="Ruby CoffeeScript">
        CoffeeScript
      </a> and a
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        way to execute javascript
      </a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.coffee</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>coffee :index</tt></td>
  </tr>
</table>

<h4>Stylus Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="https://github.com/forgecrafted/ruby-stylus" title="Ruby Stylus">
        Stylus
      </a> and a
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        way to execute javascript
      </a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.styl</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>stylus :index</tt></td>
  </tr>
</table>

<p>Antes que vcoê possa utilizar o template Stylus primeiro você deve carregar
<code class="highlighter-rouge">stylus</code> e <code class="highlighter-rouge">stylus/tilt</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'stylus'</span>
<span class="nb">require</span> <span class="s1">'stylus/tilt'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stylus</span> <span class="ss">:exemplo</span>
<span class="k">end</span>
</code></pre>
</div>

<h4>Yajl Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="https://github.com/brianmario/yajl-ruby" title="yajl-ruby">
        yajl-ruby
      </a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.yajl</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td>
      <tt>
        yajl :index,
             :locals =&gt; { :key =&gt; 'qux' },
             :callback =&gt; 'present',
             :variable =&gt; 'resource'
      </tt>
    </td>
  </tr>
</table>

<p>O código-fonte do template é executado como uma string Ruby e a variável
resultante em json é convertida utilizando <code class="highlighter-rouge">#to_json</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">json</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span> <span class="p">}</span>
<span class="n">json</span><span class="p">[</span><span class="ss">:baz</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
</code></pre>
</div>

<p>O <code class="highlighter-rouge">:callback</code> e <code class="highlighter-rouge">:variable</code> são opções que podem ser utilizadas para o objeto
de renderização:</p>

<div class="language-javascript highlighter-rouge">
<pre class="highlight"><code><span class="kd">var</span> <span class="nx">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"foo"</span><span class="p">:</span><span class="s2">"bar"</span><span class="p">,</span><span class="s2">"baz"</span><span class="p">:</span><span class="s2">"qux"</span><span class="p">};</span>
<span class="nx">present</span><span class="p">(</span><span class="nx">resource</span><span class="p">);</span>
</code></pre>
</div>

<h4>WLang Templates</h4>

<table>
  <tr>
    <td>Dependência</td>
    <td>
      <a href="https://github.com/blambeau/wlang/" title="WLang">WLang</a>
    </td>
  </tr>
  <tr>
    <td>Extensão do Arquivo</td>
    <td><tt>.wlang</tt></td>
  </tr>
  <tr>
    <td>Exemplo</td>
    <td><tt>wlang :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>Já que você não pode chamar o Ruby (exceto pelo método
<code class="highlighter-rouge">yield</code>) pelo template WLang,
você quase sempre precisará passar o <code class="highlighter-rouge">locals</code> para ele.</p>

<h2>Acessando Variáveis nos Templates</h2>

<p>Templates são avaliados dentro do mesmo contexto como manipuladores de
rota. Variáveis de instância definidas em manipuladores de rota são
diretamente acessadas por templates:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="vi">@foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= @foo.nome'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou, especifique um hash explícito de variáveis locais:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= foo.nome'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="n">foo</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isso é tipicamente utilizando quando renderizamos templates como
partials dentro de outros templates.</p>

<h3>Templates com <code class="highlighter-rouge">yield</code> e layouts aninhados</h3>

<p>Um layout geralmente é apenas um template que executa <code class="highlighter-rouge">yield</code>.
Tal template pode ser utilizado pela opção <code class="highlighter-rouge">:template</code> descrita acima ou pode
ser renderizado através de um bloco, como a seguir:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Este código é quase equivalente a <code class="highlighter-rouge">erb :index, :layout =&gt; :post</code></p>

<p>Passando blocos para os métodos de renderização é útil para criar layouts
aninhados:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:main_layout</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:admin_layout</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também pode ser feito com menos linhas de código:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:admin_layout</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:main_layout</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:user</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Atualmente os métodos listados aceitam blocos: <code class="highlighter-rouge">erb</code>, <code class="highlighter-rouge">haml</code>,
<code class="highlighter-rouge">liquid</code>, <code class="highlighter-rouge">slim </code>, <code class="highlighter-rouge">wlang</code>. E o método geral <code class="highlighter-rouge">render</code> também aceita blocos.</p>

<h3>Templates Inline</h3>

<p>Templates podem ser definidos no final do arquivo fonte:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="cp">__END__

@@ layout
%html
  = yield

@@ index
%div.title Olá Mundo.
</span></code></pre>
</div>

<p>NOTA: Templates inline definidos no arquivo fonte são automaticamente
carregados pelo Sinatra. Digite <code class="highlighter-rouge">enable :inline_templates</code> explicitamente se
você tem templates inline em outros arquivos fonte.</p>

<h3>Templates Nomeados</h3>

<p>Templates também podem ser definidos utilizando o método top-level
<code class="highlighter-rouge">template</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">template</span> <span class="ss">:layout</span> <span class="k">do</span>
  <span class="s2">"%html</span><span class="se">\n</span><span class="s2">  =yield</span><span class="se">\n</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">template</span> <span class="ss">:index</span> <span class="k">do</span>
  <span class="s1">'%div.title Olá Mundo!'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Se existir um template com nome “layout”, ele será utilizado toda vez
que um template for renderizado. Você pode desabilitar layouts passando
<code class="highlighter-rouge">:layout =&gt; false</code> ou desabilita-los por padrão
via <code class="highlighter-rouge">set :haml, :layout =&gt; false</code></p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Associando Extensões de Arquivos</h3>

<p>Para associar uma extensão de arquivo com um engine de template use o método
<code class="highlighter-rouge">Tilt.register</code>. Por exemplo, se você quiser usar a extensão <code class="highlighter-rouge">tt</code> para os
templates Textile você pode fazer o seguinte:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:tt</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:textile</span><span class="p">]</span>
</code></pre>
</div>

<h3>Adicionando seu Próprio Engine de Template</h3>

<p>Primeiro registre seu engine utilizando o Tilt, e então crie um método de
renderização:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:myat</span><span class="p">,</span> <span class="no">MyAwesomeTemplateEngine</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">myat</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="n">render</span><span class="p">(</span><span class="ss">:myat</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">myat</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Renderize <code class="highlighter-rouge">./views/index.myat</code>. Aprenda mais sobre o
Tilt <a href="https://github.com/rtomayko/tilt#readme">aqui</a>.</p>

<h3>Customizando Lógica para Encontrar Templates</h3>

<p>Para implementar sua própria lógica para busca de templates você pode escrever
seu próprio método <code class="highlighter-rouge">#find_template</code></p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:views</span> <span class="p">[</span> <span class="s1">'./views/a'</span><span class="p">,</span> <span class="s1">'./views/b'</span> <span class="p">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="no">Array</span><span class="p">(</span><span class="n">views</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
    <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Filtros</h2>

<p>Filtros Before são avaliados antes de cada requisição dentro do contexto
da requisição e podem modificar a requisição e a reposta. Variáveis de
instância definidas nos filtros são acessadas através de rotas e
templates:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@nota</span> <span class="o">=</span> <span class="s1">'Oi!'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s1">'/foo/bar/baz'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/foo/*'</span> <span class="k">do</span>
  <span class="vi">@nota</span> <span class="c1">#=&gt; 'Oi!'</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1">#=&gt; 'bar/baz'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Filtros After são avaliados após cada requisição dentro do mesmo contexto da
requisição e também podem modificar a requisição e a resposta. Variáveis de
instância definidas nos filtros before e rotas são acessadas através dos
filtros after:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">status</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Nota: A não ser que você use o metódo <code class="highlighter-rouge">body</code> ao invés de apenas retornar uma
String das rotas, o corpo ainda não estará disponível no filtro after, uma vez
que é gerado depois.</p>

<p>Filtros opcionalmente têm um padrão, fazendo com que sejam avaliados
somente se o caminho do pedido coincidir com esse padrão:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="s1">'/protected/*'</span> <span class="k">do</span>
  <span class="n">authenticate!</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/create/:slug'</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="o">|</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:last_slug</span><span class="p">]</span> <span class="o">=</span> <span class="n">slug</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Como rotas, filtros também aceitam condições:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird/</span> <span class="k">do</span>
  <span class="c1">#...</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/blog/*'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="s1">'exemplo.com'</span> <span class="k">do</span>
  <span class="c1">#...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Helpers</h2>

<p>Use o método de alto nível <code class="highlighter-rouge">helpers</code> para definir métodos auxiliares
para utilizar em manipuladores de rotas e modelos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">nome</span><span class="p">)</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">nome</span><span class="si">}</span><span class="s2">bar"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:nome'</span> <span class="k">do</span>
  <span class="n">bar</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'nome'</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Alternativamente, métodos auxiliares podem ser definidos separadamente em
módulos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">module</span> <span class="nn">FooUtils</span>
  <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">nome</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="n">nome</span><span class="si">}</span><span class="s2">foo"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">BarUtils</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">nome</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="n">nome</span><span class="si">}</span><span class="s2">bar"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">helpers</span> <span class="no">FooUtils</span><span class="p">,</span> <span class="no">BarUtils</span>
</code></pre>
</div>

<p>O efeito é o mesmo que incluir os módulos na classe da aplicação.</p>

<h3>Utilizando Sessões</h3>

<p>Uma sessão é usada para manter o estado durante requisições. Se ativada, você
 terá disponível um hash de sessão para cada sessão de usuário:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s2">"value = "</span> <span class="o">&lt;&lt;</span> <span class="n">session</span><span class="p">[</span><span class="ss">:value</span><span class="p">].</span><span class="nf">inspect</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:value'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>
<p>#### Segredo Seguro da Sessão</p>

<p>Para melhorar a segurança, os dados da sessão no cookie são assinado com uma
segredo de sessão usando <code class="highlighter-rouge">HMAC-SHA1</code>. Esse segredo de sessão deve ser, de
preferência, um valor criptograficamente randômico, seguro, de um comprimento
apropriado no qual <code class="highlighter-rouge">HMAC-SHA1</code> é maior ou igual a 64 bytes (512 bits, 128
carecteres hexadecimais). Você será avisado para não usar uma chave secreta
menor que 32 bytes de randomicidade (256 bits, 64 caracteres hexadecimais).
Portanto, é <strong>muito importante</strong> que você não invente o segredo, mas use um
gerador de números aleatórios seguro para cria-lo. Humanos são extremamente
ruins em gerar números aleatórios.</p>

<p>Por padrão, um segredo de sessão aleatório seguro de 32 bytes é gerada para
você pelo Sinatra, mas ele mudará toda vez que você reiniciar sua aplicação. Se
você tiver múltiplas instâncias da sua aplicação e você deixar que o Sinatra
gere a chave, cada instância teria uma chave de sessão diferente, o que
certamente não é o que você quer.</p>

<p>Para melhor segurança e usabilidade é
<a href="https://12factor.net/config">recomendado</a> que você gere um segredo randômico
secreto e salve-o em uma variável de ambiente em cada host rodando sua
aplicação, assim todas as instâncias da sua aplicação irão compartilhar o mesmo
segredo. Você deve, periodicamente, mudar esse segredo de sessão para um novo
valor. Abaixo, são mostrados alguns exemplos de como você pode criar um segredo
de 64 bytes e usa-lo:</p>

<p><strong>Gerando Segredo de Sessão</strong></p>

<div class="language-text highlighter-rouge">
<pre class="highlight"><code>$ ruby -e "require 'securerandom'; puts SecureRandom.hex(64)"
99ae8af...snip...ec0f262ac
</code></pre>
</div>

<p><strong>Gerando Segredo de Sessão (Pontos adicionais)</strong></p>

<p>Use preferencialmente a
<a href="https://github.com/cryptosphere/sysrandom#readme">gem sysrandom</a> para utilizar
as facilidades do sistema RNG para gerar valores aleatórios ao invés
do <code class="highlighter-rouge">OpenSSL</code> no qual o MRI Ruby padroniza para:</p>

<div class="language-text highlighter-rouge">
<pre class="highlight"><code>$ gem install sysrandom
Building native extensions. This could take a while...
Sucessfully installed sysrandom-1.x
1 gem installed

$ ruby -e "require 'sysrandom/securerandom'; puts SecureRandom.hex(64)"
99ae8af...snip...ec0f262ac
</code></pre>
</div>

<p><strong>Segredo de Sessão numa Variável de Ambiente</strong></p>

<p>Defina uma variável de ambiente <code class="highlighter-rouge">SESSION_SECRET</code> para o Sinatra com o valor que
você gerou. Salve esse valor entre as reinicializações do seu host. Já que a
forma de fazer isso irá variar entre os sistemas operacionais, o exemplo abaixo
serve apenas para fins ilustrativos:</p>

<div class="language-bash highlighter-rouge">
<pre class="highlight"><code><span class="c"># echo "export SESSION_SECRET = 99ae8af...snip...ec0f262ac" &gt;&gt; ~/.bashrc</span>
</code></pre>
</div>

<p><strong>Configurando o Segredo de Sessão na Aplicação</strong></p>

<p>Configure sua aplicação para uma falha de segredo seguro aleatório se a
variável de ambiente <code class="highlighter-rouge">SESSION_SECRET</code> não estiver disponível.</p>

<p>Como ponto adicional use a
<a href="https://github.com/cryptosphere/sysrandom#readme">gem sysrandom</a> da seguinte
forma:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'securerandom'</span>
<span class="c1"># -or- require 'sysrandom/securearandom'</span>
<span class="n">set</span> <span class="ss">:session_secret</span><span class="p">,</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fecth</span><span class="p">(</span><span class="sb">`SESSION_SECRET`</span><span class="p">)</span> <span class="p">{</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">hex</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<h4>Configuração de Sessão</h4>

<p>Se você deseja configurar isso adicionalmente, você pode salvar um hash com
opções na definição de <code class="highlighter-rouge">sessions</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'foo.com'</span>
</code></pre>
</div>

<p>Para compartilhar sua sessão com outras aplicações no subdomínio de foo.com,
adicione um <em>.</em> antes do domínio como no exemplo abaixo:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'.foo.com'</span>
</code></pre>
</div>

<h4>Escolhendo Seu Próprio Middleware de Sessão</h4>

<p>Perceba que <code class="highlighter-rouge">enable :sessions</code> na verdade guarda todos seus dados num cookie.
Isto pode não ser o que você deseja sempre (armazenar muitos dados irá aumentar
seu tráfego, por exemplo). Você pode usar qualquer middleware de sessão Rack
para fazer isso, um dos seguintes métodos pode ser usado:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>
<span class="n">set</span> <span class="ss">:session_store</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
</code></pre>
</div>

<p>Ou definir as sessões com um hash de opções:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>
<span class="n">set</span> <span class="ss">:session_store</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
</code></pre>
</div>

<p>Outra opção é <strong>não</strong> usar <code class="highlighter-rouge">enable :sessions</code>, mas ao invés disso trazer seu
middleware escolhido como você faria com qualquer outro middleware.</p>

<p>É importante lembrar que usando esse método, a proteção baseada na sessão
<strong>não estará habilitada por padrão</strong>.</p>

<p>Para o middleware Rack fazer isso, será preciso que isso também seja adicionado:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Protection</span><span class="o">::</span><span class="no">RemoteToken</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Protection</span><span class="o">::</span><span class="no">SessionHijacking</span>
</code></pre>
</div>
<p>Veja ‘<a href="#configurando-prote%C3%A7%C3%A3o-a-ataques">Configurando proteção a ataques</a>’ para
mais informações.</p>

<h3>Parando</h3>

<p>Para parar imediatamente uma requisição com um filtro ou rota utilize:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span>
</code></pre>
</div>

<p>Você também pode especificar o status quando parar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">410</span>
</code></pre>
</div>

<p>Ou o corpo:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="s1">'isso será o corpo'</span>
</code></pre>
</div>

<p>Ou ambos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">'vá embora!'</span>
</code></pre>
</div>

<p>Com cabeçalhos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">402</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/plain'</span><span class="p">},</span> <span class="s1">'revanche'</span>
</code></pre>
</div>

<p>Também é obviamente possível combinar um template com o <code class="highlighter-rouge">halt</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="n">erb</span><span class="p">(</span><span class="ss">:error</span><span class="p">)</span>
</code></pre>
</div>

<h3>Passing</h3>

<p>Uma rota pode processar aposta para a próxima rota correspondente usando
<code class="highlighter-rouge">pass</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/adivinhar/:quem'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">unless</span> <span class="n">params</span><span class="p">[</span><span class="s1">'quem'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Frank'</span>
  <span class="s1">'Você me pegou!'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/adivinhar/*'</span> <span class="k">do</span>
  <span class="s1">'Você falhou!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>O bloqueio da rota é imediatamente encerrado e o controle continua com a
próxima rota compatível. Se nenhuma rota compatível for encontrada, um
404 é retornado.</p>

<h3>Desencadeando Outra Rota</h3>

<p>As vezes o <code class="highlighter-rouge">pass</code> não é o que você quer, ao invés dele talvez você queira obter
o resultado chamando outra rota. Simplesmente utilize o método <code class="highlighter-rouge">call</code> neste
caso:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">call</span> <span class="n">env</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="s2">"PATH_INFO"</span> <span class="o">=&gt;</span> <span class="s1">'/bar'</span><span class="p">)</span>
  <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:upcase</span><span class="p">)]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="s2">"bar"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Note que no exemplo acima você ganharia performance e facilitaria os testes ao
simplesmente mover <code class="highlighter-rouge">"bar"</code> para um método auxiliar usado por ambos <code class="highlighter-rouge">/foo</code>
e <code class="highlighter-rouge">/bar</code>.</p>

<p>Se você quer que a requisição seja enviada para a mesma instância da aplicação
no lugar de uma duplicada, use <code class="highlighter-rouge">call!</code> no lugar de <code class="highlighter-rouge">call</code>.</p>

<p>Veja a especificação do Rack se você quer aprender mais sobre o <code class="highlighter-rouge">call</code>.</p>

<h3>Definindo Corpo, Código de Status e Cabeçalhos</h3>

<p>É possível e recomendado definir o código de status e o corpo da resposta com o
valor retornado do bloco da rota. Entretanto, em alguns cenários você pode
querer definir o corpo em um ponto arbitrário do fluxo de execução. Você pode
fazer isso com o metódo auxiliar <code class="highlighter-rouge">body</code>. Se você fizer isso, poderá usar esse
metódo de agora em diante para acessar o body:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">body</span> <span class="s2">"bar"</span>
<span class="k">end</span>

<span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">body</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também é possivel passar um bloco para <code class="highlighter-rouge">body</code>, que será executado pelo
manipulador Rack (isso pode ser usado para implementar transmissão,
<a href="#retorno-de-valores">veja “Retorno de Valores”</a>).</p>

<p>Similar ao corpo, você pode também definir o código de status e cabeçalhos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span> <span class="mi">418</span>
  <span class="n">headers</span> <span class="p">\</span>
    <span class="s2">"Allow"</span> <span class="o">=&gt;</span> <span class="s2">"BREW, POST, GET, PROPFIND, WHEN"</span>
    <span class="s2">"Refresh"</span> <span class="o">=&gt;</span> <span class="s2">"Refresh: 20; https://ietf.org/rfc/rfc2324.txt"</span>
  <span class="n">body</span> <span class="s2">"Eu sou um bule de chá!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Assim como <code class="highlighter-rouge">body</code>, <code class="highlighter-rouge">headers</code> e <code class="highlighter-rouge">status</code> sem argumentos podem ser usados para
acessar seus valores atuais.</p>

<h3>Transmitindo Respostas</h3>

<p>As vezes você quer começar a mandar dados enquanto está gerando partes do corpo
da resposta. Em exemplos extremos, você quer continuar enviando dados até o
cliente encerrar a conexão. Você pode usar o método auxiliar <code class="highlighter-rouge">stream</code> para
evitar criar seu próprio empacotador:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stream</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"Isso será len -</span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">" Aguarde </span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">" dário!</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isso permite você implementar APIs de Transmissão,
<a href="https://w3c.github.io/eventsource/">Eventos Enviados pelo Servidor</a>, e pode
ser usado como a base para
<a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>. Pode ser usado também
para aumentar a taxa de transferência se algum, mas não todo, conteúdo depender
de um recurso lento.</p>

<p>Perceba que o comportamento da transmissão, especialmente o número de
requisições concorrentes, depende altamente do servidor web usado para servir a
aplicação. Alguns servidores podem até mesmo não suportar transmissão de
maneira alguma. Se o servidor não suportar transmissão, o corpo será enviado
completamente após que o bloco passado para <code class="highlighter-rouge">stream</code> terminar de executar.
Transmissão não funciona de nenhuma maneira com Shotun.</p>

<p>Se o parâmetro opcional é definido como <code class="highlighter-rouge">keep_open</code>, ele não chamará <code class="highlighter-rouge">close</code> no
objeto transmitido, permitindo você a fecha-lo em algum outro ponto futuro no
fluxo de execução. Isso funciona apenas em servidores orientados a eventos,
como Thin e Rainbows. Outros servidores irão continuar fechando a transmissão:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># long polling</span>

<span class="n">set</span> <span class="ss">:server</span><span class="p">,</span> <span class="ss">:thin</span>
<span class="n">conexoes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">get</span> <span class="s1">'/assinar'</span> <span class="k">do</span>
  <span class="c1"># registra o interesse de um cliente em servidores de eventos</span>
  <span class="n">stream</span><span class="p">(</span><span class="ss">:keep_open</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">saida</span><span class="o">|</span>
    <span class="n">conexoes</span> <span class="o">&lt;&lt;</span> <span class="n">saida</span>
    <span class="c1"># retire conexões mortas</span>
    <span class="n">conexoes</span><span class="p">.</span><span class="nf">reject!</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:closed?</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/:messagem'</span> <span class="k">do</span>
  <span class="n">conexoes</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">saida</span><span class="o">|</span>
    <span class="c1"># notifica o cliente que uma nova mensagem chegou</span>
    <span class="n">saida</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'messagem'</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>

    <span class="c1"># indica ao cliente para se conectar novamente</span>
    <span class="n">saida</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>

  <span class="c1"># confirma</span>
  <span class="s2">"messagem recebida"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também é possivel para o cliente fechar a conexão quando está tentando escrever
para o socket. Devido a isso, é recomendado checar <code class="highlighter-rouge">out.closed?</code> antes de
tentar escrever.</p>

<h3>Usando Logs</h3>

<p>No escopo da requisição, o método auxiliar <code class="highlighter-rouge">logger</code> expõe uma instância
<code class="highlighter-rouge">Logger</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"loading data"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Esse logger irá automaticamente botar as configurações de log do manipulador
Rack na sua conta. Se a produção de logs estiver desabilitads, esse método
retornará um objeto dummy, então você não terá que se preocupar com suas rotas
e filtros.</p>

<p>Perceba que a produção de logs está habilitada apenas para
<code class="highlighter-rouge">Sinatra::Application</code> por padrão, então se você herdar de <code class="highlighter-rouge">Sinatra::Base</code>,
você provavelmente irá querer habilitar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code>  <span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
      <span class="n">enable</span> <span class="ss">:logging</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
</div>

<p>Para evitar que qualquer middleware de logs seja configurado, defina a
configuração <code class="highlighter-rouge">logging</code> como <code class="highlighter-rouge">nil</code>. Entretanto, tenha em mente que <code class="highlighter-rouge">logger</code>
retornará, nesse caso, <code class="highlighter-rouge">nil</code>. Um caso de uso comum é quando você quer definir
seu próprio logger. Sinatra irá usar qualquer um que ele achar
em <code class="highlighter-rouge">env['rack.logger']</code></p>

<h3>Tipos Mime</h3>

<p>Quando se está usando <code class="highlighter-rouge">send_file</code> ou arquivos estáticos, você pode ter tipos
mime que o Sinatra não entende. Use <code class="highlighter-rouge">mime_type</code> para registrá-los pela extensão
do arquivo:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">mime_type</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'text/foo'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você pode utilizar também com o método auxiliar <code class="highlighter-rouge">content_type</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">content</span><span class="o">-</span><span class="n">type</span> <span class="ss">:foo</span>
  <span class="s2">"foo foo foo"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Gerando URLs</h3>

<p>Para gerar URLs você deve usar o metódo auxiliar <code class="highlighter-rouge">url</code> no Haml:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">a</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s1">'/foo'</span><span class="p">)}</span> <span class="n">foo</span>
</code></pre>
</div>

<p>Isso inclui proxies reversos e rotas Rack, se presentes.</p>

<p>Esse método é também apelidado para <code class="highlighter-rouge">to</code> (veja
<a href="#redirecionamento-do-browser">abaixo</a> para um exemplo).</p>

<h3>Redirecionamento do Browser</h3>

<p>Você pode lançar um redirecionamento no browser com o metódo auxiliar
<code class="highlighter-rouge">redirect</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Quaisquer paramêtros adicionais são interpretados como argumentos passados
ao <code class="highlighter-rouge">halt</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">),</span> <span class="mi">303</span>
<span class="n">redirect</span> <span class="s1">'http://www.google.com/'</span><span class="p">,</span> <span class="s1">'lugar errado, amigo'</span>
</code></pre>
</div>

<p>Você pode também facilmente redirecionar para a página da qual o usuário veio
com <code class="highlighter-rouge">redirect back</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="s2">"&lt;a href='/bar'&gt;do something&lt;/a&gt;"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">do_something</span>
  <span class="n">redirect</span> <span class="n">back</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Para passar argumentos com um redirecionamento, adicione-os a query:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar?sum=42'</span><span class="p">)</span>
</code></pre>
</div>

<p>Ou use uma sessão:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'foo'</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Controle de Cache</h3>

<p>Definir sues cabeçalhos corretamente é o principal passo para uma correta cache
HTTP.</p>

<p>Você pode facilmente definir o cabeçalho de Cache-Control como:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span>
  <span class="s2">"guarde isso!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dica profissional: Configure a cache em um filtro anterior:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">60</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Se você está usando o método auxiliar <code class="highlighter-rouge">expires</code> para definir seu cabeçalho
correspondente, <code class="highlighter-rouge">Cache-Control</code> irá ser definida automaticamente para você:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">expires</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Para usar propriciamente caches, você deve considerar usar <code class="highlighter-rouge">etag</code> ou
<code class="highlighter-rouge">last_modified</code>. É recomendado chamar esses métodos auxiliares <em>antes</em> de fazer
qualquer tipo de processamento pesado, já que eles irão imediatamente retornar
uma resposta se o cliente já possui a versão atual na sua cache:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s2">"/artigo/:id"</span> <span class="k">do</span>
  <span class="vi">@artigo</span> <span class="o">=</span> <span class="no">Artigo</span><span class="p">.</span><span class="nf">find</span> <span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
  <span class="n">last_modified</span> <span class="vi">@artigo</span><span class="p">.</span><span class="nf">updated_at</span>
  <span class="n">etag</span> <span class="vi">@artigo</span><span class="p">.</span><span class="nf">sha1</span>
  <span class="n">erb</span> <span class="ss">:artigo</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também é possível usar uma
<a href="https://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation">ETag fraca</a>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span><span class="p">,</span> <span class="ss">:weak</span>
</code></pre>
</div>
<p>Esses métodos auxiliares não irão fazer nenhum processo de cache para você, mas
irão alimentar as informações necessárias para sua cache. Se você está
pesquisando por uma solução rápida de fazer cache com proxy-reverso, tente
<a href="https://github.com/rtomayko/rack-cache#readme">rack-cache</a>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s2">"rack/cache"</span>
<span class="nb">require</span> <span class="s2">"sinatra"</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cache</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">36000</span>
  <span class="nb">sleep</span> <span class="mi">5</span>
  <span class="s2">"olá"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Use a configuração <code class="highlighter-rouge">:static_cache_control</code> (veja [acima]#(controle-de-cache))
para adicionar o cabeçalho de informação <code class="highlighter-rouge">Cache-Control</code> para arquivos
estáticos.</p>

<p>De acordo com a RFC 2616, sua aplicação deve se comportar diferentemente se o
cabeçalho If-Match ou If-None-Match é definido para <code class="highlighter-rouge">*</code>, dependendo se o
recurso requisitado já existe. Sinatra assume que recursos para requisições
seguras (como get) e idempotentes (como put) já existem, enquanto que para
outros recursos (por exemplo requisições post) são tratados como novos
recursos. Você pode mudar esse comportamento passando em uma opção
<code class="highlighter-rouge">:new_resource</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/create'</span> <span class="k">do</span>
  <span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="no">Artigo</span><span class="p">.</span><span class="nf">create</span>
  <span class="n">erb</span> <span class="ss">:novo_artigo</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Se você quer continuar usando um ETag fraco, passe em uma opção <code class="highlighter-rouge">:kind</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="ss">:weak</span>
</code></pre>
</div>

<h3>Enviando Arquivos</h3>

<p>Para retornar os conteúdos de um arquivo como as resposta, você pode usar o
metódo auxiliar <code class="highlighter-rouge">send_file</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">send_file</span> <span class="s1">'foo.png'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também aceita opções:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">send_file</span> <span class="s1">'foo.png'</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:jpg</span>
</code></pre>
</div>

<p>As opções são:</p>

<dl>
  <dt>filename</dt>
    <dd>Nome do arquivo a ser usado na respota,
    o padrão é o nome do arquivo reak</dd>
  <dt>last_modified</dt>
    <dd>Valor do cabeçalho Last-Modified, o padrão corresponde ao mtime do
    arquivo.</dd>

  <dt>type</dt>
    <dd>Valor do cabeçalho Content-Type, extraído da extensão do arquivo se
    inexistente.</dd>

  <dt>disposition</dt>
    <dd>
      Valor do cabeçalho Content-Disposition, valores possíveis: <tt>nil</tt>
      (default), <tt>:attachment</tt> and <tt>:inline</tt>
    </dd>

  <dt>length</dt>
    <dd>Valor do cabeçalho Content-Length, o padrão corresponde ao tamanho do
    arquivo.</dd>

  <dt>status</dt>
    <dd>
      Código de status a ser enviado. Útil quando está se enviando um arquivo
      estático como uma página de erro. Se suportado pelo handler do Rack,
      outros meios além de transmissão do processo do Ruby serão usados.
      So você usar esse metódo auxiliar, o Sinatra irá automaticamente lidar com
      requisições de alcance.
    </dd>
</dl>

<h3>Acessando o Objeto da Requisção</h3>

<p>O objeto vindo da requisição pode ser acessado do nível de requsição (filtros,
rotas, manipuladores de erro) através do método <code class="highlighter-rouge">request</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app rodando em http://exemplo.com/exemplo</span>
<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">t</span> <span class="o">=</span> <span class="sx">%w[text/css text/html application/javascript]</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept</span>              <span class="c1"># ['text/html', '*/*']</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept?</span> <span class="s1">'text/xml'</span>  <span class="c1"># true</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">preferred_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>   <span class="c1"># 'text/html'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span>                <span class="c1"># corpo da requisição enviado pelo cliente (veja abaixo)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">scheme</span>              <span class="c1"># "http"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">script_name</span>         <span class="c1"># "/exemplo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span>           <span class="c1"># "/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">port</span>                <span class="c1"># 80</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">request_method</span>      <span class="c1"># "GET"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">query_string</span>        <span class="c1"># ""</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">content_length</span>      <span class="c1"># tamanho do request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>          <span class="c1"># tipo de mídia of request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">host</span>                <span class="c1"># "exemplo.com"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">get?</span>                <span class="c1"># true (metodo similar para outros tipos de requisição)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">form_data?</span>          <span class="c1"># false</span>
  <span class="n">request</span><span class="p">[</span><span class="s2">"algum_ param"</span><span class="p">]</span>     <span class="c1"># valor do paramêtro 'algum_param'. [] é um atalho para o hash de parametros</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">referrer</span>            <span class="c1"># a referência do cliente ou '/'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">user_agent</span>          <span class="c1"># agente de usuário (usado por :agent condition)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">cookies</span>             <span class="c1"># hash dos cookies do browser</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>                <span class="c1"># isto é uma requisição ajax?</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">url</span>                 <span class="c1"># "http://exemplo.com/exemplo/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path</span>                <span class="c1"># "/exemplo/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">ip</span>                  <span class="c1"># endereço de IP do cliente</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">secure?</span>             <span class="c1"># false (seria true se a conexão fosse ssl)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">forwarded?</span>          <span class="c1"># true (se está rodando por um proxy reverso)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">env</span>                 <span class="c1"># raw env hash handed in by Rack</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Algumas opções, como <code class="highlighter-rouge">script_name</code> ou `path_info, podem ser escritas como:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s2">"/"</span> <span class="p">}</span>

<span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
  <span class="s2">"todas requisições acabam aqui"</span>
<span class="k">end</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">request.body</code> é uma ES ou um objeo StringIO:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">post</span> <span class="s2">"/api"</span> <span class="k">do</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">rewind</span>  <span class="c1"># em caso de algo já ter lido</span>
  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span>
  <span class="s2">"Oi </span><span class="si">#{</span><span class="n">data</span><span class="p">[</span><span class="s1">'nome'</span><span class="p">]</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Anexos</h3>

<p>Você pode usar o método auxiliar <code class="highlighter-rouge">attachment</code> para dizer ao navegador que a
reposta deve ser armazenada no disco no lugar de ser exibida no browser:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span> <span class="s2">"info.txt"</span>
  <span class="s2">"salve isso!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Trabalhando com Data e Hora</h3>

<p>O Sinatra oferece um método auxiliar <code class="highlighter-rouge">time_for</code> que gera um objeto Time do
valor dado. É também possível converter <code class="highlighter-rouge">DateTime</code>, <code class="highlighter-rouge">Date</code> e classes similares:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">&gt;</span> <span class="n">time_for</span><span class="p">(</span><span class="s1">'Dec 23, 2016'</span><span class="p">)</span>
  <span class="s2">"continua no tempo"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Esse método é usado internamente por <code class="highlighter-rouge">expires</code>, <code class="highlighter-rouge">last_modified</code> e akin. Você
pode portanto facilmente estender o comportamento desses métodos sobrescrevendo
<code class="highlighter-rouge">time_for</code> na sua aplicação:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">time_for</span><span class="p">(</span><span class="n">valor</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">valor</span>
    <span class="k">when</span> <span class="ss">:ontem</span> <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">when</span> <span class="ss">:amanha</span> <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">else</span> <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">last_modified</span> <span class="ss">:ontem</span>
  <span class="n">expires</span> <span class="ss">:amanha</span>
  <span class="s2">"oi"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Pesquisando por Arquivos de Template</h3>

<p>O método auxiliar <code class="highlighter-rouge">find_template</code> é usado para encontrar arquivos de template
para renderizar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">find_template</span> <span class="n">settings</span><span class="p">.</span><span class="nf">views</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:haml</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">arquivo</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"pode ser </span><span class="si">#{</span><span class="n">arquivo</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isso não é realmente útil. Mas é útil que você possa na verdade sobrescrever
esse método para conectar no seu próprio mecanismo de pesquisa. Por exemplo, se
você quer ser capaz de usar mais de um diretório de view:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="p">[</span><span class="s1">'views'</span><span class="p">,</span> <span class="s1">'templates'</span><span class="p">]</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">Array</span><span class="p">(</span><span class="n">views</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Outro exemplo seria utilizando diretórios diferentes para motores (engines)
diferentes:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="ss">:sass</span> <span class="o">=&gt;</span> <span class="s1">'views/sass'</span><span class="p">,</span> <span class="ss">:haml</span> <span class="o">=&gt;</span> <span class="s1">'templates'</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">'views'</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">views</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">engine</span> <span class="o">==</span> <span class="no">Tilt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">folder</span> <span class="o">||=</span> <span class="n">views</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span>
    <span class="k">super</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você pode facilmente embrulhar isso é uma extensão e compartilhar com outras
pessoas!</p>

<p>Perceba que <code class="highlighter-rouge">find_template</code> não verifica se o arquivo realmente existe. Ao
invés disso, ele chama o bloco dado para todos os caminhos possíveis. Isso não
significa um problema de perfomance, já que <code class="highlighter-rouge">render</code> irá usar <code class="highlighter-rouge">break</code> assim que
o arquivo é encontrado. Além disso, as localizações (e conteúdo) de templates
serão guardados na cache se você não estiver rodando no modo de
desenvolvimento. Você deve se lembrar disso se você escrever um método
realmente maluco.</p>

<h2>Configuração</h2>

<p>É possível e recomendado definir o código de status e o corpo da resposta com o
valor retornado do bloco da rota. Entretanto, em alguns cenários você pode
querer definir o corpo em um ponto arbitrário do fluxo de execução. Você pode
fazer isso com o metódo auxiliar <code class="highlighter-rouge">body</code>. Se você fizer isso, poderá usar esse
metódo de agora em diante para acessar o body:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">body</span> <span class="s2">"bar"</span>
<span class="k">end</span>

<span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">body</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também é possivel passar um bloco para <code class="highlighter-rouge">body</code>, que será executado pelo
manipulador Rack (isso pode ser usado para implementar transmissão,
<a href="#retorno-de-valores">veja “Retorno de Valores”</a>).</p>

<p>Similar ao corpo, você pode também definir o código de status e cabeçalhos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span> <span class="mi">418</span>
  <span class="n">headers</span> <span class="p">\</span>
    <span class="s2">"Allow"</span> <span class="o">=&gt;</span> <span class="s2">"BREW, POST, GET, PROPFIND, WHEN"</span>
    <span class="s2">"Refresh"</span> <span class="o">=&gt;</span> <span class="s2">"Refresh: 20; https://ietf.org/rfc/rfc2324.txt"</span>
  <span class="n">body</span> <span class="s2">"Eu sou um bule de chá!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Assim como <code class="highlighter-rouge">body</code>, <code class="highlighter-rouge">headers</code> e <code class="highlighter-rouge">status</code> sem argumentos podem ser usados para
acessar seus valores atuais.</p>

<h3>Transmitindo Respostas</h3>

<p>As vezes você quer começar a mandar dados enquanto está gerando partes do corpo
da resposta. Em exemplos extremos, você quer continuar enviando dados até o
cliente encerrar a conexão. Você pode usar o método auxiliar <code class="highlighter-rouge">stream</code> para
evitar criar seu próprio empacotador:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stream</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"Isso será len -</span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">" Aguarde </span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">" dário!</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isso permite você implementar APIs de Transmissão,
<a href="https://w3c.github.io/eventsource/">Eventos Enviados pelo Servidor</a>, e pode
ser usado como a base para
<a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>. Pode ser usado também
para aumentar a taxa de transferência se algum, mas não todo, conteúdo depender
de um recurso lento.</p>

<p>Perceba que o comportamento da transmissão, especialmente o número de
requisições concorrentes, depende altamente do servidor web usado para servir a
aplicação. Alguns servidores podem até mesmo não suportar transmissão de
maneira alguma. Se o servidor não suportar transmissão, o corpo será enviado
completamente após que o bloco passado para <code class="highlighter-rouge">stream</code> terminar de executar.
Transmissão não funciona de nenhuma maneira com Shotun.</p>

<p>Se o parâmetro opcional é definido como <code class="highlighter-rouge">keep_open</code>, ele não chamará <code class="highlighter-rouge">close</code> no
objeto transmitido, permitindo você a fecha-lo em algum outro ponto futuro no
fluxo de execução. Isso funciona apenas em servidores orientados a eventos,
como Thin e Rainbows. Outros servidores irão continuar fechando a transmissão:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># long polling</span>

<span class="n">set</span> <span class="ss">:server</span><span class="p">,</span> <span class="ss">:thin</span>
<span class="n">conexoes</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">get</span> <span class="s1">'/assinar'</span> <span class="k">do</span>
  <span class="c1"># registra o interesse de um cliente em servidores de eventos</span>
  <span class="n">stream</span><span class="p">(</span><span class="ss">:keep_open</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">saida</span><span class="o">|</span>
    <span class="n">conexoes</span> <span class="o">&lt;&lt;</span> <span class="n">saida</span>
    <span class="c1"># retire conexões mortas</span>
    <span class="n">conexoes</span><span class="p">.</span><span class="nf">reject!</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:closed?</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/:messagem'</span> <span class="k">do</span>
  <span class="n">conexoes</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">saida</span><span class="o">|</span>
    <span class="c1"># notifica o cliente que uma nova mensagem chegou</span>
    <span class="n">saida</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'messagem'</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>

    <span class="c1"># indica ao cliente para se conectar novamente</span>
    <span class="n">saida</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>

  <span class="c1"># confirma</span>
  <span class="s2">"messagem recebida"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também é possivel para o cliente fechar a conexão quando está tentando escrever
para o socket. Devido a isso, é recomendado checar <code class="highlighter-rouge">out.closed?</code> antes de
tentar escrever.</p>

<h3>Usando Logs</h3>

<p>No escopo da requisição, o método auxiliar <code class="highlighter-rouge">logger</code> expõe uma instância
<code class="highlighter-rouge">Logger</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"loading data"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Esse logger irá automaticamente botar as configurações de log do manipulador
Rack na sua conta. Se a produção de logs estiver desabilitads, esse método
retornará um objeto dummy, então você não terá que se preocupar com suas rotas
e filtros.</p>

<p>Perceba que a produção de logs está habilitada apenas para
<code class="highlighter-rouge">Sinatra::Application</code> por padrão, então se você herdar de <code class="highlighter-rouge">Sinatra::Base</code>,
você provavelmente irá querer habilitar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code>  <span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
    <span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
      <span class="n">enable</span> <span class="ss">:logging</span>
    <span class="k">end</span>
  <span class="k">end</span>
</code></pre>
</div>

<p>Para evitar que qualquer middleware de logs seja configurado, defina a
configuração <code class="highlighter-rouge">logging</code> como <code class="highlighter-rouge">nil</code>. Entretanto, tenha em mente que <code class="highlighter-rouge">logger</code>
retornará, nesse caso, <code class="highlighter-rouge">nil</code>. Um caso de uso comum é quando você quer definir
seu próprio logger. Sinatra irá usar qualquer um que ele achar em
<code class="highlighter-rouge">env['rack.logger']</code></p>

<h3>Tipos Mime</h3>

<p>Quando se está usando <code class="highlighter-rouge">send_file</code> ou arquivos estáticos, você pode ter tipos
Mime que o Sinatra não entende. Use <code class="highlighter-rouge">mime_type</code> para registrá-los pela extensão
do arquivo:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">mime_type</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'text/foo'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você pode utilizar também com o método auxiliar <code class="highlighter-rouge">content_type</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">content</span><span class="o">-</span><span class="n">type</span> <span class="ss">:foo</span>
  <span class="s2">"foo foo foo"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Gerando URLs</h3>

<p>Para gerar URLs você deve usar o metódo auxiliar <code class="highlighter-rouge">url</code> no Haml:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">a</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s1">'/foo'</span><span class="p">)}</span> <span class="n">foo</span>
</code></pre>
</div>

<p>Isso inclui proxies reversos e rotas Rack, se presentes.</p>

<p>Esse método é também apelidado para <code class="highlighter-rouge">to</code> (veja
<a href="#redirecionamento-do-browser">abaixo</a> para um exemplo).</p>

<h3>Redirecionamento do Browser</h3>

<p>Você pode lançar um redirecionamento no browser com o metódo auxiliar
<code class="highlighter-rouge">redirect</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Quaisquer paramêtros adicionais são interpretados como argumentos passados ao
<code class="highlighter-rouge">halt</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">),</span> <span class="mi">303</span>
<span class="n">redirect</span> <span class="s1">'http://www.google.com/'</span><span class="p">,</span> <span class="s1">'lugar errado, amigo'</span>
</code></pre>
</div>

<p>Você pode também facilmente redirecionar para a página da qual o usuário veio
com <code class="highlighter-rouge">redirect back</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="s2">"&lt;a href='/bar'&gt;do something&lt;/a&gt;"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">do_something</span>
  <span class="n">redirect</span> <span class="n">back</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Para passar argumentos com um redirecionamento, adicione-os a query:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar?sum=42'</span><span class="p">)</span>
</code></pre>
</div>

<p>Ou use uma sessão:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'foo'</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Controle de Cache</h3>

<p>Definir sues cabeçalhos corretamente é o principal passo para uma correta cache
HTTP.</p>

<p>Você pode facilmente definir o cabeçalho de Cache-Control como:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span>
  <span class="s2">"guarde isso!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dica profissional: Configure a cache em um filtro anterior:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">60</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Se você está usando o método auxiliar <code class="highlighter-rouge">expires</code> para definir seu cabeçalho
correspondente, <code class="highlighter-rouge">Cache-Control</code> irá ser definida automaticamente para você:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">expires</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Para usar propriciamente caches, você deve considerar usar <code class="highlighter-rouge">etag</code> ou
<code class="highlighter-rouge">last_modified</code>. É recomendado chamar esses métodos auxiliares <em>antes</em> de fazer
qualquer tipo de processamento pesado, já que eles irão imediatamente retornar
uma resposta se o cliente já possui a versão atual na sua cache:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s2">"/artigo/:id"</span> <span class="k">do</span>
  <span class="vi">@artigo</span> <span class="o">=</span> <span class="no">Artigo</span><span class="p">.</span><span class="nf">find</span> <span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
  <span class="n">last_modified</span> <span class="vi">@artigo</span><span class="p">.</span><span class="nf">updated_at</span>
  <span class="n">etag</span> <span class="vi">@artigo</span><span class="p">.</span><span class="nf">sha1</span>
  <span class="n">erb</span> <span class="ss">:artigo</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também é possível usar uma
<a href="https://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation">ETag fraca</a>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span><span class="p">,</span> <span class="ss">:weak</span>
</code></pre>
</div>
<p>Esses métodos auxiliares não irão fazer nenhum processo de cache para você, mas
irão alimentar as informações necessárias para sua cache. Se você está
pesquisando por uma solução rápida de fazer cache com proxy-reverso, tente
<a href="https://github.com/rtomayko/rack-cache#readme">rack-cache</a>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s2">"rack/cache"</span>
<span class="nb">require</span> <span class="s2">"sinatra"</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cache</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">36000</span>
  <span class="nb">sleep</span> <span class="mi">5</span>
  <span class="s2">"olá"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Use a configuração <code class="highlighter-rouge">:static_cache_control</code> (veja [acima]#(controle-de-cache))
para adicionar o cabeçalho de informação <code class="highlighter-rouge">Cache-Control</code> para arquivos
estáticos.</p>

<p>De acordo com a RFC 2616, sua aplicação deve se comportar diferentemente se o
cabeçalho If-Match ou If-None-Match é definido para <code class="highlighter-rouge">*</code>, dependendo se o
recurso requisitado já existe. Sinatra assume que recursos para requisições
seguras (como get) e idempotentes (como put) já existem, enquanto que para
outros recursos (por exemplo requisições post) são tratados como novos
recursos. Você pode mudar esse comportamento passando em uma opção
<code class="highlighter-rouge">:new_resource</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/create'</span> <span class="k">do</span>
  <span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="no">Artigo</span><span class="p">.</span><span class="nf">create</span>
  <span class="n">erb</span> <span class="ss">:novo_artigo</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Se você quer continuar usando um ETag fraco, passe em uma opção <code class="highlighter-rouge">:kind</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="ss">:weak</span>
</code></pre>
</div>

<h3>Enviando Arquivos</h3>

<p>Para retornar os conteúdos de um arquivo como as resposta, você pode usar o
metódo auxiliar <code class="highlighter-rouge">send_file</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">send_file</span> <span class="s1">'foo.png'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Também aceita opções:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">send_file</span> <span class="s1">'foo.png'</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:jpg</span>
</code></pre>
</div>

<p>As opções são:</p>

<dl>
  <dt>filename</dt>
    <dd>Nome do arquivo a ser usado na respota,
    o padrão é o nome do arquivo reak</dd>
  <dt>last_modified</dt>
    <dd>Valor do cabeçalho Last-Modified, o padrão corresponde ao mtime do
    arquivo.</dd>

  <dt>type</dt>
    <dd>Valor do cabeçalho Content-Type, extraído da extensão do arquivo se
    inexistente.</dd>

  <dt>disposition</dt>
    <dd>
      Valor do cabeçalho Content-Disposition, valores possíveis: <tt>nil</tt>
      (default), <tt>:attachment</tt> and <tt>:inline</tt>
    </dd>

  <dt>length</dt>
    <dd>Valor do cabeçalho Content-Length, o padrão corresponde ao tamanho do
    arquivo.</dd>

  <dt>status</dt>
    <dd>
      Código de status a ser enviado. Útil quando está se enviando um arquivo
      estático como uma página de erro. Se suportado pelo handler do Rack,
      outros meios além de transmissão do processo do Ruby serão usados.
      So você usar esse metódo auxiliar, o Sinatra irá automaticamente lidar
      com requisições de alcance.
    </dd>
</dl>

<h3>Acessando o Objeto da Requisção</h3>

<p>O objeto vindo da requisição pode ser acessado do nível de requsição (filtros,
rotas, manipuladores de erro) através do método <code class="highlighter-rouge">request</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app rodando em http://exemplo.com/exemplo</span>
<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">t</span> <span class="o">=</span> <span class="sx">%w[text/css text/html application/javascript]</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept</span>              <span class="c1"># ['text/html', '*/*']</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept?</span> <span class="s1">'text/xml'</span>  <span class="c1"># true</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">preferred_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>   <span class="c1"># 'text/html'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span>                <span class="c1"># corpo da requisição enviado pelo cliente (veja abaixo)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">scheme</span>              <span class="c1"># "http"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">script_name</span>         <span class="c1"># "/exemplo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span>           <span class="c1"># "/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">port</span>                <span class="c1"># 80</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">request_method</span>      <span class="c1"># "GET"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">query_string</span>        <span class="c1"># ""</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">content_length</span>      <span class="c1"># tamanho do request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>          <span class="c1"># tipo de mídia of request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">host</span>                <span class="c1"># "exemplo.com"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">get?</span>                <span class="c1"># true (metodo similar para outros tipos de requisição)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">form_data?</span>          <span class="c1"># false</span>
  <span class="n">request</span><span class="p">[</span><span class="s2">"algum_ param"</span><span class="p">]</span>     <span class="c1"># valor do paramêtro 'algum_param'. [] é um atalho para o hash de parametros</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">referrer</span>            <span class="c1"># a referência do cliente ou '/'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">user_agent</span>          <span class="c1"># agente de usuário (usado por :agent condition)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">cookies</span>             <span class="c1"># hash dos cookies do browser</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>                <span class="c1"># isto é uma requisição ajax?</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">url</span>                 <span class="c1"># "http://exemplo.com/exemplo/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path</span>                <span class="c1"># "/exemplo/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">ip</span>                  <span class="c1"># endereço de IP do cliente</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">secure?</span>             <span class="c1"># false (seria true se a conexão fosse ssl)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">forwarded?</span>          <span class="c1"># true (se está rodando por um proxy reverso)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">env</span>                 <span class="c1"># raw env hash handed in by Rack</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Algumas opções, como <code class="highlighter-rouge">script_name</code> ou `path_info, podem ser escritas como:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s2">"/"</span> <span class="p">}</span>

<span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
  <span class="s2">"todas requisições acabam aqui"</span>
<span class="k">end</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">request.body</code> é uma ES ou um objeo StringIO:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">post</span> <span class="s2">"/api"</span> <span class="k">do</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">rewind</span>  <span class="c1"># em caso de algo já ter lido</span>
  <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span>
  <span class="s2">"Oi </span><span class="si">#{</span><span class="n">data</span><span class="p">[</span><span class="s1">'nome'</span><span class="p">]</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Anexos</h3>

<p>Você pode usar o método auxiliar <code class="highlighter-rouge">attachment</code> para dizer ao navegador que a
reposta deve ser armazenada no disco no lugar de ser exibida no browser:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span> <span class="s2">"info.txt"</span>
  <span class="s2">"salve isso!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Trabalhando com Data e Hora</h3>

<p>O Sinatra oferece um método auxiliar <code class="highlighter-rouge">time_for</code> que gera um objeto Time do
valor dado. É também possível converter <code class="highlighter-rouge">DateTime</code>, <code class="highlighter-rouge">Date</code> e classes similares:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">&gt;</span> <span class="n">time_for</span><span class="p">(</span><span class="s1">'Dec 23, 2016'</span><span class="p">)</span>
  <span class="s2">"continua no tempo"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Esse método é usado internamente por <code class="highlighter-rouge">expires</code>, <code class="highlighter-rouge">last_modified</code> e akin. Você
pode portanto facilmente estender o comportamento desses métodos sobrescrevendo
<code class="highlighter-rouge">time_for</code> na sua aplicação:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">time_for</span><span class="p">(</span><span class="n">valor</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">valor</span>
    <span class="k">when</span> <span class="ss">:ontem</span> <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">when</span> <span class="ss">:amanha</span> <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">else</span> <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">last_modified</span> <span class="ss">:ontem</span>
  <span class="n">expires</span> <span class="ss">:amanha</span>
  <span class="s2">"oi"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Pesquisando por Arquivos de Template</h3>

<p>O método auxiliar <code class="highlighter-rouge">find_template</code> é usado para encontrar arquivos de template
para renderizar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">find_template</span> <span class="n">settings</span><span class="p">.</span><span class="nf">views</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:haml</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">arquivo</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"pode ser </span><span class="si">#{</span><span class="n">arquivo</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isso não é realmente útil. Mas é útil que você possa na verdade sobrescrever
esse método para conectar no seu próprio mecanismo de pesquisa. Por exemplo, se
você quer ser capaz de usar mais de um diretório de view:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="p">[</span><span class="s1">'views'</span><span class="p">,</span> <span class="s1">'templates'</span><span class="p">]</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">Array</span><span class="p">(</span><span class="n">views</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Outro exemplo seria utilizando diretórios diferentes para motores (engines)
diferentes:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="ss">:sass</span> <span class="o">=&gt;</span> <span class="s1">'views/sass'</span><span class="p">,</span> <span class="ss">:haml</span> <span class="o">=&gt;</span> <span class="s1">'templates'</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">'views'</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">views</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">engine</span> <span class="o">==</span> <span class="no">Tilt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">folder</span> <span class="o">||=</span> <span class="n">views</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span>
    <span class="k">super</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você pode facilmente embrulhar isso é uma extensão e compartilhar com outras
pessoas!</p>

<p>Perceba que <code class="highlighter-rouge">find_template</code> não verifica se o arquivo realmente existe. Ao
invés disso, ele chama o bloco dado para todos os caminhos possíveis. Isso não
significa um problema de perfomance, já que <code class="highlighter-rouge">render</code> irá usar <code class="highlighter-rouge">break</code> assim que
o arquivo é encontrado. Além disso, as localizações (e conteúdo) de templates
serão guardados na cache se você não estiver rodando no modo de
desenvolvimento. Você deve se lembrar disso se você escrever um método
realmente maluco.</p>

<h2>Configuração</h2>

<p>Rode uma vez, na inicialização, em qualquer ambiente:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="c1"># configurando uma opção</span>
  <span class="n">set</span> <span class="ss">:option</span><span class="p">,</span> <span class="s1">'value'</span>

  <span class="c1"># configurando múltiplas opções</span>
  <span class="n">set</span> <span class="ss">:a</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="mi">2</span>

  <span class="c1"># o mesmo que `set :option, true`</span>
  <span class="n">enable</span> <span class="ss">:option</span>

  <span class="c1"># o mesmo que `set :option, false`</span>
  <span class="n">disable</span> <span class="ss">:option</span>

  <span class="c1"># você pode também ter configurações dinâmicas com blocos</span>
  <span class="n">set</span><span class="p">(</span><span class="ss">:css_dir</span><span class="p">)</span> <span class="p">{</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s1">'css'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Rode somente quando o ambiente (<code class="highlighter-rouge">APP_ENV</code> variável de ambiente) é definida para
<code class="highlighter-rouge">:production</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<p>Rode quando o ambiente é definido para <code class="highlighter-rouge">:production</code> ou <code class="highlighter-rouge">:test</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<p>Você pode acessar essas opções por meio de <code class="highlighter-rouge">settings</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo?</span> <span class="c1"># =&gt; true</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo</span>  <span class="c1"># =&gt; 'bar'</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<h3>Configurando proteção a ataques</h3>

<p>O Sinatra está usando
<a href="https://github.com/sinatra/sinatra/tree/master/rack-protection#readme">Rack::Protection</a>
para defender sua aplicação contra ataques oportunistas comuns. Você pode
facilmente desabilitar esse comportamento (o que irá abrir sua aplicação à
toneladas de vulnerabilidades comuns):</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">disable</span> <span class="ss">:protection</span>
</code></pre>
</div>

<p>Para pular uma única camada de defesa, defina <code class="highlighter-rouge">protection</code> como um hash de
opções:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="ss">:path_traversal</span>
</code></pre>
</div>

<p>Você também pode definir em um array, visando desabilitar uma lista de
proteções:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:path_traversal</span><span class="p">,</span> <span class="ss">:session_hijacking</span><span class="p">]</span>
</code></pre>
</div>

<p>Por padrão, o Sinatra irá configurar apenas sessões com proteção se <code class="highlighter-rouge">:sessions</code>
tiver sido habilitado. Veja ‘<a href="#utilizando-sess%C3%B5es">Utilizando Sessões</a>’. As
vezes você pode querer configurar sessões “fora” da aplicação do Sinatra, como
em config.ru ou com uma instância de <code class="highlighter-rouge">Rack::Builder</code> separada. Nesse caso, você
pode continuar configurando uma sessão com proteção passando a opção <code class="highlighter-rouge">:session</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>

<h3>Configurações Disponíveis</h3>

<dl>
  <dt>absolute_redirects</dt>
    <dd>
      Se desabilitada, o Sinatra irá permitir redirecionamentos relativos,
      entretanto, isso não estará conforme a RFC 2616 (HTTP 1.1), que permite
      apenas redirecionamentos absolutos.
    </dd>
    <dd>
      Habilite se sua aplicação estiver rodando antes de um proxy reverso que
      não foi configurado corretamente. Note que o método auxiliar <tt>url</tt>
      irá continuar produzindo URLs absolutas, a não ser que você passe
      <tt>false</tt> como segundo parâmetro.
    </dd>
    <dd>Desabilitado por padrão.</dd>

  <dt>add_charset</dt>
    <dd>
      Para tipos Mime o método auxiliar <tt>content_type</tt> irá
      automaticamente adicionar a informção de codificação. Você deve adcionar
      isto no lugar de sobrescrever essa opção:
      <tt>settings.add_charset &lt;&lt; "application/foobar"</tt>
    </dd>

  <dt>app_file</dt>
    <dd>
      Caminho para o arquivo principal da aplicação, usado para detectar a raíz
      do projeto, views e pastas públicas e templates inline.
    </dd>

  <dt>bind</dt>
    <dd>
      Endereço IP a ser ligado (padrão: <tt>0.0.0.0</tt> ou <tt>localhost</tt>
      se seu ambiente está definido como desenvolvimento). Usado apenas para
      servidor embutido.
    </dd>

  <dt>default_encoding</dt>
    <dd>Codificação assumida caso a mesma seja desconhecida (padrão corresponde
    a <tt>"utf-8"</tt>).</dd>

  <dt>dump_errors</dt>
    <dd>Exibe erros no log.</dd>

  <dt>environment</dt>
    <dd>
      Ambiente atual. O padrão é <tt>ENV['APP_ENV']</tt>, ou
      <tt>"development"</tt> se o primeiro não estiver disponível.
    </dd>

  <dt>logging</dt>
    <dd>Usa o logger.</dd>

  <dt>lock</dt>
    <dd>
      Coloca um bloqueio em torno de cada requisição, executando apenas
      processamento sob requisição por processo Ruby simultaneamente.
    </dd>
    <dd>Habilitado se sua aplicação não for 'thread-safe'. Desabilitado por
    padrão.</dd>

  <dt>method_override</dt>
    <dd>
      Use a mágica <tt>_method</tt> para permitir formulários put/delete em
      navegadores que não oferecem suporte à essas operações.
    </dd>

  <dt>mustermann_opts</dt>
    <dd>
      Um hash de opções padrão para passar a Mustermann.new quando se está
      compilado os caminho de roteamento.
    </dd>

  <dt>port</dt>
    <dd>Porta a ser escutada. Usado apenas para servidores embutidos.</dd>

  <dt>prefixed_redirects</dt>
    <dd>
      Inserir ou não inserir <tt>request.script_name</tt> nos redirecionamentos
      se nenhum caminho absoluto for dado. Dessa forma <tt>redirect '/foo'</tt>
      irá se comportar como <tt>redirect to('/foo').</tt>
    </dd>
    <dd>Desabilitado por padrão.</dd>

  <dt>protection</dt>
    <dd>
      Habilitar ou não proteções a ataques web. Veja a sessão de proteção acima.
    </dd>

  <dt>public_dir</dt>
    <dd>Apelido para <tt>public_folder</tt>. Veja abaixo.</dd>

  <dt>public_folder</dt>
    <dd>
      Caminho para o diretório de arquivos públicos. Usado apenas se a exibição
      de arquivos estáticos estiver habilitada (veja a configuração
      <tt>static</tt> abaixo). Deduzido da configuração <tt>app_file</tt> se
      não for definido.
    </dd>

  <dt>quiet</dt>
    <dd>
      Desabilita logs gerados pelos comandos de inicio e parada do Sinatra.
      <tt>false</tt> por padrão.
    </dd>

  <dt>reload_templates</dt>
    <dd>
      Se deve ou não recarregar templates entre as requisições. Habilitado no
      modo de desenvolvimento.
    </dd>

  <dt>root</dt>
    <dd>
      Caminho para o diretório raíz do projeto. Deduzido da configuração
      <tt>app_file</tt> se não for definido.
    </dd>

  <dt>raise_errors</dt>
    <dd>
      Lança exceções (irá para a aplicação). Habilitado por padrão quando o
      ambiente está definido para <tt>"test</tt>, desabilitado em caso
      contrário.
    </dd>

  <dt>run</dt>
    <dd>
      Se habilitado, o Sinatra irá lidar com o início do servidor web. Não
      habilite se estiver usando rackup ou outros meios.
    </dd>

  <dt>running</dt>
    <dd>É o servidor embutido que está rodando agora? Não mude essa
    configuração!</dd>

  <dt>server</dt>
    <dd>
      Servidor ou listas de servidores para usar o servidor embutido. A ordem
      indica prioridade, por padrão depende da implementação do Ruby
    </dd>

  <dt>server_settings</dt>
    <dd>
      Se você estiver usando um servidor web WEBrick, presumidamente para seu
      ambiente de desenvolvimento, você pode passar um hash de opções para
      <tt>server_settings</tt>, tais como <tt>SSLEnable</tt> ou
      <tt>SSLVerifyClient</tt>. Entretanto, servidores web como Puma e Thin não
      suportam isso, então você pode definir <tt>server_settings</tt> como um
      metódo quando chamar <tt>configure</tt>.
    </dd>

  <dt>sessions</dt>
    <dd>
      Habilita o suporte a sessões baseadas em cookie usando
      <tt>Rack::Session::Cookie</tt>. Veja a seção 'Usando Sessões' para mais
      informações.
    </dd>

  <dt>session_store</dt>
    <dd>
      O middleware de sessão Rack usado. O padrão é
      <tt>Rack::Session::Cookie</tt>. Veja a sessão 'Usando Sessões' para mais
      informações.
    </dd>

  <dt>show_exceptions</dt>
    <dd>
      Mostra um relatório de erros no navegador quando uma exceção ocorrer.
      Habilitado por padrão quando o <tt>ambiente</tt> é definido como
      <tt>"development"</tt>, desabilitado caso contrário.
    </dd>
    <dd>
      Pode também ser definido para <tt>:after_handler</tt> para disparar um
      manipulador de erro específico da aplicação antes de mostrar um relatório
      de erros no navagador.
    </dd>

  <dt>static</dt>
    <dd>
    Define se o Sinatra deve lidar com o oferecimento de arquivos
    estáticos.
    </dd>
    <dd>
    Desabilitado quando está utilizando um servidor capaz de fazer isso
    sozinho.
    </dd>
    <dd>Desabilitar irá aumentar a perfomance</dd>
    <dd>
      Habilitado por padrão no estilo clássico, desabilitado para aplicações
      modulares.
    </dd>

  <dt>static_cache_control</dt>
    <dd>
      Quando o Sinatra está oferecendo arquivos estáticos, definir isso irá
      adicionar cabeçalhos <tt>Cache-Control</tt> nas respostas. Usa o método
      auxiliar <tt>cache-control</tt>. Desabilitado por padrão.
    </dd>
    <dd>
      Use um array explícito quando estiver definindo múltiplos valores:
      <tt>set :static_cache_control, [:public, :max_age =&gt; 300]</tt>
    </dd>

  <dt>threaded</dt>
    <dd>
      Se estiver definido como <tt>true</tt>, irá definir que o Thin use
      <tt>EventMachine.defer</tt> para processar a requisição.
    </dd>

  <dt>traps</dt>
    <dd>Define se o Sinatra deve lidar com sinais do sistema.</dd>

  <dt>views</dt>
    <dd>
      Caminho para o diretório de views. Deduzido da configuração
      <tt>app_file</tt> se não estiver definido.
    </dd>

  <dt>x_cascade</dt>
    <dd>
      Se deve ou não definir o cabeçalho X-Cascade se nenhuma rota combinar.
      Definido como padrão <tt>true</tt>
    </dd>
</dl>

<h2>Ambientes</h2>

<p>Existem três <code class="highlighter-rouge">environments</code> (ambientes) pré-definidos: <code class="highlighter-rouge">"development"</code>
(desenvolvimento), <code class="highlighter-rouge">"production"</code> (produção) e <code class="highlighter-rouge">"test"</code> (teste). Ambientes
podem ser definidos através da variável de ambiente <code class="highlighter-rouge">APP_ENV</code>. O valor padrão é
<code class="highlighter-rouge">"development"</code>. No ambiente <code class="highlighter-rouge">"development"</code> todos os templates são
recarregados entre as requisições e manipuladores especiais como <code class="highlighter-rouge">not_found</code> e
<code class="highlighter-rouge">error</code> exibem relatórios de erros no seu navegador. Nos ambientes de
<code class="highlighter-rouge">"production"</code> e <code class="highlighter-rouge">"test"</code>, os templates são guardos em cache por padrão.</p>

<p>Para rodar diferentes ambientes, defina a variável de ambiente <code class="highlighter-rouge">APP_ENV</code>:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code><span class="nv">APP_ENV</span><span class="o">=</span>production ruby minha_app.rb
</code></pre>
</div>

<p>Você pode usar métodos pré-definidos: <code class="highlighter-rouge">development?</code>, <code class="highlighter-rouge">test?</code> e <code class="highlighter-rouge">production?</code>
para checar a configuração atual de ambiente:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">settings</span><span class="p">.</span><span class="nf">development?</span>
    <span class="s2">"desenvolvimento!"</span>
  <span class="k">else</span>
    <span class="s2">"não está em desenvolvimento!"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Tratamento de Erros</h2>

<p>Manipuladores de erros rodam dentro do mesmo contexto como rotas e filtros
before, o que significa que você pega todos os “presentes” que eles têm para
oferecer, como <code class="highlighter-rouge">haml</code>, <code class="highlighter-rouge">erb</code>, <code class="highlighter-rouge">halt</code>, etc.</p>

<h3>Não Encontrado</h3>

<p>Quando uma exceção <code class="highlighter-rouge">Sinatra::NotFound</code> é lançada, ou o código de
status da reposta é 404, o manipulador <code class="highlighter-rouge">not_found</code> é invocado:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">not_found</span> <span class="k">do</span>
  <span class="s1">'Isto está longe de ser encontrado'</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Erro</h3>

<p>O manipulador <code class="highlighter-rouge">error</code> é invocado toda a vez que uma exceção é lançada a
partir de um bloco de rota ou um filtro. Note que em desenvolvimento, ele irá
rodar apenas se você tiver definido a opção para exibir exceções em
<code class="highlighter-rouge">:after_handler</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:show_exceptions</span><span class="p">,</span> <span class="ss">:after_handler</span>
</code></pre>
</div>

<p>O objeto da exceção pode ser
obtido a partir da variável Rack <code class="highlighter-rouge">sinatra.error</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="k">do</span>
  <span class="s1">'Desculpe, houve um erro desagradável - '</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Erros customizados:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="no">MeuErroCustomizado</span> <span class="k">do</span>
  <span class="s1">'Então que aconteceu foi...'</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Então, se isso acontecer:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">raise</span> <span class="no">MeuErroCustomizado</span><span class="p">,</span> <span class="s1">'alguma coisa ruim'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você receberá isso:</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>Então que aconteceu foi... alguma coisa ruim
~~~~`

Alternativamente, você pode instalar um manipulador de erro para um código
de status:

~~~~ruby
error 403 do
  'Accesso negado'
end

get '/secreto' do
  403
end
</code></pre>
</div>

<p>Ou um alcance:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="mi">400</span><span class="p">.</span><span class="nf">.</span><span class="mi">510</span> <span class="k">do</span>
  <span class="s1">'Boom'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>O Sinatra instala os manipuladores especiais <code class="highlighter-rouge">not_found</code> e <code class="highlighter-rouge">error</code>
quando roda sobre o ambiente de desenvolvimento para exibir relatórios de erros
bonitos e informações adicionais de “debug” no seu navegador.</p>

<h2>Rack Middleware</h2>

<p>O Sinatra roda no <a href="http://rack.github.io/">Rack</a>, uma interface
padrão mínima para frameworks web em Ruby. Um das capacidades mais
interessantes do Rack para desenvolver aplicativos é suporte a
“middleware” – componentes que ficam entre o servidor e sua aplicação
monitorando e/ou manipulando o request/response do HTTP para prover
vários tipos de funcionalidades comuns.</p>

<p>O Sinatra faz construtores pipelines do middleware Rack facilmente em um
nível superior utilizando o método <code class="highlighter-rouge">use</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'meu_middleware_customizado'</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Lint</span>
<span class="n">use</span> <span class="no">MeuMiddlewareCustomizado</span>

<span class="n">get</span> <span class="s1">'/ola'</span> <span class="k">do</span>
  <span class="s1">'Olá mundo'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>A semântica de <code class="highlighter-rouge">use</code> é idêntica aquela definida para a DSL
<a href="http://www.rubydoc.info/github/rack/rack/master/Rack/Builder">Rack::Builder</a>
(mais frequentemente utilizada para arquivos rackup). Por exemplo, o
método <code class="highlighter-rouge">use</code> aceita múltiplos argumentos/variáveis bem como blocos:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Auth</span><span class="o">::</span><span class="no">Basic</span> <span class="k">do</span> <span class="o">|</span><span class="n">usuario</span><span class="p">,</span> <span class="n">senha</span><span class="o">|</span>
  <span class="n">usuario</span> <span class="o">==</span> <span class="s1">'admin'</span> <span class="o">&amp;&amp;</span> <span class="n">senha</span> <span class="o">==</span> <span class="s1">'secreto'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>O Rack é distribuido com uma variedade de middleware padrões para logs,
debugs, rotas de URL, autenticação, e manipuladores de sessão. Sinatra
utilizada muitos desses componentes automaticamente baseando sobre
configuração, então, tipicamente você não tem <code class="highlighter-rouge">use</code> explicitamente.</p>

<p>Você pode achar middlwares utéis em
<a href="https://github.com/rack/rack/tree/master/lib/rack">rack</a>,
<a href="https://github.com/rack/rack-contrib#readme">rack-contrib</a>,
ou em <a href="https://github.com/rack/rack/wiki/List-of-Middleware">Rack wiki</a>.</p>

<h2>Testando</h2>

<p>Testes no Sinatra podem ser escritos utilizando qualquer biblioteca ou
framework de teste baseados no Rack.
<a href="http://gitrdoc.com/brynary/rack-test">Rack::Test</a> é recomendado:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'minha_aplicacao_sinatra'</span>
<span class="nb">require</span> <span class="s1">'minitest/autorun'</span>
<span class="nb">require</span> <span class="s1">'rack/test'</span>

<span class="k">class</span> <span class="nc">MinhaAplicacaoTeste</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">meu_test_default</span>
    <span class="n">get</span> <span class="s1">'/'</span>
    <span class="n">assert_equal</span> <span class="s1">'Ola Mundo!'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">teste_com_parametros</span>
    <span class="n">get</span> <span class="s1">'/atender'</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Frank'</span>
    <span class="n">assert_equal</span> <span class="s1">'Olá Frank!'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">bodymeet</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_com_ambiente_rack</span>
    <span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">'HTTP_USER_AGENT'</span> <span class="o">=&gt;</span> <span class="s1">'Songbird'</span>
    <span class="n">assert_equal</span> <span class="s2">"Você está utilizando o Songbird!"</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>NOTA: Se você está usando o Sinatra no estilo modular, substitua
`Sinatra::Application’ acima com o nome da classe da sua aplicação</p>

<h2>Sinatra::Base - Middleware, Bibliotecas e aplicativos modulares</h2>

<p>Definir sua aplicação em um nível superior de trabalho funciona bem para
micro aplicativos, mas tem consideráveis incovenientes na construção de
componentes reutilizáveis como um middleware Rack, metal Rails,
bibliotecas simples como um componente de servidor, ou mesmo extensões
Sinatra. A DSL de nível superior polui o espaço do objeto e assume um
estilo de configuração de micro aplicativos (exemplo: uma simples
arquivo de aplicação, diretórios <code class="highlighter-rouge">./public</code> e <code class="highlighter-rouge">./views</code>, logs, página de
detalhes de exceção, etc.). É onde o <code class="highlighter-rouge">Sinatra::Base</code> entra em jogo:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MinhaApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="kp">true</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>

  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Ola mundo!'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Os métodos disponíveis para subclasses <code class="highlighter-rouge">Sinatra::Base</code> são exatamente como
aqueles disponíveis via a DSL de nível superior. Aplicações de nível
mais alto podem ser convertidas para componentes <code class="highlighter-rouge">Sinatra::Base</code> com duas
modificações:</p>

<ul>
  <li>
    <p>Seu arquivo deve requerer <code class="highlighter-rouge">sinatra/base</code> ao invés de <code class="highlighter-rouge">sinatra</code>; caso
contrário, todos os métodos DSL do Sinatra são importados para o espaço de
nomes principal.</p>
  </li>
  <li>
    <p>Coloque as rotas da sua aplicação, manipuladores de erro, filtros e opções
numa subclasse de <code class="highlighter-rouge">Sinatra::Base</code>.</p>
  </li>
</ul>

<p><code class="highlighter-rouge">Sinatra::Base</code> é um quadro branco. Muitas opções são desabilitadas por
padrão, incluindo o servidor embutido. Veja <a href="http://www.sinatrarb.com/configuration.html">Opções e
Configurações</a> para
detalhes de opções disponíveis e seus comportamentos. Se você quer
comportamento mais similiar à quando você definiu sua aplicação em nível mais
alto (também conhecido como estilo Clássico), você pode usar subclasses de
<code class="highlighter-rouge">Sinatra::Application</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MinhaApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Olá mundo!'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Estilo Clássico vs. Modular</h3>

<p>Ao contrário da crença comum, não há nada de errado com o estilo clássico. Se
encaixa com sua aplicação, você não tem que mudar para uma aplicação modular.</p>

<p>As desvantagens principais de usar o estilo clássico no lugar do estilo modular
é que você ira ter apenas uma aplicação Sinatra por processo Ruby. Se seu plano
é usar mais de uma, mude para o estilo modular. Não há nenhum impedimento para
você misturar os estilos clássico e modular.</p>

<p>Se vai mudar de um estilo para outro, você deve tomar cuidado com algumas
configurações diferentes:</p>

<table>
  <tr>
    <th>Configuração</th>
    <th>Clássico</th>
    <th>Modular</th>
    <th>Modular</th>
  </tr>

  <tr>
    <td>app_file</td>
    <td>arquivo carregando sinatra</td>
    <td>arquivo usando subclasse Sinatra::Base</td>
    <td>arquivo usando subclasse Sinatra::Application</td>
  </tr>

  <tr>
    <td>run</td>
    <td>$0 == app_file</td>
    <td>false</td>
    <td>false</td>
  </tr>

  <tr>
    <td>logging</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>method_override</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>inline_templates</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>static</td>
    <td>true</td>
    <td>File.exist?(public_folder)</td>
    <td>true</td>
  </tr>
</table>

<h3>Servindo uma Aplicação Modular:</h3>

<p>Existem duas opções comuns para começar uma aplicação modular, ativamente
começando com <code class="highlighter-rouge">run!</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># minha_app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MinhaApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ... código da aplicação aqui ...</span>

  <span class="c1"># inicie o servidor se o arquivo ruby foi executado diretamente</span>
  <span class="n">run!</span> <span class="k">if</span> <span class="n">app_file</span> <span class="o">==</span> <span class="vg">$0</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Inicie com with:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby minha_app.rb
</code></pre>
</div>

<p>Ou com um arquivo <code class="highlighter-rouge">config.ru</code>, que permite você usar qualquer manipulador Rack:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru (roda com rackup)</span>
<span class="nb">require</span> <span class="s1">'./minha_app'</span>
<span class="n">run</span> <span class="no">MinhaApp</span>
</code></pre>
</div>

<p>Rode:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>rackup -p 4567
</code></pre>
</div>

<h3>Usando uma Aplicação de Estilo Clássico com um config.ru:</h3>

<p>Escreva o arquivo da sua aplicação:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Olá mundo!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>E um <code class="highlighter-rouge">config.ru</code> correspondente:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'./app'</span>
<span class="n">run</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h3>Quando usar um config.ru?</h3>

<p>Um arquivo <code class="highlighter-rouge">config.ru</code> é recomendado se:</p>

<ul>
  <li>
    <p>Você quer lançar com um manipulador Rack diferente (Passenger, Unicorn,
Heroku, …).</p>
  </li>
  <li>Você quer usar mais de uma subclasse de <code class="highlighter-rouge">Sinatra::Base</code>.</li>
  <li>Você quer usar Sinatra apenas como middleware, mas não como um “endpoint”.</li>
</ul>

<p><strong>Não há necessidade de mudar para um <code class="highlighter-rouge">config.ru</code> simplesmente porque você mudou para o estilo modular, e você não tem que usar o estilo modular para rodar com um <code class="highlighter-rouge">config.ru</code>.</strong></p>

<h3>Usando Sinatra como Middleware</h3>

<p>O Sinatra não é capaz apenas de usar outro middleware Rack, qualquer aplicação
Sinatra pode ser adicionada na frente de qualquer “endpoint” Rack como
middleware. Esse endpoint pode ser outra aplicação Sinatra, ou qualquer outra
aplicação baseada em Rack (Rails/Hanami/Roda/…):</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">TelaLogin</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">enable</span> <span class="ss">:sessions</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span> <span class="p">{</span> <span class="n">haml</span> <span class="ss">:login</span> <span class="p">}</span>

  <span class="n">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">'nome'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'admin'</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'senha'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'admin'</span>
      <span class="n">session</span><span class="p">[</span><span class="s1">'nome_usuario'</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'nome'</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">redirect</span> <span class="s1">'/login'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MinhaApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># middleware irá rodar filtros before</span>
  <span class="n">use</span> <span class="no">TelaLogin</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">session</span><span class="p">[</span><span class="s1">'nome_usuario'</span><span class="p">]</span>
      <span class="n">halt</span> <span class="s2">"Acesso negado, por favor &lt;a href='/login'&gt;login&lt;/a&gt;."</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Olá </span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'nome_usuario'</span><span class="p">]</span><span class="si">}</span><span class="s2">."</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Criação de Aplicações Dinâmicas</h3>

<p>Às vezes, você quer criar novas aplicações em tempo de execução sem ter que
associa-las a uma constante. Você pode fazer isso com <code class="highlighter-rouge">Sinatra.new</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="n">minha_app</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"oi"</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">minha_app</span><span class="p">.</span><span class="nf">run!</span>
</code></pre>
</div>

<p>Isso leva a aplicação à herdar como um argumento opcional:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru (roda com rackup)</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">controller</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="ss">:logging</span>
  <span class="n">helpers</span> <span class="no">MeusHelpers</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/a'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'a'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/b'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'b'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Isso é especialmente útil para testar extensões do Sinatra ou usar Sinatra na
sua própria biblioteca.</p>

<p>Isso também faz o uso do Sinatra como middleware extremamente fácil:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">use</span> <span class="no">Sinatra</span> <span class="k">do</span>
  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">RailsProject</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h1>Escopos e Ligação</h1>

<p>O escopo que você está atualmente determina quais métodos e varáveis está
disponíveis.</p>

<h3>Escopo de Aplicação/Classe</h3>

<p>Toda aplicação Sinatra corresponde à um subclasse de <code class="highlighter-rouge">Sinatra::Base</code>. Se você
está utilizando a DSL de nível mais alto (<code class="highlighter-rouge">require 'sinatra</code>), então esta
classe é <code class="highlighter-rouge">Sinatra::Application</code>, caso contrário é a subclasse que você criou
explicitamente. No nível de classe você tem métodos como <code class="highlighter-rouge">get</code> ou <code class="highlighter-rouge">before</code>, mas
você não pode acessar os objetos <code class="highlighter-rouge">request</code> ou <code class="highlighter-rouge">session</code>, como existe apenas uma
única classe de aplicativo para todas as solicitações.</p>

<p>Opções criadas via <code class="highlighter-rouge">set</code> são métodos a nível de classe:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MinhaApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Hey, eu estou no escopo da aplicação!</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="mi">42</span>
  <span class="n">foo</span> <span class="c1"># =&gt; 42</span>

  <span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
    <span class="c1"># Hey, eu não estou mais no escopo da aplicação!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você tem a ligação ao escopo da aplicação dentro:</p>

<ul>
  <li>Do corpo da classe da sua aplicação</li>
  <li>De métodos definidos por extensões</li>
  <li>Do bloco passado a <code class="highlighter-rouge">helpers</code>
</li>
  <li>De Procs/Blocos usados como valor para <code class="highlighter-rouge">set</code>`</li>
  <li>Do bloco passado a <code class="highlighter-rouge">Sinatra.new</code>`</li>
</ul>

<p>Você pode atingir o escopo do objeto (a classe) de duas maneiras:</p>

<ul>
  <li>Por meio do objeto passado aos blocos “configure” (<code class="highlighter-rouge">configure { |c| ...}</code>)</li>
  <li>
<code class="highlighter-rouge">settings</code> de dentro do escopo da requisição</li>
</ul>

<h3>Escopo de Instância/Requisição</h3>

<p>Para toda requsição que chega, uma nova instância da classe da sua aplicação é
criada e todos blocos de manipulação rodam nesse escopo. Dentro desse escopo
você pode acessar os objetos <code class="highlighter-rouge">request</code> e <code class="highlighter-rouge">session</code> ou chamar métodos de
renderização como <code class="highlighter-rouge">erb</code> ou <code class="highlighter-rouge">haml</code>. Você pode acessar o escopo da aplicação de
dentro do escopo da requisição através do método auxiliar <code class="highlighter-rouge">settings</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MinhaApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Hey, eu estou no escopo da aplicação!</span>
  <span class="n">get</span> <span class="s1">'/define_rota/:nome'</span> <span class="k">do</span>
    <span class="c1"># Escopo da requisição para '/define_rota/:nome'</span>
    <span class="vi">@valor</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">settings</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"/</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'nome'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1"># Escopo da requisição para "/#{params['nome']}"</span>
      <span class="vi">@valor</span> <span class="c1"># =&gt; nil (não é a mesma requisição)</span>
    <span class="k">end</span>

    <span class="s2">"Rota definida!"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Você tem a ligação ao escopo da requisição dentro dos:</p>

<ul>
  <li>blocos get, head, post, put, delete, options, patch, link e unlink</li>
  <li>filtros after e before</li>
  <li>métodos “helper” (auxiliares)</li>
  <li>templates/views</li>
</ul>

<h3>Escopo de Delegação</h3>

<p>O escopo de delegação apenas encaminha métodos ao escopo da classe. Entretando,
ele não se comporta exatamente como o escopo da classse já que você não tem a
ligação da classe. Apenas métodos marcados explicitamente para delegação
estarão disponíveis e você não compartilha variáveis/estado com o escopo da
classe (leia: você tem um <code class="highlighter-rouge">self</code> diferente). Você pode explicitamente adicionar
delegações de métodos chamando <code class="highlighter-rouge">Sinatra::Delegator.delegate :method_name</code>.</p>

<p>Você tem a ligação com o escopo delegado dentro:</p>

<ul>
  <li>Da ligação de maior nível, se você digitou <code class="highlighter-rouge">require "sinatra"</code>
</li>
  <li>De um objeto estendido com o mixin <code class="highlighter-rouge">Sinatra::Delegator</code>
</li>
</ul>

<p>Dê uma olhada no código você mesmo: aqui está <a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/base.rb#L1609-1633">Sinatra::Delegator mixin</a> em <a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/main.rb#L28-30">estendendo o objeto principal</a>.</p>

<h2>Linha de Comando</h2>

<p>Aplicações Sinatra podem ser executadas diretamente:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby minhaapp.rb <span class="o">[</span>-h] <span class="o">[</span>-x] <span class="o">[</span>-q] <span class="o">[</span>-e AMBIENTE] <span class="o">[</span>-p PORTA] <span class="o">[</span>-o HOST] <span class="o">[</span>-s MANIPULADOR]
</code></pre>
</div>

<p>As opções são:</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>-h # ajuda
-p # define a porta (padrão é 4567)
-o # define o host (padrão é 0.0.0.0)
-e # define o ambiente (padrão é development)
-s # especifica o servidor/manipulador rack (padrão é thin)
-x # ativa o bloqueio mutex (padrão é desligado)
</code></pre>
</div>

<h3>Multi-threading</h3>

<p><em>Parafraseando <a href="resposta-so">esta resposta no StackOverflow</a> por Konstantin</em></p>

<p>Sinatra não impõe nenhum modelo de concorrencia, mas deixa isso como
responsabilidade do Rack (servidor) subjacente como o Thin, Puma ou WEBrick.
Sinatra por si só é thread-safe, então não há nenhum problema se um Rack
handler usar um modelo de thread de concorrência. Isso significaria que ao
iniciar o servidor, você teria que espeficiar o método de invocação correto
para o Rack handler específico. Os seguintes exemplos é uma demonstração de
como iniciar um servidor Thin multi-thread:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app.rb</span>

<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">App</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Olá mundo'</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">App</span><span class="p">.</span><span class="nf">run!</span>
</code></pre>
</div>

<p>Para iniciar o servidor seria:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>thin --threaded start
</code></pre>
</div>

<h2>Requerimentos</h2>

<p>As seguintes versões do Ruby são oficialmente suportadas:</p>
<dl>
  <dt>Ruby 2.2</dt>
  <dd>
    2.2 é totalmente suportada e recomendada. Atualmente não existem planos
    para para o suporte oficial para ela.
  </dd>

  <dt>Rubinius</dt>
  <dd>
    Rubinius é oficialmente suportado (Rubinius &gt;= 2.x). É recomendado rodar
    <tt>gem install puma</tt>.
  </dd>

  <dt>JRuby</dt>
  <dd>
    A útlima versão estável lançada do JRuby é oficialmente suportada. Não é
    recomendado usar extensões em C com o JRuby. É recomendado rodar
    <tt>gem install trinidad</tt>.
  </dd>
</dl>

<p>Versões do Ruby antes da 2.2.2 não são mais suportadas pelo Sinatra 2.0.</p>

<p>Nós também estamos de olhos em versões futuras do Ruby.</p>

<p>As seguintes implementações do Ruby não são oficialmente suportadas mas sabemos
que rodam o Sinatra:</p>

<ul>
  <li>Versões antigas do JRuby e Rubinius</li>
  <li>Ruby Enterprise Edition</li>
  <li>MacRuby, Maglev, IronRuby</li>
  <li>Ruby 1.9.0 e 1.9.1 (mas nós não recomendamos o uso dessas)</li>
</ul>

<p>Não ser oficialmente suportada significa que se algo quebrar e não estiver nas
plataformas suporta, iremos assumir que não é um problema nosso e sim das
plataformas.</p>

<p>Nós também rodas nossa IC sobre ruby-head (lançamentos futuros do MRI), mas nós
não podemos garantir nada, já que está em constante mudança. Espera-se que
lançamentos futuros da versão 2.x sejam totalmente suportadas.</p>

<p>Sinatra deve funcionar em qualquer sistema operacional suportado pela
implementação Ruby escolhida.</p>

<p>Se você rodar MacRuby, você deve rodar <code class="highlighter-rouge">gem install control_tower</code>.</p>

<p>O Sinatra atualmente não roda em Cardinal, SmallRuby, BlueRuby ou qualquer
versão do Ruby anterior ao 2.2.</p>

<h2>A última versão</h2>

<p>Se você gostaria de utilizar o código da última versão do Sinatra, sinta-se
livre para rodar a aplicação com o ramo master, ele deve ser estável.</p>

<p>Nós também lançamos pré-lançamentos de gems de tempos em tempos, então você
pode fazer:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra --pre
</code></pre>
</div>

<p>para obter alguma das últimas funcionalidades.</p>

<h3>Com Bundler</h3>

<p>Se você quer rodar sua aplicação com a última versão do Sinatra usando
<a href="https://bundler.io">Bundler</a> é recomendado fazer dessa forma.</p>

<p>Primeiramente, instale o Bundler, se você ainda não tiver:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install bundler
</code></pre>
</div>

<p>Então, no diretório do seu projeto, crie uma <code class="highlighter-rouge">Gemfile</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">gem</span> <span class="s1">'sinatra'</span><span class="p">,</span> <span class="ss">:github</span> <span class="o">=&gt;</span> <span class="s1">'sinatra/sinatra'</span>

<span class="c1"># outras dependências</span>
<span class="n">gem</span> <span class="s1">'haml'</span>                    <span class="c1"># por exemplo, se você usar haml</span>
</code></pre>
</div>

<p>Perceba que você terá que listar todas suas dependências de aplicação no
<code class="highlighter-rouge">Gemfile</code>. As dependências diretas do Sinatra (Rack e Tilt) irão, entretanto,
ser automaticamente recuperadas e adicionadas pelo Bundler.</p>

<p>Então você pode rodar sua aplicação assim:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>bundle <span class="nb">exec </span>ruby myapp.rb
</code></pre>
</div>

<h2>Versionando</h2>

<p>O Sinatras segue <a href="https://semver.org/">Versionamento Semântico</a>, tanto SemVer
como SemVerTag.</p>

<h2>Mais</h2>

<ul>
  <li>
<a href="http://www.sinatrarb.com/">Website do Projeto</a> - Documentação
adicional, novidades e links para outros recursos.</li>
  <li>
<a href="http://www.sinatrarb.com/contributing">Contribuir</a> - Encontrou um
bug? Precisa de ajuda? Tem um patch?</li>
  <li><a href="https://github.com/sinatra/sinatra/issues">Acompanhar Problemas</a></li>
  <li><a href="https://twitter.com/sinatra">Twitter</a></li>
  <li><a href="http://groups.google.com/group/sinatrarb/topics">Lista de Email</a></li>
  <li>
<a href="https://sinatrarb.slack.com">Sinatra &amp; Amigos</a> no Slack
(<a href="https://sinatra-slack.herokuapp.com/">consiga um convite</a>)</li>
  <li>
<a href="https://github.com/sinatra/sinatra-book/">Sinatra Book</a> - Livro de “Receitas”</li>
  <li>
<a href="http://recipes.sinatrarb.com/">Sinatra Recipes</a> - “Receitas” de
contribuições da comunidade</li>
  <li>Documentação da API para a
<a href="http://www.rubydoc.info/gems/sinatra">última release</a>
ou para o <a href="http://www.rubydoc.info/github/sinatra/sinatra">HEAD atual</a>
no <a href="http://www.rubydoc.info/">Ruby Doc</a>
</li>
  <li><a href="https://travis-ci.org/sinatra/sinatra">Servidor de CI</a></li>
</ul>
</body></html>
