<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>

<p><a href="http://travis-ci.org/sinatra/sinatra"><img src="https://secure.travis-ci.org/sinatra/sinatra.svg" alt="Build Status"></a></p>

<p><em>Wichtig: Dieses Dokument ist eine Übersetzung aus dem Englischen und unter
Umständen nicht auf dem aktuellen Stand (aktuell Sinatra 2.0
Vorabausgabe).</em></p>

<p>Sinatra ist eine
<a href="https://de.wikipedia.org/wiki/Dom%C3%A4nenspezifische_Sprache">DSL</a>, die das
schnelle Erstellen von Webanwendungen in Ruby mit minimalem Aufwand
ermöglicht:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># myapp.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Hallo Welt!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Sinatra-Gem installieren:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra
</code></pre>
</div>

<p>und im gleichen Verzeichnis ausführen:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby myapp.rb
</code></pre>
</div>

<p>Die Seite kann nun unter <a href="http://localhost:4567">http://localhost:4567</a>
aufgerufen werden.</p>

<p>Es wird empfohlen <code class="highlighter-rouge">gem installl thin</code> auszuführen, Sinatra wird dann
diesen Server verwenden.</p>

<h2>Inhalt</h2>



<h2>Routen</h2>

<p>In Sinatra wird eine Route durch eine HTTP-Methode und ein URL-Muster
definiert. Jeder dieser Routen wird ein Ruby-Block zugeordnet:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">zeige</span> <span class="n">etwas</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">erstelle</span> <span class="n">etwas</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">put</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">update</span> <span class="n">etwas</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">delete</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">entferne</span> <span class="n">etwas</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">options</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">zeige</span><span class="p">,</span> <span class="n">was</span> <span class="n">wir</span> <span class="n">k</span><span class="err">ö</span><span class="n">nnen</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">link</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">verbinde</span> <span class="n">etwas</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">unlink</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">trenne</span> <span class="n">etwas</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Die Routen werden in der Reihenfolge durchlaufen, in der sie definiert wurden.
Das erste Routen-Muster, das mit dem Request übereinstimmt, wird ausgeführt.</p>

<p>Routen mit angehängtem Schrägstrich unterscheiden sich von Routen ohne:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="c1"># wird nicht bei "GET /foo/" aufgerufen</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Die Muster der Routen können benannte Parameter beinhalten, die über den
<code class="highlighter-rouge">params</code>-Hash zugänglich gemacht werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/hallo/:name'</span> <span class="k">do</span>
  <span class="c1"># passt auf "GET /hallo/foo" und "GET /hallo/bar"</span>
  <span class="c1"># params['name'] ist dann 'foo' oder 'bar'</span>
  <span class="s2">"Hallo </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Man kann auf diese auch mit Block-Parametern zugreifen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/hallo/:name'</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="c1"># n entspricht hier params['name']</span>
  <span class="s2">"Hallo </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Routen-Muster können auch mit sog. Splat- oder Wildcard-Parametern über das
<code class="highlighter-rouge">params['splat']</code>-Array angesprochen werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/sag/*/zu/*'</span> <span class="k">do</span>
  <span class="c1"># passt z.B. auf /sag/hallo/zu/welt</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["hallo", "welt"]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/download/*.*'</span> <span class="k">do</span>
  <span class="c1"># passt auf /download/pfad/zu/datei.xml</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["pfad/zu/datei", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Oder mit Block-Parametern:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/download/*.*'</span> <span class="k">do</span> <span class="o">|</span><span class="n">pfad</span><span class="p">,</span> <span class="n">endung</span><span class="o">|</span>
  <span class="p">[</span><span class="n">pfad</span><span class="p">,</span> <span class="n">endung</span><span class="p">]</span> <span class="c1"># =&gt; ["Pfad/zu/Datei", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Routen mit regulären Ausdrücken sind auch möglich:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">/\/hallo\/([\w]+)/</span> <span class="k">do</span>
  <span class="s2">"Hallo, </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'captures'</span><span class="p">].</span><span class="nf">first</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Und auch hier können Block-Parameter genutzt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{/hallo/([</span><span class="se">\w</span><span class="sr">]+)}</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># erkennt "GET /hallo/frank" oder "GET /sag/hallo/frank" usw.</span>
  <span class="s2">"Hallo, </span><span class="si">#{</span><span class="n">c</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Routen-Muster können auch mit optionalen Parametern ausgestattet werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/posts/:format?'</span> <span class="k">do</span>
  <span class="c1"># passt auf "GET /posts/" sowie jegliche Erweiterung</span>
  <span class="c1"># wie "GET /posts/json", "GET /posts/xml" etc.</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Routen können auch den query-Parameter verwenden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/posts'</span> <span class="k">do</span>
  <span class="c1"># passt zu "GET /posts?title=foo&amp;author=bar"</span>
  <span class="n">title</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
  <span class="n">author</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'author'</span><span class="p">]</span>
  <span class="c1"># verwendet title- und author-Variablen. Der query-Parameter ist für</span>
  <span class="c1"># die /post-Route optional</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Anmerkung: Solange man den sog. Path Traversal Attack-Schutz nicht deaktiviert
(siehe weiter unten), kann es sein, dass der Request-Pfad noch vor dem
Abgleich mit den Routen modifiziert wird.</p>

<p>Die Mustermann-Optionen können für eine gegebene Route angepasst werden,
indem man der Route den <code class="highlighter-rouge">:mustermann_opts</code>-Hash mitgibt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'\A/posts\z'</span><span class="p">,</span> <span class="ss">:mustermann_opts</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:regexp</span><span class="p">,</span> <span class="ss">:check_anchors</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">}</span> <span class="k">do</span>
  <span class="c1"># Passt genau auf /posts mit explizitem Anchoring</span>
  <span class="s2">"Wenn Dein Anchor-Muster passt, darfst Du klatschen!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Das sieht zwar genauso aus wie eine Bedingung, ist es aber nicht. Diese
Option wird mit dem globalen <code class="highlighter-rouge">:mustermann_opts</code>-Hash zusammengeführt
(siehe weiter unten).</p>

<h3>Bedingungen</h3>

<p>An Routen können eine Vielzahl von Bedingungen geknüpft werden, die erfüllt
sein müssen, damit der Block ausgeführt wird. Möglich wäre etwa eine
Einschränkung des User-Agents über die interne Bedingung <code class="highlighter-rouge">:agent</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span><span class="p">,</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird (\d\.\d)[\d\/]*?/</span> <span class="k">do</span>
  <span class="s2">"Du verwendest Songbird Version </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'agent'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Wird Songbird als Browser nicht verwendet, springt Sinatra zur nächsten Route:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="c1"># passt auf andere Browser</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Andere verfügbare Bedingungen sind <code class="highlighter-rouge">:host_name</code> und <code class="highlighter-rouge">:provides</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="sr">/^admin\./</span> <span class="k">do</span>
  <span class="s2">"Adminbereich, Zugriff verweigert!"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="s1">'html'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'rss'</span><span class="p">,</span> <span class="s1">'atom'</span><span class="p">,</span> <span class="s1">'xml'</span><span class="p">]</span> <span class="k">do</span>
  <span class="n">builder</span> <span class="ss">:feed</span>
<span class="k">end</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">provides</code> durchsucht den Accept-Header der Anfrage</p>

<p>Eigene Bedingungen können relativ einfach hinzugefügt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:wahrscheinlichkeit</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">value</span><span class="o">|</span> <span class="n">condition</span> <span class="p">{</span> <span class="nb">rand</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="p">}</span> <span class="p">}</span>

<span class="n">get</span> <span class="s1">'/auto_gewinnen'</span><span class="p">,</span> <span class="ss">:wahrscheinlichkeit</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="k">do</span>
  <span class="s2">"Du hast gewonnen!"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/auto_gewinnen'</span> <span class="k">do</span>
  <span class="s2">"Tut mir leid, verloren."</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Bei Bedingungen, die mehrere Werte annehmen können, sollte ein Splat verwendet
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:auth</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">roles</span><span class="o">|</span> <span class="c1"># &lt;- hier kommt der Splat ins Spiel</span>
  <span class="n">condition</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">logged_in?</span> <span class="o">&amp;&amp;</span> <span class="n">roles</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">role</span><span class="o">|</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">in_role?</span> <span class="n">role</span> <span class="p">}</span>
      <span class="n">redirect</span> <span class="s2">"/login/"</span><span class="p">,</span> <span class="mi">303</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/mein/account/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">]</span> <span class="k">do</span>
  <span class="s2">"Mein Account"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/nur/admin/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="ss">:admin</span> <span class="k">do</span>
  <span class="s2">"Nur Admins dürfen hier rein!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Rückgabewerte</h3>

<p>Durch den Rückgabewert eines Routen-Blocks wird mindestens der Response-Body
festgelegt, der an den HTTP-Client, bzw. die nächste Rack-Middleware,
weitergegeben wird. Im Normalfall handelt es sich hierbei, wie in den
vorangehenden Beispielen zu sehen war, um einen String. Es werden allerdings
auch andere Werte akzeptiert.</p>

<p>Es kann jedes gültige Objekt zurückgegeben werden, bei dem es sich entweder um
einen Rack-Rückgabewert, einen Rack-Body oder einen HTTP-Status-Code handelt:</p>

<ul>
  <li>Ein Array mit drei Elementen: <code class="highlighter-rouge">[Status (Integer), Headers (Hash),
Response-Body (antwortet auf #each)]</code>.</li>
  <li>Ein Array mit zwei Elementen: <code class="highlighter-rouge">[Status (Integer), Response-Body (antwortet
auf #each)]</code>.</li>
  <li>Ein Objekt, das auf <code class="highlighter-rouge">#each</code> antwortet und den an diese Methode übergebenen
Block nur mit Strings als Übergabewerte aufruft.</li>
  <li>Ein Integer, das den Status-Code festlegt.</li>
</ul>

<p>Damit lässt sich relativ einfach Streaming implementieren:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Stream</span>
  <span class="k">def</span> <span class="nf">each</span>
    <span class="mi">100</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="k">yield</span> <span class="s2">"</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="no">Stream</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
</code></pre>
</div>

<p>Ebenso kann die <code class="highlighter-rouge">stream</code>-Helfer-Methode (s.u.) verwendet werden, die Streaming
direkt in die Route integriert.</p>

<h3>Eigene Routen-Muster</h3>

<p>Wie oben schon beschrieben, ist Sinatra von Haus aus mit Unterstützung für
String-Muster und Reguläre Ausdrücke zum Abgleichen von Routen ausgestattet.
Das muss aber noch nicht alles sein, es können ohne großen Aufwand eigene
Routen-Muster erstellt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">AllButPattern</span>
  <span class="nc">Match</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:captures</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">except</span><span class="p">)</span>
    <span class="vi">@except</span>   <span class="o">=</span> <span class="n">except</span>
    <span class="vi">@captures</span> <span class="o">=</span> <span class="no">Match</span><span class="p">.</span><span class="nf">new</span><span class="p">([])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="vi">@captures</span> <span class="k">unless</span> <span class="vi">@except</span> <span class="o">===</span> <span class="n">str</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">all_but</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
  <span class="no">AllButPattern</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="n">all_but</span><span class="p">(</span><span class="s2">"/index"</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Beachte, dass das obige Beispiel etwas übertrieben wirkt. Es geht auch
einfacher:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">//</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">==</span> <span class="s2">"/index"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Oder unter Verwendung eines negativen look ahead:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{(?!/index)}</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Statische Dateien</h2>

<p>Statische Dateien werden im <code class="highlighter-rouge">./public</code>-Ordner erwartet. Es ist möglich,
einen anderen Ort zu definieren, indem man die <code class="highlighter-rouge">:public_folder</code>-Option setzt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:public_folder</span><span class="p">,</span> <span class="n">__dir__</span> <span class="o">+</span> <span class="s1">'/static'</span>
</code></pre>
</div>

<p>Zu beachten ist, dass der Ordnername <code class="highlighter-rouge">public</code> nicht Teil der URL ist.
Die Datei <code class="highlighter-rouge">./public/css/style.css</code> ist unter
<code class="highlighter-rouge">http://example.com/css/style.css</code> zu finden.</p>

<p>Um den <code class="highlighter-rouge">Cache-Control</code>-Header mit Informationen zu versorgen, verwendet man
die <code class="highlighter-rouge">:static_cache_control</code>-Einstellung (s.u.).</p>

<h2>Views/Templates</h2>

<p>Alle Templatesprachen verwenden ihre eigene Renderingmethode, die jeweils
einen String zurückgibt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dieses Beispiel rendert <code class="highlighter-rouge">views/index.erb</code>.</p>

<p>Anstelle eines Templatenamens kann man auch direkt die Templatesprache
verwenden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">code</span> <span class="o">=</span> <span class="s2">"&lt;%= Time.now %&gt;"</span>
  <span class="n">erb</span> <span class="n">code</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Templates nehmen ein zweite Argument an, den Options-Hash:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:post</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dieses Beispiel rendert <code class="highlighter-rouge">views/index.erb</code> eingebettet in <code class="highlighter-rouge">views/post.erb</code>
(Voreinstellung ist <code class="highlighter-rouge">views/layout.erb</code>, sofern es vorhanden ist.)</p>

<p>Optionen, die Sinatra nicht versteht, werden an das Template weitergereicht:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:html5</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Für alle Templates können auch Einstellungen, die für alle Routen gelten,
festgelegt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:haml</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:html5</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Optionen, die an die Rendermethode weitergegeben werden, überschreiben die
Einstellungen, die mit <code class="highlighter-rouge">set</code> festgelegt wurden.</p>

<p>Einstellungen:</p>

<dl>
  <dt>locals</dt>
  <dd>Liste von lokalen Variablen, die an das Dokument weitergegeben werden.
    Praktisch für Partials:

    <tt>erb "&lt;%= foo %&gt;", :locals =&gt; {:foo =&gt; "bar"}</tt>
</dd>

  <dt>default_encoding</dt>
  <dd>Gibt die Stringkodierung an, die verwendet werden soll. Voreingestellt
    auf <tt>settings.default_encoding</tt>.</dd>

  <dt>views</dt>
  <dd>Ordner, aus dem die Templates geladen werden. Voreingestellt auf
    <tt>settings.views</tt>.</dd>

  <dt>layout</dt>
  <dd>Legt fest, ob ein Layouttemplate verwendet werden soll oder nicht
    (<tt>true</tt> oder<tt>false</tt>). Ist es ein Symbol, dann legt es fest,
    welches Template als Layout verwendet wird:

    <tt>erb :index, :layout =&gt; !request.xhr?</tt>
</dd>

  <dt>content_type</dt>
  <dd>Content-Typ den das Template ausgibt. Voreinstellung hängt von der
    Templatesprache ab.</dd>

  <dt>scope</dt>
  <dd>Scope, in dem das Template gerendert wird. Liegt standardmäßig innerhalb
    der App-Instanz. Wird Scope geändert, sind Instanzvariablen und
    Helfermethoden nicht verfügbar.</dd>

  <dt>layout_engine</dt>
  <dd>Legt fest, welcher Renderer für das Layout verantwortlich ist. Hilfreich
    für Sprachen, die sonst keine Templates unterstützen. Voreingestellt auf
    den Renderer, der für das Template verwendet wird:

    <tt>set :rdoc, :layout_engine =&gt; :erb</tt>
</dd>

  <dt>layout_options</dt>
  <dd>Besondere Einstellungen, die nur für das Rendering verwendet werden:

    <tt>set :rdoc, :layout_options =&gt; { :views =&gt; 'views/layouts' }</tt>
</dd>
</dl>

<p>Sinatra geht davon aus, dass die Templates sich im <code class="highlighter-rouge">./views</code> Verzeichnis
befinden. Es kann jedoch ein anderer Ordner festgelegt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="nf">root</span> <span class="o">+</span> <span class="s1">'/templates'</span>
</code></pre>
</div>

<p>Es ist zu beachten, dass immer mit Symbolen auf Templates verwiesen
werden muss, auch dann, wenn sie sich in einem Unterordner befinden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">haml</span> <span class="ss">:'unterverzeichnis/template'</span>
</code></pre>
</div>

<p>Wird einer Rendering-Methode ein String übergeben, wird dieser direkt
gerendert.</p>

<h3>Direkte Templates</h3>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Hallo Welt'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Hier wird der String direkt gerendert.</p>

<p>Optional kann <code class="highlighter-rouge">:path</code> und <code class="highlighter-rouge">:line</code> für einen genaueren Backtrace
übergeben werden, wenn mit dem vorgegebenen String ein Pfad im
Dateisystem oder eine Zeilennummer verbunden ist:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Hallo Welt'</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">'examples/datei.haml'</span><span class="p">,</span> <span class="ss">:line</span> <span class="o">=&gt;</span> <span class="mi">3</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Verfügbare Templatesprachen</h3>

<p>Einige Sprachen haben mehrere Implementierungen. Um festzulegen, welche
verwendet wird (und dann auch Thread-sicher ist), verwendet man am besten zu
Beginn ein <code class="highlighter-rouge">'require'</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rdiscount'</span> <span class="c1"># oder require 'bluecloth'</span>
<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="n">markdown</span> <span class="ss">:index</span> <span class="p">}</span>
</code></pre>
</div>

<h4>Haml Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://haml.info/">haml</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.haml</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>haml :index, :format =&gt; :html5</tt></td>
  </tr>
</table>

<h4>Erb Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td>
<a href="http://www.kuwata-lab.com/erubis/">erubis</a> oder erb
    (Standardbibliothek von Ruby)</td>
  </tr>
  <tr>
    <td>Dateierweiterungen</td>
    <td>
<tt>.erb</tt>, <tt>.rhtml</tt> oder <tt>.erubis</tt> (nur Erubis)</td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>erb :index</tt></td>
  </tr>
</table>

<h4>Builder Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://github.com/jimweirich/builder">builder</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.builder</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>builder { |xml| xml.em "Hallo" }</tt></td>
  </tr>
</table>

<p>Nimmt ebenso einen Block für Inline-Templates entgegen (siehe Beispiel).</p>

<h4>Nokogiri Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://www.nokogiri.org/">nokogiri</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.nokogiri</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>nokogiri { |xml| xml.em "Hallo" }</tt></td>
  </tr>
</table>

<p>Nimmt ebenso einen Block für Inline-Templates entgegen (siehe Beispiel).</p>

<h4>Sass Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://sass-lang.com/">sass</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.sass</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>sass :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>

<h4>SCSS Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://sass-lang.com/">sass</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.scss</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>scss :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>

<h4>Less Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://lesscss.org/">less</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.less</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>less :stylesheet</tt></td>
  </tr>
</table>

<h4>Liquid Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://shopify.github.io/liquid/">liquid</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.liquid</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>liquid :index, :locals =&gt; { :key =&gt; 'Wert' }</tt></td>
  </tr>
</table>

<p>Da man aus dem Liquid-Template heraus keine Ruby-Methoden aufrufen kann
(ausgenommen <code class="highlighter-rouge">yield</code>), wird man üblicherweise locals verwenden wollen, mit
denen man Variablen weitergibt.</p>

<h4>Markdown Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td>Eine der folgenden Bibliotheken:
        <a href="https://github.com/davidfstr/rdiscount" title="RDiscount">RDiscount</a>,
        <a href="https://github.com/vmg/redcarpet" title="RedCarpet">RedCarpet</a>,
        <a href="https://github.com/ged/bluecloth" title="bluecloth">BlueCloth</a>,
        <a href="http://kramdown.gettalong.org/" title="kramdown">kramdown</a> oder
        <a href="https://github.com/bhollis/maruku" title="maruku">maruku</a>
    </td>
  </tr>
  <tr>
    <td>Dateierweiterungen</td>
    <td>
<tt>.markdown</tt>, <tt>.mkd</tt> und <tt>.md</tt>
</td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>markdown :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Da man aus den Markdown-Templates heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Markdown üblicherweise in Kombination
mit anderen Renderern verwenden wollen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:einfuehrung</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Beachte, dass man die <code class="highlighter-rouge">markdown</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Gru</span><span class="err">ß</span> <span class="n">von</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:Gr</span><span class="err">üß</span><span class="n">e</span><span class="p">)</span>
</code></pre>
</div>

<p>Da man Ruby nicht von Markdown heraus aufrufen kann, können auch Layouts nicht
in Markdown geschrieben werden. Es ist aber möglich, einen Renderer für die
Templates zu verwenden und einen anderen für das Layout, indem die
<code class="highlighter-rouge">:layout_engine</code>-Option verwendet wird.</p>

<h4>Textile Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://redcloth.org/">RedCloth</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.textile</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>textile :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Da man aus dem Textile-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Textile üblicherweise in Kombination mit
anderen Renderern verwenden wollen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:einfuehrung</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Beachte, dass man die <code class="highlighter-rouge">textile</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Gru</span><span class="err">ß</span> <span class="n">von</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:Gr</span><span class="err">üß</span><span class="n">e</span><span class="p">)</span>
</code></pre>
</div>

<p>Da man Ruby nicht von Textile heraus aufrufen kann, können auch Layouts nicht
in Textile geschrieben werden. Es ist aber möglich, einen Renderer für die
Templates zu verwenden und einen anderen für das Layout, indem die
<code class="highlighter-rouge">:layout_engine</code>-Option verwendet wird.</p>

<h4>RDoc Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://rdoc.sourceforge.net/">rdoc</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.rdoc</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>textile :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Da man aus dem RDoc-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man RDoc üblicherweise in Kombination mit
anderen Renderern verwenden wollen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:einfuehrung</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Beachte, dass man die <code class="highlighter-rouge">rdoc</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Gru</span><span class="err">ß</span> <span class="n">von</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:Gr</span><span class="err">üß</span><span class="n">e</span><span class="p">)</span>
</code></pre>
</div>

<p>Da man Ruby nicht von RDoc heraus aufrufen kann, können auch Layouts nicht in
RDoc geschrieben werden. Es ist aber möglich, einen Renderer für die Templates
zu verwenden und einen anderen für das Layout, indem die
<code class="highlighter-rouge">:layout_engine</code>-Option verwendet wird.</p>

<h4>AsciiDoc Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://asciidoctor.org/" title="Asciidoctor">Asciidoctor</a></td>
  </tr>
  <tr>
    <td>Dateierweiterungen</td>
    <td>
<tt>.asciidoc</tt>, <tt>.adoc</tt> und <tt>.ad</tt>
</td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>asciidoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Da man aus dem AsciiDoc-Template heraus keine Ruby-Methoden aufrufen kann
(ausgenommen <code class="highlighter-rouge">yield</code>), wird man üblicherweise locals verwenden wollen, mit
denen man Variablen weitergibt.</p>

<h4>Radius Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://github.com/jlong/radius">radius</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.radius</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>radius :index, :locals =&gt; { :key =&gt; 'Wert' }</tt></td>
  </tr>
</table>

<p>Da man aus dem Radius-Template heraus keine Ruby-Methoden aufrufen kann, wird
man üblicherweise locals verwenden wollen, mit denen man Variablen weitergibt.</p>

<h4>Markaby Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://markaby.github.io/">markaby</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.mab</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>markaby { h1 "Willkommen!" }</tt></td>
  </tr>
</table>

<p>Nimmt ebenso einen Block für Inline-Templates entgegen (siehe Beispiel).</p>

<h4>RABL Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://github.com/nesquena/rabl">rabl</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.rabl</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>rabl :index</tt></td>
  </tr>
</table>

<h4>Slim Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="http://slim-lang.com/">slim</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.slim</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>slim :index</tt></td>
  </tr>
</table>

<h4>Creole Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://github.com/minad/creole">creole</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.creole</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>creole :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Da man aus dem Creole-Template heraus keine Ruby-Methoden aufrufen und auch
keine locals verwenden kann, wird man Creole üblicherweise in Kombination mit
anderen Renderern verwenden wollen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">creole</span><span class="p">(</span><span class="ss">:einfuehrung</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Beachte, dass man die <code class="highlighter-rouge">creole</code>-Methode auch aus anderen Templates heraus
aufrufen kann:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Gru</span><span class="err">ß</span> <span class="n">von</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">creole</span><span class="p">(</span><span class="ss">:Gr</span><span class="err">üß</span><span class="n">e</span><span class="p">)</span>
</code></pre>
</div>

<p>Da man Ruby nicht von Creole heraus aufrufen kann, können auch Layouts
nicht in Creole geschrieben werden. Es ist aber möglich, einen Renderer
für die Templates zu verwenden und einen anderen für das Layout, indem
die <code class="highlighter-rouge">:layout_engine</code>-Option verwendet wird.</p>

<h4>MediaWiki Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://github.com/nricciar/wikicloth" title="WikiCloth">WikiCloth</a></td>
  </tr>
  <tr>
    <td>Dateierweiterungen</td>
    <td>
<tt>.mediawiki</tt> und <tt>.mw</tt>
</td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>mediawiki :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Da man aus dem Mediawiki-Template heraus keine Ruby-Methoden aufrufen
und auch keine locals verwenden kann, wird man Mediawiki üblicherweise
in Kombination mit anderen Renderern verwenden wollen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">mediawiki</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Beachte: Man kann die <code class="highlighter-rouge">mediawiki</code>-Methode auch aus anderen Templates
heraus aufrufen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Gr</span><span class="err">üß</span><span class="n">e</span> <span class="n">von</span> <span class="no">Haml</span><span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">mediawiki</span><span class="p">(</span><span class="ss">:greetings</span><span class="p">)</span>
</code></pre>
</div>

<p>Da man Ruby nicht von MediaWiki heraus aufrufen kann, können auch
Layouts nicht in MediaWiki geschrieben werden. Es ist aber möglich,
einen Renderer für die Templates zu verwenden und einen anderen für das
Layout, indem die <code class="highlighter-rouge">:layout_engine</code>-Option verwendet wird.</p>

<h4>CoffeeScript Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td>
<a href="https://github.com/josh/ruby-coffee-script">coffee-script</a>
        und eine <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme">Möglichkeit JavaScript auszuführen</a>.
    </td>
  </tr>
    <td>Dateierweiterung</td>
    <td><tt>.coffee</tt></td>
  &lt;/tr&gt;
  <tr>
    <td>Beispiel</td>
    <td><tt>coffee :index</tt></td>
  </tr>
</table>

<h4>Stylus Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td>
      <a href="https://github.com/forgecrafted/ruby-stylus" title="Ruby Stylus">
        Stylus
      </a> und eine Möglichkeit
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        JavaScript auszuführen
      </a>.
    </td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.styl</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>stylus :index</tt></td>
  </tr>
</table>

<p>Um Stylus-Templates ausführen zu können, müssen <code class="highlighter-rouge">stylus</code> und <code class="highlighter-rouge">stylus/tilt</code>
zuerst geladen werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'stylus'</span>
<span class="nb">require</span> <span class="s1">'stylus/tilt'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stylus</span> <span class="ss">:example</span>
<span class="k">end</span>
</code></pre>
</div>

<h4>Yajl Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://github.com/brianmario/yajl-ruby" title="yajl-ruby">yajl-ruby</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.yajl</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td>
      <tt>
        yajl :index,
             :locals =&gt; { :key =&gt; 'qux' },
             :callback =&gt; 'present',
             :variable =&gt; 'resource'
      </tt>
    </td>
  </tr>
</table>

<p>Die Template-Quelle wird als Ruby-String evaluiert. Die daraus resultierende
json Variable wird mit Hilfe von <code class="highlighter-rouge">#to_json</code> umgewandelt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">json</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span> <span class="p">}</span>
<span class="n">json</span><span class="p">[</span><span class="ss">:baz</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
</code></pre>
</div>

<p>Die <code class="highlighter-rouge">:callback</code> und <code class="highlighter-rouge">:variable</code> Optionen können mit dem gerenderten Objekt
verwendet werden:</p>

<div class="language-javascript highlighter-rouge">
<pre class="highlight"><code><span class="kd">var</span> <span class="nx">resource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"foo"</span><span class="p">:</span><span class="s2">"bar"</span><span class="p">,</span><span class="s2">"baz"</span><span class="p">:</span><span class="s2">"qux"</span><span class="p">};</span>
<span class="nx">present</span><span class="p">(</span><span class="nx">resource</span><span class="p">);</span>
</code></pre>
</div>

<h4>WLang Templates</h4>

<table>
  <tr>
    <td>Abhängigkeit</td>
    <td><a href="https://github.com/blambeau/wlang/">wlang</a></td>
  </tr>
  <tr>
    <td>Dateierweiterung</td>
    <td><tt>.wlang</tt></td>
  </tr>
  <tr>
    <td>Beispiel</td>
    <td><tt>wlang :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>Ruby-Methoden in Wlang aufzurufen entspricht nicht den idiomatischen Vorgaben
von Wlang, es bietet sich deshalb an, <code class="highlighter-rouge">:locals</code> zu verwenden. Layouts, die
Wlang und <code class="highlighter-rouge">yield</code> verwenden, werden aber trotzdem unterstützt.</p>

<p>Rendert den eingebetteten Template-String.</p>

<h3>Auf Variablen in Templates zugreifen</h3>

<p>Templates werden in demselben Kontext ausgeführt wie Routen. Instanzvariablen
in Routen sind auch direkt im Template verfügbar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="vi">@foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= @foo.name'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Oder durch einen expliziten Hash von lokalen Variablen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= bar.name'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:bar</span> <span class="o">=&gt;</span> <span class="n">foo</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dies wird typischerweise bei Verwendung von Subtemplates (partials) in anderen
Templates eingesetzt.</p>

<h3>Templates mit <code class="highlighter-rouge">yield</code> und verschachtelte Layouts</h3>

<p>Ein Layout ist üblicherweise ein Template, das ein <code class="highlighter-rouge">yield</code> aufruft. Ein
solches Template kann entweder wie oben beschrieben über die <code class="highlighter-rouge">:template</code>
Option verwendet werden oder mit einem Block gerendert werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dieser Code entspricht weitestgehend <code class="highlighter-rouge">erb :index, :layout =&gt; :post</code>.</p>

<p>Blöcke an Render-Methoden weiterzugeben ist besonders bei verschachtelten
Layouts hilfreich:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:main_layout</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:admin_layout</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:user</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Der gleiche Effekt kann auch mit weniger Code erreicht werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:admin_layout</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:main_layout</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:user</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Zur Zeit nehmen folgende Renderer Blöcke an: <code class="highlighter-rouge">erb</code>, <code class="highlighter-rouge">haml</code>, <code class="highlighter-rouge">liquid</code>, <code class="highlighter-rouge">slim </code>
und <code class="highlighter-rouge">wlang</code>.</p>

<p>Das gleich gilt auch für die allgemeine <code class="highlighter-rouge">render</code> Methode.</p>

<h3>Inline-Templates</h3>

<p>Templates können auch am Ende der Datei definiert werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="cp">__END__

@@ layout
%html
  = yield

@@ index
%div.title Hallo Welt
</span></code></pre>
</div>

<p>Anmerkung: Inline-Templates, die in der Datei definiert sind, die <code class="highlighter-rouge">require
'sinatra'</code> aufruft, werden automatisch geladen. Um andere Inline-Templates in
weiteren Dateien aufzurufen, muss explizit <code class="highlighter-rouge">enable :inline_templates</code>
verwendet werden.</p>

<h3>Benannte Templates</h3>

<p>Templates können auch mit der Top-Level <code class="highlighter-rouge">template</code>-Methode definiert werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">template</span> <span class="ss">:layout</span> <span class="k">do</span>
  <span class="s2">"%html</span><span class="se">\n</span><span class="s2"> =yield</span><span class="se">\n</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">template</span> <span class="ss">:index</span> <span class="k">do</span>
  <span class="s1">'%div.title Hallo Welt!'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Wenn ein Template mit dem Namen “layout” existiert, wird es bei jedem Aufruf
verwendet. Durch <code class="highlighter-rouge">:layout =&gt; false</code> kann das Ausführen individuell nach Route
verhindert werden, oder generell für ein Template, z.B. Haml via:
<code class="highlighter-rouge">set :haml, :layout =&gt; false</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>
  <span class="c1"># !request.xhr? prüft, ob es sich um einen asynchronen Request handelt.</span>
  <span class="c1"># wenn nicht, dann verwende ein Layout (negiert durch !)</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Dateiendungen zuordnen</h3>

<p>Um eine Dateiendung einer Template-Engine zuzuordnen, kann <code class="highlighter-rouge">Tilt.register</code>
genutzt werden. Wenn etwa die Dateiendung <code class="highlighter-rouge">tt</code> für Textile-Templates genutzt
werden soll, lässt sich dies wie folgt bewerkstelligen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:tt</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:textile</span><span class="p">]</span>
</code></pre>
</div>

<h3>Eine eigene Template-Engine hinzufügen</h3>

<p>Zu allererst muss die Engine bei Tilt registriert und danach eine
Rendering-Methode erstellt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:mtt</span><span class="p">,</span> <span class="no">MeineTolleTemplateEngine</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">mtt</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="n">render</span><span class="p">(</span><span class="ss">:mtt</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">mtt</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dieser Code rendert <code class="highlighter-rouge">./views/application.mtt</code>. Siehe
<a href="https://github.com/rtomayko/tilt">github.com/rtomayko/tilt</a>, um mehr über
Tilt zu erfahren.</p>

<h3>Eigene Methoden zum Aufsuchen von Templates verwenden</h3>

<p>Um einen eigenen Mechanismus zum Aufsuchen von Templates zu
implementieren, muss <code class="highlighter-rouge">#find_template</code> definiert werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:views</span> <span class="p">[</span> <span class="s1">'./views/a'</span><span class="p">,</span> <span class="s1">'./views/b'</span> <span class="p">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="no">Array</span><span class="p">(</span><span class="n">views</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
    <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Filter</h2>

<p>Before-Filter werden vor jedem Request in demselben Kontext, wie danach die
Routen, ausgeführt. So können etwa Request und Antwort geändert werden.
Gesetzte Instanzvariablen in Filtern können in Routen und Templates verwendet
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@note</span> <span class="o">=</span> <span class="s1">'Hi!'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s1">'/foo/bar/baz'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/foo/*'</span> <span class="k">do</span>
  <span class="vi">@note</span> <span class="c1">#=&gt; 'Hi!'</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1">#=&gt; 'bar/baz'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>After-Filter werden nach jedem Request in demselben Kontext ausgeführt und
können ebenfalls Request und Antwort ändern. In Before-Filtern gesetzte
Instanzvariablen können in After-Filtern verwendet werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">status</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Achtung: Wenn statt der body-Methode ein einfacher String verwendet
wird, ist der Response-body im after-Filter noch nicht verfügbar, da
er erst nach dem Durchlaufen des after-Filters erzeugt wird.</p>

<p>Filter können optional auch mit einem Muster ausgestattet werden, das auf den
Request-Pfad passen muss, damit der Filter ausgeführt wird:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="s1">'/protected/*'</span> <span class="k">do</span>
  <span class="n">authenticate!</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/create/:slug'</span> <span class="k">do</span> <span class="o">|</span><span class="n">slug</span><span class="o">|</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:last_slug</span><span class="p">]</span> <span class="o">=</span> <span class="n">slug</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ähnlich wie Routen können Filter auch mit weiteren Bedingungen eingeschränkt
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird/</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/blog/*'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="s1">'example.com'</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Helfer</h2>

<p>Durch die Top-Level <code class="highlighter-rouge">helpers</code>-Methode werden sogenannte Helfer-Methoden
definiert, die in Routen und Templates verwendet werden können:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
    <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">bar"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:name'</span> <span class="k">do</span>
  <span class="n">bar</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ebenso können Helfer auch in einem eigenen Modul definiert werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">module</span> <span class="nn">FooUtils</span>
  <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">foo"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">BarUtils</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">bar"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">helpers</span> <span class="no">FooUtils</span><span class="p">,</span> <span class="no">BarUtils</span>
</code></pre>
</div>

<p>Das Ergebnis ist das gleiche, wie beim Einbinden in die
Anwendungs-Klasse.</p>

<h3>Sessions verwenden</h3>
<p>Sessions werden verwendet, um Zustände zwischen den Requests zu speichern.
Sind sie aktiviert, kann ein Session-Hash je Benutzer-Session verwendet
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s2">"value = "</span> <span class="o">&lt;&lt;</span> <span class="n">session</span><span class="p">[</span><span class="ss">:value</span><span class="p">].</span><span class="nf">inspect</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:value'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:value</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'value'</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Um die Sicherheit zu erhöhen, werden Daten mit einem geheimen
Sitzungsschlüssel unter Verwendung von <code class="highlighter-rouge">HMAC-SHA1</code> in einem Cookie signiert.
Der Sitzungsschlüssel sollte optimalerweise ein kryptografisch zufällig
erzeugter Wert mit angemessener Länge sein, für den <code class="highlighter-rouge">HMAC-SHA1</code> größer
oder gleich 65 Bytes ist (256 Bits, 64 Hex-Zeichen). Es wird empfohlen,
keinen Schlüssel zu verwenden, dessen Zufälligkeit weniger als 32 Bytes
entspricht (also 256 Bits, 64 Hex-Zeichen). Es ist deshalb <strong>wirklich
wichtig</strong>, dass nicht einfach irgendetwas als Schlüssel verwendet wird,
sondern ein sicherer Zufallsgenerator die Zeichenkette erstellt. Menschen sind
nicht besonders gut, zufällige Zeichenfolgen zu erstellen.</p>

<p>Sinatra generiert automatisch einen zufälligen 32 Byte langen zufälligen
Schlüssel. Da jedoch bei jedem Neustart der Schlüssel ebenfalls neu generiert
wird, ist es sinnvoll einen eigenen Schlüssel festzulegen, damit er über alle
Anwendungsinstanzen hinweg geteilt werden kann.</p>

<p>Aus praktikablen und Sicherheitsgründen wird
<a href="https://12factor.net/config">empfohlen</a>, dass ein sicherer Zufallswert
erzeugt und in einer Umgebungsvariable abgelgegt wird, damit alle
Anwendungsinstanzen darauf zugreifen können. Dieser Sitzungsschlüssel
sollte in regelmäßigen Abständen erneuert werden. Zum Erzeugen von 64
Byte starken Schlüsseln sind hier ein paar Beispiele vorgestellt:</p>

<p><strong>Sitzungsschlüssel erzeugen</strong></p>

<div class="language-text highlighter-rouge">
<pre class="highlight"><code>$ ruby -e "require 'securerandom'; puts SecureRandom.hex(64)"
99ae8afi...usw...ec0f262ac
</code></pre>
</div>

<p><strong>Sitzungsschlüssel erzeugen (Bonuspunkte)</strong></p>

<p>Um den systemweiten Zufallszahlengenerator zu verwenden, kann das
<a href="https://github.com/cryptosphere/sysrandom">sysrandom gem</a> installiert
werden, anstelle von Zufallszahlen aus dem Userspace, auf die MRI zur
Zeit standardmäßig zugreift:</p>

<div class="language-text highlighter-rouge">
<pre class="highlight"><code>$ gem install sysrandom
Building native extensions. This could take a while...
Successfully installed sysrandom-1.x
1 gem installed

$ ruby -e "require 'sysrandom/securerandom'; puts SecureRandom.hex(64)"
99ae8af...snip...ec0f262ac
</code></pre>
</div>

<p><strong>Sitzungsschlüssel-Umgebungsvariable</strong></p>

<p>Wird eine <code class="highlighter-rouge">SESSION_SECRET</code>-Umgebungsvariable persistent gesetzt, kann
Sinatra darauf zugreifen. Da die folgende Methode von System zu System
variieren kann, ist dies als Beispiel zu verstehen:</p>

<div class="language-bash highlighter-rouge">
<pre class="highlight"><code><span class="gp">$ </span><span class="nb">echo</span> <span class="s2">"export SESSION_SECRET=99ae8af...etc...ec0f262ac"</span> &gt;&gt; ~/.bashrc
</code></pre>
</div>

<p><strong>Anwendungseinstellung für Sitzungsschlüssel</strong></p>

<p>Die Anwendung sollte unabhängig von der <code class="highlighter-rouge">SESSION_SECRET</code>-Umgebungsvariable
auf einen sicheren zufälligen Schlüssel zurückgreifen.</p>

<p>Auch hier sollte das
<a href="https://github.com/cryptosphere/sysrandom">sysrandom gem</a> verwendet
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'securerandom'</span>
<span class="c1"># -or- require 'sysrandom/securerandom'</span>
<span class="n">set</span> <span class="ss">:session_secret</span><span class="p">,</span> <span class="no">ENV</span><span class="p">.</span><span class="nf">fetch</span><span class="p">(</span><span class="s1">'SESSION_SECRET'</span><span class="p">)</span> <span class="p">{</span> <span class="no">SecureRandom</span><span class="p">.</span><span class="nf">hex</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<h4>Sitzungseinstellungen</h4>

<p>Im Options-Hash können weitere Einstellungen abgelegt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'foo.com'</span>
</code></pre>
</div>

<p>Um Sitzungsdaten über mehrere Anwendungen und Subdomains hinweg zu
teilen, muss die Domain mit einem <code class="highlighter-rouge">*.*</code> vor der Domain ausgestattet
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'.foo.com'</span>
</code></pre>
</div>

<h4>Eigene Sitzungs-Middleware auswählen</h4>

<p>Beachte, dass <code class="highlighter-rouge">enable :sessions</code> alle Daten in einem Cookie speichert. Unter
Umständen kann dies negative Effekte haben, z.B. verursachen viele Daten
höheren, teilweise überflüssigen Traffic. Es kann daher eine beliebige
Rack-Session Middleware verwendet werden. Folgende Methoden stehen zur
Verfügung:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>
<span class="n">set</span> <span class="ss">:session_store</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
</code></pre>
</div>

<p>Oder Sitzungen werden mit einem Options-Hash ausgestattet:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>
<span class="n">set</span> <span class="ss">:session_store</span><span class="p">,</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
</code></pre>
</div>

<p>Eine weitere Methode ist der Verzicht auf <code class="highlighter-rouge">enable :session</code> und
stattdessen die Verwendung einer beliebigen anderen Middleware.</p>

<p>Dabei ist jedoch zu beachten, dass der reguläre sitzungsbasierte
Sicherungsmechanismus <strong>nicht automatisch aktiviert wird</strong>.</p>

<p>Die dazu benötigte Rack-Middleware muss explizit eingebunden werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Protection</span><span class="o">::</span><span class="no">RemoteToken</span>
<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Protection</span><span class="o">::</span><span class="no">SessionHijacking</span>
</code></pre>
</div>

<p>Mehr dazu unter <a href="https://github.com/sinatra/sinatra/blob/master/README.de.md#einstellung-des-angriffsschutzes">Einstellung des Angiffsschutzes</a>.</p>

<h3>Anhalten</h3>

<p>Zum sofortigen Stoppen eines Request in einem Filter oder einer Route:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span>
</code></pre>
</div>

<p>Der Status kann beim Stoppen mit angegeben werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">410</span>
</code></pre>
</div>

<p>Oder auch den Response-Body:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="s1">'Hier steht der Body'</span>
</code></pre>
</div>

<p>Oder beides:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">'verschwinde!'</span>
</code></pre>
</div>

<p>Sogar mit Headern:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">402</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/plain'</span><span class="p">},</span> <span class="s1">'Rache'</span>
</code></pre>
</div>

<p>Natürlich ist es auch möglich, ein Template mit <code class="highlighter-rouge">halt</code> zu verwenden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="n">erb</span><span class="p">(</span><span class="ss">:error</span><span class="p">)</span>
</code></pre>
</div>

<h3>Weiterspringen</h3>

<p>Eine Route kann mittels <code class="highlighter-rouge">pass</code> zu der nächsten passenden Route springen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/raten/:wer'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">unless</span> <span class="n">params</span><span class="p">[</span><span class="s1">'wer'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Frank'</span>
  <span class="s1">'Du hast mich!'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/raten/*'</span> <span class="k">do</span>
  <span class="s1">'Du hast mich nicht!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Der Block wird sofort verlassen und es wird nach der nächsten treffenden Route
gesucht. Ein 404-Fehler wird zurückgegeben, wenn kein treffendes Routen-Muster
gefunden wird.</p>

<h3>Eine andere Route ansteuern</h3>

<p>Wenn nicht zu einer anderen Route gesprungen werden soll, sondern nur das
Ergebnis einer anderen Route gefordert wird, kann <code class="highlighter-rouge">call</code> für einen internen
Request verwendet werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">call</span> <span class="n">env</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="s2">"PATH_INFO"</span> <span class="o">=&gt;</span> <span class="s1">'/bar'</span><span class="p">)</span>
  <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:upcase</span><span class="p">)]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="s2">"bar"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Beachte, dass in dem oben angegeben Beispiel die Performance erheblich erhöht
werden kann, wenn <code class="highlighter-rouge">"bar"</code> in eine Helfer-Methode umgewandelt wird, auf die
<code class="highlighter-rouge">/foo</code> und <code class="highlighter-rouge">/bar</code> zugreifen können.</p>

<p>Wenn der Request innerhalb derselben Applikations-Instanz aufgerufen und keine
Kopie der Instanz erzeugt werden soll, kann <code class="highlighter-rouge">call!</code> anstelle von <code class="highlighter-rouge">call</code>
verwendet werden.</p>

<p>Weitere Informationen zu <code class="highlighter-rouge">call</code> finden sich in den Rack-Spezifikationen.</p>

<h3>Body, Status-Code und Header setzen</h3>

<p>Es ist möglich und empfohlen, den Status-Code sowie den Response-Body mit
einem Returnwert in der Route zu setzen. In manchen Situationen kann es
jedoch sein, dass der Body an anderer Stelle während der Ausführung gesetzt
werden soll. Dafür kann man die Helfer-Methode <code class="highlighter-rouge">body</code> einsetzen. Ist sie
gesetzt, kann sie zu einem späteren Zeitpunkt aufgerufen werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">body</span> <span class="s2">"bar"</span>
<span class="k">end</span>

<span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">body</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ebenso ist es möglich, einen Block an <code class="highlighter-rouge">body</code> weiterzureichen, der dann vom
Rack-Handler ausgeführt wird (lässt sich z.B. zur Umsetzung von Streaming
einsetzen, siehe auch “Rückgabewerte”).</p>

<p>Vergleichbar mit <code class="highlighter-rouge">body</code> lassen sich auch Status-Code und Header setzen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span> <span class="mi">418</span>
  <span class="n">headers</span> <span class="p">\</span>
    <span class="s2">"Allow"</span>   <span class="o">=&gt;</span> <span class="s2">"BREW, POST, GET, PROPFIND, WHEN"</span><span class="p">,</span>
    <span class="s2">"Refresh"</span> <span class="o">=&gt;</span> <span class="s2">"Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"</span>
  <span class="n">halt</span> <span class="s2">"Ich bin ein Teekesselchen"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Genau wie bei <code class="highlighter-rouge">body</code> liest ein Aufrufen von <code class="highlighter-rouge">headers</code> oder <code class="highlighter-rouge">status</code> ohne
Argumente den aktuellen Wert aus.</p>

<h3>Response-Streams</h3>

<p>In manchen Situationen sollen Daten bereits an den Client zurückgeschickt
werden, bevor ein vollständiger Response bereit steht. Manchmal will man die
Verbindung auch erst dann beenden und Daten so lange an den Client
zurückschicken, bis er die Verbindung abbricht. Für diese Fälle gibt es die
<code class="highlighter-rouge">stream</code>-Helfer-Methode, die es einem erspart, eigene Lösungen zu schreiben:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stream</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"Das ist ja mal wieder fanta -</span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">" (bitte warten …) </span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"- stisch!</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Damit lassen sich Streaming-APIs realisieren, sog.
<a href="https://w3c.github.io/eventsource/">Server Sent Events</a>, die als Basis für
<a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a> dienen. Ebenso können
sie verwendet werden, um den Durchsatz zu erhöhen, wenn ein Teil der Daten von
langsamen Ressourcen abhängig ist.</p>

<p>Es ist zu beachten, dass das Verhalten beim Streaming, insbesondere die Anzahl
nebenläufiger Anfragen, stark davon abhängt, welcher Webserver für die
Applikation verwendet wird. Einige Server unterstützen
Streaming nicht oder nur teilweise. Sollte der Server Streaming nicht
unterstützen, wird ein vollständiger Response-Body zurückgeschickt, sobald der
an <code class="highlighter-rouge">stream</code> weitergegebene Block abgearbeitet ist. Mit Shotgun funktioniert
Streaming z.B. überhaupt nicht.</p>

<p>Ist der optionale Parameter <code class="highlighter-rouge">keep_open</code> aktiviert, wird beim gestreamten
Objekt <code class="highlighter-rouge">close</code> nicht aufgerufen und es ist einem überlassen dies an einem
beliebigen späteren Zeitpunkt nachholen. Die Funktion ist jedoch nur bei
Event-gesteuerten Serven wie Thin oder Rainbows möglich, andere Server werden
trotzdem den Stream beenden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># Durchgehende Anfrage (long polling)</span>

<span class="n">set</span> <span class="ss">:server</span><span class="p">,</span> <span class="ss">:thin</span>
<span class="n">connections</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">get</span> <span class="s1">'/subscribe'</span> <span class="k">do</span>
  <span class="c1"># Client-Registrierung beim Server, damit Events mitgeteilt werden können</span>
  <span class="n">stream</span><span class="p">(</span><span class="ss">:keep_open</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">connections</span> <span class="o">&lt;&lt;</span> <span class="n">out</span>
    <span class="c1"># tote Verbindungen entfernen</span>
    <span class="n">connections</span><span class="p">.</span><span class="nf">reject!</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:closed?</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/:message'</span> <span class="k">do</span>
  <span class="n">connections</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="c1"># Den Client über eine neue Nachricht in Kenntnis setzen</span>
    <span class="c1"># notify client that a new message has arrived</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>

    <span class="c1"># Den Client zur erneuten Verbindung auffordern</span>
    <span class="n">out</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>

  <span class="c1"># Rückmeldung</span>
  <span class="s2">"Mitteiling erhalten"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Es ist ebenfalls möglich, dass der Client die Verbindung schließt, während in
den Socket geschrieben wird. Deshalb ist es sinnvoll, vor einem
Schreibvorgang <code class="highlighter-rouge">out.closed?</code> zu prüfen.</p>

<h3>Logger</h3>

<p>Im Geltungsbereich eines Request stellt die <code class="highlighter-rouge">logger</code> Helfer-Methode eine
<code class="highlighter-rouge">Logger</code> Instanz zur Verfügung:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"es passiert gerade etwas"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Der Logger übernimmt dabei automatisch alle im Rack-Handler eingestellten
Log-Vorgaben. Ist Loggen ausgeschaltet, gibt die Methode ein Leerobjekt
zurück. In den Routen und Filtern muss man sich also nicht weiter darum
kümmern.</p>

<p>Beachte, dass das Loggen standardmäßig nur für <code class="highlighter-rouge">Sinatra::Application</code>
voreingestellt ist. Wird über <code class="highlighter-rouge">Sinatra::Base</code> vererbt, muss es erst aktiviert
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
    <span class="n">enable</span> <span class="ss">:logging</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Damit auch keine Middleware das Logging aktivieren kann, muss die <code class="highlighter-rouge">logging</code>
Einstellung auf <code class="highlighter-rouge">nil</code> gesetzt werden. Das heißt aber auch, dass <code class="highlighter-rouge">logger</code> in
diesem Fall <code class="highlighter-rouge">nil</code> zurückgeben wird. Üblicherweise wird das eingesetzt, wenn
ein eigener Logger eingerichtet werden soll. Sinatra wird dann verwenden, was
in <code class="highlighter-rouge">env['rack.logger']</code> eingetragen ist.</p>

<h3>Mime-Types</h3>

<p>Wenn <code class="highlighter-rouge">send_file</code> oder statische Dateien verwendet werden, kann es vorkommen,
dass Sinatra den Mime-Typ nicht kennt. Registriert wird dieser mit <code class="highlighter-rouge">mime_type</code>
per Dateiendung:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">mime_type</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'text/foo'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Es kann aber auch der <code class="highlighter-rouge">content_type</code>-Helfer verwendet werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:foo</span>
  <span class="s2">"foo foo foo"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>URLs generieren</h3>

<p>Zum Generieren von URLs sollte die <code class="highlighter-rouge">url</code>-Helfer-Methode genutzen werden, so
z.B. beim Einsatz von Haml:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">a</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s1">'/foo'</span><span class="p">)}</span> <span class="n">foo</span>
</code></pre>
</div>

<p>Soweit vorhanden, wird Rücksicht auf Proxys und Rack-Router genommen.</p>

<p>Diese Methode ist ebenso über das Alias <code class="highlighter-rouge">to</code> zu erreichen (siehe Beispiel
unten).</p>

<h3>Browser-Umleitung</h3>

<p>Eine Browser-Umleitung kann mithilfe der <code class="highlighter-rouge">redirect</code>-Helfer-Methode erreicht
werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Weitere Parameter werden wie Argumente der <code class="highlighter-rouge">halt</code>-Methode behandelt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">),</span> <span class="mi">303</span>
<span class="n">redirect</span> <span class="s1">'http://www.google.com/'</span><span class="p">,</span> <span class="s1">'Hier bist du falsch'</span>
</code></pre>
</div>

<p>Ebenso leicht lässt sich ein Schritt zurück mit dem Alias <code class="highlighter-rouge">redirect back</code>
erreichen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="s2">"&lt;a href='/bar'&gt;mach was&lt;/a&gt;"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">mach_was</span>
  <span class="n">redirect</span> <span class="n">back</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Um Argumente an ein Redirect weiterzugeben, können sie entweder dem Query
übergeben:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar?summe=42'</span><span class="p">)</span>
</code></pre>
</div>

<p>oder eine Session verwendet werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'foo'</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="ss">:secret</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Cache einsetzen</h3>

<p>Ein sinnvolles Einstellen von Header-Daten ist die Grundlage für ein
ordentliches HTTP-Caching.</p>

<p>Der Cache-Control-Header lässt sich ganz einfach einstellen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span>
  <span class="s2">"schon gecached!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Profitipp: Caching im before-Filter aktivieren</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">60</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Bei Verwendung der <code class="highlighter-rouge">expires</code>-Helfermethode zum Setzen des gleichnamigen
Headers, wird <code class="highlighter-rouge">Cache-Control</code> automatisch eigestellt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">expires</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Um alles richtig zu machen, sollten auch <code class="highlighter-rouge">etag</code> oder <code class="highlighter-rouge">last_modified</code> verwendet
werden. Es wird empfohlen, dass diese Helfer aufgerufen werden <em>bevor</em> die
eigentliche Arbeit anfängt, da sie sofort eine Antwort senden, wenn der Client
eine aktuelle Version im Cache vorhält:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/article/:id'</span> <span class="k">do</span>
  <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">find</span> <span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
  <span class="n">last_modified</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">updated_at</span>
  <span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span>
  <span class="n">erb</span> <span class="ss">:article</span>
<span class="k">end</span>
</code></pre>
</div>

<p>ebenso ist es möglich einen
<a href="https://de.wikipedia.org/wiki/HTTP_ETag">schwachen ETag</a> zu verwenden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span><span class="p">,</span> <span class="ss">:weak</span>
</code></pre>
</div>

<p>Diese Helfer führen nicht das eigentliche Caching aus, sondern geben die dafür
notwendigen Informationen an den Cache weiter. Für schnelle Reverse-Proxy
Cache-Lösungen bietet sich z.B.
<a href="https://github.com/rtomayko/rack-cache">rack-cache</a> an:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s2">"rack/cache"</span>
<span class="nb">require</span> <span class="s2">"sinatra"</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cache</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">36000</span>
  <span class="nb">sleep</span> <span class="mi">5</span>
  <span class="s2">"hello"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Um den <code class="highlighter-rouge">Cache-Control</code>-Header mit Informationen zu versorgen, verwendet man
die <code class="highlighter-rouge">:static_cache_control</code>-Einstellung (s.u.).</p>

<p>Nach RFC 2616 sollte sich die Anwendung anders verhalten, wenn ein If-Match
oder ein If-None-Match Header auf <code class="highlighter-rouge">*</code> gesetzt wird in Abhängigkeit davon, ob
die Resource bereits existiert. Sinatra geht davon aus, dass Ressourcen bei
sicheren Anfragen (z.B. bei get oder Idempotenten Anfragen wie put) bereits
existieren, wobei anderen Ressourcen (besipielsweise bei post), als neue
Ressourcen behandelt werden. Dieses Verhalten lässt sich mit der
<code class="highlighter-rouge">:new_resource</code> Option ändern:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/create'</span> <span class="k">do</span>
  <span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="no">Article</span><span class="p">.</span><span class="nf">create</span>
  <span class="n">erb</span> <span class="ss">:new_article</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Soll das schwache ETag trotzdem verwendet werden, verwendet man die <code class="highlighter-rouge">:kind</code>
Option:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="ss">:weak</span>
</code></pre>
</div>

<h3>Dateien versenden</h3>

<p>Um den Inhalt einer Datei als Response zurückzugeben, kann die
<code class="highlighter-rouge">send_file</code>-Helfer-Methode verwendet werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">send_file</span> <span class="s1">'foo.png'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Für <code class="highlighter-rouge">send_file</code> stehen einige Hash-Optionen zur Verfügung:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">send_file</span> <span class="s1">'foo.png'</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:jpg</span>
</code></pre>
</div>

<dl>
  <dt>filename</dt>
    <dd>Dateiname als Response.
    Standardwert ist der eigentliche Dateiname.</dd>

  <dt>last_modified</dt>
    <dd>Wert für den Last-Modified-Header, Standardwert ist <tt>mtime</tt> der
    Datei.</dd>

  <dt>type</dt>
    <dd>Content-Type, der verwendet werden soll. Wird, wenn nicht angegeben,
    von der Dateiendung abgeleitet.</dd>

  <dt>disposition</dt>
    <dd>Verwendet für Content-Disposition. Mögliche Werte sind: <tt>nil</tt>
    (Standard), <tt>:attachment</tt> und <tt>:inline</tt>.</dd>

  <dt>length</dt>
    <dd>Content-Length-Header. Standardwert ist die Dateigröße.</dd>
  <dt>Status</dt>
    <dd>Zu versendender Status-Code. Nützlich, wenn eine statische Datei
    als Fehlerseite zurückgegeben werden soll. Wenn der Rack-Handler es
    unterstützt, dann können auch andere Methoden außer Streaming vom
    Ruby-Prozess verwendet werden. Wird diese Helfermethode verwendet,
    dann wird Sinatra sich automatisch um die Range-Anfrage kümmern.</dd>
</dl>

<h3>Das Request-Objekt</h3>

<p>Auf das <code class="highlighter-rouge">request</code>-Objekt der eigehenden Anfrage kann vom Anfrage-Scope aus
zugegriffen werden (d.h. Filter, Routen, Fehlerbehandlung):</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># App läuft unter http://example.com/example</span>
<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">t</span> <span class="o">=</span> <span class="sx">%w[text/css text/html application/javascript]</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept</span>              <span class="c1"># ['text/html', '*/*']</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept?</span> <span class="s1">'text/xml'</span>  <span class="c1"># true</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">preferred_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>   <span class="c1"># 'text/html'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span>                <span class="c1"># Request-Body des Client (siehe unten)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">scheme</span>              <span class="c1"># "http"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">script_name</span>         <span class="c1"># "/example"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span>           <span class="c1"># "/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">port</span>                <span class="c1"># 80</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">request_method</span>      <span class="c1"># "GET"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">query_string</span>        <span class="c1"># ""</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">content_length</span>      <span class="c1"># Länge des request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>          <span class="c1"># Medientypus von request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">host</span>                <span class="c1"># "example.com"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">get?</span>                <span class="c1"># true (ähnliche Methoden für andere Verben)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">form_data?</span>          <span class="c1"># false</span>
  <span class="n">request</span><span class="p">[</span><span class="s2">"irgendein_param"</span><span class="p">]</span>  <span class="c1"># Wert von einem Parameter; [] ist die Kurzform für den params Hash</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">referrer</span>            <span class="c1"># Der Referrer des Clients oder '/'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">user_agent</span>          <span class="c1"># User-Agent (verwendet in der :agent Bedingung)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">cookies</span>             <span class="c1"># Hash des Browser-Cookies</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>                <span class="c1"># Ist das hier ein Ajax-Request?</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">url</span>                 <span class="c1"># "http://example.com/example/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path</span>                <span class="c1"># "/example/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">ip</span>                  <span class="c1"># IP-Adresse des Clients</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">secure?</span>             <span class="c1"># false (true wenn SSL)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">forwarded?</span>          <span class="c1"># true (Wenn es hinter einem Reverse-Proxy verwendet wird)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">env</span>                 <span class="c1"># vollständiger env-Hash von Rack übergeben</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Manche Optionen, wie etwa <code class="highlighter-rouge">script_name</code> oder <code class="highlighter-rouge">path_info</code>, sind auch
schreibbar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s2">"/"</span> <span class="p">}</span>

<span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
  <span class="s2">"Alle Anfragen kommen hier an!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Der <code class="highlighter-rouge">request.body</code> ist ein IO- oder StringIO-Objekt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">post</span> <span class="s2">"/api"</span> <span class="k">do</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">rewind</span> <span class="c1"># falls schon jemand davon gelesen hat</span>
  <span class="n">daten</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span>
  <span class="s2">"Hallo </span><span class="si">#{</span><span class="n">daten</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Anhänge</h3>

<p>Damit der Browser erkennt, dass ein Response gespeichert und nicht im Browser
angezeigt werden soll, kann der <code class="highlighter-rouge">attachment</code>-Helfer verwendet werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span>
  <span class="s2">"Speichern!"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ebenso kann eine Dateiname als Parameter hinzugefügt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span> <span class="s2">"info.txt"</span>
  <span class="s2">"Speichern!"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Umgang mit Datum und Zeit</h3>

<p>Sinatra bietet eine <code class="highlighter-rouge">time_for</code>-Helfer-Methode, die aus einem gegebenen Wert
ein Time-Objekt generiert. Ebenso kann sie nach <code class="highlighter-rouge">DateTime</code>, <code class="highlighter-rouge">Date</code> und
ähnliche Klassen konvertieren:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">&gt;</span> <span class="n">time_for</span><span class="p">(</span><span class="s1">'Dec 23, 2016'</span><span class="p">)</span>
  <span class="s2">"noch Zeit"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Diese Methode wird intern für <code class="highlighter-rouge">expires</code>, <code class="highlighter-rouge">last_modiefied</code> und ihresgleichen
verwendet. Mit ein paar Handgriffen lässt sich diese Methode also in ihrem
Verhalten erweitern, indem man <code class="highlighter-rouge">time_for</code> in der eigenen Applikation
überschreibt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">time_for</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">value</span>
    <span class="k">when</span> <span class="ss">:yesterday</span> <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">when</span> <span class="ss">:tomorrow</span>  <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">else</span> <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">last_modified</span> <span class="ss">:yesterday</span>
  <span class="n">expires</span> <span class="ss">:tomorrow</span>
  <span class="s2">"Hallo"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Nachschlagen von Template-Dateien</h3>

<p>Die <code class="highlighter-rouge">find_template</code>-Helfer-Methode wird genutzt, um Template-Dateien zum
Rendern aufzufinden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">find_template</span> <span class="n">settings</span><span class="p">.</span><span class="nf">views</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:haml</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"könnte diese hier sein: </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Das ist zwar nicht wirklich brauchbar, aber wenn man sie überschreibt, kann
sie nützlich werden, um eigene Nachschlage-Mechanismen einzubauen. Zum
Beispiel dann, wenn mehr als nur ein view-Verzeichnis verwendet werden soll:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="p">[</span><span class="s1">'views'</span><span class="p">,</span> <span class="s1">'templates'</span><span class="p">]</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="no">Array</span><span class="p">(</span><span class="n">views</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ein anderes Beispiel wäre, verschiedene Vereichnisse für verschiedene Engines
zu verwenden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="ss">:sass</span> <span class="o">=&gt;</span> <span class="s1">'views/sass'</span><span class="p">,</span> <span class="ss">:haml</span> <span class="o">=&gt;</span> <span class="s1">'templates'</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">'views'</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">folder</span> <span class="o">=</span> <span class="n">views</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">engine</span> <span class="o">==</span> <span class="no">Tilt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">folder</span> <span class="o">||=</span> <span class="n">views</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span>
    <span class="k">super</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ebensogut könnte eine Extension aber auch geschrieben und mit anderen geteilt
werden!</p>

<p>Beachte, dass <code class="highlighter-rouge">find_template</code> nicht prüft, ob eine Datei tatsächlich
existiert. Es wird lediglich der angegebene Block aufgerufen und nach allen
möglichen Pfaden gesucht. Das ergibt kein Performance-Problem, da <code class="highlighter-rouge">render</code>
<code class="highlighter-rouge">block</code> verwendet, sobald eine Datei gefunden wurde. Ebenso werden
Template-Pfade samt Inhalt gecached, solange nicht im Entwicklungsmodus
gearbeitet wird. Das sollte im Hinterkopf behalten werden, wenn irgendwelche
verrückten Methoden zusammengebastelt werden.</p>

<h3>Konfiguration</h3>

<p>Wird einmal beim Starten in jedweder Umgebung ausgeführt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="c1"># setze eine Option</span>
  <span class="n">set</span> <span class="ss">:option</span><span class="p">,</span> <span class="s1">'wert'</span>

  <span class="c1"># setze mehrere Optionen</span>
  <span class="n">set</span> <span class="ss">:a</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="mi">2</span>

  <span class="c1"># das gleiche wie `set :option, true`</span>
  <span class="n">enable</span> <span class="ss">:option</span>

  <span class="c1"># das gleiche wie `set :option, false`</span>
  <span class="n">disable</span> <span class="ss">:option</span>

  <span class="c1"># dynamische Einstellungen mit Blöcken</span>
  <span class="n">set</span><span class="p">(</span><span class="ss">:css_dir</span><span class="p">)</span> <span class="p">{</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s1">'css'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Läuft nur, wenn die Umgebung (<code class="highlighter-rouge">APP_ENV</code>-Umgebungsvariable) auf <code class="highlighter-rouge">:production</code>
gesetzt ist:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="ss">:production</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<p>Läuft nur, wenn die Umgebung auf <code class="highlighter-rouge">:production</code> oder auf <code class="highlighter-rouge">:test</code> gesetzt ist:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<p>Diese Einstellungen sind über <code class="highlighter-rouge">settings</code> erreichbar:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo?</span> <span class="c1"># =&gt; true</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo</span>  <span class="c1"># =&gt; 'bar'</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<h4>Einstellung des Angriffsschutzes</h4>

<p>Sinatra verwendet
<a href="https://github.com/sinatra/sinatra/tree/master/rack-protection#readme">Rack::Protection</a>, um die
Anwendung vor häufig vorkommenden Angriffen zu schützen. Diese Voreinstellung
lässt sich selbstverständlich deaktivieren, der damit verbundene
Geschwindigkeitszuwachs steht aber in keinem Verhätnis zu den möglichen
Risiken.</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">disable</span> <span class="ss">:protection</span>
</code></pre>
</div>

<p>Um einen bestimmten Schutzmechanismus zu deaktivieren, fügt man <code class="highlighter-rouge">protection</code>
einen Hash mit Optionen hinzu:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="ss">:path_traversal</span>
</code></pre>
</div>

<p>Neben Strings akzeptiert <code class="highlighter-rouge">:except</code> auch Arrays, um gleich mehrere
Schutzmechanismen zu deaktivieren:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:path_traversal</span><span class="p">,</span> <span class="ss">:session_hijacking</span><span class="p">]</span>
</code></pre>
</div>

<p>Standardmäßig setzt Sinatra einen sitzungbasierten Schutz nur dann ein,
wenn <code class="highlighter-rouge">:sessions</code> aktiviert wurde (siehe oben). Manchmal kann es aber
auch sein, dass Sitzungen außerhalb von Sinatra eingerichtet werden,
z.B. über eine config.ru oder einer zusätzlichen
<code class="highlighter-rouge">Rack::Builder</code>-Instance. In diesen Situationen kann eine
sitzungbasierte Sicherung eingesetzt werden mit Hilfe der
<code class="highlighter-rouge">:session</code>-Option:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="n">session</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>

<h4>Mögliche Einstellungen</h4>

<dl>
  <dt>absolute_redirects</dt>
    <dd>
      Wenn ausgeschaltet, wird Sinatra relative Redirects zulassen.
      Jedoch ist Sinatra dann nicht mehr mit RFC 2616 (HTTP 1.1)
      konform, das nur absolute Redirects zulässt.
    </dd>
    <dd>
      Sollte eingeschaltet werden, wenn die Applikation hinter einem
      Reverse-Proxy liegt, der nicht ordentlich eingerichtet ist.
      Beachte, dass die <tt>url</tt>-Helfer-Methode nach wie vor
      absolute URLs erstellen wird, es sei denn, es wird als zweiter
      Parameter <tt>false</tt> angegeben.
    </dd>
    <dd>Standardmäßig nicht aktiviert.</dd>

  <dt>add_charset</dt>
    <dd>
      Mime-Types werden hier automatisch der Helfer-Methode
      <tt>content_type</tt> zugeordnet. Es empfielt sich, Werte
      hinzuzufügen statt sie zu überschreiben: <tt>settings.add_charset
      &lt;&lt; "application/foobar"</tt>
    </dd>

  <dt>app_file</dt>
    <dd>
      Pfad zur Hauptdatei der Applikation. Wird verwendet, um das Wurzel-,
      Inline-, View- und öffentliche Verzeichnis des Projekts festzustellen.
    </dd>

  <dt>bind</dt>
    <dd>
      IP-Address, an die gebunden wird (Standardwert: <tt>0.0.0.0</tt>
      <em>oder</em> <tt>localhost</tt>). Wird nur für den eingebauten Server
      verwendet.
    </dd>

  <dt>default_encoding</dt>
    <dd>
      Das Encoding, falls keines angegeben wurde. Standardwert ist
      <tt>"utf-8"</tt>.
    </dd>

  <dt>dump_errors</dt>
    <dd>Fehler im Log anzeigen.</dd>

  <dt>environment</dt>
    <dd>
      Momentane Umgebung. Standardmäßig auf <tt>ENV['APP_ENV']</tt> oder
      <tt>"development"</tt> eingestellt, soweit ersteres nicht vorhanden.
    </dd>

  <dt>logging</dt>
    <dd>Den Logger verwenden.</dd>

  <dt>lock</dt>
    <dd>
      Jeder Request wird gelocked. Es kann nur ein Request pro Ruby-Prozess
      gleichzeitig verarbeitet werden.
    </dd>
    <dd>
      Eingeschaltet, wenn die Applikation threadsicher ist. Standardmäßig
      nicht aktiviert.
    </dd>

  <dt>method_override</dt>
    <dd>
      Verwende <tt>_method</tt>, um put/delete-Formulardaten in Browsern zu
      verwenden, die dies normalerweise nicht unterstützen.
    </dd>

  <dt>mustermann_opts</dt>
    <dd>
      Ein Hash mit Standardeinstellungen, der an Mustermann.new beim
      Kompilieren der Routen übergeben wird.
    </dd>

  <dt>port</dt>
    <dd>Port für die Applikation. Wird nur im internen Server verwendet.</dd>

  <dt>prefixed_redirects</dt>
    <dd>
      Entscheidet, ob <tt>request.script_name</tt> in Redirects
      eingefügt wird oder nicht, wenn kein absoluter Pfad angegeben ist.
      Auf diese Weise verhält sich <tt>redirect '/foo'</tt> so, als wäre
      es ein <tt>redirect to('/foo')</tt>. Standardmäßig nicht
      aktiviert.
    </dd>

  <dt>protection</dt>
    <dd>
      Legt fest, ob der Schutzmechanismus für häufig Vorkommende Webangriffe
      auf Webapplikationen aktiviert wird oder nicht. Weitere Informationen im
      vorhergehenden Abschnitt.
    </dd>

  <dt>public_folder</dt>
    <dd>
      Das öffentliche Verzeichnis, aus dem Daten zur Verfügung gestellt
      werden können. Wird nur dann verwendet, wenn statische Daten zur
      Verfügung gestellt werden können (s.u. <tt>static</tt> Option).
      Leitet sich von der <tt>app_file</tt> Einstellung ab, wenn nicht
      gesetzt.
    </dd>

  <dt>quiet</dt>
    <dd>
      Deaktiviert Logs, die beim Starten und Beenden von Sinatra
      ausgegeben werden. <tt>false</tt> ist die Standardeinstellung.
    </dd>

  <dt>public_dir</dt>
    <dd>Alias für <tt>public_folder</tt>, s.o.</dd>

  <dt>reload_templates</dt>
    <dd>
      Legt fest, ob Templates für jede Anfrage neu generiert werden. Im
      development-Modus aktiviert.
    </dd>

  <dt>root</dt>
    <dd>
      Wurzelverzeichnis des Projekts. Leitet sich von der <tt>app_file</tt>
      Einstellung ab, wenn nicht gesetzt.
    </dd>

  <dt>raise_errors</dt>
    <dd>
      Einen Ausnahmezustand aufrufen. Beendet die Applikation. Ist
      automatisch aktiviert, wenn die Umgebung auf <tt>"test"</tt>
      eingestellt ist. Ansonsten ist diese Option deaktiviert.
    </dd>

  <dt>run</dt>
    <dd>
      Wenn aktiviert, wird Sinatra versuchen, den Webserver zu starten. Nicht
      verwenden, wenn Rackup oder anderes verwendet werden soll.
    </dd>

  <dt>running</dt>
    <dd>Läuft der eingebaute Server? Diese Einstellung nicht ändern!</dd>

  <dt>server</dt>
    <dd>
      Server oder Liste von Servern, die als eingebaute Server zur
      Verfügung stehen. Die Reihenfolge gibt die Priorität vor, die
      Voreinstellung hängt von der verwendenten Ruby Implementierung ab.
    </dd>

  <dt>sessions</dt>
    <dd>
      Sessions auf Cookiebasis mittels
      <tt>Rack::Session::Cookie</tt> aktivieren. Für weitere Infos bitte
      in der Sektion ‘Sessions verwenden’ nachschauen.
    </dd>

  <dt>session_store</dt>
    <dd>
      Die verwendete Rack Sitzungs-Middleware. Verweist standardmäßig
      auf <tt>Rack::Session::Cookie</tt>. Für weitere Infos bitte
      in der Sektion ‘Sessions verwenden’ nachschauen.
    </dd>

  <dt>show_exceptions</dt>
    <dd>
      Bei Fehlern einen Stacktrace im Browseranzeigen. Ist automatisch
      aktiviert, wenn die Umgebung auf <tt>"development"</tt>
      eingestellt ist. Ansonsten ist diese Option deaktiviert.
    </dd>
    <dd>
      Kann auch auf <tt>:after_handler</tt> gestellt werden, um eine
      anwendungsspezifische Fehlerbehandlung auszulösen, bevor der
      Fehlerverlauf im Browser angezeigt wird.
    </dd>

  <dt>static</dt>
    <dd>
      Entscheidet, ob Sinatra statische Dateien zur Verfügung stellen
      soll oder nicht. Sollte nicht aktiviert werden, wenn ein Server
      verwendet wird, der dies auch selbstständig erledigen kann.
      Deaktivieren wird die Performance erhöhen. Standardmäßig
      aktiviert.
    </dd>

  <dt>static_cache_control</dt>
    <dd>
      Wenn Sinatra statische Daten zur Verfügung stellt, können mit
      dieser Einstellung die <tt>Cache-Control</tt> Header zu den
      Responses hinzugefügt werden. Die Einstellung verwendet dazu die
      <tt>cache_control</tt> Helfer-Methode. Standardmäßig deaktiviert.
      Ein Array wird verwendet, um mehrere Werte gleichzeitig zu
      übergeben: <tt>set :static_cache_control, [:public, :max_age =&gt;
      300]</tt>
    </dd>

  <dt>threaded</dt>
    <dd>
      Wird es auf <tt>true</tt> gesetzt, wird Thin aufgefordert
      <tt>EventMachine.defer</tt> zur Verarbeitung des Requests einzusetzen.
    </dd>

  <dt>traps</dt>
    <dd>Legt fest, wie Sinatra mit System-Signalen umgehen soll.</dd>

  <dt>views</dt>
    <dd>
      Verzeichnis der Views. Leitet sich von der <tt>app_file</tt> Einstellung
      ab, wenn nicht gesetzt.
    </dd>

  <dt>x_cascade</dt>
    <dd>
      Einstellung, ob der X-Cascade Header bei fehlender Route gesetzt
      wird oder nicht. Standardeinstellung ist <tt>true</tt>.
    </dd>
</dl>

<h2>Umgebungen</h2>

<p>Es gibt drei voreingestellte Umgebungen in Sinatra: <code class="highlighter-rouge">"development"</code>,
<code class="highlighter-rouge">"production"</code> und <code class="highlighter-rouge">"test"</code>. Umgebungen können über die <code class="highlighter-rouge">APP_ENV</code>
Umgebungsvariable gesetzt werden. Die Standardeinstellung ist <code class="highlighter-rouge">"development"</code>.
In diesem Modus werden alle Templates zwischen Requests neu geladen. Dazu gibt
es besondere Fehlerseiten für 404 Stati und Fehlermeldungen. In <code class="highlighter-rouge">"production"</code>
und <code class="highlighter-rouge">"test"</code> werden Templates automatisch gecached.</p>

<p>Um die Anwendung in einer anderen Umgebung auszuführen, kann man die
<code class="highlighter-rouge">APP_ENV</code>-Umgebungsvariable setzen:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code><span class="nv">APP_ENV</span><span class="o">=</span>production ruby my_app.rb
</code></pre>
</div>

<p>In der Anwendung kann man die die Methoden <code class="highlighter-rouge">development?</code>, <code class="highlighter-rouge">test?</code> und
<code class="highlighter-rouge">production?</code> verwenden, um die aktuelle Umgebung zu erfahren:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">settings</span><span class="p">.</span><span class="nf">development?</span>
    <span class="s2">"development!"</span>
  <span class="k">else</span>
    <span class="s2">"nicht development!"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Fehlerbehandlung</h2>

<p>Error-Handler laufen in demselben Kontext wie Routen und Filter, was bedeutet,
dass alle Goodies wie <code class="highlighter-rouge">haml</code>, <code class="highlighter-rouge">erb</code>, <code class="highlighter-rouge">halt</code>, etc. verwendet werden können.</p>

<h3>Nicht gefunden</h3>

<p>Wenn eine <code class="highlighter-rouge">Sinatra::NotFound</code>-Exception geworfen wird oder der Statuscode 404
ist, wird der <code class="highlighter-rouge">not_found</code>-Handler ausgeführt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">not_found</span> <span class="k">do</span>
  <span class="s1">'Seite kann nirgendwo gefunden werden.'</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Fehler</h3>

<p>Der <code class="highlighter-rouge">error</code>-Handler wird immer ausgeführt, wenn eine Exception in einem
Routen-Block oder in einem Filter geworfen wurde. In der
<code class="highlighter-rouge">development</code>-Umgebung wird es nur dann funktionieren, wenn die
<code class="highlighter-rouge">:show_exceptions</code>-Option auf <code class="highlighter-rouge">:after_handler</code> eingestellt wurde:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:show_exceptions</span><span class="p">,</span> <span class="ss">:after_handler</span>
</code></pre>
</div>

<p>Die Exception kann über die <code class="highlighter-rouge">sinatra.error</code>-Rack-Variable angesprochen werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="k">do</span>
  <span class="s1">'Entschuldige, es gab einen hässlichen Fehler - '</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Benutzerdefinierte Fehler:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="no">MeinFehler</span> <span class="k">do</span>
  <span class="s1">'Au weia, '</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Dann, wenn das passiert:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">raise</span> <span class="no">MeinFehler</span><span class="p">,</span> <span class="s1">'etwas Schlimmes ist passiert'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>bekommt man dieses:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>Au weia, etwas Schlimmes ist passiert
</code></pre>
</div>

<p>Alternativ kann ein Error-Handler auch für einen Status-Code definiert werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="mi">403</span> <span class="k">do</span>
  <span class="s1">'Zugriff verboten'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/geheim'</span> <span class="k">do</span>
  <span class="mi">403</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Oder ein Status-Code-Bereich:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="mi">400</span><span class="p">.</span><span class="nf">.</span><span class="mi">510</span> <span class="k">do</span>
  <span class="s1">'Hallo?'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Sinatra setzt verschiedene <code class="highlighter-rouge">not_found</code>- und <code class="highlighter-rouge">error</code>-Handler in der
Development-Umgebung ein, um hilfreiche Debugging-Informationen und
Stack-Traces anzuzeigen.</p>

<h2>Rack-Middleware</h2>

<p>Sinatra baut auf <a href="http://rack.github.io/">Rack</a> auf, einem minimalistischen
Standard-Interface für Ruby-Webframeworks. Eines der interessantesten Features
für Entwickler ist der Support von Middlewares, die zwischen den Server und
die Anwendung geschaltet werden und so HTTP-Request und/oder Antwort
überwachen und/oder manipulieren können.</p>

<p>Sinatra macht das Erstellen von Middleware-Verkettungen mit der
Top-Level-Methode <code class="highlighter-rouge">use</code> zu einem Kinderspiel:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'meine_middleware'</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Lint</span>
<span class="n">use</span> <span class="no">MeineMiddleware</span>

<span class="n">get</span> <span class="s1">'/hallo'</span> <span class="k">do</span>
  <span class="s1">'Hallo Welt'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Die Semantik von <code class="highlighter-rouge">use</code> entspricht der gleichnamigen Methode der
<a href="http://www.rubydoc.info/github/rack/rack/master/Rack/Builder">Rack::Builder</a>-DSL
(meist verwendet in Rackup-Dateien). Ein Beispiel dafür ist, dass die
<code class="highlighter-rouge">use</code>-Methode mehrere/verschiedene Argumente und auch Blöcke
entgegennimmt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Auth</span><span class="o">::</span><span class="no">Basic</span> <span class="k">do</span> <span class="o">|</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">|</span>
  <span class="n">username</span> <span class="o">==</span> <span class="s1">'admin'</span> <span class="o">&amp;&amp;</span> <span class="n">password</span> <span class="o">==</span> <span class="s1">'geheim'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Rack bietet eine Vielzahl von Standard-Middlewares für Logging, Debugging,
URL-Routing, Authentifizierung und Session-Verarbeitung. Sinatra verwendet
viele von diesen Komponenten automatisch, abhängig von der Konfiguration. So
muss <code class="highlighter-rouge">use</code> häufig nicht explizit verwendet werden.</p>

<p>Hilfreiche Middleware gibt es z.B. hier:
<a href="https://github.com/rack/rack/tree/master/lib/rack">rack</a>,
<a href="https://github.com/rack/rack-contrib#readme">rack-contrib</a>,
oder im <a href="https://github.com/rack/rack/wiki/List-of-Middleware">Rack wiki</a>.</p>

<h2>Testen</h2>

<p>Sinatra-Tests können mit jedem auf Rack aufbauendem Test-Framework
geschrieben werden.
<a href="http://www.rubydoc.info/github/brynary/rack-test/master/frames">Rack::Test</a>
wird empfohlen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'my_sinatra_app'</span>
<span class="nb">require</span> <span class="s1">'minitest/autorun'</span>
<span class="nb">require</span> <span class="s1">'rack/test'</span>

<span class="k">class</span> <span class="nc">MyAppTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_my_default</span>
    <span class="n">get</span> <span class="s1">'/'</span>
    <span class="n">assert_equal</span> <span class="s1">'Hallo Welt!'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_with_params</span>
    <span class="n">get</span> <span class="s1">'/meet'</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s1">'Frank'</span>
    <span class="n">assert_equal</span> <span class="s1">'Hallo Frank!'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_with_user_agent</span>
    <span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">'HTTP_USER_AGENT'</span> <span class="o">=&gt;</span> <span class="s1">'Songbird'</span>
    <span class="n">assert_equal</span> <span class="s2">"Du verwendest Songbird!"</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Hinweis: Wird Sinatra modular verwendet, muss
<code class="highlighter-rouge">Sinatra::Application</code> mit dem Namen der Applikations-Klasse
ersetzt werden.</p>

<h2>Sinatra::Base - Middleware, Bibliotheken und modulare Anwendungen</h2>

<p>Das Definieren einer Top-Level-Anwendung funktioniert gut für
Mikro-Anwendungen, hat aber Nachteile, wenn wiederverwendbare Komponenten wie
Middleware, Rails Metal, einfache Bibliotheken mit Server-Komponenten oder
auch Sinatra-Erweiterungen geschrieben werden sollen.</p>

<p>Das Top-Level geht von einer Konfiguration für eine Mikro-Anwendung aus (wie
sie z.B. bei einer einzelnen Anwendungsdatei, <code class="highlighter-rouge">./public</code> und <code class="highlighter-rouge">./views</code> Ordner,
Logging, Exception-Detail-Seite, usw.). Genau hier kommt <code class="highlighter-rouge">Sinatra::Base</code> ins
Spiel:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="kp">true</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>

  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Hallo Welt!'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Die Methoden der <code class="highlighter-rouge">Sinatra::Base</code>-Subklasse sind genau dieselben wie die der
Top-Level-DSL. Die meisten Top-Level-Anwendungen können mit nur zwei
Veränderungen zu <code class="highlighter-rouge">Sinatra::Base</code> konvertiert werden:</p>

<ul>
  <li>Die Datei sollte <code class="highlighter-rouge">require 'sinatra/base'</code> anstelle von <code class="highlighter-rouge">require
'sinatra'</code> aufrufen, ansonsten werden alle von Sinatras DSL-Methoden
in den Top-Level-Namespace importiert.</li>
  <li>Alle Routen, Error-Handler, Filter und Optionen der Applikation müssen in
einer Subklasse von <code class="highlighter-rouge">Sinatra::Base</code> definiert werden.</li>
</ul>

<p><code class="highlighter-rouge">Sinatra::Base</code> ist ein unbeschriebenes Blatt. Die meisten Optionen sind per
Standard deaktiviert. Das betrifft auch den eingebauten Server. Siehe
<a href="http://www.sinatrarb.com/configuration.html">Optionen und Konfiguration</a> für
Details über mögliche Optionen.</p>

<p>Damit eine App sich ähnlich wie eine klassische App verhält, kann man
auch eine Subclass von <code class="highlighter-rouge">Sinatra::Application</code> erstellen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Hello world!'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Modularer vs. klassischer Stil</h3>

<p>Entgegen häufiger Meinungen gibt es nichts gegen den klassischen Stil
einzuwenden. Solange es die Applikation nicht beeinträchtigt, besteht kein
Grund, eine modulare Applikation zu erstellen.</p>

<p>Der größte Nachteil der klassischen Sinatra Anwendung gegenüber einer
modularen ist die Einschränkung auf eine Sinatra Anwendung pro Ruby-Prozess.
Sollen mehrere zum Einsatz kommen, muss auf den modularen Stil umgestiegen
werden. Dabei ist es kein Problem klassische und modulare Anwendungen
miteinander zu vermischen.</p>

<p>Bei einem Umstieg, sollten einige Unterschiede in den Einstellungen beachtet
werden:</p>

<table>
  <tr>
    <th>Szenario</th>
    <th>Classic</th>
    <th>Modular</th>
    <th>Modular</th>
  </tr>

  <tr>
    <td>app_file</td>
    <td>Sinatra ladende Datei</td>
    <td>Sinatra::Base subklassierende Datei</td>
    <td>Sinatra::Application subklassierende Datei</td>
  </tr>

  <tr>
    <td>run</td>
    <td>$0 == app_file</td>
    <td>false</td>
    <td>false</td>
  </tr>

  <tr>
    <td>logging</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>method_override</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>inline_templates</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>static</td>
    <td>true</td>
    <td>File.exist?(public_folder)</td>
    <td>true</td>
  </tr>
</table>

<h3>Eine modulare Applikation bereitstellen</h3>

<p>Es gibt zwei übliche Wege, eine modulare Anwendung zu starten. Zum einen über
<code class="highlighter-rouge">run!</code>:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># mein_app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MeinApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ... Anwendungscode hierhin ...</span>

  <span class="c1"># starte den Server, wenn die Ruby-Datei direkt ausgeführt wird</span>
  <span class="n">run!</span> <span class="k">if</span> <span class="n">app_file</span> <span class="o">==</span> <span class="vg">$0</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Starte mit:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby mein_app.rb
</code></pre>
</div>

<p>Oder über eine <code class="highlighter-rouge">config.ru</code>-Datei, die es erlaubt, einen beliebigen
Rack-Handler zu verwenden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru (mit rackup starten)</span>
<span class="nb">require</span> <span class="s1">'./mein_app'</span>
<span class="n">run</span> <span class="no">MeineApp</span>
</code></pre>
</div>

<p>Starte:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>rackup -p 4567
</code></pre>
</div>

<h3>Eine klassische Anwendung mit einer config.ru verwenden</h3>

<p>Schreibe eine Anwendungsdatei:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Hallo Welt!'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>sowie eine dazugehörige <code class="highlighter-rouge">config.ru</code>-Datei:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'./app'</span>
<span class="n">run</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h3>Wann sollte eine config.ru-Datei verwendet werden?</h3>

<p>Anzeichen dafür, dass eine <code class="highlighter-rouge">config.ru</code>-Datei gebraucht wird:</p>

<ul>
  <li>Es soll ein anderer Rack-Handler verwendet werden (Passenger, Unicorn,
Heroku, …).</li>
  <li>Es gibt mehr als nur eine Subklasse von <code class="highlighter-rouge">Sinatra::Base</code>.</li>
  <li>Sinatra soll als Middleware verwendet werden, nicht als Endpunkt.</li>
</ul>

<p><strong>Es gibt keinen Grund, eine <code class="highlighter-rouge">config.ru</code>-Datei zu verwenden, nur weil eine
Anwendung im modularen Stil betrieben werden soll. Ebenso wird keine Anwendung
mit modularem Stil benötigt, um eine <code class="highlighter-rouge">config.ru</code>-Datei zu verwenden.</strong></p>

<h3>Sinatra als Middleware nutzen</h3>

<p>Es ist nicht nur möglich, andere Rack-Middleware mit Sinatra zu nutzen, es
kann außerdem jede Sinatra-Anwendung selbst als Middleware vor jeden
beliebigen Rack-Endpunkt gehangen werden. Bei diesem Endpunkt muss es sich
nicht um eine andere Sinatra-Anwendung handeln, es kann jede andere
Rack-Anwendung sein (Rails/Hanami/Roda/…):</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">LoginScreen</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">enable</span> <span class="ss">:sessions</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span> <span class="p">{</span> <span class="n">haml</span> <span class="ss">:login</span> <span class="p">}</span>

  <span class="n">post</span><span class="p">(</span><span class="s1">'/login'</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'admin'</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'admin'</span>
      <span class="n">session</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">redirect</span> <span class="s1">'/login'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Middleware wird vor Filtern ausgeführt</span>
  <span class="n">use</span> <span class="no">LoginScreen</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">session</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span>
      <span class="n">halt</span> <span class="s2">"Zugriff verweigert, bitte &lt;a href='/login'&gt;einloggen&lt;/a&gt;."</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Hallo </span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'user_name'</span><span class="p">]</span><span class="si">}</span><span class="s2">."</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Dynamische Applikationserstellung</h3>

<p>Manche Situationen erfordern die Erstellung neuer Applikationen zur Laufzeit,
ohne dass sie einer Konstanten zugeordnet werden. Dies lässt sich mit
<code class="highlighter-rouge">Sinatra.new</code> erreichen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="n">my_app</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"hallo"</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">my_app</span><span class="p">.</span><span class="nf">run!</span>
</code></pre>
</div>

<p>Die Applikation kann mit Hilfe eines optionalen Parameters erstellt werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">controller</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="ss">:logging</span>
  <span class="n">helpers</span> <span class="no">MyHelpers</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/a'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'a'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/b'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controller</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'b'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Das ist besonders dann interessant, wenn Sinatra-Erweiterungen getestet werden
oder Sinatra in einer Bibliothek Verwendung findet.</p>

<p>Ebenso lassen sich damit hervorragend Sinatra-Middlewares erstellen:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">use</span> <span class="no">Sinatra</span> <span class="k">do</span>
  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">RailsProject</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h2>Geltungsbereich und Bindung</h2>

<p>Der Geltungsbereich (Scope) legt fest, welche Methoden und Variablen zur
Verfügung stehen.</p>

<h3>Anwendungs- oder Klassen-Scope</h3>

<p>Jede Sinatra-Anwendung entspricht einer <code class="highlighter-rouge">Sinatra::Base</code>-Subklasse. Falls die
Top- Level-DSL verwendet wird (<code class="highlighter-rouge">require 'sinatra'</code>), handelt es sich um
<code class="highlighter-rouge">Sinatra::Application</code>, andernfalls ist es jene Subklasse, die explizit
angelegt wurde. Auf Klassenebene stehen Methoden wie <code class="highlighter-rouge">get</code> oder <code class="highlighter-rouge">before</code> zur
Verfügung, es gibt aber keinen Zugriff auf das <code class="highlighter-rouge">request</code>-Object oder die
<code class="highlighter-rouge">session</code>, da nur eine einzige Klasse für alle eingehenden Anfragen genutzt
wird.</p>

<p>Optionen, die via <code class="highlighter-rouge">set</code> gesetzt werden, sind Methoden auf Klassenebene:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Hey, ich bin im Anwendungsscope!</span>
<span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="mi">42</span>
  <span class="n">foo</span> <span class="c1"># =&gt; 42</span>

  <span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
    <span class="c1"># Hey, ich bin nicht mehr im Anwendungs-Scope!</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Im Anwendungs-Scope befindet man sich:</p>

<ul>
  <li>Innerhalb der Anwendungs-Klasse</li>
  <li>In Methoden, die von Erweiterungen definiert werden</li>
  <li>Im Block, der an <code class="highlighter-rouge">helpers</code> übergeben wird</li>
  <li>In Procs und Blöcken, die an <code class="highlighter-rouge">set</code> übergeben werden</li>
  <li>Der an <code class="highlighter-rouge">Sinatra.new</code> übergebene Block</li>
</ul>

<p>Auf das Scope-Objekt (die Klasse) kann wie folgt zugegriffen werden:</p>

<ul>
  <li>Über das Objekt, das an den <code class="highlighter-rouge">configure</code>-Block übergeben wird (<code class="highlighter-rouge">configure {
|c| ... }</code>).</li>
  <li>
<code class="highlighter-rouge">settings</code> aus den anderen Scopes heraus.</li>
</ul>

<h3>Anfrage- oder Instanz-Scope</h3>

<p>Für jede eingehende Anfrage wird eine neue Instanz der Anwendungs-Klasse
erstellt und alle Handler in diesem Scope ausgeführt. Aus diesem Scope heraus
kann auf <code class="highlighter-rouge">request</code> oder <code class="highlighter-rouge">session</code> zugegriffen und Methoden wie <code class="highlighter-rouge">erb</code> oder
<code class="highlighter-rouge">haml</code> aufgerufen werden. Außerdem kann mit der <code class="highlighter-rouge">settings</code>-Method auf den
Anwendungs-Scope zugegriffen werden:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Hey, ich bin im Anwendungs-Scope!</span>
  <span class="n">get</span> <span class="s1">'/neue_route/:name'</span> <span class="k">do</span>
    <span class="c1"># Anfrage-Scope für '/neue_route/:name'</span>
    <span class="vi">@value</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">settings</span><span class="p">.</span><span class="nf">get</span> <span class="s2">"/</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'name'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span> <span class="k">do</span>
      <span class="c1"># Anfrage-Scope für "/#{params['name']}"</span>
      <span class="vi">@value</span> <span class="c1"># =&gt; nil (nicht dieselbe Anfrage)</span>
    <span class="k">end</span>

    <span class="s2">"Route definiert!"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Im Anfrage-Scope befindet man sich:</p>

<ul>
  <li>In get, head, post, put, delete, options, patch, link und unlink Blöcken</li>
  <li>In before und after Filtern</li>
  <li>In Helfer-Methoden</li>
  <li>In Templates/Views</li>
</ul>

<h3>Delegation-Scope</h3>

<p>Vom Delegation-Scope aus werden Methoden einfach an den Klassen-Scope
weitergeleitet. Dieser verhält sich jedoch nicht 100%ig wie der Klassen-Scope,
da man nicht die Bindung der Klasse besitzt: Nur Methoden, die explizit als
delegierbar markiert wurden, stehen hier zur Verfügung und es kann nicht auf
die Variablen des Klassenscopes zugegriffen werden (mit anderen Worten: es
gibt ein anderes <code class="highlighter-rouge">self</code>). Weitere Delegationen können mit
<code class="highlighter-rouge">Sinatra::Delegator.delegate :methoden_name</code> hinzugefügt werden.</p>

<p>Im Delegation-Scop befindet man sich:</p>

<ul>
  <li>Im Top-Level, wenn <code class="highlighter-rouge">require 'sinatra'</code> aufgerufen wurde.</li>
  <li>In einem Objekt, das mit dem <code class="highlighter-rouge">Sinatra::Delegator</code>-Mixin erweitert wurde.</li>
</ul>

<p>Schau am besten im Code nach: Hier ist <a href="http://github.com/sinatra/sinatra/blob/master/lib/sinatra/base.rb#L1064">Sinatra::Delegator
mixin</a> definiert und wird in den <a href="http://github.com/sinatra/sinatra/blob/master/lib/sinatra/main.rb">globalen Namespace
eingebunden</a>.</p>

<h2>Kommandozeile</h2>

<p>Sinatra-Anwendungen können direkt von der Kommandozeile aus gestartet werden:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby myapp.rb <span class="o">[</span>-h] <span class="o">[</span>-x] <span class="o">[</span>-q] <span class="o">[</span>-e ENVIRONMENT] <span class="o">[</span>-p PORT] <span class="o">[</span>-h HOST] <span class="o">[</span>-s HANDLER]
</code></pre>
</div>

<p>Die Optionen sind:</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>-h # Hilfe
-p # Port setzen (Standard ist 4567)
-h # Host setzen (Standard ist 0.0.0.0)
-e # Umgebung setzen (Standard ist development)
-s # Rack-Server/Handler setzen (Standard ist thin)
-q # den lautlosen Server-Modus einschalten (Standard ist aus)
-x # Mutex-Lock einschalten (Standard ist aus)
</code></pre>
</div>

<h3>Multi-threading</h3>

<p><em>Paraphrasiert von <a href="http://stackoverflow.com/questions/6278817/is-sinatra-multi-threaded/6282999#6282999)">dieser Antwort auf StackOverflow</a> von
Konstantin</em></p>

<p>Sinatra erlegt kein Nebenläufigkeitsmodell auf, sondern überlässt dies dem
selbst gewählten Rack-Proxy (Server), so wie Thin, Puma oder WEBrick.
Sinatra selbst ist Thread-sicher, somit ist es kein Problem wenn der
Rack-Proxy ein anderes Threading-Modell für Nebenläufigkeit benutzt.
Das heißt, dass wenn der Server gestartet wird, dass man die korrekte
Aufrufsmethode benutzen sollte für den jeweiligen Rack-Proxy.
Das folgende Beispiel ist eine Veranschaulichung eines mehrprozessigen
Thin Servers:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app.rb</span>

<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">App</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s2">"Hello, World"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">App</span><span class="p">.</span><span class="nf">run!</span>

</code></pre>
</div>

<p>Um den Server zu starten, führt man das folgende Kommando aus:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>thin --threaded start
</code></pre>
</div>

<h2>Systemanforderungen</h2>

<p>Die folgenden Versionen werden offiziell unterstützt:</p>

<dl>
  <dt>Ruby 2.3</dt>
  <dd>
    2.3 wird vollständig unterstützt. Es gibt derzeit keine Pläne die
    offizielle Unterstützung zu beenden
  </dd>

  <dt>Rubinius</dt>
  <dd>
    Rubinius (Version &gt;= 2.x) wird offiziell unterstützt. Es wird
    empfohlen, den <a href="http://puma.io">Puma Server</a> zu
    installieren (<tt>gem install puma</tt>)
  </dd>

  <dt>JRuby</dt>
  <dd>
    Aktuelle JRuby Versionen werden offiziell unterstützt. Es wird empfohlen,
    keine C-Erweiterungen zu verwenden und als Server Trinidad zu verwenden
    (<tt>gem install trinidad</tt>).
  </dd>
</dl>

<p>Versionen vor Ruby 2.2.2 werden ab Sinatra 2.0 nicht länger unterstützt.</p>

<p>Nachfolgende Ruby-Versionen werden regelmäßig auf Unterstützung geprüft.</p>

<p>Die nachfolgend aufgeführten Ruby-Implementierungen werden offiziell nicht von
Sinatra unterstützt, funktionieren aber normalerweise:</p>

<ul>
  <li>Ruby Enterprise Edition</li>
  <li>Ältere Versionen von JRuby und Rubinius</li>
  <li>MacRuby, Maglev, IronRuby</li>
  <li>Ruby 1.9.0 und 1.9.1 (wird aber nicht empfohlen)</li>
</ul>

<p>Nicht offiziell unterstützt bedeutet, dass wenn Sachen nicht funktionieren,
wir davon ausgehen, dass es nicht an Sinatra sondern an der jeweiligen
Implementierung liegt.</p>

<p>Im Rahmen unserer CI (Kontinuierlichen Integration) wird bereits ruby-head
(zukünftige Versionen von MRI) mit eingebunden. Es kann davon ausgegangen
werden, dass Sinatra MRI auch weiterhin vollständig unterstützen wird.</p>

<p>Sinatra sollte auf jedem Betriebssystem laufen, das einen funktionierenden
Ruby-Interpreter aufweist.</p>

<p>Sinatra läuft aktuell nicht unter Cardinal, SmallRuby, BlueRuby oder Ruby &lt;=
2.2.</p>

<h2>Der neuste Stand (The Bleeding Edge)</h2>

<p>Um auf dem neusten Stand zu bleiben, kann der Master-Branch verwendet werden.
Er sollte recht stabil sein. Ebenso gibt es von Zeit zu Zeit prerelease Gems,
die so installiert werden:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra --pre
</code></pre>
</div>

<h3>Mit Bundler</h3>

<p>Wenn die Applikation mit der neuesten Version von Sinatra und
<a href="http://bundler.io">Bundler</a> genutzt werden soll, empfehlen wir den
nachfolgenden Weg.</p>

<p>Soweit Bundler noch nicht installiert ist:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install bundler
</code></pre>
</div>

<p>Anschließend wird eine <code class="highlighter-rouge">Gemfile</code>-Datei im Projektverzeichnis mit folgendem
Inhalt erstellt:</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">source</span> <span class="ss">:rubygems</span>
<span class="n">gem</span> <span class="s1">'sinatra'</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">"git://github.com/sinatra/sinatra.git"</span>

<span class="c1"># evtl. andere Abhängigkeiten</span>
<span class="n">gem</span> <span class="s1">'haml'</span>                    <span class="c1"># z.B. wenn du Haml verwendest...</span>
</code></pre>
</div>

<p>Beachte: Hier sollten alle Abhängigkeiten eingetragen werden. Sinatras eigene,
direkte Abhängigkeiten (Tilt und Rack) werden von Bundler automatisch aus dem
Gemfile von Sinatra hinzugefügt.</p>

<p>Jetzt kannst du deine Applikation starten:</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>bundle <span class="nb">exec </span>ruby myapp.rb
</code></pre>
</div>

<h2>Versions-Verfahren</h2>

<p>Sinatra folgt dem sogenannten <a href="http://semver.org/">Semantic Versioning</a>, d.h.
SemVer und SemVerTag.</p>

<h2>Mehr</h2>

<ul>
  <li>
<a href="http://www.sinatrarb.com/">Projekt-Website</a> - Ergänzende Dokumentation,
News und Links zu anderen Ressourcen.</li>
  <li>
<a href="http://www.sinatrarb.com/contributing.html">Mitmachen</a> - Einen Fehler
gefunden? Brauchst du Hilfe? Hast du einen Patch?</li>
  <li><a href="https://github.com/sinatra/sinatra/issues">Issue-Tracker</a></li>
  <li><a href="https://twitter.com/sinatra">Twitter</a></li>
  <li><a href="http://groups.google.com/group/sinatrarb">Mailing-Liste</a></li>
  <li>IRC <a href="irc://chat.freenode.net/#sinatra">#sinatra</a> auf
http://freenode.net Es gibt dort auch immer wieder deutschsprachige
Entwickler, die gerne weiterhelfen.</li>
  <li>
<a href="https://sinatrarb.slack.com">Sinatra &amp; Friends</a> on Slack and see
<a href="https://sinatra-slack.herokuapp.com/">here</a> for an invite.</li>
  <li>
<a href="https://github.com/sinatra/sinatra-book/">Sinatra Book</a> Kochbuch Tutorial</li>
  <li>
<a href="http://recipes.sinatrarb.com/">Sinatra Recipes</a> Sinatra-Rezepte aus der
Community</li>
  <li>API Dokumentation für die
<a href="http://www.rubydoc.info//gems/sinatra">aktuelle Version</a> oder für
<a href="http://www.rubydoc.info/github/sinatra/sinatra">HEAD</a> auf
http://rubydoc.info</li>
  <li><a href="https://travis-ci.org/sinatra/sinatra">CI Server</a></li>
</ul>
</body></html>
