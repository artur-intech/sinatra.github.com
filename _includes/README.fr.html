<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<p><em>Attention : Ce document correspond à la traduction de la version anglaise et
il n’est peut-être plus à jour.</em></p>

<p>Sinatra est un <a href="https://fr.wikipedia.org/wiki/Langage_d%C3%A9di%C3%A9">DSL</a> pour
créer rapidement et facilement des applications web en Ruby :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># mon_application.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Bonjour le monde !'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Installez la gem Sinatra :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra
</code></pre>
</div>

<p>Puis lancez votre programme :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby mon_application.rb
</code></pre>
</div>

<p>Le résultat est visible sur : <a href="http://localhost:4567">http://localhost:4567</a></p>

<p>Le code que vous avez modifié ne sera pas pris en compte tant que vous ne
redémarrerez pas le serveur. Pensez à redémarrer le serveur à chaque
modification ou utilisez
<a href="http://www.sinatrarb.com/contrib/reloader">sinatra/reloader</a>.</p>

<p>Il est recommandé d’exécuter également <code class="highlighter-rouge">gem install thin</code>, pour que
Sinatra utilise le server Thin quand il est disponible.</p>

<h2>Table des matières</h2>



<h2>Routes</h2>

<p>Dans Sinatra, une route est une méthode HTTP couplée à un masque (pattern)
URL. Chaque route est associée à un bloc :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">montrer</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">cr</span><span class="err">é</span><span class="n">er</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">put</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">remplacer</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">patch</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">changer</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">delete</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">effacer</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">options</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">param</span><span class="err">é</span><span class="n">trer</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">link</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">relier</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>

<span class="n">unlink</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="p">.</span><span class="nf">.</span> <span class="n">s</span><span class="err">é</span><span class="n">parer</span> <span class="n">quelque</span> <span class="n">chose</span> <span class="p">.</span><span class="nf">.</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les routes sont évaluées dans l’ordre où elles ont été définies. La première
route qui correspond à la requête est appelée.</p>

<p>Les routes se terminant par un slash sont différentes de celles qui n’en
comportent pas :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="c1"># Ne correspond pas à "GET /foo/"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les masques peuvent inclure des paramètres nommés, accessibles par
l’intermédiaire du hash <code class="highlighter-rouge">params</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/bonjour/:nom'</span> <span class="k">do</span>
  <span class="c1"># répond aux requêtes "GET /bonjour/foo" et "GET /bonjour/bar"</span>
  <span class="c1"># params['nom'] est 'foo' ou 'bar'</span>
  <span class="s2">"Bonjour </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">]</span><span class="si">}</span><span class="s2"> !"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous pouvez aussi accéder aux paramètres nommés directement grâce aux
paramètres du bloc comme ceci :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/bonjour/:nom'</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="c1"># répond aux requêtes "GET /bonjour/foo" et "GET /bonjour/bar"</span>
  <span class="c1"># params['nom'] est 'foo' ou 'bar'</span>
  <span class="c1"># n contient params['nom']</span>
  <span class="s2">"Bonjour </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2"> !"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Une route peut contenir un <code class="highlighter-rouge">splat</code> (caractère joker), accessible par
l’intermédiaire du tableau <code class="highlighter-rouge">params['splat']</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/dire/*/a/*'</span> <span class="k">do</span>
  <span class="c1"># répond à /dire/bonjour/a/monde</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["bonjour", "monde"]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/telecharger/*.*'</span> <span class="k">do</span>
  <span class="c1"># répond à /telecharger/chemin/vers/fichier.xml</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1"># =&gt; ["chemin/vers/fichier", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou par l’intermédiaire des paramètres du bloc :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/telecharger/*.*'</span> <span class="k">do</span> <span class="o">|</span><span class="n">chemin</span><span class="p">,</span> <span class="n">ext</span><span class="o">|</span>
  <span class="p">[</span><span class="n">chemin</span><span class="p">,</span> <span class="n">ext</span><span class="p">]</span> <span class="c1"># =&gt; ["path/to/file", "xml"]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Une route peut aussi être définie par une expression régulière :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">/\/bonjour\/([\w]+)/</span> <span class="k">do</span>
  <span class="s2">"Bonjour, </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'captures'</span><span class="p">].</span><span class="nf">first</span><span class="si">}</span><span class="s2"> !"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Là encore on peut utiliser les paramètres de bloc :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{/bonjour/([</span><span class="se">\w</span><span class="sr">]+)}</span> <span class="k">do</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span>
  <span class="c1"># répond à "GET /meta/bonjour/monde", "GET /bonjour/monde/1234" etc.</span>
  <span class="s2">"Bonjour, </span><span class="si">#{</span><span class="n">c</span><span class="si">}</span><span class="s2"> !"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les routes peuvent aussi comporter des paramètres optionnels :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/articles/:format?'</span> <span class="k">do</span>
  <span class="c1"># répond à "GET /articles/" ou avec une extension "GET /articles/json", "GET /articles/xml" etc...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ainsi que des paramètres d’URL :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/articles'</span> <span class="k">do</span>
  <span class="c1"># répond à "GET /articles?titre=foo&amp;auteur=bar"</span>
  <span class="n">titre</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'titre'</span><span class="p">]</span>
  <span class="n">auteur</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'auteur'</span><span class="p">]</span>
  <span class="c1"># utilise les variables titre et auteur qui sont des paramètres d'URL optionnels pour la route /articles</span>
<span class="k">end</span>
</code></pre>
</div>

<p>À ce propos, à moins d’avoir désactivé la protection contre les attaques par
“path transversal” (voir plus loin), l’URL demandée peut avoir été modifiée
avant d’être comparée à vos routes.</p>

<p>Vous pouvez personnaliser les options <a href="https://github.com/sinatra/mustermann#readme">Mustermann</a>
utilisées pour une route donnée en fournissant un hash <code class="highlighter-rouge">:mustermann_opts</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'\A/articles\z'</span><span class="p">,</span> <span class="ss">:mustermann_opts</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:regexp</span><span class="p">,</span> <span class="ss">:check_anchors</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">}</span> <span class="k">do</span>
  <span class="c1"># répond exactement à /articles, avec un ancrage explicite</span>
  <span class="s2">"Si tu réponds à un pattern ancré tape dans tes mains !
end
</span></code></pre>
</div>

<p>Cela ressemble à une <a href="#conditions">condition</a>, mais ce n’en est pas une !
Ces options seront mergées dans le hash global <code class="highlighter-rouge">:mustermann_opts</code> décrit
<a href="#param%C3%A8tres-disponibles">plus bas</a>.</p>

<h2>Conditions</h2>

<p>Les routes peuvent définir toutes sortes de conditions, comme par exemple le
“user agent” :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span><span class="p">,</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird (\d\.\d)[\d\/]*?/</span> <span class="k">do</span>
  <span class="s2">"Vous utilisez Songbird version </span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'agent'</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="c1"># Correspond à tous les autres navigateurs</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les autres conditions disponibles sont <code class="highlighter-rouge">host_name</code> et <code class="highlighter-rouge">provides</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="sr">/^admin\./</span> <span class="k">do</span>
  <span class="s2">"Zone Administrateur, Accès refusé !"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="s1">'html'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="ss">:provides</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'rss'</span><span class="p">,</span> <span class="s1">'atom'</span><span class="p">,</span> <span class="s1">'xml'</span><span class="p">]</span> <span class="k">do</span>
  <span class="n">builder</span> <span class="ss">:feed</span>
<span class="k">end</span>
</code></pre>
</div>
<p><code class="highlighter-rouge">provides</code> se base sur l’en-tête <code class="highlighter-rouge">Accept</code> de la requête.</p>

<p>Vous pouvez facilement définir vos propres conditions :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:chance</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">valeur</span><span class="o">|</span> <span class="n">condition</span> <span class="p">{</span> <span class="nb">rand</span> <span class="o">&lt;=</span> <span class="n">valeur</span> <span class="p">}</span> <span class="p">}</span>

<span class="n">get</span> <span class="s1">'/gagner_une_voiture'</span><span class="p">,</span> <span class="ss">:chance</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">1</span> <span class="k">do</span>
  <span class="s2">"Vous avez gagné !"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/gagner_une_voiture'</span> <span class="k">do</span>
  <span class="s2">"Désolé, vous avez perdu."</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Utilisez un <code class="highlighter-rouge">splat</code> (caractère joker) dans le cas d’une condition qui prend
plusieurs valeurs :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span><span class="p">(</span><span class="ss">:auth</span><span class="p">)</span> <span class="k">do</span> <span class="o">|*</span><span class="n">roles</span><span class="o">|</span>   <span class="c1"># &lt;- ici on utilise un splat</span>
  <span class="n">condition</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">logged_in?</span> <span class="o">&amp;&amp;</span> <span class="n">roles</span><span class="p">.</span><span class="nf">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">role</span><span class="o">|</span> <span class="n">current_user</span><span class="p">.</span><span class="nf">in_role?</span> <span class="n">role</span> <span class="p">}</span>
      <span class="n">redirect</span> <span class="s2">"/login/"</span><span class="p">,</span> <span class="mi">303</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/mon/compte/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">]</span> <span class="k">do</span>
  <span class="s2">"Informations sur votre compte"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s2">"/reserve/aux/admins/"</span><span class="p">,</span> <span class="ss">:auth</span> <span class="o">=&gt;</span> <span class="ss">:admin</span> <span class="k">do</span>
  <span class="s2">"Seuls les administrateurs sont acceptés ici !"</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Valeurs de retour</h2>

<p>La valeur renvoyée par le bloc correspondant à une route constitue le corps de
la réponse qui sera transmise au client HTTP ou du moins au prochain <code class="highlighter-rouge">middleware</code>
dans la pile Rack. Le plus souvent, il s’agit d’une chaîne de caractères,
comme dans les exemples précédents. Cependant, d’autres valeurs sont
acceptées.</p>

<p>Vous pouvez renvoyer n’importe quel objet qu’il s’agisse d’une réponse Rack
valide, d’un corps de réponse Rack ou d’un code statut HTTP :</p>

<ul>
  <li>Un tableau de 3 éléments : <code class="highlighter-rouge">[code statut (Integer), en-têtes (Hash), corps
de la réponse (répondant à #each)]</code>
</li>
  <li>Un tableau de 2 élements : <code class="highlighter-rouge">[code statut (Integer), corps de la réponse
(répondant à #each)]</code>
</li>
  <li>Un objet qui répond à <code class="highlighter-rouge">#each</code> et qui ne transmet que des chaînes de
caractères au bloc fourni</li>
  <li>Un Integer représentant le code statut</li>
</ul>

<p>Ainsi, on peut facilement implémenter un exemple de streaming :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">Stream</span>
  <span class="k">def</span> <span class="nf">each</span>
    <span class="mi">100</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="k">yield</span> <span class="s2">"</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="se">\n</span><span class="s2">"</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="no">Stream</span><span class="p">.</span><span class="nf">new</span> <span class="p">}</span>
</code></pre>
</div>

<p>Vous pouvez aussi utiliser le helper <code class="highlighter-rouge">stream</code> (présenté un peu plus loin) pour
éviter les répétitions et intégrer le traitement relatif au streaming dans le bloc
de code de la route.</p>

<h2>Masques de route spécifiques</h2>

<p>Comme cela a été vu auparavant, Sinatra offre la possibilité d’utiliser des
masques sous forme de chaines de caractères ou des expressions régulières
pour définir les routes. Mais il est possible de faire bien plus. Vous pouvez
facilement définir vos propres masques :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MasqueToutSauf</span>
  <span class="nc">Masque</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:captures</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">except</span><span class="p">)</span>
    <span class="vi">@except</span>   <span class="o">=</span> <span class="n">except</span>
    <span class="vi">@captures</span> <span class="o">=</span> <span class="no">Masque</span><span class="p">.</span><span class="nf">new</span><span class="p">([])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
    <span class="vi">@caputres</span> <span class="k">unless</span> <span class="vi">@except</span> <span class="o">===</span> <span class="n">str</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">tout_sauf</span><span class="p">(</span><span class="n">masque</span><span class="p">)</span>
  <span class="no">MasqueToutSauf</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">masque</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="n">tout_sauf</span><span class="p">(</span><span class="s2">"/index"</span><span class="p">)</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Notez que l’exemple ci-dessus est plus compliqué qu’il ne devrait et peut être implémenté de la façon suivante :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">//</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">==</span> <span class="s2">"/index"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou bien en utilisant cette expression regulière :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="sr">%r{(?!/index)}</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Fichiers statiques</h2>

<p>Les fichiers du dossier <code class="highlighter-rouge">./public</code> sont servis de façon statique. Vous pouvez spécifier un autre dossier avec le paramètre <code class="highlighter-rouge">:public_folder</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:public_folder</span><span class="p">,</span> <span class="n">__dir__</span> <span class="o">+</span> <span class="s1">'/statique'</span>
</code></pre>
</div>

<p>Notez que le nom du dossier public n’apparait pas dans l’URL. Le fichier
<code class="highlighter-rouge">./public/css/style.css</code> sera accessible à l’URL :
<code class="highlighter-rouge">http://exemple.com/css/style.css</code>.</p>

<p>Utilisez le paramètre <code class="highlighter-rouge">:static_cache_control</code> pour ajouter l’information
d’en-tête <code class="highlighter-rouge">Cache-Control</code> (voir plus bas).</p>

<h2>Vues / Templates</h2>

<p>Chaque langage de template est disponible via sa propre méthode de rendu,
lesquelles renvoient tout simplement une chaîne de caractères.</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ceci génère la vue <code class="highlighter-rouge">views/index.erb</code>.</p>

<p>Plutôt que d’utiliser le nom d’un template, vous pouvez directement passer
le contenu du template :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">code</span> <span class="o">=</span> <span class="s2">"&lt;%= Time.now %&gt;"</span>
  <span class="n">erb</span> <span class="n">code</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les méthodes de templates acceptent un hash d’options comme second argument :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:post</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ceci génèrera la vue <code class="highlighter-rouge">views/index.erb</code> en l’intégrant au <em>layout</em> <code class="highlighter-rouge">views/post.erb</code> (<code class="highlighter-rouge">views/layout.erb</code> est la valeur par défaut si ce fichier existe).</p>

<p>Toute option que Sinatra ne comprend pas sera passée au moteur de rendu :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="ss">:html5</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous pouvez également définir les options de chaque langage de template de façon
générale :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:haml</span><span class="p">,</span> <span class="ss">:format</span> <span class="o">=&gt;</span> <span class="n">html5</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les arguments passés à la méthode de rendu prennent le pas sur les options définies au moyen de <code class="highlighter-rouge">set</code>.</p>

<p>Options disponibles :</p>

<dl>
  <dt>locals</dt>
  <dd>
    Liste de variables locales passées au document. Pratique pour les vues
    partielles.
    Exemple : <tt>erb "&lt;%= foo %&gt;", :locals =&gt; {:foo =&gt; "bar"}</tt>.
  </dd>

  <dt>default_encoding</dt>
  <dd>
    Encodage de caractères à utiliser en cas d'incertitude. Par défaut
    <tt>settings.default_encoding</tt>.
  </dd>

  <dt>views</dt>
  <dd>
    Dossier de vues dans lequel chercher les templates. Par défaut
    <tt>settings.views</tt>.
  </dd>

  <dt>layout</dt>
  <dd>
    S'il faut ou non utiliser un layout (<tt>true</tt> ou <tt>false</tt>).
    Ou indique le template à utiliser lorsque c'est un symbole. Exemple :
    <tt>erb :index, :layout =&gt; !request.xhr?</tt>.
  </dd>

  <dt>content_type</dt>
  <dd>
    Content-Type que le template génère. La valeur par défaut dépend du langage de template.
  </dd>

  <dt>scope</dt>
  <dd>
    Contexte dans lequel effectuer le rendu du template. Par défaut il s'agit
    de l'instance de l'application. Si vous changez cela, les variables
    d'instance et les méthodes utilitaires ne seront pas disponibles.
  </dd>

  <dt>layout_engine</dt>
  <dd>
    Moteur de rendu à utiliser pour le layout. Utile pour les langages ne
    supportant pas les layouts. Il s'agit par défaut du moteur utilisé pour
    le rendu du template. Exemple : <tt>set :rdoc, :layout_engine =&gt; :erb</tt>
  </dd>

  <dt>layout_options</dt>
  <dd>
    Options spécifiques à la génération du layout. Exemple : <tt>set :rdoc,
    :layout_options =&gt; { :views =&gt; 'views/layouts' }</tt>
  </dd>
</dl>

<p>Les templates sont supposés se trouver directement dans le dossier
<code class="highlighter-rouge">./views</code>. Pour utiliser un dossier de vues différent :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="n">settings</span><span class="p">.</span><span class="nf">root</span> <span class="o">+</span> <span class="s1">'/templates'</span>
</code></pre>
</div>

<p>Il est important de se souvenir que les templates sont toujours référencés
sous forme de symboles, même lorsqu’ils sont dans un sous-répertoire (dans
ce cas, utilisez <code class="highlighter-rouge">:'sous_repertoire/template'</code>). Il faut utiliser
un symbole car les méthodes de rendu évaluent le contenu des chaînes de
caractères au lieu de les considérer comme un chemin vers un fichier.</p>

<h3>Templates littéraux</h3>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Bonjour le monde'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Utilisera la chaine de caractères comme template pour générer la réponse.
Vous pouvez spécifier un <code class="highlighter-rouge">:path</code> et <code class="highlighter-rouge">:line</code> optionnels pour une trace plus
claire s’il existe un chemin dans le système de fichiers ou une ligne
associés à cette chaîne de caractères :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="s1">'%div.title Bonjour le monde'</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s1">'exemples/fichier.haml'</span><span class="p">,</span> <span class="ss">:line</span> <span class="o">=&gt;</span> <span class="mi">3</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Langages de template disponibles</h3>

<p>Certains langages ont plusieurs implémentations. Pour préciser l’implémentation
à utiliser (et garantir l’aspect thread-safe), vous devez simplement l’avoir
chargée au préalable :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rdiscount'</span> <span class="c1"># ou require 'bluecloth'</span>
<span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="n">markdown</span> <span class="ss">:index</span> <span class="p">}</span>
</code></pre>
</div>

<h4>Templates Haml</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://haml.info/" title="haml">haml</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.haml</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>haml :index, :format =&gt; :html5</tt></td>
  </tr>
</table>

<h4>Templates Erb</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td>
      <a href="http://www.kuwata-lab.com/erubis/" title="erubis">erubis</a>
      ou erb (inclus avec Ruby)
    </td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td>
<tt>.erb</tt>, <tt>.rhtml</tt> ou <tt>.erubis</tt> (Erubis seulement)</td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>erb :index</tt></td>
  </tr>
</table>

<h4>Templates Builder</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td>
      <a href="https://github.com/jimweirich/builder" title="builder">builder</a>
    </td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.builder</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>builder { |xml| xml.em "salut" }</tt></td>
  </tr>
</table>

<p>Ce moteur accepte également un bloc pour des templates en ligne (voir
exemple).</p>

<h4>Templates Nokogiri</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://www.nokogiri.org/" title="nokogiri">nokogiri</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.nokogiri</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td>
<tt>nokogiri { |xml| xml.em "salut" }</tt>
    </td>
  </tr>
</table>

<p>Ce moteur accepte également un bloc pour des templates en ligne (voir
exemple).</p>

<h4>Templates Sass</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.sass</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>sass :stylesheet, :style =&gt; :expanded</tt></td>
  </tr>
</table>

<h4>Templates SCSS</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://sass-lang.com/" title="sass">sass</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.scss</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td>
<tt>scss :stylesheet, :style =&gt; :expanded</tt>&lt;/p&gt;
    </td>
  </tr>
</table>

<h4>Templates Less</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://lesscss.org/" title="less">less</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.less</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td>
<tt>less :stylesheet</tt>
    </td>
  </tr>
</table>

<h4>Templates Liquid</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="https://shopify.github.io/liquid/" title="liquid">liquid</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.liquid</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>liquid :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>Comme vous ne pouvez appeler de méthodes Ruby (autres que <code class="highlighter-rouge">yield</code>)
dans un template Liquid, vous aurez sûrement à lui passer des variables
locales.</p>

<h4>Templates Markdown</h4>

<table>
  <tr>
    <td><p>Dépendances</p></td>
    <td>
      Au choix :
      <a href="https://github.com/davidfstr/rdiscount" title="RDiscount">RDiscount</a>,
      <a href="https://github.com/vmg/redcarpet" title="RedCarpet">RedCarpet</a>,
      <a href="https://github.com/ged/bluecloth" title="bluecloth">BlueCloth</a>,
      <a href="http://kramdown.gettalong.org/" title="kramdown">kramdown</a>,
      <a href="https://github.com/bhollis/maruku" title="maruku">maruku</a>
    </td>
  </tr>

  <tr>
    <td>Extensions de fichier</td>
    <td>
<tt>.markdown</tt>, <tt>.mkd</tt> et <tt>.md</tt>
</td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>markdown :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Il n’est pas possible d’appeler des méthodes depuis markdown, ni de
lui passer de variables locales. Par conséquent, il sera souvent utilisé
en combinaison avec un autre moteur de rendu :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:accueil</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Notez que vous pouvez également appeler la méthode <code class="highlighter-rouge">markdown</code> depuis un autre template :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Bonjour</span> <span class="n">depuis</span> <span class="no">Haml</span> <span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:bienvenue</span><span class="p">)</span>
</code></pre>
</div>

<p>Comme vous ne pouvez pas appeler de méthode Ruby depuis Markdown, vous ne
pouvez pas utiliser de layouts écrits en Markdown. Toutefois, il
est possible d’utiliser un moteur de rendu différent pour le template et
pour le layout en utilisant l’option <code class="highlighter-rouge">:layout_engine</code>.</p>

<h4>Templates Textile</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://redcloth.org/" title="RedCloth">RedCloth</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.textile</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>textile :index, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Il n’est pas possible d’appeler de méthodes depuis textile, ni de lui
passer de variables locales. Par conséquent, il sera souvent utilisé en
combinaison avec un autre moteur de rendu :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:accueil</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Notez que vous pouvez également appeler la méthode <code class="highlighter-rouge">textile</code> depuis un autre template :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Bonjour</span> <span class="n">depuis</span> <span class="no">Haml</span> <span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">textile</span><span class="p">(</span><span class="ss">:bienvenue</span><span class="p">)</span>
</code></pre>
</div>

<p>Comme vous ne pouvez pas appeler de méthode Ruby depuis Textile, vous ne pouvez
pas utiliser de layouts écrits en Textile. Toutefois, il est
possible d’utiliser un moteur de rendu différent pour le template et
pour le layout en utilisant l’option <code class="highlighter-rouge">:layout_engine</code>.</p>

<h4>Templates RDoc</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://rdoc.sourceforge.net/" title="RDoc">RDoc</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.rdoc</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>rdoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Il n’est pas possible d’appeler de méthodes Ruby depuis rdoc, ni de lui
passer de variables locales. Par conséquent, il sera souvent utilisé en
combinaison avec un autre moteur de rendu :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:accueil</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Notez que vous pouvez également appeler la méthode <code class="highlighter-rouge">rdoc</code> depuis un autre template :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Bonjour</span> <span class="n">depuis</span> <span class="no">Haml</span> <span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">rdoc</span><span class="p">(</span><span class="ss">:bienvenue</span><span class="p">)</span>
</code></pre>
</div>

<p>Comme vous ne pouvez pas appeler de méthodes Ruby depuis RDoc, vous ne pouvez
pas utiliser de layouts écrits en RDoc. Toutefois, il est
possible d’utiliser un moteur de rendu différent pour le template et
pour le layout en utilisant l’option <code class="highlighter-rouge">:layout_engine</code>.</p>

<h4>Templates Asciidoc</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://asciidoctor.org/" title="Asciidoctor">Asciidoctor</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td>
<tt>.asciidoc</tt>, <tt>.adoc</tt> and <tt>.ad</tt>
</td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>asciidoc :README, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Comme vous ne pouvez pas appeler de méthodes Ruby depuis un template
AsciiDoc, vous aurez sûrement à lui passer des variables locales.</p>

<h4>Templates Radius</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="https://github.com/jlong/radius" title="Radius">Radius</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.radius</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>radius :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>Comme vous ne pouvez pas appeler de méthodes Ruby depuis un template
Radius, vous aurez sûrement à lui passer des variables locales.</p>

<h4>Templates Markaby</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://markaby.github.io/" title="Markaby">Markaby</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.mab</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>markaby { h1 "Bienvenue !" }</tt></td>
  </tr>
</table>

<p>Ce moteur accepte également un bloc pour des templates en ligne (voir
exemple).</p>

<h4>Templates RABL</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="https://github.com/nesquena/rabl" title="Rabl">Rabl</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.rabl</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>rabl :index</tt></td>
  </tr>
</table>

<h4>Templates Slim</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="http://slim-lang.com/" title="Slim Lang">Slim Lang</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.slim</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>slim :index</tt></td>
  </tr>
</table>

<h4>Templates Creole</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="https://github.com/minad/creole" title="Creole">Creole</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.creole</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>creole :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Il n’est pas possible d’appeler de méthodes Ruby depuis creole, ni de lui
passer de variables locales. Par conséquent, il sera souvent utilisé en
combinaison avec un autre moteur de rendu :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:accueil</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">markdown</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Notez que vous pouvez également appeler la méthode <code class="highlighter-rouge">creole</code> depuis un autre template :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Bonjour</span> <span class="n">depuis</span> <span class="no">Haml</span> <span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">creole</span><span class="p">(</span><span class="ss">:bienvenue</span><span class="p">)</span>
</code></pre>
</div>

<p>Comme vous ne pouvez pas appeler de méthodes Ruby depuis Creole, vous ne pouvez
pas utiliser de layouts écrits en Creole. Toutefois, il est possible
d’utiliser un moteur de rendu différent pour le template et pour le layout
en utilisant l’option <code class="highlighter-rouge">:layout_engine</code>.</p>

<h4>Templates MediaWiki</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="https://github.com/nricciar/wikicloth" title="WikiCloth">WikiCloth</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td>
<tt>.mediawiki</tt> and <tt>.mw</tt>
</td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>mediawiki :wiki, :layout_engine =&gt; :erb</tt></td>
  </tr>
</table>

<p>Il n’est pas possible d’appeler de méthodes Ruby depuis Mediawiki, ni de lui
passer de variables locales. Par conséquent, il sera souvent utilisé en
combinaison avec un autre moteur de rendu :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:overview</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">mediawiki</span><span class="p">(</span><span class="ss">:introduction</span><span class="p">)</span> <span class="p">}</span>
</code></pre>
</div>

<p>Notez que vous pouvez également appeler la méthode <code class="highlighter-rouge">mediawiki</code> depuis un
autre template :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">h1</span> <span class="no">Bonjour</span> <span class="n">depuis</span> <span class="no">Haml</span> <span class="o">!</span>
<span class="o">%</span><span class="nb">p</span><span class="o">=</span> <span class="n">mediawiki</span><span class="p">(</span><span class="ss">:bienvenue</span><span class="p">)</span>
</code></pre>
</div>

<p>Comme vous ne pouvez pas appeler de méthodes Ruby depuis MediaWiki, vous ne pouvez
pas utiliser de layouts écrits en MediaWiki. Toutefois, il est
possible d’utiliser un moteur de rendu différent pour le template et
pour le layout en utilisant l’option <code class="highlighter-rouge">:layout_engine</code>.</p>

<h4>Templates CoffeeScript</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td>
      <a href="https://github.com/josh/ruby-coffee-script" title="Ruby CoffeeScript">
        CoffeeScript
      </a>
      et un
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        moyen d'exécuter javascript
      </a>
    </td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.coffee</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>coffee :index</tt></td>
  </tr>
</table>

<h4>Templates Stylus</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td>
      <a href="https://github.com/forgecrafted/ruby-stylus" title="Ruby Stylus">
        Stylus
      </a>
      et un
      <a href="https://github.com/sstephenson/execjs/blob/master/README.md#readme" title="ExecJS">
        moyen d'exécuter javascript
      </a>
    </td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.styl</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>stylus :index</tt></td>
  </tr>
</table>

<p>Avant de pouvoir utiliser des templates Stylus, vous devez auparavant charger
<code class="highlighter-rouge">stylus</code> et <code class="highlighter-rouge">stylus/tilt</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'stylus'</span>
<span class="nb">require</span> <span class="s1">'stylus/tilt'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stylus</span> <span class="ss">:exemple</span>
<span class="k">end</span>
</code></pre>
</div>

<h4>Templates Yajl</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td>
      <a href="https://github.com/brianmario/yajl-ruby" title="yajl-ruby">yajl-ruby</a>
    </td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.yajl</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td>
<tt>yajl :index, :locals =&gt; { :key =&gt; 'qux' }, :callback =&gt; 'present', :variable =&gt; 'ressource'</tt>&lt;/p&gt;
    </td>
  </tr>
</table>

<p>La source du template est évaluée en tant que chaine Ruby, puis la
variable json obtenue est convertie avec #to_json.</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">json</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="s1">'bar'</span> <span class="p">}</span>
<span class="n">json</span><span class="p">[</span><span class="ss">:baz</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span>
</code></pre>
</div>

<p>Les options <code class="highlighter-rouge">:callback</code> et <code class="highlighter-rouge">:variable</code> peuvent être utilisées pour décorer
l’objet retourné.</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">var</span> <span class="n">ressource</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"foo"</span><span class="ss">:"bar"</span><span class="p">,</span><span class="s2">"baz"</span><span class="ss">:"qux"</span><span class="p">};</span> <span class="n">present</span><span class="p">(</span><span class="n">ressource</span><span class="p">);</span><span class="o">&lt;</span><span class="sr">/pre&gt;
</span></code></pre>
</div>

<h4>Templates WLang</h4>

<table>
  <tr>
    <td>Dépendances</td>
    <td><a href="https://github.com/blambeau/wlang/" title="wlang">wlang</a></td>
  </tr>
  <tr>
    <td>Extensions de fichier</td>
    <td><tt>.wlang</tt></td>
  </tr>
  <tr>
    <td>Exemple</td>
    <td><tt>wlang :index, :locals =&gt; { :key =&gt; 'value' }</tt></td>
  </tr>
</table>

<p>L’appel de code ruby au sein des templates n’est pas idiomatique en wlang.
L’écriture de templates sans logique est encouragée, via le passage de variables
locales. Il est néanmoins possible d’écrire un layout en wlang et d’y utiliser
<code class="highlighter-rouge">yield</code>.</p>

<h3>Accéder aux variables dans un Template</h3>

<p>Un template est évalué dans le même contexte que l’endroit d’où il a été
appelé (gestionnaire de route). Les variables d’instance déclarées dans le
gestionnaire de route sont directement accessibles dans le template :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="vi">@foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= @foo.nom'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Alternativement, on peut passer un hash contenant des variables locales :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/:id'</span> <span class="k">do</span>
  <span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="p">.</span><span class="nf">find</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
  <span class="n">haml</span> <span class="s1">'%h1= foo.nom'</span><span class="p">,</span> <span class="ss">:locals</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:foo</span> <span class="o">=&gt;</span> <span class="n">foo</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ceci est généralement nécessaire lorsque l’on veut utiliser un template depuis un autre template (partiel) et qu’il faut donc adapter le nom des variables.</p>

<h3>Templates avec <code class="highlighter-rouge">yield</code> et layouts imbriqués</h3>

<p>En général, un layout est un simple template qui appelle <code class="highlighter-rouge">yield</code>. Ce genre de
template peut s’utiliser via l’option <code class="highlighter-rouge">:template</code> comme décrit précédemment ou
peut être rendu depuis un bloc :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ce code est plus ou moins équivalent à <code class="highlighter-rouge">erb :index, :layout =&gt; :post</code>.</p>

<p>Le fait de passer des blocs aux méthodes de rendu est particulièrement utile
pour gérer des templates imbriqués :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:layout_principal</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:layout_admin</span> <span class="k">do</span>
    <span class="n">erb</span> <span class="ss">:utilisateur</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou plus brièvement :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">erb</span> <span class="ss">:layout_admin</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="ss">:layout_principal</span> <span class="k">do</span>
  <span class="n">erb</span> <span class="ss">:utilisateur</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Actuellement, les méthodes de rendu qui acceptent un bloc sont : <code class="highlighter-rouge">erb</code>, <code class="highlighter-rouge">haml</code>,
<code class="highlighter-rouge">liquid</code>, <code class="highlighter-rouge">slim </code> et <code class="highlighter-rouge">wlang</code>. La méthode générale <code class="highlighter-rouge">render</code> accepte elle aussi
un bloc.</p>

<h3>Templates dans le fichier source</h3>

<p>Des templates peuvent être définis dans le fichier source comme ceci :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>

<span class="cp">__END__

@@ layout
%html
  = yield

@@ index
%div.title Bonjour le monde !
</span></code></pre>
</div>

<p>NOTE : Les templates du fichier source qui contient <code class="highlighter-rouge">require 'sinatra'</code>
sont automatiquement chargés. Si vous avez des templates dans d’autres
fichiers source, il faut explicitement les déclarer avec
<code class="highlighter-rouge">enable :inline_templates</code>.</p>

<h3>Templates nommés</h3>

<p>Les templates peuvent aussi être définis grâce à la méthode de haut niveau <code class="highlighter-rouge">template</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">template</span> <span class="ss">:layout</span> <span class="k">do</span>
  <span class="s2">"%html</span><span class="se">\n</span><span class="s2">  =yield</span><span class="se">\n</span><span class="s2">"</span>
<span class="k">end</span>

<span class="n">template</span> <span class="ss">:index</span> <span class="k">do</span>
  <span class="s1">'%div.title Bonjour le monde !'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Si un template nommé “layout” existe, il sera utilisé à chaque fois qu’un
template sera affiché. Vous pouvez désactivez les layouts au cas par cas en
passant <code class="highlighter-rouge">:layout =&gt; false</code> ou bien les désactiver par défaut au moyen
de <code class="highlighter-rouge">set :haml, :layout =&gt; false</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">haml</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:layout</span> <span class="o">=&gt;</span> <span class="o">!</span><span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Associer des extensions de fichier</h3>

<p>Pour associer une extension de fichier avec un moteur de rendu, utilisez
<code class="highlighter-rouge">Tilt.register</code>. Par exemple, si vous désirez utiliser l’extension
de fichier <code class="highlighter-rouge">tt</code> pour les templates Textile, vous pouvez faire comme suit :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:tt</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:textile</span><span class="p">]</span>
</code></pre>
</div>

<h3>Ajouter son propre moteur de rendu</h3>

<p>En premier lieu, déclarez votre moteur de rendu avec Tilt, ensuite créez
votre méthode de rendu :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="no">Tilt</span><span class="p">.</span><span class="nf">register</span> <span class="ss">:monmoteur</span><span class="p">,</span> <span class="no">MonMerveilleuxMoteurDeRendu</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">monmoteur</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="n">render</span><span class="p">(</span><span class="ss">:monmoteur</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">monmoteur</span> <span class="ss">:index</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Utilisera <code class="highlighter-rouge">./views/index.monmoteur</code>. Voir <a href="https://github.com/rtomayko/tilt">le projet Github</a> pour en savoir plus sur Tilt.</p>

<h3>Utiliser des règles personnalisées pour la recherche de templates</h3>

<p>Pour implémenter votre propre mécanisme de recherche de templates, vous
pouvez écrire votre propre méthode <code class="highlighter-rouge">#find_template</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'./vues/a'</span><span class="p">,</span> <span class="s1">'./vues/b'</span> <span class="p">]</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">vues</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">moteur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bloc</span><span class="p">)</span>
  <span class="no">Array</span><span class="p">(</span><span class="n">vues</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
    <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">moteur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bloc</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Filtres</h2>

<p>Les filtres <code class="highlighter-rouge">before</code> sont exécutés avant chaque requête, dans le même contexte
que les routes, et permettent de modifier la requête et sa réponse. Les
variables d’instance déclarées dans les filtres sont accessibles au niveau
des routes et des templates :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="vi">@note</span> <span class="o">=</span> <span class="s1">'Coucou !'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s1">'/foo/bar/baz'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/foo/*'</span> <span class="k">do</span>
  <span class="vi">@note</span> <span class="c1">#=&gt; 'Coucou !'</span>
  <span class="n">params</span><span class="p">[</span><span class="s1">'splat'</span><span class="p">]</span> <span class="c1">#=&gt; 'bar/baz'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les filtres <code class="highlighter-rouge">after</code> sont exécutés après chaque requête à l’intérieur du même
contexte et permettent de modifier la requête et sa réponse. Les variables
d’instance déclarées dans les filtres <code class="highlighter-rouge">before</code> ou les routes sont accessibles
au niveau des filtres <code class="highlighter-rouge">after</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">response</span><span class="p">.</span><span class="nf">status</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Note : Le corps de la réponse n’est pas disponible au niveau du filtre <code class="highlighter-rouge">after</code>
car il ne sera généré que plus tard (sauf dans le cas où vous utilisez la
méthode <code class="highlighter-rouge">body</code> au lieu de simplement renvoyer une chaine depuis vos routes).</p>

<p>Les filtres peuvent être associés à un masque, ce qui permet de limiter leur
exécution aux cas où la requête correspond à ce masque :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="s1">'/secret/*'</span> <span class="k">do</span>
  <span class="n">authentification!</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/faire/:travail'</span> <span class="k">do</span> <span class="o">|</span><span class="n">travail</span><span class="o">|</span>
  <span class="n">session</span><span class="p">[</span><span class="s1">'dernier_travail'</span><span class="p">]</span> <span class="o">=</span> <span class="n">travail</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Tout comme les routes, les filtres acceptent également des conditions :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="ss">:agent</span> <span class="o">=&gt;</span> <span class="sr">/Songbird/</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>

<span class="n">after</span> <span class="s1">'/blog/*'</span><span class="p">,</span> <span class="ss">:host_name</span> <span class="o">=&gt;</span> <span class="s1">'example.com'</span> <span class="k">do</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Helpers</h2>

<p>Utilisez la méthode de haut niveau <code class="highlighter-rouge">helpers</code> pour définir des méthodes
qui seront accessibles dans vos gestionnaires de route et dans vos templates :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">nom</span><span class="p">)</span>
    <span class="s2">"</span><span class="si">#{</span><span class="n">nom</span><span class="si">}</span><span class="s2">bar"</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:nom'</span> <span class="k">do</span>
  <span class="n">bar</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">])</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous pouvez aussi définir les méthodes helper dans un module séparé :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">module</span> <span class="nn">FooUtils</span>
  <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">nom</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="n">nom</span><span class="si">}</span><span class="s2">foo"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nn">BarUtils</span>
  <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">nom</span><span class="p">)</span> <span class="s2">"</span><span class="si">#{</span><span class="n">nom</span><span class="si">}</span><span class="s2">bar"</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">helpers</span> <span class="no">FooUtils</span><span class="p">,</span> <span class="no">BarUtils</span>
</code></pre>
</div>

<p>Cela a le même résultat que d’inclure les modules dans la classe de
l’application.</p>

<h3>Utiliser les sessions</h3>

<p>Les sessions sont utilisées pour conserver un état entre les requêtes. Une fois
activées, vous avez un hash de session par session utilisateur :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s2">"valeur = "</span> <span class="o">&lt;&lt;</span> <span class="n">session</span><span class="p">[</span><span class="s1">'valeur'</span><span class="p">].</span><span class="nf">inspect</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:valeur'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="s1">'valeur'</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'valeur'</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Notez que <code class="highlighter-rouge">enable :sessions</code> enregistre en fait toutes les données dans
un cookie. Ce n’est pas toujours ce que vous voulez (enregistrer beaucoup de
données va augmenter le traffic par exemple). Vous pouvez utiliser n’importe
quel middleware Rack de session afin d’éviter cela. N’utilisez <strong>pas</strong>
<code class="highlighter-rouge">enable :sessions</code> dans ce cas mais chargez le middleware de votre
choix comme vous le feriez pour n’importe quel autre middleware :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span><span class="p">,</span> <span class="ss">:expire_after</span> <span class="o">=&gt;</span> <span class="mi">2592000</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s2">"valeur = "</span> <span class="o">&lt;&lt;</span> <span class="n">session</span><span class="p">[</span><span class="s1">'valeur'</span><span class="p">].</span><span class="nf">inspect</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/:valeur'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="s1">'valeur'</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'valeur'</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Pour renforcer la sécurité, les données de session dans le cookie sont signées
avec une clé secrète de session. Une clé secrète est générée pour vous au
hasard par Sinatra. Toutefois, comme cette clé change à chaque démarrage de
votre application, vous pouvez définir cette clé vous-même afin que toutes
les instances de votre application la partage :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:session_secret</span><span class="p">,</span> <span class="s1">'super secret'</span>
</code></pre>
</div>

<p>Si vous souhaitez avoir plus de contrôle, vous pouvez également enregistrer un
hash avec des options lors de la configuration de <code class="highlighter-rouge">sessions</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'foo.com'</span>
</code></pre>
</div>

<p>Pour que les différents sous-domaines de foo.com puissent partager une session,
vous devez précéder le domaine d’un <em>.</em> (point) :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:domain</span> <span class="o">=&gt;</span> <span class="s1">'.foo.com'</span>
</code></pre>
</div>

<h3>Halt</h3>

<p>Pour arrêter immédiatement la requête dans un filtre ou un gestionnaire de
route :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span>
</code></pre>
</div>

<p>Vous pouvez aussi passer le code retour …</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">410</span>
</code></pre>
</div>

<p>Ou le texte …</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="s1">'Ceci est le texte'</span>
</code></pre>
</div>

<p>Ou les deux …</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">401</span><span class="p">,</span> <span class="s1">'Partez !'</span>
</code></pre>
</div>

<p>Ainsi que les en-têtes …</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="mi">402</span><span class="p">,</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'text/plain'</span><span class="p">},</span> <span class="s1">'revanche'</span>
</code></pre>
</div>

<p>Bien sûr il est possible de combiner un template avec <code class="highlighter-rouge">halt</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">halt</span> <span class="n">erb</span><span class="p">(</span><span class="ss">:erreur</span><span class="p">)</span>
</code></pre>
</div>

<h3>Passer</h3>

<p>Une route peut passer le relais aux autres routes qui correspondent également
avec <code class="highlighter-rouge">pass</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/devine/:qui'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">unless</span> <span class="n">params</span><span class="p">[</span><span class="s1">'qui'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Frank'</span>
  <span class="s2">"Tu m'as eu !"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/devine/*'</span> <span class="k">do</span>
  <span class="s1">'Manqué !'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>On sort donc immédiatement de ce gestionnaire et on continue à chercher,
dans les masques suivants, le prochain qui correspond à la requête.
Si aucun des masques suivants ne correspond, un code 404 est retourné.</p>

<h3>Déclencher une autre route</h3>

<p>Parfois, <code class="highlighter-rouge">pass</code> n’est pas ce que vous recherchez, au lieu de cela vous
souhaitez obtenir le résultat d’une autre route. Pour cela, utilisez
simplement <code class="highlighter-rouge">call</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">call</span> <span class="n">env</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="s2">"PATH_INFO"</span> <span class="o">=&gt;</span> <span class="s1">'/bar'</span><span class="p">)</span>
  <span class="p">[</span><span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">body</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:upcase</span><span class="p">)]</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="s2">"bar"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Notez que dans l’exemple ci-dessus, vous faciliterez les tests et améliorerez
la performance en déplaçant simplement <code class="highlighter-rouge">"bar"</code> dans un helper
utilisé à la fois par <code class="highlighter-rouge">/foo</code> et <code class="highlighter-rouge">/bar</code>.</p>

<p>Si vous souhaitez que la requête soit envoyée à la même instance de
l’application plutôt qu’à une copie, utilisez <code class="highlighter-rouge">call!</code> au lieu de
<code class="highlighter-rouge">call</code>.</p>

<p>Lisez la spécification Rack si vous souhaitez en savoir plus sur
<code class="highlighter-rouge">call</code>.</p>

<h3>Définir le corps, le code retour et les en-têtes</h3>

<p>Il est possible et recommandé de définir le code retour et le corps de la
réponse au moyen de la valeur de retour d’un bloc définissant une route.
Quoiqu’il en soit, dans certains cas vous pourriez avoir besoin de définir
le coprs de la réponse à un moment arbitraire de l’exécution. Vous pouvez le
faire au moyen de la méthode <code class="highlighter-rouge">body</code>. Si vous faites ainsi, vous pouvez alors
utiliser cette même méthode pour accéder au corps de la réponse :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">body</span> <span class="s2">"bar"</span>
<span class="k">end</span>

<span class="n">after</span> <span class="k">do</span>
  <span class="nb">puts</span> <span class="n">body</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Il est également possible de passer un bloc à <code class="highlighter-rouge">body</code>, qui sera exécuté par le
gestionnaire Rack (ceci peut être utilisé pour implémenter un streaming,
voir “Valeurs de retour”).</p>

<p>Pareillement au corps de la réponse, vous pouvez également définir le code
retour et les en-têtes :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">status</span> <span class="mi">418</span>
  <span class="n">headers</span> <span class="p">\</span>
    <span class="s2">"Allow"</span>   <span class="o">=&gt;</span> <span class="s2">"BREW, POST, GET, PROPFIND, WHEN"</span><span class="p">,</span>
    <span class="s2">"Refresh"</span> <span class="o">=&gt;</span> <span class="s2">"Refresh: 20; http://www.ietf.org/rfc/rfc2324.txt"</span>
  <span class="n">body</span> <span class="s2">"Je suis une théière !"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Comme pour <code class="highlighter-rouge">body</code>, <code class="highlighter-rouge">headers</code> et <code class="highlighter-rouge">status</code> peuvent être utilisés sans arguments
pour accéder à leurs valeurs.</p>

<h3>Faire du streaming</h3>

<p>Il y a des cas où vous voulez commencer à renvoyer des données pendant que
vous êtes en train de générer le reste de la réponse. Dans les cas les plus
extrèmes, vous souhaitez continuer à envoyer des données tant que le client
n’abandonne pas la connexion. Vous pouvez alors utiliser le helper <code class="highlighter-rouge">stream</code>
pour éviter de créer votre propre système :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">stream</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"Ca va être hallu -</span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">" (attends la suite) </span><span class="se">\n</span><span class="s2">"</span>
    <span class="nb">sleep</span> <span class="mi">1</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s2">"- cinant !</span><span class="se">\n</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Cela permet d’implémenter des API de streaming ou de
<a href="https://w3c.github.io/eventsource/">Server Sent Events</a> et peut servir de
base pour des <a href="https://en.wikipedia.org/wiki/WebSocket">WebSockets</a>. Vous
pouvez aussi l’employer pour augmenter le débit quand une partie du contenu
provient d’une ressource lente.</p>

<p>Le fonctionnement du streaming, notamment le nombre de requêtes simultanées,
dépend énormément du serveur web utilisé. Certains ne prennent pas du tout en
charge le streaming. Lorsque le serveur ne gère pas le streaming, la partie
body de la réponse sera envoyée au client en une seule fois, après
l’exécution du bloc passé au helper <code class="highlighter-rouge">stream</code>. Le streaming ne
fonctionne pas du tout avec Shotgun.</p>

<p>En utilisant le helper <code class="highlighter-rouge">stream</code> avec le paramètre <code class="highlighter-rouge">keep_open</code>, il n’appelera
pas la méthode <code class="highlighter-rouge">close</code> du flux, vous laissant la possibilité de le fermer à
tout moment au cours de l’exécution. Ceci ne fonctionne qu’avec les serveurs
evented (ie non threadés) tels que Thin et Rainbows. Les autres serveurs
fermeront malgré tout le flux :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># interrogation prolongée</span>

<span class="n">set</span> <span class="ss">:server</span><span class="p">,</span> <span class="ss">:thin</span>
<span class="n">connexions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">get</span> <span class="s1">'/souscrire'</span> <span class="k">do</span>
  <span class="c1"># abonne un client aux évènements du serveur</span>
  <span class="n">stream</span><span class="p">(</span><span class="ss">:keep_open</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="n">connexions</span> <span class="o">&lt;&lt;</span> <span class="n">out</span>
    <span class="c1"># purge les connexions abandonnées</span>
    <span class="n">connexions</span><span class="p">.</span><span class="nf">reject!</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:closed?</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="s1">'/message'</span> <span class="k">do</span>
  <span class="n">connexions</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span>
    <span class="c1"># prévient le client qu'un nouveau message est arrivé</span>
    <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'message'</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>

    <span class="c1"># indique au client de se connecter à nouveau</span>
    <span class="n">out</span><span class="p">.</span><span class="nf">close</span>
  <span class="k">end</span>

  <span class="c1"># compte-rendu</span>
  <span class="s2">"message reçu"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Il est aussi possible pour le client de fermer la connexion en essayant
d’écrire sur le socket. Pour cette raison, il est recommandé de vérifier
<code class="highlighter-rouge">out.closed?</code> avant d’essayer d’y écrire.</p>

<h3>Journalisation (Logging)</h3>

<p>Dans le contexte de la requête, la méthode utilitaire <code class="highlighter-rouge">logger</code> expose une
instance de <code class="highlighter-rouge">Logger</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">logger</span><span class="p">.</span><span class="nf">info</span> <span class="s2">"chargement des données"</span>
  <span class="c1"># ...</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ce logger va automatiquement prendre en compte les paramètres de
configuration pour la journalisation de votre gestionnaire Rack. Si la
journalisation est désactivée, cette méthode renverra un objet factice et
vous n’avez pas à vous en inquiéter dans vos routes en le filtrant.</p>

<p>Notez que la journalisation est seulement activée par défaut pour
<code class="highlighter-rouge">Sinatra::Application</code>, donc si vous héritez de <code class="highlighter-rouge">&gt;Sinatra::Base</code>,
vous aurez à l’activer vous-même :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MonApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:development</span> <span class="k">do</span>
    <span class="n">enable</span> <span class="ss">:logging</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Si vous souhaitez utiliser votre propre logger, vous devez définir le paramètre
<code class="highlighter-rouge">logging</code> à <code class="highlighter-rouge">nil</code> pour être certain qu’aucun middleware de logging ne sera
installé (notez toutefois que <code class="highlighter-rouge">logger</code> renverra alors <code class="highlighter-rouge">nil</code>). Dans ce cas,
Sinatra utilisera ce qui sera présent dans <code class="highlighter-rouge">env['rack.logger']</code>.</p>

<h3>Types Mime</h3>

<p>Quand vous utilisez <code class="highlighter-rouge">send_file</code> ou des fichiers statiques, vous
pouvez rencontrer des types mime que Sinatra ne connaît pas. Utilisez
<code class="highlighter-rouge">mime_type</code> pour les déclarer par extension de fichier :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">mime_type</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'text/foo'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous pouvez également les utiliser avec la méthode <code class="highlighter-rouge">content_type</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:foo</span>
  <span class="s2">"foo foo foo"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Former des URLs</h3>

<p>Pour former des URLs, vous devriez utiliser la méthode <code class="highlighter-rouge">url</code>, par exemple en
Haml :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="o">%</span><span class="n">a</span><span class="p">{</span><span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">url</span><span class="p">(</span><span class="s1">'/foo'</span><span class="p">)}</span> <span class="n">foo</span>
</code></pre>
</div>

<p>Cela prend en compte les proxy inverse et les routeurs Rack, s’ils existent.</p>

<p>Cette méthode est également disponible sous l’alias <code class="highlighter-rouge">to</code> (voir ci-dessous
pour un exemple).</p>

<h3>Redirection du navigateur</h3>

<p>Vous pouvez déclencher une redirection du navigateur avec la méthode
<code class="highlighter-rouge">redirect</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Tout paramètre additionnel sera utilisé comme argument pour la méthode
<code class="highlighter-rouge">halt</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">),</span> <span class="mi">303</span>
<span class="n">redirect</span> <span class="s1">'http://www.google.com/'</span><span class="p">,</span> <span class="s1">'mauvais endroit mon pote'</span>
</code></pre>
</div>

<p>Vous pouvez aussi rediriger vers la page dont l’utilisateur venait au moyen de
<code class="highlighter-rouge">redirect back</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="s2">"&lt;a href='/bar'&gt;faire quelque chose&lt;/a&gt;"</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">faire_quelque_chose</span>
  <span class="n">redirect</span> <span class="n">back</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Pour passer des arguments à une redirection, ajoutez-les soit à la requête :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar?sum=42'</span><span class="p">)</span>
</code></pre>
</div>

<p>Ou bien utilisez une session :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">enable</span> <span class="ss">:sessions</span>

<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="s1">'secret'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'foo'</span>
  <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s1">'/bar'</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/bar'</span> <span class="k">do</span>
  <span class="n">session</span><span class="p">[</span><span class="s1">'secret'</span><span class="p">]</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Contrôle du cache</h3>

<p>Définissez correctement vos en-têtes à la base pour un bon cache HTTP.</p>

<p>Vous pouvez facilement définir l’en-tête Cache-Control de la manière suivante :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span>
  <span class="s2">"met le en cache !"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Conseil de pro : définir le cache dans un filtre before :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">60</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Si vous utilisez la méthode <code class="highlighter-rouge">expires</code> pour définir l’en-tête correspondant,
<code class="highlighter-rouge">Cache-Control</code> sera alors défini automatiquement :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="k">do</span>
  <span class="n">expires</span> <span class="mi">500</span><span class="p">,</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:must_revalidate</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Pour utiliser correctement le cache, vous devriez utiliser <code class="highlighter-rouge">etag</code> ou
<code class="highlighter-rouge">last_modified</code>. Il est recommandé d’utiliser ces méthodes <em>avant</em> de faire
d’importantes modifications, car elles vont immédiatement déclencher la réponse
si le client a déjà la version courante dans son cache :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/article/:id'</span> <span class="k">do</span>
  <span class="vi">@article</span> <span class="o">=</span> <span class="no">Article</span><span class="p">.</span><span class="nf">find</span> <span class="n">params</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]</span>
  <span class="n">last_modified</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">updated_at</span>
  <span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span>
  <span class="n">erb</span> <span class="ss">:article</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Il est également possible d’utiliser un
<a href="https://en.wikipedia.org/wiki/HTTP_ETag#Strong_and_weak_validation">weak ETag</a> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="vi">@article</span><span class="p">.</span><span class="nf">sha1</span><span class="p">,</span> <span class="ss">:weak</span>
</code></pre>
</div>

<p>Ces méthodes ne sont pas chargées de mettre des données en cache, mais elles
fournissent les informations nécessaires pour le cache de votre navigateur. Si vous êtes à la
recherche d’une solution rapide pour un reverse-proxy de cache, essayez
<a href="https://github.com/rtomayko/rack-cache">rack-cache</a> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s2">"rack/cache"</span>
<span class="nb">require</span> <span class="s2">"sinatra"</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Cache</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">cache_control</span> <span class="ss">:public</span><span class="p">,</span> <span class="ss">:max_age</span> <span class="o">=&gt;</span> <span class="mi">36000</span>
  <span class="nb">sleep</span> <span class="mi">5</span>
  <span class="s2">"hello"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Utilisez le paramètre <code class="highlighter-rouge">:static_cache_control</code> pour ajouter l’information
d’en-tête <code class="highlighter-rouge">Cache-Control</code> (voir plus loin).</p>

<p>D’après la RFC 2616, votre application devrait se comporter différement lorsque
l’en-tête If-Match ou If-None-Match est défini à <code class="highlighter-rouge">*</code> en tenant compte du
fait que la ressource demandée existe déjà ou pas. Sinatra considère que les
requêtes portant sur des ressources sûres (tel que get) ou idempotentes (tel que
put) existent déjà et pour les autres ressources (par exemple dans le cas
de requêtes post) qu’il s’agit de nouvelles ressources. Vous pouvez modifier ce
comportement en passant une option <code class="highlighter-rouge">:new_resource</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/create'</span> <span class="k">do</span>
  <span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="no">Article</span><span class="p">.</span><span class="nf">create</span>
  <span class="n">erb</span> <span class="ss">:nouvel_article</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Si vous souhaitez avoir un ETag faible, utilisez l’option <code class="highlighter-rouge">:kind</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">etag</span> <span class="s1">''</span><span class="p">,</span> <span class="ss">:new_resource</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:kind</span> <span class="o">=&gt;</span> <span class="ss">:weak</span>
</code></pre>
</div>

<h3>Envoyer des fichiers</h3>

<p>Pour envoyer des fichiers, vous pouvez utiliser la méthode <code class="highlighter-rouge">send_file</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">send_file</span> <span class="s1">'foo.png'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Quelques options sont également acceptées :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">send_file</span> <span class="s1">'foo.png'</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:jpg</span>
</code></pre>
</div>

<p>Les options sont :</p>

<dl>
  <dt>filename</dt>
  <dd>
    le nom du fichier dans la réponse, par défaut le nom du fichier envoyé.
  </dd>

  <dt>type</dt>
  <dd>
    type de contenu à utiliser, deviné à partir de l’extension de fichier si
    absent
  </dd>

  <dt>disposition</dt>
  <dd>
    utilisé pour Content-Disposition, les valeurs possibles étant : <tt>nil</tt>
    (par défaut), <tt>:attachment</tt> et <tt>:inline</tt>
  </dd>

  <dt>length</dt>
  <dd>en-tête Content-Length, par défaut la taille du fichier</dd>

  <dt>status</dt>
  <dd>
    code état à renvoyer. Utile quand un fichier statique sert de page d’erreur.
    Si le gestionnaire Rack le supporte, d'autres moyens que le streaming via le
    processus Ruby seront utilisés. Si vous utilisez cette méthode, Sinatra gérera
    automatiquement les requêtes de type range.
  </dd>
</dl>

<h3>Accéder à l’objet requête</h3>

<p>L’objet correspondant à la requête envoyée peut être récupéré dans le contexte
de la requête (filtres, routes, gestionnaires d’erreur) au moyen de la méthode
<code class="highlighter-rouge">request</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># application tournant à l'adresse http://exemple.com/exemple</span>
<span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
  <span class="n">t</span> <span class="o">=</span> <span class="sx">%w[text/css text/html application/javascript]</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept</span>              <span class="c1"># ['text/html', '*/*']</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">accept?</span> <span class="s1">'text/xml'</span>  <span class="c1"># vrai</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">preferred_type</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>   <span class="c1"># 'text/html'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span>                <span class="c1"># corps de la requête envoyée par le client</span>
                              <span class="c1"># (voir ci-dessous)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">scheme</span>              <span class="c1"># "http"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">script_name</span>         <span class="c1"># "/exemple"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span>           <span class="c1"># "/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">port</span>                <span class="c1"># 80</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">request_method</span>      <span class="c1"># "GET"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">query_string</span>        <span class="c1"># ""</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">content_length</span>      <span class="c1"># taille de request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">media_type</span>          <span class="c1"># type de média pour request.body</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">host</span>                <span class="c1"># "exemple.com"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">get?</span>                <span class="c1"># vrai (méthodes similaires pour les autres</span>
                              <span class="c1"># verbes HTTP)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">form_data?</span>          <span class="c1"># faux</span>
  <span class="n">request</span><span class="p">[</span><span class="s2">"UN_ENTETE"</span><span class="p">]</span>        <span class="c1"># valeur de l'en-tête UN_ENTETE</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">referrer</span>            <span class="c1"># référant du client ou '/'</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">user_agent</span>          <span class="c1"># user agent (utilisé par la condition :agent)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">cookies</span>             <span class="c1"># tableau contenant les cookies du navigateur</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">xhr?</span>                <span class="c1"># requête AJAX ?</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">url</span>                 <span class="c1"># "http://exemple.com/exemple/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">path</span>                <span class="c1"># "/exemple/foo"</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">ip</span>                  <span class="c1"># adresse IP du client</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">secure?</span>             <span class="c1"># faux</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">forwarded?</span>          <span class="c1"># vrai (si on est derrière un proxy inverse)</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">env</span>                 <span class="c1"># tableau brut de l'environnement fourni par Rack</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Certaines options, telles que <code class="highlighter-rouge">script_name</code> ou <code class="highlighter-rouge">path_info</code>
peuvent également être modifiées :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">before</span> <span class="p">{</span> <span class="n">request</span><span class="p">.</span><span class="nf">path_info</span> <span class="o">=</span> <span class="s2">"/"</span> <span class="p">}</span>

<span class="n">get</span> <span class="s2">"/"</span> <span class="k">do</span>
  <span class="s2">"toutes les requêtes arrivent ici"</span>
<span class="k">end</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">request.body</code> est un objet IO ou StringIO :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">post</span> <span class="s2">"/api"</span> <span class="k">do</span>
  <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">rewind</span>  <span class="c1"># au cas où il a déjà été lu</span>
  <span class="n">donnees</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span> <span class="n">request</span><span class="p">.</span><span class="nf">body</span><span class="p">.</span><span class="nf">read</span>
  <span class="s2">"Bonjour </span><span class="si">#{</span><span class="n">donnees</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">]</span><span class="si">}</span><span class="s2"> !"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Fichiers joints</h3>

<p>Vous pouvez utiliser la méthode <code class="highlighter-rouge">attachment</code> pour indiquer au navigateur que
la réponse devrait être stockée sur le disque plutôt qu’affichée :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span>
  <span class="s2">"enregistre-le !"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous pouvez également lui passer un nom de fichier :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">attachment</span> <span class="s2">"info.txt"</span>
  <span class="s2">"enregistre-le !"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Gérer Date et Time</h3>

<p>Sinatra fourni un helper <code class="highlighter-rouge">time_for</code> pour convertir une valeur donnée en
objet <code class="highlighter-rouge">Time</code>. Il peut aussi faire la conversion à partir d’objets <code class="highlighter-rouge">DateTime</code>,
<code class="highlighter-rouge">Date</code> ou de classes similaires :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">pass</span> <span class="k">if</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">&gt;</span> <span class="n">time_for</span><span class="p">(</span><span class="s1">'Dec 23, 2012'</span><span class="p">)</span>
  <span class="s2">"encore temps"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Cette méthode est utilisée en interne par <code class="highlighter-rouge">expires</code>, <code class="highlighter-rouge">last_modified</code> et
consorts. Par conséquent, vous pouvez très facilement étendre le
fonctionnement de ces méthodes en surchargeant le helper <code class="highlighter-rouge">time_for</code> dans
votre application :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">time_for</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">value</span>
    <span class="k">when</span> <span class="ss">:yesterday</span> <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">when</span> <span class="ss">:tomorrow</span>  <span class="k">then</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">+</span> <span class="mi">24</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span>
    <span class="k">else</span> <span class="k">super</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">last_modified</span> <span class="ss">:yesterday</span>
  <span class="n">expires</span> <span class="ss">:tomorrow</span>
  <span class="s2">"salut"</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Chercher les fichiers de templates</h3>

<p>La méthode <code class="highlighter-rouge">find_template</code> est utilisée pour trouver les fichiers de
templates à générer :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">find_template</span> <span class="n">settings</span><span class="p">.</span><span class="nf">views</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="no">Tilt</span><span class="p">[</span><span class="ss">:haml</span><span class="p">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">"pourrait être </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ce n’est pas très utile. En revanche, il est utile de pouvoir surcharger
cette méthode afin de définir son propre mécanisme de recherche. Par exemple,
vous pouvez utiliser plus d’un répertoire de vues :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="p">[</span><span class="s1">'views'</span><span class="p">,</span> <span class="s1">'templates'</span><span class="p">]</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">vues</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">moteur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bloc</span><span class="p">)</span>
    <span class="no">Array</span><span class="p">(</span><span class="n">vues</span><span class="p">).</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="k">super</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">moteur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bloc</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Un autre exemple est d’utiliser des répertoires différents pour des moteurs
de rendu différents :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:views</span><span class="p">,</span> <span class="ss">:sass</span> <span class="o">=&gt;</span> <span class="s1">'views/sass'</span><span class="p">,</span> <span class="ss">:haml</span> <span class="o">=&gt;</span> <span class="s1">'templates'</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">'views'</span>

<span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">find_template</span><span class="p">(</span><span class="n">vues</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">moteur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bloc</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">dossier</span> <span class="o">=</span> <span class="n">vues</span><span class="p">.</span><span class="nf">detect</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">moteur</span> <span class="o">==</span> <span class="no">Tilt</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="p">}</span>
    <span class="n">dossier</span> <span class="o">||=</span> <span class="n">vues</span><span class="p">[</span><span class="ss">:default</span><span class="p">]</span>
    <span class="k">super</span><span class="p">(</span><span class="n">dossier</span><span class="p">,</span> <span class="n">nom</span><span class="p">,</span> <span class="n">moteur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bloc</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous pouvez également écrire cela dans une extension et la partager avec
d’autres !</p>

<p>Notez que <code class="highlighter-rouge">find_template</code> ne vérifie pas que le fichier existe mais
va plutôt exécuter le bloc pour tous les chemins possibles. Cela n’induit pas
de problème de performance dans le sens où <code class="highlighter-rouge">render</code> va utiliser <code class="highlighter-rouge">break</code> dès
qu’un fichier sera trouvé. De plus, l’emplacement des templates (et leur
contenu) est mis en cache si vous n’êtes pas en mode développement. Vous
devez garder cela en tête si vous écrivez une méthode vraiment dingue.</p>

<h2>Configuration</h2>

<p>Lancé une seule fois au démarrage de tous les environnements :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="c1"># définir un paramètre</span>
  <span class="n">set</span> <span class="ss">:option</span><span class="p">,</span> <span class="s1">'valeur'</span>

  <span class="c1"># définir plusieurs paramètres</span>
  <span class="n">set</span> <span class="ss">:a</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="ss">:b</span> <span class="o">=&gt;</span> <span class="mi">2</span>

  <span class="c1"># équivalent à "set :option, true"</span>
  <span class="n">enable</span> <span class="ss">:option</span>

  <span class="c1"># équivalent à "set :option, false""</span>
  <span class="n">disable</span> <span class="ss">:option</span>

  <span class="c1"># vous pouvez également avoir des paramètres dynamiques avec des blocs</span>
  <span class="n">set</span><span class="p">(</span><span class="ss">:css_dir</span><span class="p">)</span> <span class="p">{</span> <span class="no">File</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">views</span><span class="p">,</span> <span class="s1">'css'</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Lancé si l’environnement (variable d’environnement APP_ENV) est <code class="highlighter-rouge">:production</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code>  <span class="n">configure</span> <span class="ss">:production</span> <span class="k">do</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
</code></pre>
</div>

<p>Lancé si l’environnement est <code class="highlighter-rouge">:production</code> ou <code class="highlighter-rouge">:test</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code>  <span class="n">configure</span> <span class="ss">:production</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
    <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
  <span class="nf">end</span>
</code></pre>
</div>

<p>Vous pouvez accéder à ces paramètres via <code class="highlighter-rouge">settings</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">configure</span> <span class="k">do</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo?</span> <span class="c1"># =&gt; true</span>
  <span class="n">settings</span><span class="p">.</span><span class="nf">foo</span>  <span class="c1"># =&gt; 'bar'</span>
  <span class="p">.</span><span class="nf">.</span><span class="p">.</span>
<span class="nf">end</span>
</code></pre>
</div>

<h3>Se protéger des attaques</h3>

<p>Sinatra utilise <a href="https://github.com/sinatra/sinatra/tree/master/rack-protection#readme">Rack::Protection</a>
pour protéger votre application contre les principales attaques opportunistes.
Vous pouvez très simplement désactiver cette fonctionnalité (ce qui exposera
votre application à beaucoup de vulnerabilités courantes) :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">disable</span> <span class="ss">:protection</span>
</code></pre>
</div>

<p>Pour désactiver seulement un type de protection, vous pouvez définir <code class="highlighter-rouge">protection</code>
avec un hash d’options :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="ss">:path_traversal</span>
</code></pre>
</div>

<p>Vous pouvez également lui passer un tableau pour désactiver plusieurs types de
protection :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:path_traversal</span><span class="p">,</span> <span class="ss">:session_hijacking</span><span class="p">]</span>
</code></pre>
</div>

<p>Par défaut, il faut que <code class="highlighter-rouge">:sessions</code> soit activé pour que Sinatra mette en place
un système de protection au niveau de la session. Dans le cas où vous gérez
vous même les sessions, vous devez utiliser l’option <code class="highlighter-rouge">:session</code> pour que cela
soit le cas :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Session</span><span class="o">::</span><span class="no">Pool</span>
<span class="n">set</span> <span class="ss">:protection</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</code></pre>
</div>

<h3>Paramètres disponibles</h3>

<dl>
  <dt>absolute_redirects</dt>
  <dd>Si désactivé, Sinatra permettra les redirections relatives. Toutefois,
  Sinatra ne sera plus conforme à la RFC 2616 (HTTP 1.1), qui n’autorise
  que les redirections absolues.&lt;/p&gt;

  Activez si votre application tourne derrière un proxy inverse qui n’a
  pas été correctement configuré. Notez que la méthode <tt>url</tt>
  continuera de produire des URLs absolues, sauf si vous lui passez
  <tt>false</tt> comme second argument.&lt;/p&gt;

  <p>Désactivé par défaut.</p>
</dd>

  <dt>add_charset</dt>
  <dd>
<p>types mime pour lesquels la méthode <tt>content_type</tt> va
  automatiquement ajouter l’information du <tt>charset</tt>.</p>

  <p>Vous devriez lui ajouter des valeurs plutôt que de l’écraser :</p>

  <pre>settings.add_charset &gt;&gt; "application/foobar"</pre>
</dd>

  <dt>app_file</dt>
  <dd><p>chemin pour le fichier de l’application principale, utilisé pour
  détecter la racine du projet, les dossiers public et vues, et les
  templates en ligne.</p></dd>

  <dt>bind</dt>
  <dd>adresse IP sur laquelle se brancher (par défaut : 0.0.0.0). Utiliser
  seulement pour le serveur intégré.</dd>

  <dt>default_encoding</dt>
  <dd>encodage à utiliser si inconnu (par défaut <tt>"utf-8"</tt>)</dd>

  <dt>dump_errors</dt>
  <dd>afficher les erreurs dans le <tt>log</tt>.
  </dd>

  <dt>environment</dt>
  <dd>environnement courant, par défaut <tt>ENV['APP_ENV']</tt>, ou
  <tt>"development"</tt> si absent.</dd>

  <dt>logging</dt>
  <dd>utiliser le <tt>logger</tt>.</dd>

  <dt>lock</dt>
  <dd>
<p>Place un <tt>lock</tt> autour de chaque requête, n’exécutant donc
  qu’une seule requête par processus Ruby.</p>

  <p>Activé si votre application n’est pas <tt>thread-safe</tt>. Désactivé
  par défaut.</p>
</dd>

  <dt>method_override</dt>
  <dd>utilise la magie de <tt>_method</tt> afin de permettre des formulaires
  put/delete dans des navigateurs qui ne le permettent pas.

  </dd>
  <dt>port</dt>
  <dd>port à écouter. Utiliser seulement pour le serveur intégré.</dd>

  <dt>mustermann_opts</dt>
  <dd>
    Un hash d'options à passer à Mustermann.new lors de la compilation
    des chemins de routes
  </dd>

  <dt>prefixed_redirects</dt>
  <dd>si oui ou non <tt>request.script_name</tt> doit être inséré dans les
  redirections si un chemin non absolu est utilisé. Ainsi, <tt>redirect
  '/foo'</tt> se comportera comme <tt>redirect to('/foo')</tt>. Désactivé
  par défaut.</dd>

  <dt>protection</dt>
  <dd>défini s’il faut activer ou non la protection contre les attaques web.
  Voir la section protection précédente.</dd>

  <dt>public_dir</dt>
  <dd>alias pour <tt>public_folder</tt>. Voir ci-dessous.</dd>

  <dt>public_folder</dt>
  <dd>chemin pour le dossier à partir duquel les fichiers publics sont servis.
  Utilisé seulement si les fichiers statiques doivent être servis (voir le
  paramètre <tt>static</tt>). Si non défini, il découle du paramètre
  <tt>app_file</tt>.</dd>

  <dt>quiet</dt>
  <dd>
    Désactive les journaux (logs) générés par les commandes start et stop
    de Sinatra. <tt>false</tt> par défaut.
  </dd>

  <dt>reload_templates</dt>
  <dd>si oui ou non les templates doivent être rechargés entre les requêtes.
  Activé en mode développement.</dd>

  <dt>root</dt>
  <dd>chemin pour le dossier racine du projet. Si non défini, il découle du
  paramètre <tt>app_file</tt>.</dd>

  <dt>raise_errors</dt>
  <dd>soulever les erreurs (ce qui arrêtera l’application). Désactivé par
  défaut sauf lorsque <tt>environment</tt> est défini à
  <tt>"test"</tt>.</dd>

  <dt>run</dt>
  <dd>si activé, Sinatra s’occupera de démarrer le serveur, ne pas activer si
  vous utiliser rackup ou autres.</dd>

  <dt>running</dt>
  <dd>est-ce que le serveur intégré est en marche ? ne changez pas ce
  paramètre !</dd>

  <dt>server</dt>
  <dd>serveur ou liste de serveurs à utiliser pour le serveur intégré. Par
  défaut [‘thin’, ‘mongrel’, ‘webrick’], l’ordre indiquant la
  priorité.</dd>

  <dt>server_settings</dt>
  <dd>
    Si vous utilisez un serveur Webrick, sans doute pour votre environnement de
    développement, vous pouvez passer des options à <tt>server_settings</tt>,
    comme <tt>SSLEnable</tt> ou <tt>SSLVerifyClient</tt>. Cependant, les
    serveurs comme Puma et Thin ne le permettent pas, et vous pouvez donc
    définir <tt>server_settings</tt> en tant que méthode lorsque vous appelez
    <tt>configure</tt>.
  </dd>

  <dt>sessions</dt>
  <dd>active le support des sessions basées sur les cookies, en utilisant
  <tt>Rack::Session::Cookie</tt>. Reportez-vous à la section ‘Utiliser les
  sessions’ pour plus d’informations.</dd>

  <dt>session_store</dt>
  <dd>
    Le middleware Rack utilisé pour les sessions. <tt>Rack::Session::Cookie</tt>
    par défaut. Voir la section 'Utiliser les sessions' pour plus de détails.
  </dd>

  <dt>show_exceptions</dt>
  <dd>affiche la trace de l’erreur dans le navigateur lorsqu’une exception se
  produit. Désactivé par défaut sauf lorsque <tt>environment</tt> est
  défini à <tt>"development"</tt>.</dd>

  <dt>static</dt>
  <dd>Si oui ou non Sinatra doit s’occuper de servir les fichiers statiques.
  Désactivez si vous utilisez un serveur capable de le gérer lui même. Le
  désactiver augmentera la performance. Activé par défaut pour le style
  classique, désactivé pour le style modulaire.</dd>

  <dt>static_cache_control</dt>
  <dd>A définir quand Sinatra rend des fichiers statiques pour ajouter les
  en-têtes <tt>Cache-Control</tt>. Utilise le helper <tt>cache_control</tt>.
  Désactivé par défaut. Utiliser un array explicite pour définir des
  plusieurs valeurs : <tt>set :static_cache_control, [:public, :max_age =&gt;
  300]</tt>
</dd>

  <dt>threaded</dt>
  <dd>à définir à <tt>true</tt> pour indiquer à Thin d’utiliser
  <tt>EventMachine.defer</tt> pour traiter la requête.</dd>

  <dt>traps</dt>
  <dd>Indique si Sinatra doit gérer les signaux système.</dd>

  <dt>views</dt>
  <dd>chemin pour le dossier des vues. Si non défini, il découle du paramètre
  <tt>app_file</tt>.</dd>

  <dt>x_cascade</dt>
  <dd>
    Indique s'il faut ou non définir le header X-Cascade lorsqu'aucune route
    ne correspond. Défini à <tt>true</tt> par défaut.
  </dd>
</dl>

<h2>Environnements</h2>

<p>Il existe trois environnements prédéfinis : <code class="highlighter-rouge">"development"</code>,
<code class="highlighter-rouge">"production"</code> et <code class="highlighter-rouge">"test"</code>. Les environnements peuvent être
sélectionné via la variable d’environnement <code class="highlighter-rouge">APP_ENV</code>. Sa valeur par défaut
est <code class="highlighter-rouge">"development"</code>. Dans ce mode, tous les templates sont rechargés à
chaque requête. Des handlers spécifiques pour <code class="highlighter-rouge">not_found</code> et
<code class="highlighter-rouge">error</code> sont installés pour vous permettre d’avoir une pile de trace
dans votre navigateur. En mode <code class="highlighter-rouge">"production"</code> et <code class="highlighter-rouge">"test"</code> les
templates sont mis en cache par défaut.</p>

<p>Pour exécuter votre application dans un environnement différent, définissez la
variable d’environnement <code class="highlighter-rouge">APP_ENV</code> :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code><span class="nv">APP_ENV</span><span class="o">=</span>production ruby my_app.rb
</code></pre>
</div>

<p>Vous pouvez utiliser une des méthodes <code class="highlighter-rouge">development?</code>, <code class="highlighter-rouge">test?</code> et <code class="highlighter-rouge">production?</code>
pour déterminer quel est l’environnement en cours :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">if</span> <span class="n">settings</span><span class="p">.</span><span class="nf">development?</span>
    <span class="s2">"développement !"</span>
  <span class="k">else</span>
    <span class="s2">"pas en développement !"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h2>Gérer les erreurs</h2>

<p>Les gestionnaires d’erreur s’exécutent dans le même contexte que les routes ou
les filtres, ce qui veut dire que vous avez accès (entre autres) aux bons
vieux <code class="highlighter-rouge">haml</code>, <code class="highlighter-rouge">erb</code>, <code class="highlighter-rouge">halt</code>, etc.</p>

<h3>NotFound</h3>

<p>Quand une exception <tt>Sinatra::NotFound</tt> est soulevée, ou que le code
retour est 404, le gestionnaire <tt>not_found</tt> est invoqué :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">not_found</span> <span class="k">do</span>
  <span class="s1">'Pas moyen de trouver ce que vous cherchez'</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Error</h3>

<p>Le gestionnaire <code class="highlighter-rouge">error</code> est invoqué à chaque fois qu’une exception est
soulevée dans une route ou un filtre. Notez qu’en développement, il ne
sera exécuté que si vous définissez l’option show exceptions à
<code class="highlighter-rouge">:after_handler</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">set</span> <span class="ss">:show_exceptions</span><span class="p">,</span> <span class="ss">:after_handler</span>
</code></pre>
</div>

<p>L’objet exception est accessible via la
variable Rack <code class="highlighter-rouge">sinatra.error</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="k">do</span>
  <span class="s1">'Désolé mais une méchante erreur est survenue - '</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Erreur personnalisée :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="no">MonErreurSurMesure</span> <span class="k">do</span>
  <span class="s1">'Oups ! Il est arrivé...'</span> <span class="o">+</span> <span class="n">env</span><span class="p">[</span><span class="s1">'sinatra.error'</span><span class="p">].</span><span class="nf">message</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Donc si cette erreur est soulevée :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="k">raise</span> <span class="no">MonErreurSurMesure</span><span class="p">,</span> <span class="s1">'quelque chose de mal'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>La réponse sera :</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>Oups ! Il est arrivé... quelque chose de mal
</code></pre>
</div>

<p>Alternativement, vous pouvez avoir un gestionnaire d’erreur associé à un code
particulier :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="mi">403</span> <span class="k">do</span>
  <span class="s1">'Accès interdit'</span>
<span class="k">end</span>

<span class="n">get</span> <span class="s1">'/secret'</span> <span class="k">do</span>
  <span class="mi">403</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Ou un intervalle :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">error</span> <span class="mi">400</span><span class="p">.</span><span class="nf">.</span><span class="mi">510</span> <span class="k">do</span>
  <span class="s1">'Boom'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Sinatra installe pour vous quelques gestionnaires <code class="highlighter-rouge">not_found</code> et
<code class="highlighter-rouge">error</code> génériques lorsque vous êtes en environnement de
<code class="highlighter-rouge">development</code>.</p>

<h2>Les Middlewares Rack</h2>

<p>Sinatra fonctionne avec <a href="http://rack.github.io/">Rack</a>, une interface standard
et minimale pour les web frameworks Ruby. Un des points forts de Rack est le
support de ce que l’on appelle des “middlewares” – composants qui viennent se
situer entre le serveur et votre application, et dont le but est de
visualiser/manipuler la requête/réponse HTTP, et d’offrir diverses
fonctionnalités classiques.</p>

<p>Sinatra permet d’utiliser facilement des middlewares Rack via la méthode de
haut niveau <code class="highlighter-rouge">use</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'mon_middleware_perso'</span>

<span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Lint</span>
<span class="n">use</span> <span class="no">MonMiddlewarePerso</span>

<span class="n">get</span> <span class="s1">'/bonjour'</span> <span class="k">do</span>
  <span class="s1">'Bonjour le monde'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>La sémantique de <code class="highlighter-rouge">use</code> est identique à celle définie dans le DSL de
<a href="http://www.rubydoc.info/github/rack/rack/master/Rack/Builder">Rack::Builder</a>
(le plus souvent utilisé dans un fichier <code class="highlighter-rouge">rackup</code>). Par exemple, la méthode
<code class="highlighter-rouge">use</code> accepte divers arguments ainsi que des blocs :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">use</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Auth</span><span class="o">::</span><span class="no">Basic</span> <span class="k">do</span> <span class="o">|</span><span class="n">identifiant</span><span class="p">,</span> <span class="n">mot_de_passe</span><span class="o">|</span>
  <span class="n">identifiant</span> <span class="o">==</span> <span class="s1">'admin'</span> <span class="o">&amp;&amp;</span> <span class="n">mot_de_passe</span> <span class="o">==</span> <span class="s1">'secret'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Rack est distribué avec de nombreux middlewares standards pour loguer, débuguer,
faire du routage URL, de l’authentification ou gérer des sessions. Sinatra gère
plusieurs de ces composants automatiquement via son système de configuration, ce
qui vous dispense de faire un <code class="highlighter-rouge">use</code> pour ces derniers.</p>

<p>Vous trouverez d’autres middlewares intéressants sur
<a href="https://github.com/rack/rack/tree/master/lib/rack">rack</a>,
<a href="https://github.com/rack/rack-contrib#readm">rack-contrib</a>,
ou en consultant le <a href="https://github.com/rack/rack/wiki/List-of-Middleware">wiki de Rack</a>.</p>

<h2>Tester</h2>

<p>Les tests pour Sinatra peuvent être écrit avec n’importe quelle bibliothèque
basée sur Rack. <a href="http://gitrdoc.com/brynary/rack-test">Rack::Test</a> est
recommandé :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'mon_application_sinatra'</span>
<span class="nb">require</span> <span class="s1">'minitest/autorun'</span>
<span class="nb">require</span> <span class="s1">'rack/test'</span>

<span class="k">class</span> <span class="nc">MonTest</span> <span class="o">&lt;</span> <span class="no">Minitest</span><span class="o">::</span><span class="no">Test</span>
  <span class="kp">include</span> <span class="no">Rack</span><span class="o">::</span><span class="no">Test</span><span class="o">::</span><span class="no">Methods</span>

  <span class="k">def</span> <span class="nf">app</span>
    <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_ma_racine</span>
    <span class="n">get</span> <span class="s1">'/'</span>
    <span class="n">assert_equal</span> <span class="s1">'Bonjour le monde !'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_avec_des_parametres</span>
    <span class="n">get</span> <span class="s1">'/rencontrer'</span><span class="p">,</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s1">'Frank'</span>
    <span class="n">assert_equal</span> <span class="s1">'Salut Frank !'</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">test_avec_agent</span>
    <span class="n">get</span> <span class="s1">'/'</span><span class="p">,</span> <span class="p">{},</span> <span class="s1">'HTTP_USER_AGENT'</span> <span class="o">=&gt;</span> <span class="s1">'Songbird'</span>
    <span class="n">assert_equal</span> <span class="s2">"Vous utilisez Songbird !"</span><span class="p">,</span> <span class="n">last_response</span><span class="p">.</span><span class="nf">body</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Note : si vous utilisez le style modulaire de Sinatra, remplacez
<code class="highlighter-rouge">Sinatra::Application</code> par le nom de la classe de votre application.</p>

<h2>Sinatra::Base - Les Middlewares, Bibliothèques, et Applications Modulaires</h2>

<p>Définir votre application au niveau supérieur fonctionne bien dans le cas des
micro-applications mais présente pas mal d’inconvénients pour créer des
composants réutilisables sous forme de middlewares Rack, de Rails metal, de
simples librairies avec un composant serveur ou même d’extensions Sinatra. Le
niveau supérieur suppose une configuration dans le style des micro-applications
(une application d’un seul fichier, des répertoires <code class="highlighter-rouge">./public</code> et
<code class="highlighter-rouge">./views</code>, des logs, une page d’erreur, etc…). C’est là que
<code class="highlighter-rouge">Sinatra::Base</code> prend tout son intérêt :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MonApplication</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">set</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="kp">true</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="s1">'bar'</span>

  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Bonjour le monde !'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Les méthodes de la classe <code class="highlighter-rouge">Sinatra::Base</code> sont parfaitement identiques à
celles disponibles via le DSL de haut niveau. Il suffit de deux modifications
pour transformer la plupart des applications de haut niveau en un composant
<code class="highlighter-rouge">Sinatra::Base</code> :</p>

<ul>
  <li>Votre fichier doit charger <code class="highlighter-rouge">sinatra/base</code> au lieu de <code class="highlighter-rouge">sinatra</code>, sinon toutes
les méthodes du DSL Sinatra seront importées dans l’espace de nom principal.</li>
  <li>Les gestionnaires de routes, la gestion d’erreur, les filtres et les options
doivent être placés dans une classe héritant de <code class="highlighter-rouge">Sinatra::Base</code>.</li>
</ul>

<p><code class="highlighter-rouge">Sinatra::Base</code> est une page blanche. La plupart des options sont
désactivées par défaut, y compris le serveur intégré. Reportez-vous à
<a href="http://www.sinatrarb.com/configuration.html">Options et Configuration</a>
pour plus d’informations sur les options et leur fonctionnement. Si vous
souhaitez un comportement plus proche de celui obtenu lorsque vous définissez
votre application au niveau supérieur (aussi connu sous le nom de style
Classique), vous pouvez créer une classe héritant de <code class="highlighter-rouge">Sinatra::Application</code>.</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
  <span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
    <span class="s1">'Bonjour le monde !'</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Style modulaire vs. style classique</h3>

<p>Contrairement aux idées reçues, il n’y a rien de mal à utiliser le style
classique. Si c’est ce qui convient pour votre application, vous n’avez
aucune raison de passer à une application modulaire.</p>

<p>Le principal inconvénient du style classique sur le style modulaire est que vous
ne pouvez avoir qu’une application par processus Ruby. Si vous pensez en
utiliser plus, passez au style modulaire. Et rien ne vous empêche de mixer style
classique et style modulaire.</p>

<p>Si vous passez d’un style à l’autre, souvenez-vous des quelques différences
mineures en ce qui concerne les paramètres par défaut :</p>

<table>
  <tr>
    <th>Paramètre</th>
    <th>Classique</th>
    <th>Modulaire</th>
    <th>Modulaire</th>
  </tr>

  <tr>
    <td>app_file</td>
    <td>fichier chargeant sinatra</td>
    <td>fichier héritant de Sinatra::Base</td>
    <td>fichier héritant de Sinatra::Application</td>
  </tr>

  <tr>
    <td>run</td>
    <td>$0 == app_file</td>
    <td>false</td>
    <td>false</td>
  </tr>

  <tr>
    <td>logging</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>method_override</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>inline_templates</td>
    <td>true</td>
    <td>false</td>
    <td>true</td>
  </tr>

  <tr>
    <td>static</td>
    <td>true</td>
    <td>File.exist?(public_folder)</td>
    <td>true</td>
  </tr>
</table>

<h3>Servir une application modulaire</h3>

<p>Il y a deux façons de faire pour démarrer une application modulaire, démarrez
avec <code class="highlighter-rouge">run!</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># my_app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">MyApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># ... code de l'application ici ...</span>

  <span class="c1"># démarre le serveur si ce fichier est directement exécuté</span>
  <span class="n">run!</span> <span class="k">if</span> <span class="n">app_file</span> <span class="o">==</span> <span class="vg">$0</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Démarrez ensuite avec :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby my_app.rb
</code></pre>
</div>

<p>Ou alors avec un fichier <code class="highlighter-rouge">config.ru</code>, qui permet d’utiliser n’importe
quel gestionnaire Rack :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru</span>
<span class="nb">require</span> <span class="s1">'./my_app'</span>
<span class="n">run</span> <span class="no">MyApp</span>
</code></pre>
</div>

<p>Exécutez :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>rackup -p 4567
</code></pre>
</div>

<h3>Utiliser une application de style classique avec un fichier config.ru</h3>

<p>Ecrivez votre application :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># app.rb</span>
<span class="nb">require</span> <span class="s1">'sinatra'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="s1">'Bonjour le monde !'</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Et un fichier <code class="highlighter-rouge">config.ru</code> correspondant :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'./app'</span>
<span class="n">run</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h3>Quand utiliser un fichier config.ru ?</h3>

<p>Quelques cas où vous devriez utiliser un fichier <code class="highlighter-rouge">config.ru</code> :</p>

<ul>
  <li>Vous souhaitez déployer avec un autre gestionnaire Rack (Passenger, Unicorn,
Heroku, …).</li>
  <li>Vous souhaitez utiliser plus d’une sous-classe de <code class="highlighter-rouge">Sinatra::Base</code>.</li>
  <li>Vous voulez utiliser Sinatra comme un middleware, non en tant que
endpoint.</li>
</ul>

<p><strong>Il n’est pas nécessaire de passer par un fichier <code class="highlighter-rouge">config.ru</code> pour la
seule raison que vous êtes passé au style modulaire, et vous n’avez pas besoin
de passer au style modulaire pour utiliser un fichier <code class="highlighter-rouge">config.ru</code>.</strong></p>

<h3>Utiliser Sinatra comme Middleware</h3>

<p>Non seulement Sinatra peut utiliser d’autres middlewares Rack, il peut
également être à son tour utilisé au-dessus de n’importe quel endpoint Rack
en tant que middleware. Cet endpoint peut très bien être une autre
application Sinatra, ou n’importe quelle application basée sur Rack
(Rails/Ramaze/Camping/…) :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="k">class</span> <span class="nc">EcranDeConnexion</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">enable</span> <span class="ss">:sessions</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/connexion'</span><span class="p">)</span> <span class="p">{</span> <span class="n">haml</span> <span class="ss">:connexion</span> <span class="p">}</span>

  <span class="n">post</span><span class="p">(</span><span class="s1">'/connexion'</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'admin'</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="p">[</span><span class="s1">'motdepasse'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'admin'</span>
      <span class="n">session</span><span class="p">[</span><span class="s1">'nom_utilisateur'</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="n">redirect</span> <span class="s1">'/connexion'</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">MonApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># le middleware sera appelé avant les filtres</span>
  <span class="n">use</span> <span class="no">EcranDeConnexion</span>

  <span class="n">before</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">session</span><span class="p">[</span><span class="s1">'nom_utilisateur'</span><span class="p">]</span>
      <span class="n">halt</span> <span class="s2">"Accès refusé, merci de vous &lt;a href='/connexion'&gt;connecter&lt;/a&gt;."</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"Bonjour </span><span class="si">#{</span><span class="n">session</span><span class="p">[</span><span class="s1">'nom_utilisateur'</span><span class="p">]</span><span class="si">}</span><span class="s2">."</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<h3>Création dynamique d’applications</h3>

<p>Il se peut que vous ayez besoin de créer une nouvelle application à l’exécution
sans avoir à les assigner à une constante, vous pouvez le faire grâce à
<code class="highlighter-rouge">Sinatra.new</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="n">mon_app</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s2">"salut"</span> <span class="p">}</span> <span class="p">}</span>
<span class="n">mon_app</span><span class="p">.</span><span class="nf">run!</span>
</code></pre>
</div>

<p>L’application dont elle hérite peut être passé en argument optionnel :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="c1"># config.ru</span>
<span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">controleur</span> <span class="o">=</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="n">enable</span> <span class="ss">:logging</span>
  <span class="n">helpers</span> <span class="no">MyHelpers</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/a'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controleur</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'a'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">map</span><span class="p">(</span><span class="s1">'/b'</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">run</span> <span class="no">Sinatra</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">controleur</span><span class="p">)</span> <span class="p">{</span> <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="s1">'b'</span> <span class="p">}</span> <span class="p">}</span>
<span class="k">end</span>
</code></pre>
</div>

<p>C’est notamment utile pour tester des extensions pour Sinatra ou bien pour
utiliser Sinatra dans votre propre bibliothèque.</p>

<p>Cela permet également d’utiliser très facilement Sinatra comme middleware :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra/base'</span>

<span class="n">use</span> <span class="no">Sinatra</span> <span class="k">do</span>
  <span class="n">get</span><span class="p">(</span><span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span> <span class="p">.</span><span class="nf">.</span><span class="o">.</span> <span class="p">}</span>
<span class="k">end</span>

<span class="n">run</span> <span class="no">RailsProject</span><span class="o">::</span><span class="no">Application</span>
</code></pre>
</div>

<h2>Contextes et Binding</h2>

<p>Le contexte dans lequel vous êtes détermine les méthodes et variables
disponibles.</p>

<h3>Contexte de l’application/classe</h3>

<p>Une application Sinatra correspond à une sous-classe de <code class="highlighter-rouge">Sinatra::Base</code>. Il
s’agit de <code class="highlighter-rouge">Sinatra::Application</code> si vous utilisez le DSL de haut niveau
(<code class="highlighter-rouge">require 'sinatra'</code>). Sinon c’est la sous-classe que vous avez définie. Dans
le contexte de cette classe, vous avez accès aux méthodes telles que <code class="highlighter-rouge">get</code> ou
<code class="highlighter-rouge">before</code>, mais pas aux objets <code class="highlighter-rouge">request</code> ou <code class="highlighter-rouge">session</code> étant donné que toutes
les requêtes sont traitées par une seule classe d’application.</p>

<p>Les options définies au moyen de <code class="highlighter-rouge">set</code> deviennent des méthodes de classe :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MonApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Eh, je suis dans le contexte de l'application !</span>
  <span class="n">set</span> <span class="ss">:foo</span><span class="p">,</span> <span class="mi">42</span>
  <span class="n">foo</span> <span class="c1"># =&gt; 42</span>

  <span class="n">get</span> <span class="s1">'/foo'</span> <span class="k">do</span>
    <span class="c1"># Eh, je ne suis plus dans le contexte de l'application !</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous avez le binding du contexte de l’application dans :</p>

<ul>
  <li>Le corps de la classe d’application</li>
  <li>Les méthodes définies par les extensions</li>
  <li>Le bloc passé à <code class="highlighter-rouge">helpers</code>
</li>
  <li>Les procs/blocs utilisés comme argument pour <code class="highlighter-rouge">set</code>
</li>
  <li>Le bloc passé à <code class="highlighter-rouge">Sinatra.new</code>
</li>
</ul>

<p>Vous pouvez atteindre ce contexte (donc la classe) de la façon suivante :</p>

<ul>
  <li>Via l’objet passé dans les blocs <code class="highlighter-rouge">configure</code> (<code class="highlighter-rouge">configure { |c| ... }</code>)</li>
  <li>En utilisant <code class="highlighter-rouge">settings</code> dans le contexte de la requête</li>
</ul>

<h3>Contexte de la requête/instance</h3>

<p>Pour chaque requête traitée, une nouvelle instance de votre classe
d’application est créée et tous vos gestionnaires sont exécutés dans ce
contexte. Depuis celui-ci, vous pouvez accéder aux objets <code class="highlighter-rouge">request</code> et
<code class="highlighter-rouge">session</code> ou faire appel aux fonctions de rendu telles que <code class="highlighter-rouge">erb</code> ou <code class="highlighter-rouge">haml</code>.
Vous pouvez accéder au contexte de l’application depuis le contexte de la
requête au moyen de <code class="highlighter-rouge">settings</code> :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="k">class</span> <span class="nc">MonApp</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Eh, je suis dans le contexte de l'application !</span>
  <span class="n">get</span> <span class="s1">'/ajouter_route/:nom'</span> <span class="k">do</span>
    <span class="c1"># Contexte de la requête pour '/ajouter_route/:nom'</span>
    <span class="vi">@value</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="n">settings</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="s2">"/</span><span class="si">#{</span><span class="n">params</span><span class="p">[</span><span class="s1">'nom'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1"># Contexte de la requête pour "/#{params['nom']}"</span>
      <span class="vi">@value</span> <span class="c1"># =&gt; nil (on est pas au sein de la même requête)</span>
    <span class="k">end</span>

    <span class="s2">"Route ajoutée !"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>

<p>Vous avez le binding du contexte de la requête dans :</p>

<ul>
  <li>les blocs get, head, post, put, delete, options, patch, link et unlink</li>
  <li>les filtres before et after</li>
  <li>les méthodes utilitaires (définies au moyen de <code class="highlighter-rouge">helpers</code>)</li>
  <li>les vues et templates</li>
</ul>

<h3>Le contexte de délégation</h3>

<p>Le contexte de délégation se contente de transmettre les appels de méthodes au
contexte de classe. Toutefois, il ne se comporte pas à 100% comme le contexte
de classe car vous n’avez pas le binding de la classe : seules les méthodes
spécifiquement déclarées pour délégation sont disponibles et il n’est pas
possible de partager de variables/états avec le contexte de classe
(comprenez : <code class="highlighter-rouge">self</code> n’est pas le même). Vous pouvez ajouter des délégations de
méthode en appelant <code class="highlighter-rouge">Sinatra::Delegator.delegate :method_name</code>.</p>

<p>Vous avez le binding du contexte de délégation dans :</p>

<ul>
  <li>Le binding de haut niveau, si vous avez utilisé <code class="highlighter-rouge">require "sinatra"</code>
</li>
  <li>Un objet qui inclut le module <code class="highlighter-rouge">Sinatra::Delegator</code>
</li>
</ul>

<p>Pour vous faire une idée, vous pouvez jeter un coup d’oeil au
<a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/base.rb#L1609-1633">mixin Sinatra::Delegator</a>
qui <a href="https://github.com/sinatra/sinatra/blob/ca06364/lib/sinatra/main.rb#L28-30">étend l’objet principal</a>.</p>

<h2>Ligne de commande</h2>

<p>Les applications Sinatra peuvent être lancées directement :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>ruby mon_application.rb <span class="o">[</span>-h] <span class="o">[</span>-x] <span class="o">[</span>-e ENVIRONNEMENT] <span class="o">[</span>-p PORT] <span class="o">[</span>-o HOTE] <span class="o">[</span>-s SERVEUR]
</code></pre>
</div>

<p>Avec les options :</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>-h # aide
-p # déclare le port (4567 par défaut)
-o # déclare l'hôte (0.0.0.0 par défaut)
-e # déclare l'environnement (development par défaut)
-s # déclare le serveur/gestionnaire à utiliser (thin par défaut)
-x # active le mutex lock (off par défaut)
</code></pre>
</div>

<h3>Multi-threading</h3>

<p><em>Cette partie est basée sur <a href="http://stackoverflow.com/questions/6278817/is-sinatra-multi-threaded/6282999#6282999)">une réponse StackOverflow</a> de Konstantin.</em></p>

<p>Sinatra n’impose pas de modèle de concurrence. Sinatra est thread-safe, vous pouvez
donc utiliser n’importe quel gestionnaire Rack, comme Thin, Puma ou WEBrick en mode
multi-threaded.</p>

<p>Cela signifie néanmoins qu’il vous faudra spécifier les paramètres correspondant au
gestionnaire Rack utilisé lors du démarrage du serveur.</p>

<p>L’exemple ci-dessous montre comment vous pouvez exécuter un serveur Thin de manière
multi-threaded:</p>

<div class="highlighter-rouge">
<pre class="highlight"><code># app.rb
require 'sinatra/base'

classe App &lt; Sinatra::Base
  get '/' do
    'Bonjour le monde !'
  end
end

App.run!
</code></pre>
</div>

<p>Pour démarrer le serveur, exécuter la commande suivante:</p>

<div class="highlighter-rouge">
<pre class="highlight"><code>thin --threaded start
</code></pre>
</div>

<h2>Configuration nécessaire</h2>

<p>Les versions suivantes de Ruby sont officiellement supportées :</p>

<dl>
  <dt>Ruby 2.2</dt>
  <dd>
    2.2 est totalement supporté et recommandé. L'abandon de son support
    officiel n'est pas à l'ordre du jour.
  </dd>

  <dt>Rubinius</dt>
  <dd>
    Rubinius est officiellement supporté (Rubinius &gt;= 2.x). Un <tt>gem install
    puma</tt> est recommandé.
  </dd>

  <dt>JRuby</dt>
  <dd>
    La dernière version stable de JRuby est officiellement supportée. Il est
    déconseillé d'utiliser des extensions C avec JRuby. Un <tt>gem install
    trinidad</tt> est recommandé.
  </dd>
</dl>

<p>Les versions antérieures à 2.2.2 ne sont plus supportées depuis Sinatra 2.0.</p>

<p>Nous gardons également un oeil sur les versions Ruby à venir.</p>

<p>Les implémentations Ruby suivantes ne sont pas officiellement supportées mais
sont malgré tout connues pour permettre de faire fonctionner Sinatra :</p>

<ul>
  <li>Versions plus anciennes de JRuby et Rubinius</li>
  <li>Ruby Enterprise Edition</li>
  <li>MacRuby, Maglev, IronRuby</li>
  <li>Ruby 1.9.0 et 1.9.1 (mais nous déconseillons leur utilisation)</li>
</ul>

<p>Le fait de ne pas être officiellement supporté signifie que si quelque chose
ne fonctionne pas sur cette plateforme uniquement alors c’est un problème de la
plateforme et pas un bug de Sinatra.</p>

<p>Nous lançons également notre intégration continue (CI) avec ruby-head (la
future 2.1.0), mais nous ne pouvont rien garantir étant donné les évolutions
continuelles. La version 2.1.0 devrait être totalement supportée.</p>

<p>Sinatra devrait fonctionner sur n’importe quel système d’exploitation
supporté par l’implémentation Ruby choisie.</p>

<p>Si vous utilisez MacRuby, vous devriez <code class="highlighter-rouge">gem install control_tower</code>.</p>

<p>Il n’est pas possible d’utiliser Sinatra sur Cardinal, SmallRuby, BlueRuby ou
toute version de Ruby antérieure à 1.8.7 à l’heure actuelle.</p>

<h2>Essuyer les plâtres</h2>

<p>Si vous souhaitez tester la toute dernière version de Sinatra, n’hésitez pas
à faire tourner votre application sur la branche master, celle-ci devrait être
stable.</p>

<p>Pour cela, la méthode la plus simple est d’installer une gem de prerelease que
nous publions de temps en temps :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install sinatra --pre
</code></pre>
</div>
<p>Ce qui permet de bénéficier des toutes dernières fonctionnalités.</p>

<h3>Installer avec Bundler</h3>

<p>Il est cependant conseillé de passer par <a href="http://bundler.io">Bundler</a> pour
faire tourner votre application avec la dernière version de Sinatra.</p>

<p>Pour commencer, installez bundler si nécessaire :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>gem install bundler
</code></pre>
</div>

<p>Ensuite, créez un fichier <code class="highlighter-rouge">Gemfile</code> dans le dossier de votre projet :</p>

<div class="language-ruby highlighter-rouge">
<pre class="highlight"><code><span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
<span class="n">gem</span> <span class="s1">'sinatra'</span><span class="p">,</span> <span class="ss">:github</span> <span class="o">=&gt;</span> <span class="s2">"sinatra/sinatra"</span>

<span class="c1"># autres dépendances</span>
<span class="n">gem</span> <span class="s1">'haml'</span>                    <span class="c1"># si par exemple vous utilisez haml</span>
<span class="n">gem</span> <span class="s1">'activerecord'</span><span class="p">,</span> <span class="s1">'~&gt; 3.0'</span>  <span class="c1"># au cas où vous auriez besoin de ActiveRecord 3.x</span>
</code></pre>
</div>

<p>Notez que vous devez lister toutes les dépendances de votre application dans
ce fichier <code class="highlighter-rouge">Gemfile</code>. Les dépendances directes de Sinatra (Rack et Tilt) seront
automatiquement téléchargées et ajoutées par Bundler.</p>

<p>Vous pouvez alors lancer votre application de la façon suivante :</p>

<div class="language-shell highlighter-rouge">
<pre class="highlight"><code>bundle <span class="nb">exec </span>ruby myapp.rb
</code></pre>
</div>

<h2>Versions</h2>

<p>Sinatra se conforme aux <a href="http://semver.org/">versions sémantiques</a>, aussi bien
SemVer que SemVerTag.</p>

<h2>Mais encore</h2>

<ul>
  <li>
<a href="http://www.sinatrarb.com/">Site internet</a> - Plus de documentation,
de news, et des liens vers d’autres ressources.</li>
  <li>
<a href="http://www.sinatrarb.com/contributing">Contribuer</a> - Vous avez trouvé un
bug ? Besoin d’aide ? Vous avez un patch ?</li>
  <li><a href="https://github.com/sinatra/sinatra/issues">Suivi des problèmes</a></li>
  <li><a href="https://twitter.com/sinatra">Twitter</a></li>
  <li><a href="http://groups.google.com/group/sinatrarb/topics">Mailing List</a></li>
  <li>IRC : <a href="irc://chat.freenode.net/#sinatra">#sinatra</a> sur http://freenode.net</li>
  <li>
<a href="https://github.com/sinatra/sinatra-book/">Sinatra Book</a> Tutoriels et recettes</li>
  <li>
<a href="http://recipes.sinatrarb.com/">Sinatra Recipes</a> trucs et astuces rédigés par
la communauté</li>
  <li>Documentation API de la <a href="http://www.rubydoc.info/gems/sinatra">dernière version</a>
ou du <a href="http://www.rubydoc.info/github/sinatra/sinatra">HEAD courant</a> sur
http://www.rubydoc.info/</li>
  <li><a href="https://travis-ci.org/sinatra/sinatra">CI server</a></li>
</ul>
</body></html>
